!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=31)}([function(t,e,n){"use strict";n.d(e,"c",function(){return i}),n.d(e,"O",function(){return o}),n.d(e,"V",function(){return r}),n.d(e,"N",function(){return a}),n.d(e,"E",function(){return s}),n.d(e,"G",function(){return l}),n.d(e,"H",function(){return h}),n.d(e,"D",function(){return c}),n.d(e,"Xb",function(){return u}),n.d(e,"Yb",function(){return d}),n.d(e,"Z",function(){return f}),n.d(e,"i",function(){return p}),n.d(e,"A",function(){return g}),n.d(e,"o",function(){return m}),n.d(e,"l",function(){return v}),n.d(e,"Sb",function(){return y}),n.d(e,"cb",function(){return b}),n.d(e,"C",function(){return E}),n.d(e,"Wb",function(){return w}),n.d(e,"U",function(){return C}),n.d(e,"F",function(){return O}),n.d(e,"Zb",function(){return x}),n.d(e,"j",function(){return T}),n.d(e,"Lb",function(){return _}),n.d(e,"k",function(){return S}),n.d(e,"Rb",function(){return k}),n.d(e,"ac",function(){return A}),n.d(e,"K",function(){return R}),n.d(e,"n",function(){return D}),n.d(e,"Tb",function(){return P}),n.d(e,"m",function(){return L}),n.d(e,"ab",function(){return N}),n.d(e,"bb",function(){return M}),n.d(e,"eb",function(){return B}),n.d(e,"I",function(){return j}),n.d(e,"J",function(){return H}),n.d(e,"t",function(){return I}),n.d(e,"Ub",function(){return F}),n.d(e,"z",function(){return q}),n.d(e,"Q",function(){return z}),n.d(e,"db",function(){return Y}),n.d(e,"R",function(){return X}),n.d(e,"P",function(){return W}),n.d(e,"dc",function(){return U}),n.d(e,"e",function(){return V}),n.d(e,"Jb",function(){return G}),n.d(e,"f",function(){return J}),n.d(e,"Kb",function(){return $}),n.d(e,"T",function(){return Q}),n.d(e,"S",function(){return K}),n.d(e,"r",function(){return Z}),n.d(e,"q",function(){return tt}),n.d(e,"p",function(){return et}),n.d(e,"d",function(){return nt}),n.d(e,"Ib",function(){return it}),n.d(e,"L",function(){return ot}),n.d(e,"bc",function(){return rt}),n.d(e,"g",function(){return at}),n.d(e,"W",function(){return st}),n.d(e,"X",function(){return lt}),n.d(e,"Y",function(){return ht}),n.d(e,"ec",function(){return ct}),n.d(e,"M",function(){return ut}),n.d(e,"y",function(){return dt}),n.d(e,"Vb",function(){return ft}),n.d(e,"B",function(){return pt}),n.d(e,"s",function(){return gt}),n.d(e,"h",function(){return mt}),n.d(e,"Qb",function(){return vt}),n.d(e,"fc",function(){return yt}),n.d(e,"cc",function(){return bt}),n.d(e,"w",function(){return Et}),n.d(e,"x",function(){return wt}),n.d(e,"u",function(){return Ct}),n.d(e,"v",function(){return Ot}),n.d(e,"Pb",function(){return xt}),n.d(e,"Ob",function(){return Tt}),n.d(e,"Nb",function(){return _t}),n.d(e,"Mb",function(){return St}),n.d(e,"ib",function(){return kt}),n.d(e,"jb",function(){return At}),n.d(e,"pb",function(){return Rt}),n.d(e,"hb",function(){return Dt}),n.d(e,"rb",function(){return Pt}),n.d(e,"kb",function(){return Lt}),n.d(e,"tb",function(){return Nt}),n.d(e,"mb",function(){return Mt}),n.d(e,"sb",function(){return Bt}),n.d(e,"ob",function(){return jt}),n.d(e,"lb",function(){return Ht}),n.d(e,"nb",function(){return It}),n.d(e,"qb",function(){return Ft}),n.d(e,"Gb",function(){return qt}),n.d(e,"Hb",function(){return zt}),n.d(e,"Db",function(){return Yt}),n.d(e,"Eb",function(){return Xt}),n.d(e,"Fb",function(){return Wt}),n.d(e,"xb",function(){return Ut}),n.d(e,"gc",function(){return Vt}),n.d(e,"Cb",function(){return Gt}),n.d(e,"ic",function(){return Jt}),n.d(e,"yb",function(){return $t}),n.d(e,"a",function(){return Qt}),n.d(e,"hc",function(){return Kt}),n.d(e,"fb",function(){return Zt}),n.d(e,"gb",function(){return te}),n.d(e,"Bb",function(){return ee}),n.d(e,"Ab",function(){return ne}),n.d(e,"zb",function(){return ie}),n.d(e,"wb",function(){return oe}),n.d(e,"ub",function(){return re}),n.d(e,"b",function(){return ae}),n.d(e,"vb",function(){return se});var i="bp-is-active",o="bp-is-hidden",r="bp-is-invisible",a="is-disabled",s="bp-btn",l="bp-btn-plain",h="bp-btn-primary",c="bp-header",u=".bp-base-header",d=".bp-header-container",f="bp-doc-presentation",p="ba-annotations-loaded",g="ba-point-annotation-marker",m="ba-annotation-dialog",v="ba-annotation-caret",y="."+v,b="ba-textarea",E="annotation-textarea",w="."+E,C="ba-invalid-input",O="button-container",x="."+O,T="cancel-annotation-btn",_="."+T,S="post-annotation-btn",k="."+S,A=".delete-comment-btn",R="delete-confirmation-message",D="annotation-container",P="."+D,L="ba-annotation-comment-text",N="profile-container",M="profile-image-container",B="user-name",j="comment-date",H="ba-create-comment",I="ba-annotation-highlight-dialog",F="."+I,q="ba-plain-highlight",z="ba-highlight-dialog",Y="ba-is-text-highlighted",X="ba-annotation-highlight-label",W="ba-annotation-highlight-btns",U="."+W,V="ba-add-highlight-btn",G="."+V,J="ba-highlight-comment-btn",$="."+J,Q="ba-quad-corner-container",K="ba-quad-corner",Z="ba-annotation-drawing-label",tt="ba-annotation-drawing-dialog",et="ba-annotation-drawing-btns",nt="ba-btn-annotate-draw-add",it="."+nt,ot="ba-btn-annotate-draw-delete",rt="."+ot,at="ba-animate-show-dialog",st="ba-mobile-annotation-dialog",lt="ba-mobile-create-annotation-dialog",ht="ba-annotation-mobile-header",ct="."+ht,ut="ba-annotation-dialog-close",dt="ba-annotation-mode",ft="."+dt,pt="ba-point-mode",gt="ba-draw-mode",mt="ba-annotate-mode-background",vt=".ba-btn-annotate-point-exit",yt=".ba-point-mode-header",bt=".ba-draw-mode-header",Et="ba-annotation-layer-highlight",wt="ba-annotation-layer-highlight-comment",Ct="ba-annotation-layer-draw",Ot="ba-annotation-layer-draw-in-progress",xt=".ba-btn-annotate-draw-undo",Tt=".ba-btn-annotate-draw-redo",_t=".ba-btn-annotate-draw-post",St=".ba-btn-annotate-draw-cancel",kt="annotation-dialog",At="annotation-indicator",Rt="highlight-btn",Dt="add-highlight-comment-btn",Pt="post-annotation-btn",Lt="cancel-annotation-btn",Nt="reply-textarea",Mt="cancel-reply-btn",Bt="post-reply-btn",jt="delete-btn",Ht="cancel-delete-btn",It="confirm-delete-btn",Ft="mobile-dialog-close-btn",qt='[data-section="create"]',zt='[data-section="show"]',Yt="can_annotate",Xt="can_view_annotations_all",Wt="can_view_annotations_self",Ut={idle:"idle",drawing:"drawing",erasing:"erasing"},Vt={hover:"hover",inactive:"inactive",pending:"pending",pending_active:"pending-active"},Gt=[Vt.pending,Vt.pending_active],Jt={point:"point",highlight:"highlight",draw:"draw",highlight_comment:"highlight-comment"},$t={normal:"rgba(254, 217, 78, 0.5)",active:"rgba(255, 201, 0, 0.5)",erase:"rgba(255, 245, 132, 1)"},Qt={fetch:"annotationsfetched",error:"annotationerror",scale:"scaleannotations"},Kt={pending:"annotationpending",threadSave:"annotationthreadsaved",threadDelete:"annotationthreaddeleted",threadCleanup:"annotationthreadcleanup",save:"annotationsaved",delete:"annotationdeleted",deleteError:"annotationdeleteerror",cancel:"annotationcanceled",createError:"annotationcreateerror",show:"annotationshow",hide:"annotationhide"},Zt={toggleMode:"togglemode",enter:"annotationmodeenter",exit:"annotationmodeexit",createThread:"createannotationthread",register:"registerthread",unregister:"unregisterthread",bindDOMListeners:"binddomlisteners",unbindDOMListeners:"unbinddomlisteners",renderPage:"annotationsrenderpage",resetMobileDialog:"annotationsmobiledialogreset"},te={init:"init",post:"post_comment",cancel:"cancel",plain:"plain_highlight_create",comment:"comment_highlight_edit"},ee=15,ne=15,ie="mobile-annotation-dialog",oe=16.67,re=3,ae=5,se=5},function(t,e,n){"use strict";n(13);var i=n(0),o=n(2);n.d(e,"H",function(){return d}),n.d(e,"k",function(){return f}),n.d(e,"u",function(){return p}),n.d(e,"j",function(){return g}),n.d(e,"M",function(){return m}),n.d(e,"x",function(){return v}),n.d(e,"g",function(){return y}),n.d(e,"h",function(){return b}),n.d(e,"K",function(){return E}),n.d(e,"D",function(){return w}),n.d(e,"C",function(){return C}),n.d(e,"z",function(){return O}),n.d(e,"m",function(){return x}),n.d(e,"A",function(){return T}),n.d(e,"o",function(){return _}),n.d(e,"v",function(){return S}),n.d(e,"r",function(){return k}),n.d(e,"t",function(){return A}),n.d(e,"F",function(){return R}),n.d(e,"B",function(){return D}),n.d(e,"q",function(){return P}),n.d(e,"y",function(){return L}),n.d(e,"J",function(){return N}),n.d(e,"E",function(){return M}),n.d(e,"w",function(){return B}),n.d(e,"a",function(){return j}),n.d(e,"i",function(){return H}),n.d(e,"G",function(){return I}),n.d(e,"e",function(){return F}),n.d(e,"f",function(){return q}),n.d(e,"s",function(){return z}),n.d(e,"L",function(){return Y}),n.d(e,"I",function(){return X}),n.d(e,"b",function(){return W}),n.d(e,"d",function(){return U}),n.d(e,"c",function(){return V}),n.d(e,"l",function(){return G}),n.d(e,"n",function(){return J}),n.d(e,"p",function(){return $});var r="X-Box-Client-Name",a="X-Box-Client-Version",s="box-annotations",l="2.3.0",h=9,c=["annotations","annotationService","fileVersionId","locale","location","type"],u=/\r\n|\n\r|\n|\r/g;function d(t,e){var n=t.querySelector(e);if(n){var o=t.querySelectorAll("."+i.D);[].forEach.call(o,function(t){t.classList.add(i.O)}),n.classList.remove(i.O)}}function f(t,e){for(var n=t;n&&n!==document;n=n.parentNode)if(n.classList&&n.classList.contains(e))return n;return null}function p(t){var e=f(t,"page")||null,n=1;return e&&(n=parseInt(e.getAttribute("data-page-number"),10)),{pageEl:e,page:n}}function g(t,e){for(var n=e||"data-type",i=t;i&&i!==document;i=i.parentNode)if(i&&i.getAttribute(n))return i.getAttribute(n);return""}function m(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.remove(i.O)}function v(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.add(i.O)}function y(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.add(i.N)}function b(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.remove(i.N)}function E(t,e){var n=t;n.style.width="",n.style.height="",n.classList.remove(i.c),n.classList.remove(i.U),e&&(n.value="")}function w(t,e){return!!f(e||t.target,i.o)}function C(t){var e=t.target;return!(!f(e,i.o)&&!f(e,i.A))}function O(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t.insertBefore(function(t,e){var n=document.createRange();return n.selectNode(t),n.createContextualFragment(e.replace(/>\s*</g,"><"))}(t,e),n)}function x(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=document.createElement("button");return t.forEach(function(t){return o.classList.add(t)}),o.title=e,o.innerHTML=n,o.setAttribute("data-type",i),o}function T(t){var e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function _(t,e,n,i){if(""!==t)return('<img src="'+t+'" alt="'+i+'">').trim();var o="";return"0"!==e&&(o=n.replace(/\W*(\w)\w*/g,"$1").toUpperCase().substring(0,3)),('<div class="ba-annotation-profile avatar-color-'+(parseInt(e,10)||0)%h+'">'+o+"</div>").trim()}function S(t){return parseFloat(t.getAttribute("data-scale"))||1}function k(t){return t[Object.keys(t)[0]]}function A(t){var e=Object.keys(t).length;return t[Object.keys(t)[e-1]]}function R(t){var e=k(t);return 1===Object.keys(t).length&&""===e.text}function D(t){return t===i.ic.highlight||t===i.ic.highlight_comment}function P(t,e,n,i){var o=null;if(t&&void 0!==t.x&&void 0!==t.y){var r=e.width/n,a=(e.height-i)/n;(Math.abs(r-t.x)>1||Math.abs(a!==t.y)>1)&&(o={x:r/t.x,y:a/t.y})}return o}function L(t){return(""+t).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/`/g,"&#96;")}function N(t,e,n,o,r){var a=e<0,s=e+n>r,l=t.querySelector(i.Sb);if(a&&!s){var h=Math.max(10,o);return l.style.left=h+"px",0}if(s&&!a){var c=Math.max(10,r-o);return l.style.left=n-c+"px",r-n}return l.style.left="50%",e}function M(t){return i.Cb.indexOf(t)>-1}function B(t){return!!(D(t.type)||t.minX&&t.minY&&t.maxX&&t.maxY)}function j(t){return!!t&&(!(!(t.type!==i.ic.point||(e=t.location,e&&e.x&&e.y))||D(t.type)&&!function(t){return!(!t||!t.quadPoints)}(t.location)||t.type===i.ic.draw&&!function(t){return!!(t&&t.minX&&t.minY&&t.maxX&&t.maxY)}(t.location))&&c.every(function(e){return void 0!==t[e]}));var e}function H(t,e){return function(n){var i=n||window.event;if(i&&(!i.target||"BUTTON"!==i.target.nodeName)){i.preventDefault(),i.stopPropagation();var o=t(i);e(o)}}}function I(t){t&&(t.preventDefault(),t.stopPropagation())}function F(t,e,n){var i={x:t,y:e};return n&&(i.dimensions=n),i}function q(t){return function(t){var e="",n=t.keyIdentifier,i=t.key||n||"";return t.ctrlKey?e="Control":t.shiftKey?e="Shift":t.metaKey&&(e="Meta"),i===e&&(i=""),0===i.indexOf("U+")&&(i="U+001B"===i?"Escape":String.fromCharCode(Number(i.replace("U+","0x")))),i?(" "===i&&(i="Space"),"Esc"===i&&(i="Escape"),"Right"!==i&&"Left"!==i&&"Down"!==i&&"Up"!==i||(i="Arrow"+i),e&&(e+="+"),e+i):""}(t)}function z(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return e&&(t.Authorization="Bearer "+e),n&&(t.BoxApi="shared_link="+n,i&&(t.BoxApi=t.BoxApi+"&shared_link_password="+i)),s&&(t[r]=s),l&&(t[a]=l),t}function Y(t,e){var n=(t+"e").split("e");return+((n=(Math.round(n[0]+"e"+(+n[1]+e))+"e").split("e"))[0]+"e"+(+n[1]-e))}function X(t,e){return t&&t.length?t.replace(/\{\d+\}/g,function(t){var n=parseInt(t.replace(/^\D+/g,""),10)-1;return e[n]?e[n]:t}):t}function W(t){if(!t)return!1;var e=t[i.Db],n=t[i.Eb],o=t[i.Fb];return!!e||!!n||!!o}function U(t){var e=t.replace(u,"\n").split("\n"),n=document.createElement("p");return n.classList.add(i.m),e.length>1?e.forEach(function(t){if(""===t)n.appendChild(document.createElement("br"));else{var e=document.createElement("p");e.textContent=t,n.appendChild(e)}}):n.textContent=t,n}function V(t,e){var n=t.querySelector("canvas."+e);if(n){var i=n.getContext("2d");i&&i.clearRect(0,0,n.width,n.height)}}function G(t){var e=t;return e?(e.classList.add(i.c),e.selectionStart&&(e.selectionEnd=e.value.length,e.selectionStart=e.selectionEnd),T(e)&&e.focus(),e):e}function J(){var t=document.createElement("div"),e=document.createElement("div");e.classList.add(i.Y),t.appendChild(e);var n=x([i.M],i.qb,o.a,i.qb);return e.appendChild(n),t}function $(t){var e=t;!function(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.add(i.V)}(e),m(e),e.style.left=0;var n=e.getBoundingClientRect().width;return v(e),function(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.remove(i.V)}(e),n}},function(t,e,n){"use strict";n.d(e,"f",function(){return O}),n.d(e,"g",function(){return x}),n.d(e,"b",function(){return T}),n.d(e,"e",function(){return _}),n.d(e,"a",function(){return S}),n.d(e,"d",function(){return k}),n.d(e,"c",function(){return A});var i=n(14),o=n.n(i),r=n(15),a=n.n(r),s=n(16),l=n.n(s),h=n(17),c=n.n(h),u=n(18),d=n.n(u),f=n(19),p=n.n(f),g=n(20),m=n.n(g),v=n(21),y=n.n(v),b=n(22),E=n.n(b),w=n(23),C=n.n(w),O=(o.a,a.a),x=l.a,T=(c.a,d.a,p.a),_=m.a,S=y.a,k=E.a,A=C.a},function(t,e){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(t){return"function"==typeof t}function o(t){return"object"==typeof t&&null!==t}function r(t){return void 0===t}t.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},n.prototype.emit=function(t){var e,n,a,s,l,h;if(this._events||(this._events={}),"error"===t&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var c=new Error('Uncaught, unspecified "error" event. ('+e+")");throw c.context=e,c}if(r(n=this._events[t]))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),n.apply(this,s)}else if(o(n))for(s=Array.prototype.slice.call(arguments,1),a=(h=n.slice()).length,l=0;l<a;l++)h[l].apply(this,s);return!0},n.prototype.addListener=function(t,e){var a;if(!i(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,i(e.listener)?e.listener:e),this._events[t]?o(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,o(this._events[t])&&!this._events[t].warned&&(a=r(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&a>0&&this._events[t].length>a&&(this._events[t].warned=!0,console.trace),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(t,e){if(!i(e))throw TypeError("listener must be a function");var n=!1;function o(){this.removeListener(t,o),n||(n=!0,e.apply(this,arguments))}return o.listener=e,this.on(t,o),this},n.prototype.removeListener=function(t,e){var n,r,a,s;if(!i(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(a=(n=this._events[t]).length,r=-1,n===e||i(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(o(n)){for(s=a;s-- >0;)if(n[s]===e||n[s].listener&&n[s].listener===e){r=s;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},n.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(i(n=this._events[t]))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},n.prototype.listeners=function(t){return this._events&&this._events[t]?i(this._events[t])?[this._events[t]]:this._events[t].slice():[]},n.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(i(e))return 1;if(e)return e.length}return 0},n.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,n){"use strict";var i=n(3),o=n.n(i),r=n(10),a=n(6),s=n(1),l=n(2),h=n(0),c=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),u=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var d=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.annotatedElement=t.annotatedElement,n.annotations=t.annotations||{},n.annotationService=t.annotationService,n.container=t.container,n.fileVersionId=t.fileVersionId,n.location=t.location,n.threadID=t.threadID||a.a.generateID(),n.threadNumber=t.threadNumber||"",n.type=t.type,n.locale=t.locale,n.isMobile=t.isMobile||!1,n.hasTouch=t.hasTouch||!1,n.permissions=t.permissions,n.localized=t.localized,n.state=h.gc.inactive,n.regenerateBoundary(),n.showDialog=n.showDialog.bind(n),n.setup(),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),c(e,[{key:"destroy",value:function(){this.dialog&&!this.isMobile&&(this.unbindCustomListenersOnDialog(),this.dialog.destroy(),this.dialog=null),this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null),this.state!==h.gc.pending&&this.emit(h.hc.threadDelete)}},{key:"hide",value:function(){s.x(this.element)}},{key:"reset",value:function(){this.state=h.gc.inactive}},{key:"isDialogVisible",value:function(){return!(!this.dialog||!this.dialog.element||this.dialog.element.classList.contains(h.O))}},{key:"showDialog",value:function(){this.dialog.element||this.dialog.setup(this.annotations,this.element),this.dialog.show()}},{key:"hideDialog",value:function(){this.dialog&&(this.state=h.gc.inactive,this.dialog.hide())}},{key:"saveAnnotation",value:function(t,e){var n=this,i=this.createAnnotationData(t,e),o=a.a.generateID(),s=i;s.annotationID=o,s.permissions={can_edit:!0,can_delete:!0},s.created=(new Date).getTime(),s.modified=s.created;var l=new r.a(s);return this.saveAnnotationToThread(l),this.state=h.gc.inactive,this.dialog&&this.dialog.disable(l.annotationID),this.annotationService.create(i).then(function(t){return n.updateTemporaryAnnotation(l,t)}).catch(function(t){return n.handleThreadSaveError(t,o)})}},{key:"deleteAnnotation",value:function(t){var e=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.annotations[t];if(!i)return this.emit(h.hc.deleteError),Promise.reject();if(i.permissions&&!i.permissions.can_delete)return this.emit(h.hc.deleteError),Promise.reject();delete this.annotations[t];var o=s.r(this.annotations),r=o&&o.permissions&&o.permissions.can_delete;return s.F(this.annotations)&&!r?this.cancelFirstComment():!o||s.F(this.annotations)?(this.isMobile&&this.dialog&&(this.dialog.hideMobileDialog(),this.dialog.removeAnnotation(t)),this.destroy()):this.dialog&&(this.dialog.removeAnnotation(t),this.showDialog(),this.dialog.activateReply()),n?this.annotationService.delete(t).then(function(){o=s.r(e.annotations),r=o&&o.permissions&&o.permissions.can_delete,s.F(e.annotations)&&r&&e.annotationService.delete(o.annotationID),(o=s.r(e.annotations))||e.emit(h.hc.threadCleanup),e.emit(h.hc.delete)}).catch(function(t){e.emit(h.hc.deleteError)}):Promise.resolve()}},{key:"cancelFirstComment",value:function(){}},{key:"show",value:function(){}},{key:"createDialog",value:function(){}},{key:"setup",value:function(){var t=s.r(this.annotations);this.state=t?h.gc.inactive:h.gc.pending,this.createDialog(),this.bindCustomListenersOnDialog(),this.dialog&&(this.dialog.isMobile=this.isMobile,this.dialog.localized=this.localized),this.setupElement()}},{key:"setupElement",value:function(){this.element=this.createElement(),this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element&&this.element.addEventListener("click",this.showDialog)}},{key:"unbindDOMListeners",value:function(){this.element&&this.element.removeEventListener("click",this.showDialog)}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.createAnnotation=this.createAnnotation.bind(this),this.cancelUnsavedAnnotation=this.cancelUnsavedAnnotation.bind(this),this.deleteAnnotationWithID=this.deleteAnnotationWithID.bind(this),this.dialog.addListener("annotationcreate",this.createAnnotation),this.dialog.addListener("annotationcancel",this.cancelUnsavedAnnotation),this.dialog.addListener("annotationdelete",this.deleteAnnotationWithID),this.dialog.addListener("annotationshow",function(){return t.emit(h.hc.show)}),this.dialog.addListener("annotationhide",function(){return t.emit(h.hc.hide)}))}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog&&this.dialog.removeAllListeners(["annotationcreate","annotationcancel","annotationdelete","annotationshow","annotationhide"])}},{key:"cancelUnsavedAnnotation",value:function(){s.E(this.state)?(this.emit(h.hc.cancel),this.destroy()):this.hideDialog()}},{key:"scrollIntoView",value:function(){var t=parseInt(this.location.y,10);this.scrollToPage(),this.centerAnnotation(this.annotatedElement.scrollTop+t)}},{key:"scrollToPage",value:function(){this.location&&this.location.page&&this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]').scrollIntoView()}},{key:"centerAnnotation",value:function(t){t<this.annotatedElement.scrollHeight?this.annotatedElement.scrollTop=t:this.annotatedElement.scrollTop=this.annotatedElement.scrollBottom}},{key:"updateTemporaryAnnotation",value:function(t,e){t.annotationID in this.annotations?(delete this.annotations[t.annotationID],this.annotations[e.annotationID]=e):this.saveAnnotationToThread(e),!this.threadNumber&&e&&e.threadNumber&&(this.threadNumber=e.threadNumber),this.dialog&&(this.dialog.element&&this.dialog.element.dataset&&(this.dialog.element.dataset.threadNumber=this.threadNumber),this.dialog.addAnnotation(e),this.dialog.removeAnnotation(t.annotationID),this.dialog.enable(e.annotationID),this.dialog.scrollToLastComment()),this.isMobile&&(this.state=h.gc.hover,this.showDialog()),this.emit(h.hc.save)}},{key:"createElement",value:function(){var t=document.createElement("button");return t.classList.add(h.A),t.setAttribute("data-type",h.jb),t.innerHTML=l.g,t}},{key:"saveAnnotationToThread",value:function(t){this.annotations[t.annotationID]=t,this.dialog&&(this.dialog.addAnnotation(t),this.dialog.activateReply())}},{key:"createAnnotationData",value:function(t,e){return{fileVersionId:this.fileVersionId,type:t,text:e,location:this.location,user:this.annotationService.user,threadID:this.threadID,threadNumber:this.threadNumber}}},{key:"createAnnotation",value:function(t){this.saveAnnotation(h.ic.point,t.text)}},{key:"deleteAnnotationWithID",value:function(t){this.deleteAnnotation(t.annotationID)}},{key:"regenerateBoundary",value:function(){this.location&&this.location.x&&this.location.y&&(this.minX=this.location.x,this.maxX=this.location.x,this.minY=this.location.y,this.maxY=this.location.y)}},{key:"handleThreadSaveError",value:function(t,e){this.deleteAnnotation(e,!1),this.emit(h.hc.createError)}},{key:"getThreadEventData",value:function(){var t={type:this.type,threadID:this.threadID};return this.annotationService.user.id>0&&(t.userId=this.annotationService.user.id),this.threadNumber&&(t.threadNumber=this.threadNumber),t}},{key:"emit",value:function(t,n){var i=this.getThreadEventData();u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,t,{data:i,eventData:n}),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,"threadevent",{event:t,data:i,eventData:n})}}]),e}();e.a=d},function(t,e,n){"use strict";var i=n(3),o=n.n(i),r=n(1),a=n(0),s=n(2),l=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var h="ba-annotation-dialog-flipped",c=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.annotatedElement=t.annotatedElement,n.container=t.container,n.location=t.location,n.hasAnnotations=Object.keys(t.annotations).length>0,n.canAnnotate=t.canAnnotate,n.locale=t.locale,n.isMobile=t.isMobile||!1,n.hasTouch=t.hasTouch||!1,n.keydownHandler=n.keydownHandler.bind(n),n.clickHandler=n.clickHandler.bind(n),n.stopPropagation=n.stopPropagation.bind(n),n.validateTextArea=n.validateTextArea.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),l(e,[{key:"destroy",value:function(){this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null)}},{key:"show",value:function(){if(this.isMobile)this.showMobileDialog();else if(this.element&&!this.element.classList.contains(a.O))return;var t=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(a.Wb);if(this.canAnnotate&&(t.classList.contains(a.c)&&this.element.parentNode))return r.M(this.element),void this.scrollToLastComment();this.isMobile||this.position(),this.scrollToLastComment(),this.emit("annotationshow")}},{key:"scrollToLastComment",value:function(){if(this.element){this.hasAnnotations&&this.activateReply();var t=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(a.Wb);r.l(t);var e=this.element.querySelector(a.Tb);if(e){var n=this.dialogEl.classList.contains(h)?0:e.clientHeight;e.scrollTop=e.scrollHeight-n}}}},{key:"showMobileDialog",value:function(){if(this.element=this.container.querySelector("."+a.W),this.element.classList.contains(a.O)){r.M(this.element),this.element.appendChild(this.dialogEl);var t=this.element.querySelectorAll(".annotation-comment");if(this.highlightDialogEl&&!t.length)this.element.classList.add(a.z),this.element.querySelector(a.ec).classList.add(a.O);this.element.classList.add(a.g),this.bindDOMListeners()}}},{key:"hideMobileDialog",value:function(){this.element&&(this.dialogEl&&this.dialogEl.parentNode&&this.dialogEl.parentNode.removeChild(this.dialogEl),r.x(this.element),this.unbindDOMListeners(),this.element=r.n())}},{key:"hide",value:function(){this.element&&this.element.classList.contains(a.O)||(this.isMobile&&this.hideMobileDialog(),r.x(this.element),this.deactivateReply(),this.emit("annotationhide"),this.toggleFlippedThreadEl())}},{key:"addAnnotation",value:function(t){if(!this.hasAnnotations){var e=this.element.querySelector(a.Gb),n=this.element.querySelector(a.Hb);r.x(e),r.M(n),this.hasAnnotations=!0}this.addAnnotationElement(t)}},{key:"removeAnnotation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');e&&e.parentNode.removeChild(e);var n=this.element.querySelector(".reply-textarea");n&&n.focus()}},{key:"postAnnotation",value:function(t){var e=this.element.querySelector(a.Wb),n=t||e.value;""!==n.trim()?(this.emit("annotationcreate",{text:n}),e.value=""):e.classList.add(a.U)}},{key:"position",value:function(){}},{key:"setup",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(this.threadEl=e,this.dialogEl=this.generateDialogEl(Object.keys(t).length),this.dialogEl.classList.add(a.n),!this.isMobile){this.element=document.createElement("div"),this.element.setAttribute("data-type",a.ib),this.element.classList.add(a.o),this.element.classList.add(a.O),this.element.innerHTML='<div class="'+a.l+'"></div>',this.element.appendChild(this.dialogEl);var n=r.r(t);n&&(this.element.dataset.threadNumber=n.threadNumber),this.bindDOMListeners()}this.addSortedAnnotations(t)}},{key:"addSortedAnnotations",value:function(t){var e=this,n=Object.keys(t).map(function(e){return t[e]});n.sort(function(t,e){return new Date(t.created)-new Date(e.created)}),n.forEach(function(t){e.addAnnotationElement(t)})}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("wheel",this.stopPropagation),this.element.addEventListener("mouseup",this.stopPropagation),this.hasTouch&&(this.element.addEventListener("touchstart",this.clickHandler),this.element.addEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.addEventListener("focus",this.validateTextArea);var e=this.element.querySelector(a.Wb);e&&e.addEventListener("focus",this.validateTextArea),this.isMobile||this.element.addEventListener("click",this.clickHandler)}},{key:"validateTextArea",value:function(t){var e=t.target;"textarea"===e.type&&""!==e.value.trim()&&e.classList.remove(a.U)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation),this.hasTouch&&(this.element.removeEventListener("touchstart",this.clickHandler),this.element.removeEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.removeEventListener("focus",this.validateTextArea);var e=this.element.querySelector(a.Wb);e&&e.removeEventListener("focus",this.validateTextArea),this.isMobile||(this.element.removeEventListener("click",this.clickHandler),this.element.removeEventListener("click",this.stopPropagation))}},{key:"enable",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');if(e){var n=e.querySelectorAll("button");Array.prototype.forEach.call(n,function(t){t.classList.remove(a.N)})}}},{key:"disable",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');if(e){var n=e.querySelectorAll("button");Array.prototype.forEach.call(n,function(t){t.classList.add(a.N)})}}},{key:"keydownHandler",value:function(t){(t.stopPropagation(),"Escape"===r.f(t))?this.hasAnnotations?this.hide():this.cancelAnnotation():"reply-textarea"===r.j(t.target)&&this.scrollToLastComment()}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"clickHandler",value:function(t){t.stopPropagation(),this.isMobile&&t.target&&"BUTTON"===t.target.nodeName&&t.preventDefault();var e=t.target,n=r.j(e),i=r.j(e,"data-annotation-id");switch(n){case a.rb:this.postAnnotation();break;case a.kb:case a.qb:this.hide(),this.isMobile||this.cancelAnnotation();break;case a.tb:this.activateReply();break;case a.mb:this.deactivateReply(!0);break;case a.sb:this.postReply();break;case a.ob:this.showDeleteConfirmation(i);break;case a.lb:this.hideDeleteConfirmation(i);break;case a.nb:this.deleteAnnotation(i)}}},{key:"addAnnotationElement",value:function(t){var e=r.y(t.user.id||"0"),n=void 0;n="0"===e?this.localized.posting:r.y(t.user.name)||this.localized.anonymousUserName;var i=r.y(t.user.avatarUrl||""),o=r.o(i,e,n,this.localized.profileAlt),l=new Date(t.created).toLocaleString(this.locale,{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),h=r.d(t.text),c=document.createElement("div");c.classList.add("annotation-comment"),c.setAttribute("data-annotation-id",t.annotationID),this.dialogEl.querySelector(".annotation-comments").appendChild(c);var u=document.createElement("div");u.classList.add(a.bb),u.innerHTML=o,c.appendChild(u);var d=document.createElement("div");d.classList.add(a.ab),c.appendChild(d);var f=document.createElement("div");f.classList.add(a.eb),f.textContent=n,d.appendChild(f);var p=document.createElement("div");p.classList.add(a.I),p.textContent=l,d.appendChild(p);var g=document.createElement("div");if(g.appendChild(h),c.appendChild(g),t.permissions.can_delete){var m=r.m([a.G,"delete-comment-btn"],this.localized.deleteButton,s.b,a.ob);c.appendChild(m);var v=document.createElement("div");v.classList.add("delete-confirmation"),v.classList.add(a.O),c.appendChild(v);var y=document.createElement("div");y.classList.add(a.K),y.textContent=this.localized.deleteConfirmation,v.appendChild(y);var b=document.createElement("div");b.classList.add(a.F),v.appendChild(b);var E=r.m([a.E,"cancel-delete-btn"],this.localized.cancelButton,this.localized.cancelButton,a.lb);b.appendChild(E);var w=r.m([a.E,"confirm-delete-btn",a.H],this.localized.deleteButton,this.localized.deleteButton,a.nb);b.appendChild(w)}}},{key:"cancelAnnotation",value:function(){this.emit("annotationcancel")}},{key:"activateReply",value:function(){if(this.dialogEl){var t=this.dialogEl.querySelector(".reply-textarea");if(t){var e=t.classList.contains(a.c);if(t.classList.remove(a.U),!e){var n=t.parentNode.querySelector(a.Zb);t.classList.add(a.c),r.M(n)}}}}},{key:"deactivateReply",value:function(t){if(this.dialogEl){var e=this.dialogEl.querySelector(".reply-container");if(e){var n=e.querySelector(".reply-textarea"),i=e.querySelector(a.Zb);r.K(n,t),r.x(i)}}}},{key:"postReply",value:function(){var t=this.element.querySelector(".reply-textarea"),e=t.value;""!==e.trim()?(this.emit("annotationcreate",{text:e}),t.value="",t.focus()):t.classList.add(a.U)}},{key:"showDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),n=e.querySelector(".delete-confirmation"),i=e.querySelector(".cancel-delete-btn"),o=e.querySelector(a.ac);r.x(o),r.M(n),i.focus()}},{key:"hideDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),n=e.querySelector(".delete-confirmation"),i=e.querySelector(a.ac);r.M(i),r.x(n),i.focus()}},{key:"deleteAnnotation",value:function(t){this.emit("annotationdelete",{annotationID:t})}},{key:"generateDialogEl",value:function(t){var e=document.createElement("div");if(this.canAnnotate){var n=document.createElement("section");n.setAttribute("data-section","create"),t&&n.classList.add(a.O),e.appendChild(n);var i=document.createElement("textarea");i.classList.add(a.cb),i.classList.add(a.C),i.placeholder=this.localized.addCommentPlaceholder,n.appendChild(i);var o=document.createElement("div");o.classList.add(a.F),n.appendChild(o);var s=r.m([a.E,a.j],this.localized.cancelButton,this.localized.cancelButton,a.kb);o.appendChild(s);var l=r.m([a.E,a.H,a.k],this.localized.postButton,this.localized.postButton,a.rb);o.appendChild(l)}var h=document.createElement("section");h.setAttribute("data-section","show"),t||h.classList.add(a.O),e.appendChild(h);var c=document.createElement("div");if(c.classList.add("annotation-comments"),h.appendChild(c),this.canAnnotate){var u=document.createElement("div");u.classList.add("reply-container"),h.appendChild(u);var d=document.createElement("textarea");d.classList.add(a.cb),d.classList.add(a.C),d.classList.add("reply-textarea"),d.placeholder=this.localized.replyPlaceholder,d.setAttribute("data-type",a.tb),u.appendChild(d);var f=document.createElement("div");f.classList.add(a.F),f.classList.add(a.O),u.appendChild(f);var p=r.m([a.E,a.j],this.localized.cancelButton,this.localized.cancelButton,a.mb);f.appendChild(p);var g=r.m([a.E,a.H,a.k],this.localized.postButton,this.localized.postButton,a.sb);f.appendChild(g)}return e}},{key:"flipDialog",value:function(t,e){var n="",i="",o=this.element.querySelector(a.Sb);t<=e/2?(n=t-8+"px",i="",this.element.classList.remove(h),o.style.bottom=""):(n="",i=e-t-27+"px",this.element.classList.add(h),o.style.top="",o.style.bottom="0px");return this.fitDialogHeightInPage(),this.toggleFlippedThreadEl(),{top:n,bottom:i}}},{key:"toggleFlippedThreadEl",value:function(){this.element&&this.threadEl&&(this.element.classList.contains(h)&&(this.element.classList.contains(a.O)?this.threadEl.classList.remove(h):this.threadEl.classList.add(h)))}},{key:"fitDialogHeightInPage",value:function(){var t=this.container.clientHeight/2-a.Bb-a.Ab;this.dialogEl.style.maxHeight=t+"px";var e=this.dialogEl.querySelector("."+a.n);e&&(e.style.maxHeight=t+"px")}}]),e}();e.a=c},function(t,e,n){"use strict";n(13);var i=n(3),o=n.n(i),r=n(10),a=n(1),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var l=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.api=t.apiHost,n.fileId=t.fileId,n.headers=Object(a.s)({},t.token),n.canAnnotate=t.canAnnotate,n.user={id:"0",name:n.anonymousUserName},n.createThreadMap=n.createThreadMap.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),s(e,null,[{key:"generateID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}}]),s(e,[{key:"create",value:function(t){var e=this;return new Promise(function(n,i){fetch(e.api+"/2.0/annotations",{method:"POST",headers:e.headers,body:JSON.stringify({item:{type:"file_version",id:t.fileVersionId},details:{type:t.type,drawingPaths:t.drawingPaths,location:t.location,threadID:t.threadID},message:t.text,thread:t.threadNumber})}).then(function(t){return t.json()}).then(function(t){if("error"!==t.type&&t.id){var o=t;o.permissions={can_edit:!0,can_delete:!0};var r=e.createAnnotation(o);"0"===e.user.id&&(e.user=r.user),n(r)}else{var a=new Error("Could not create annotation");i(a),e.emit("annotationerror",{reason:"create",error:a.toString()})}}).catch(function(t){i(new Error("Could not create annotation due to invalid or expired token")),e.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"read",value:function(t){this.annotations={};var e=void 0,n=void 0,i=new Promise(function(t,i){e=t,n=i});return this.readFromMarker(e,n,t),i}},{key:"delete",value:function(t){var e=this;return new Promise(function(n,i){fetch(e.api+"/2.0/annotations/"+t,{method:"DELETE",headers:e.headers}).then(function(o){if(204===o.status)n();else{var r=new Error("Could not delete annotation with ID "+t);i(r),e.emit("annotationerror",{reason:"delete",error:r.toString()})}}).catch(function(t){i(new Error("Could not delete annotation due to invalid or expired token")),e.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"getThreadMap",value:function(t){return this.read(t).then(this.createThreadMap)}},{key:"createThreadMap",value:function(t){var e={};return this.annotations=t,Object.keys(t).forEach(function(n){var i=t[n],o=i.threadID,r=e[o]||[];e[o]=r,r[i.annotationID]=i}),e}},{key:"createAnnotation",value:function(t){return new r.a({annotationID:t.id,fileVersionId:t.item.id,threadID:t.details.threadID,type:t.details.type,threadNumber:t.thread,text:t.message,location:t.details.location,user:{id:t.created_by.id,name:t.created_by.name,avatarUrl:t.created_by.profile_image},permissions:t.permissions,created:t.created_at,modified:t.modified_at})}},{key:"getReadUrl",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=this.api+"/2.0/files/"+this.fileId+"/annotations?version="+t+"&fields=item,thread,details,message,created_by,created_at,modified_at,permissions";return e&&(i+="&marker="+e),n&&(i+="&limit="+n),i}},{key:"readFromMarker",value:function(t,e,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;fetch(this.getReadUrl(n,o,r),{headers:this.headers}).then(function(t){return t.json()}).then(function(o){if("error"!==o.type&&Array.isArray(o.entries))o.entries.forEach(function(t){var e=i.createAnnotation(t);i.annotations[e.annotationID]=e}),o.next_marker?i.readFromMarker(t,e,n,o.next_marker,r):t(i.annotations);else{var a=new Error("Could not read annotations from file version with ID "+n);e(a),i.emit("annotationerror",{reason:"read",error:a.toString()})}}).catch(function(t){e(new Error("Could not read annotations from file due to invalid or expired token")),i.emit("annotationerror",{reason:"authorization",error:t.toString()})})}}]),e}();e.a=l},function(t,e,n){var i,o;void 0===(o="function"==typeof(i=function(){var t="object",e="function",n="undefined",i=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],o=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],r=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],a=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function s(n,i){var o=typeof n[i];return o==e||!(o!=t||!n[i])||"unknown"==o}function l(e,n){return!(typeof e[n]!=t||!e[n])}function h(t,e){return typeof t[e]!=n}function c(t){return function(e,n){for(var i=n.length;i--;)if(!t(e,n[i]))return!1;return!0}}var u=c(s),d=c(l),f=c(h);function p(t){return t&&u(t,a)&&f(t,r)}function g(t){return l(t,"body")?t.body:t.getElementsByTagName("body")[0]}var m,v,y={},b=typeof window!=n&&typeof document!=n,E={isHostMethod:s,isHostObject:l,isHostProperty:h,areHostMethods:u,areHostObjects:d,areHostProperties:f,isTextRange:p,getBody:g,forEach:[].forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=0,i=t.length;n<i;++n)e(t[n],n)}},w={version:"1.3.0",initialized:!1,isBrowser:b,supported:!0,util:E,features:{},modules:y,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==n||rangyAutoInitialize}};function C(t){typeof console!=n&&s(console,"log")}function O(t,e){b&&e?alert(t):C()}function x(t){w.initialized=!0,w.supported=!1,O("Rangy is not supported in this environment. Reason: "+t,w.config.alertOnFail)}w.fail=x,w.warn=function(t){O("Rangy warning: "+t,w.config.alertOnWarn)},{}.hasOwnProperty?(E.extend=m=function(t,e,n){var i,o;for(var r in e)e.hasOwnProperty(r)&&(i=t[r],o=e[r],n&&null!==i&&"object"==typeof i&&null!==o&&"object"==typeof o&&m(i,o,!0),t[r]=o);return e.hasOwnProperty("toString")&&(t.toString=e.toString),t},E.createOptions=function(t,e){var n={};return m(n,e),t&&m(n,t),n}):x("hasOwnProperty not supported"),b||x("Rangy can only run in a browser"),function(){var t;if(b){var e=document.createElement("div");e.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(t){return n.call(t,0)})}catch(t){}}t||(t=function(t){for(var e=[],n=0,i=t.length;n<i;++n)e[n]=t[n];return e}),E.toArray=t}(),b&&(s(document,"addEventListener")?v=function(t,e,n){t.addEventListener(e,n,!1)}:s(document,"attachEvent")?v=function(t,e,n){t.attachEvent("on"+e,n)}:x("Document does not have required addEventListener or attachEvent method"),E.addListener=v);var T=[];function _(t){return t.message||t.description||String(t)}function S(){if(b&&!w.initialized){var t,e=!1,n=!1;s(document,"createRange")&&(t=document.createRange(),u(t,o)&&f(t,i)&&(e=!0));var r=g(document);if(r&&"body"==r.nodeName.toLowerCase())if(r&&s(r,"createTextRange")&&p(t=r.createTextRange())&&(n=!0),e||n){var a;for(var l in w.initialized=!0,w.features={implementsDomRange:e,implementsTextRange:n},y)(a=y[l])instanceof D&&a.init(a,w);for(var h=0,c=T.length;h<c;++h)try{T[h](w)}catch(t){C(_(t))}}else x("Neither Range nor TextRange are available");else x("No body element found")}}function k(t,e,n){n&&(t+=" in module "+n.name),w.warn("DEPRECATED: "+t+" is deprecated. Please use "+e+" instead.")}function A(t,e,n,i){t[e]=function(){return k(e,n,i),t[n].apply(t,E.toArray(arguments))}}E.deprecationNotice=k,E.createAliasForDeprecatedMethod=A,w.init=S,w.addInitListener=function(t){w.initialized?t(w):T.push(t)};var R=[];function D(t,e,n){this.name=t,this.dependencies=e,this.initialized=!1,this.supported=!1,this.initializer=n}function P(t,e,n){var i=new D(t,e,function(t){if(!t.initialized){t.initialized=!0;try{n(w,t),t.supported=!0}catch(t){_(t);C(),t.stack&&C(t.stack)}}});return y[t]=i,i}function L(){}w.addShimListener=function(t){R.push(t)},b&&(w.shim=w.createMissingNativeApi=function(t){t=t||window,S();for(var e=0,n=R.length;e<n;++e)R[e](t)},A(w,"createMissingNativeApi","shim")),D.prototype={init:function(){for(var t,e,n=this.dependencies||[],i=0,o=n.length;i<o;++i){if(e=n[i],!((t=y[e])&&t instanceof D))throw new Error("required module '"+e+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+e+"' not supported")}this.initializer(this)},fail:function(t){throw this.initialized=!0,this.supported=!1,new Error(t)},warn:function(t){w.warn("Module "+this.name+": "+t)},deprecationNotice:function(t,e){w.warn("DEPRECATED: "+t+" in module "+this.name+" is deprecated. Please use "+e+" instead")},createError:function(t){return new Error("Error in Rangy "+this.name+" module: "+t)}},w.createModule=function(t){var e,n;2==arguments.length?(e=arguments[1],n=[]):(e=arguments[2],n=arguments[1]);var i=P(t,n,e);w.initialized&&w.supported&&i.init()},w.createCoreModule=function(t,e,n){P(t,e,n)},w.RangePrototype=L,w.rangePrototype=new L,w.selectionPrototype=new function(){},w.createCoreModule("DomUtil",[],function(t,e){var n="undefined",i=t.util,o=i.getBody;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||e.fail("document missing a Node creation method"),i.isHostMethod(document,"getElementsByTagName")||e.fail("document missing getElementsByTagName method");var r=document.createElement("div");i.areHostMethods(r,["insertBefore","appendChild","cloneNode"]||!i.areHostObjects(r,["previousSibling","nextSibling","childNodes","parentNode"]))||e.fail("Incomplete Element implementation"),i.isHostProperty(r,"innerHTML")||e.fail("Element is missing innerHTML property");var a=document.createTextNode("test");i.areHostMethods(a,["splitText","deleteData","insertData","appendData","cloneNode"]||!i.areHostObjects(r,["previousSibling","nextSibling","childNodes","parentNode"])||!i.areHostProperties(a,["data"]))||e.fail("Incomplete Text Node implementation");var s=function(t,e){for(var n=t.length;n--;)if(t[n]===e)return!0;return!1};function l(t){for(var e=0;t=t.previousSibling;)++e;return e}function h(t,e){var n,i=[];for(n=t;n;n=n.parentNode)i.push(n);for(n=e;n;n=n.parentNode)if(s(i,n))return n;return null}function c(t,e,n){for(var i=n?e:e.parentNode;i;){if(i===t)return!0;i=i.parentNode}return!1}function u(t,e,n){for(var i,o=n?t:t.parentNode;o;){if((i=o.parentNode)===e)return o;o=i}return null}function d(t){var e=t.nodeType;return 3==e||4==e||8==e}function f(t,e){var n=e.nextSibling,i=e.parentNode;return n?i.insertBefore(t,n):i.appendChild(t),t}function p(t){if(9==t.nodeType)return t;if(typeof t.ownerDocument!=n)return t.ownerDocument;if(typeof t.document!=n)return t.document;if(t.parentNode)return p(t.parentNode);throw e.createError("getDocument: no document found for node")}function g(t){var i=p(t);if(typeof i.defaultView!=n)return i.defaultView;if(typeof i.parentWindow!=n)return i.parentWindow;throw e.createError("Cannot get a window object for node")}function m(t){if(typeof t.contentDocument!=n)return t.contentDocument;if(typeof t.contentWindow!=n)return t.contentWindow.document;throw e.createError("getIframeDocument: No Document object found for iframe element")}function v(t){return t&&i.isHostMethod(t,"setTimeout")&&i.isHostObject(t,"document")}var y,b=!1;function E(t){try{return t.parentNode,!1}catch(t){return!0}}function w(t){if(!t)return"[No node]";if(b&&E(t))return"[Broken node]";if(d(t))return'"'+t.data+'"';if(1==t.nodeType){var e=t.id?' id="'+t.id+'"':"";return"<"+t.nodeName+e+">[index:"+l(t)+",length:"+t.childNodes.length+"]["+(t.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return t.nodeName}function C(t){this.root=t,this._next=t}function O(t,e){this.node=t,this.offset=e}function x(t){this.code=this[t],this.codeName=t,this.message="DOMException: "+this.codeName}!function(){var e=document.createElement("b");e.innerHTML="1";var n=e.firstChild;e.innerHTML="<br />",b=E(n),t.features.crashyTextNodes=b}(),typeof window.getComputedStyle!=n?y=function(t,e){return g(t).getComputedStyle(t,null)[e]}:typeof document.documentElement.currentStyle!=n?y=function(t,e){return t.currentStyle?t.currentStyle[e]:""}:e.fail("No means of obtaining computed style properties found"),C.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var t,e,n=this._current=this._next;if(this._current)if(t=n.firstChild)this._next=t;else{for(e=null;n!==this.root&&!(e=n.nextSibling);)n=n.parentNode;this._next=e}return this._current},detach:function(){this._current=this._next=this.root=null}},O.prototype={equals:function(t){return!!t&&this.node===t.node&&this.offset==t.offset},inspect:function(){return"[DomPosition("+w(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},x.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},x.prototype.toString=function(){return this.message},t.dom={arrayContains:s,isHtmlNamespace:function(t){var e;return typeof t.namespaceURI==n||null===(e=t.namespaceURI)||"http://www.w3.org/1999/xhtml"==e},parentElement:function(t){var e=t.parentNode;return 1==e.nodeType?e:null},getNodeIndex:l,getNodeLength:function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},getCommonAncestor:h,isAncestorOf:c,isOrIsAncestorOf:function(t,e){return c(t,e,!0)},getClosestAncestorIn:u,isCharacterDataNode:d,isTextOrCommentNode:function(t){if(!t)return!1;var e=t.nodeType;return 3==e||8==e},insertAfter:f,splitDataNode:function(t,e,n){var i=t.cloneNode(!1);if(i.deleteData(0,e),t.deleteData(e,t.length-e),f(i,t),n)for(var o,r=0;o=n[r++];)o.node==t&&o.offset>e?(o.node=i,o.offset-=e):o.node==t.parentNode&&o.offset>l(t)&&++o.offset;return i},getDocument:p,getWindow:g,getIframeWindow:function(t){if(typeof t.contentWindow!=n)return t.contentWindow;if(typeof t.contentDocument!=n)return t.contentDocument.defaultView;throw e.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:m,getBody:o,isWindow:v,getContentDocument:function(t,e,n){var o;if(t?i.isHostProperty(t,"nodeType")?o=1==t.nodeType&&"iframe"==t.tagName.toLowerCase()?m(t):p(t):v(t)&&(o=t.document):o=document,!o)throw e.createError(n+"(): Parameter must be a Window object or DOM node");return o},getRootContainer:function(t){for(var e;e=t.parentNode;)t=e;return t},comparePoints:function(t,n,i,o){var r,a,s,c,d;if(t==i)return n===o?0:n<o?-1:1;if(r=u(i,t,!0))return n<=l(r)?-1:1;if(r=u(t,i,!0))return l(r)<o?-1:1;if(!(a=h(t,i)))throw new Error("comparePoints error: nodes have no common ancestor");if(s=t===a?a:u(t,a,!0),c=i===a?a:u(i,a,!0),s===c)throw e.createError("comparePoints got to case 4 and childA and childB are the same!");for(d=a.firstChild;d;){if(d===s)return-1;if(d===c)return 1;d=d.nextSibling}},isBrokenNode:E,inspectNode:w,getComputedStyleProperty:y,createTestElement:function(t,e,n){var i=o(t),r=t.createElement("div");r.contentEditable=""+!!n,e&&(r.innerHTML=e);var a=i.firstChild;return a?i.insertBefore(r,a):i.appendChild(r),r},removeNode:function(t){return t.parentNode.removeChild(t)},fragmentFromNodeChildren:function(t){for(var e,n=p(t).createDocumentFragment();e=t.firstChild;)n.appendChild(e);return n},createIterator:function(t){return new C(t)},DomPosition:O},t.DOMException=x}),w.createCoreModule("DomRange",["DomUtil"],function(t,e){var n=t.dom,i=t.util,o=n.DomPosition,r=t.DOMException,a=n.isCharacterDataNode,s=n.getNodeIndex,l=n.isOrIsAncestorOf,h=n.getDocument,c=n.comparePoints,u=n.splitDataNode,d=n.getClosestAncestorIn,f=n.getNodeLength,p=n.arrayContains,g=n.getRootContainer,m=t.features.crashyTextNodes,v=n.removeNode;function y(t,e){return 3!=t.nodeType&&(l(t,e.startContainer)||l(t,e.endContainer))}function b(t){return t.document||h(t.startContainer)}function E(t){return new o(t.parentNode,s(t))}function w(t){return new o(t.parentNode,s(t)+1)}function C(t,e,i){var o=11==t.nodeType?t.firstChild:t;return a(e)?i==e.length?n.insertAfter(t,e):e.parentNode.insertBefore(t,0==i?e:u(e,i)):i>=e.childNodes.length?e.appendChild(t):e.insertBefore(t,e.childNodes[i]),o}function O(t,e,n){if(W(t),W(e),b(e)!=b(t))throw new r("WRONG_DOCUMENT_ERR");var i=c(t.startContainer,t.startOffset,e.endContainer,e.endOffset),o=c(t.endContainer,t.endOffset,e.startContainer,e.startOffset);return n?i<=0&&o>=0:i<0&&o>0}function x(t,e,i){var o,r,a,s;for(i=i||{stop:!1};a=t.next();)if(t.isPartiallySelectedSubtree()){if(!1===e(a))return void(i.stop=!0);if(x(s=t.getSubtreeIterator(),e,i),s.detach(),i.stop)return}else for(o=n.createIterator(a);r=o.next();)if(!1===e(r))return void(i.stop=!0)}function T(t){for(var e;t.next();)t.isPartiallySelectedSubtree()?(T(e=t.getSubtreeIterator()),e.detach()):t.remove()}function _(t){for(var e,n,i=b(t.range).createDocumentFragment();e=t.next();){if(t.isPartiallySelectedSubtree()?(e=e.cloneNode(!1),n=t.getSubtreeIterator(),e.appendChild(_(n)),n.detach()):t.remove(),10==e.nodeType)throw new r("HIERARCHY_REQUEST_ERR");i.appendChild(e)}return i}function S(t){var e=void 0===t.getName?"Range":t.getName();return"["+e+"("+n.inspectNode(t.startContainer)+":"+t.startOffset+", "+n.inspectNode(t.endContainer)+":"+t.endOffset+")]"}function k(t,e){if(this.range=t,this.clonePartiallySelectedTextNodes=e,!t.collapsed){this.sc=t.startContainer,this.so=t.startOffset,this.ec=t.endContainer,this.eo=t.endOffset;var n=t.commonAncestorContainer;this.sc===this.ec&&a(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||a(this.sc)?d(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||a(this.ec)?d(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}k.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var t=this._current=this._next;return t&&(this._next=t!==this._last?t.nextSibling:null,a(t)&&this.clonePartiallySelectedTextNodes&&(t===this.ec&&(t=t.cloneNode(!0)).deleteData(this.eo,t.length-this.eo),this._current===this.sc&&(t=t.cloneNode(!0)).deleteData(0,this.so))),t},remove:function(){var t,e,n=this._current;!a(n)||n!==this.sc&&n!==this.ec?n.parentNode&&v(n):(t=n===this.sc?this.so:0,e=n===this.ec?this.eo:n.length,t!=e&&n.deleteData(t,e-t))},isPartiallySelectedSubtree:function(){var t=this._current;return y(t,this.range)},getSubtreeIterator:function(){var t;if(this.isSingleCharacterDataNode)(t=this.range.cloneRange()).collapse(!1);else{t=new dt(b(this.range));var e=this._current,n=e,i=0,o=e,r=f(e);l(e,this.sc)&&(n=this.sc,i=this.so),l(e,this.ec)&&(o=this.ec,r=this.eo),ut(t,n,i,o,r)}return new k(t,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var A=[1,3,4,5,7,8,10],R=[2,9,11],D=[1,3,4,5,7,8,10,11],P=[1,3,4,5,7,8];function L(t){return function(e,n){for(var i,o=n?e:e.parentNode;o;){if(i=o.nodeType,p(t,i))return o;o=o.parentNode}return null}}var N=L([9,11]),M=L([5,6,10,12]),B=L([6,10,12]);function j(t,e){if(B(t,e))throw new r("INVALID_NODE_TYPE_ERR")}function H(t,e){if(!p(e,t.nodeType))throw new r("INVALID_NODE_TYPE_ERR")}function I(t,e){if(e<0||e>(a(t)?t.length:t.childNodes.length))throw new r("INDEX_SIZE_ERR")}function F(t,e){if(N(t,!0)!==N(e,!0))throw new r("WRONG_DOCUMENT_ERR")}function q(t){if(M(t,!0))throw new r("NO_MODIFICATION_ALLOWED_ERR")}function z(t,e){if(!t)throw new r(e)}function Y(t,e){return e<=(a(t)?t.length:t.childNodes.length)}function X(t){return!!t.startContainer&&!!t.endContainer&&!(m&&(n.isBrokenNode(t.startContainer)||n.isBrokenNode(t.endContainer)))&&g(t.startContainer)==g(t.endContainer)&&Y(t.startContainer,t.startOffset)&&Y(t.endContainer,t.endOffset)}function W(t){if(!X(t))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+t.inspect()+")")}var U=document.createElement("style"),V=!1;try{U.innerHTML="<b>x</b>",V=3==U.firstChild.nodeType}catch(t){}t.features.htmlParsingConforms=V;var G=V?function(t){var e=this.startContainer,i=h(e);if(!e)throw new r("INVALID_STATE_ERR");var o=null;return 1==e.nodeType?o=e:a(e)&&(o=n.parentElement(e)),(o=null===o||"HTML"==o.nodeName&&n.isHtmlNamespace(h(o).documentElement)&&n.isHtmlNamespace(o)?i.createElement("body"):o.cloneNode(!1)).innerHTML=t,n.fragmentFromNodeChildren(o)}:function(t){var e=b(this),i=e.createElement("body");return i.innerHTML=t,n.fragmentFromNodeChildren(i)};function J(t,e){W(t);var n=t.startContainer,i=t.startOffset,o=t.endContainer,r=t.endOffset,l=n===o;a(o)&&r>0&&r<o.length&&u(o,r,e),a(n)&&i>0&&i<n.length&&(n=u(n,i,e),l?(r-=i,o=n):o==n.parentNode&&r>=s(n)&&r++,i=0),t.setStartAndEnd(n,i,o,r)}function $(t){W(t);var e=t.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(t.cloneContents()),e.innerHTML}var Q=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],K=0,Z=1,tt=2,et=3,nt=0,it=1,ot=2,rt=3;function at(t){t.START_TO_START=K,t.START_TO_END=Z,t.END_TO_END=tt,t.END_TO_START=et,t.NODE_BEFORE=nt,t.NODE_AFTER=it,t.NODE_BEFORE_AND_AFTER=ot,t.NODE_INSIDE=rt}function st(t){at(t),at(t.prototype)}function lt(t,e){return function(){W(this);var n,i,o=this.startContainer,r=this.startOffset,a=this.commonAncestorContainer,s=new k(this,!0);o!==a&&(n=d(o,a,!0),i=w(n),o=i.node,r=i.offset),x(s,q),s.reset();var l=t(s);return s.detach(),e(this,o,r,o,r),l}}function ht(e,n){function o(t,e){return function(n){H(n,A),H(g(n),R);var i=(t?E:w)(n);(e?r:l)(this,i.node,i.offset)}}function r(t,e,i){var o=t.endContainer,r=t.endOffset;e===t.startContainer&&i===t.startOffset||(g(e)==g(o)&&1!=c(e,i,o,r)||(o=e,r=i),n(t,e,i,o,r))}function l(t,e,i){var o=t.startContainer,r=t.startOffset;e===t.endContainer&&i===t.endOffset||(g(e)==g(o)&&-1!=c(e,i,o,r)||(o=e,r=i),n(t,o,r,e,i))}var h=function(){};h.prototype=t.rangePrototype,e.prototype=new h,i.extend(e.prototype,{setStart:function(t,e){j(t,!0),I(t,e),r(this,t,e)},setEnd:function(t,e){j(t,!0),I(t,e),l(this,t,e)},setStartAndEnd:function(){var t=arguments,e=t[0],i=t[1],o=e,r=i;switch(t.length){case 3:r=t[2];break;case 4:o=t[2],r=t[3]}n(this,e,i,o,r)},setBoundary:function(t,e,n){this["set"+(n?"Start":"End")](t,e)},setStartBefore:o(!0,!0),setStartAfter:o(!1,!0),setEndBefore:o(!0,!1),setEndAfter:o(!1,!1),collapse:function(t){W(this),t?n(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):n(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(t){j(t,!0),n(this,t,0,t,f(t))},selectNode:function(t){j(t,!1),H(t,A);var e=E(t),i=w(t);n(this,e.node,e.offset,i.node,i.offset)},extractContents:lt(_,n),deleteContents:lt(T,n),canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&y(t._first,this)||t._last&&y(t._last,this);return t.detach(),!e},splitBoundaries:function(){J(this)},splitBoundariesPreservingPositions:function(t){J(this,t)},normalizeBoundaries:function(){W(this);var t,e=this.startContainer,i=this.startOffset,o=this.endContainer,r=this.endOffset,l=function(t){var e=t.nextSibling;e&&e.nodeType==t.nodeType&&(o=t,r=t.length,t.appendData(e.data),v(e))},h=function(t){var n=t.previousSibling;if(n&&n.nodeType==t.nodeType){e=t;var a=t.length;if(i=n.length,t.insertData(0,n.data),v(n),e==o)r+=i,o=e;else if(o==t.parentNode){var l=s(t);r==l?(o=t,r=a):r>l&&r--}}},c=!0;if(a(o))r==o.length?l(o):0==r&&(t=o.previousSibling)&&t.nodeType==o.nodeType&&(r=t.length,e==o&&(c=!1),t.appendData(o.data),v(o),o=t);else{if(r>0){var u=o.childNodes[r-1];u&&a(u)&&l(u)}c=!this.collapsed}if(c){if(a(e))0==i?h(e):i==e.length&&(t=e.nextSibling)&&t.nodeType==e.nodeType&&(o==t&&(o=e,r+=e.length),e.appendData(t.data),v(t));else if(i<e.childNodes.length){var d=e.childNodes[i];d&&a(d)&&h(d)}}else e=o,i=r;n(this,e,i,o,r)},collapseToPoint:function(t,e){j(t,!0),I(t,e),this.setStartAndEnd(t,e)}}),st(e)}function ct(t){t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset,t.commonAncestorContainer=t.collapsed?t.startContainer:n.getCommonAncestor(t.startContainer,t.endContainer)}function ut(t,e,i,o,r){t.startContainer=e,t.startOffset=i,t.endContainer=o,t.endOffset=r,t.document=n.getDocument(e),ct(t)}function dt(t){this.startContainer=t,this.startOffset=0,this.endContainer=t,this.endOffset=0,this.document=t,ct(this)}i.extend(t.rangePrototype,{compareBoundaryPoints:function(t,e){var n,i,o,r;W(this),F(this.startContainer,e.startContainer);var a=t==et||t==K?"start":"end",s=t==Z||t==K?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],o=e[s+"Container"],r=e[s+"Offset"],c(n,i,o,r)},insertNode:function(t){if(W(this),H(t,D),q(this.startContainer),l(t,this.startContainer))throw new r("HIERARCHY_REQUEST_ERR");var e=C(t,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){var t,e;if(W(this),this.collapsed)return b(this).createDocumentFragment();if(this.startContainer===this.endContainer&&a(this.startContainer))return(t=this.startContainer.cloneNode(!0)).data=t.data.slice(this.startOffset,this.endOffset),(e=b(this).createDocumentFragment()).appendChild(t),e;var n=new k(this,!0);return t=function t(e){for(var n,i,o,a=b(e.range).createDocumentFragment();i=e.next();){if(n=e.isPartiallySelectedSubtree(),i=i.cloneNode(!n),n&&(o=e.getSubtreeIterator(),i.appendChild(t(o)),o.detach()),10==i.nodeType)throw new r("HIERARCHY_REQUEST_ERR");a.appendChild(i)}return a}(n),n.detach(),t},canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&y(t._first,this)||t._last&&y(t._last,this);return t.detach(),!e},surroundContents:function(t){if(H(t,P),!this.canSurroundContents())throw new r("INVALID_STATE_ERR");var e=this.extractContents();if(t.hasChildNodes())for(;t.lastChild;)t.removeChild(t.lastChild);C(t,this.startContainer,this.startOffset),t.appendChild(e),this.selectNode(t)},cloneRange:function(){W(this);for(var t,e=new dt(b(this)),n=Q.length;n--;)e[t=Q[n]]=this[t];return e},toString:function(){W(this);var t=this.startContainer;if(t===this.endContainer&&a(t))return 3==t.nodeType||4==t.nodeType?t.data.slice(this.startOffset,this.endOffset):"";var e=[],n=new k(this,!0);return x(n,function(t){3!=t.nodeType&&4!=t.nodeType||e.push(t.data)}),n.detach(),e.join("")},compareNode:function(t){W(this);var e=t.parentNode,n=s(t);if(!e)throw new r("NOT_FOUND_ERR");var i=this.comparePoint(e,n),o=this.comparePoint(e,n+1);return i<0?o>0?ot:nt:o>0?it:rt},comparePoint:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),c(t,e,this.startContainer,this.startOffset)<0?-1:c(t,e,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:G,toHtml:function(){return $(this)},intersectsNode:function(t,e){if(W(this),g(t)!=g(this.startContainer))return!1;var n=t.parentNode,i=s(t);if(!n)return!0;var o=c(n,i,this.endContainer,this.endOffset),r=c(n,i+1,this.startContainer,this.startOffset);return e?o<=0&&r>=0:o<0&&r>0},isPointInRange:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),c(t,e,this.startContainer,this.startOffset)>=0&&c(t,e,this.endContainer,this.endOffset)<=0},intersectsRange:function(t){return O(this,t,!1)},intersectsOrTouchesRange:function(t){return O(this,t,!0)},intersection:function(t){if(this.intersectsRange(t)){var e=c(this.startContainer,this.startOffset,t.startContainer,t.startOffset),n=c(this.endContainer,this.endOffset,t.endContainer,t.endOffset),i=this.cloneRange();return-1==e&&i.setStart(t.startContainer,t.startOffset),1==n&&i.setEnd(t.endContainer,t.endOffset),i}return null},union:function(t){if(this.intersectsOrTouchesRange(t)){var e=this.cloneRange();return-1==c(t.startContainer,t.startOffset,this.startContainer,this.startOffset)&&e.setStart(t.startContainer,t.startOffset),1==c(t.endContainer,t.endOffset,this.endContainer,this.endOffset)&&e.setEnd(t.endContainer,t.endOffset),e}throw new r("Ranges do not intersect")},containsNode:function(t,e){return e?this.intersectsNode(t,!1):this.compareNode(t)==rt},containsNodeContents:function(t){return this.comparePoint(t,0)>=0&&this.comparePoint(t,f(t))<=0},containsRange:function(t){var e=this.intersection(t);return null!==e&&t.equals(e)},containsNodeText:function(t){var e=this.cloneRange();e.selectNode(t);var n=e.getNodes([3]);if(n.length>0){e.setStart(n[0],0);var i=n.pop();return e.setEnd(i,i.length),this.containsRange(e)}return this.containsNodeContents(t)},getNodes:function(t,e){return W(this),function(t,e,n){var i,o=!(!e||!e.length),r=!!n;o&&(i=new RegExp("^("+e.join("|")+")$"));var s=[];return x(new k(t,!1),function(e){if((!o||i.test(e.nodeType))&&(!r||n(e))){var l=t.startContainer;if(e!=l||!a(l)||t.startOffset!=l.length){var h=t.endContainer;e==h&&a(h)&&0==t.endOffset||s.push(e)}}}),s}(this,t,e)},getDocument:function(){return b(this)},collapseBefore:function(t){this.setEndBefore(t),this.collapse(!1)},collapseAfter:function(t){this.setStartAfter(t),this.collapse(!0)},getBookmark:function(e){var i=b(this),o=t.createRange(i);e=e||n.getBody(i),o.selectNodeContents(e);var r=this.intersection(o),a=0,s=0;return r&&(o.setEnd(r.startContainer,r.startOffset),a=o.toString().length,s=a+r.toString().length),{start:a,end:s,containerNode:e}},moveToBookmark:function(t){var e=t.containerNode,n=0;this.setStart(e,0),this.collapse(!0);for(var i,o,r,a,s=[e],l=!1,h=!1;!h&&(i=s.pop());)if(3==i.nodeType)o=n+i.length,!l&&t.start>=n&&t.start<=o&&(this.setStart(i,t.start-n),l=!0),l&&t.end>=n&&t.end<=o&&(this.setEnd(i,t.end-n),h=!0),n=o;else for(a=i.childNodes,r=a.length;r--;)s.push(a[r])},getName:function(){return"DomRange"},equals:function(t){return dt.rangesEqual(this,t)},isValid:function(){return X(this)},inspect:function(){return S(this)},detach:function(){}}),ht(dt,ut),i.extend(dt,{rangeProperties:Q,RangeIterator:k,copyComparisonConstants:st,createPrototypeRange:ht,inspect:S,toHtml:$,getRangeDocument:b,rangesEqual:function(t,e){return t.startContainer===e.startContainer&&t.startOffset===e.startOffset&&t.endContainer===e.endContainer&&t.endOffset===e.endOffset}}),t.DomRange=dt}),w.createCoreModule("WrappedRange",["DomRange"],function(t,e){var n,i,o=t.dom,r=t.util,a=o.DomPosition,s=t.DomRange,l=o.getBody,h=o.getContentDocument,c=o.isCharacterDataNode;if(t.features.implementsDomRange&&function(){var i,a,c=s.rangeProperties;function u(t){for(var e,n=c.length;n--;)e=c[n],t[e]=t.nativeRange[e];t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset}n=function(t){if(!t)throw e.createError("WrappedRange: Range must be specified");this.nativeRange=t,u(this)},s.createPrototypeRange(n,function(t,e,n,i,o){var r=t.startContainer!==e||t.startOffset!=n,a=t.endContainer!==i||t.endOffset!=o,s=!t.equals(t.nativeRange);(r||a||s)&&(t.setEnd(i,o),t.setStart(e,n))}),(i=n.prototype).selectNode=function(t){this.nativeRange.selectNode(t),u(this)},i.cloneContents=function(){return this.nativeRange.cloneContents()},i.surroundContents=function(t){this.nativeRange.surroundContents(t),u(this)},i.collapse=function(t){this.nativeRange.collapse(t),u(this)},i.cloneRange=function(){return new n(this.nativeRange.cloneRange())},i.refresh=function(){u(this)},i.toString=function(){return this.nativeRange.toString()};var d=document.createTextNode("test");l(document).appendChild(d);var f=document.createRange();f.setStart(d,0),f.setEnd(d,0);try{f.setStart(d,1),i.setStart=function(t,e){this.nativeRange.setStart(t,e),u(this)},i.setEnd=function(t,e){this.nativeRange.setEnd(t,e),u(this)},a=function(t){return function(e){this.nativeRange[t](e),u(this)}}}catch(t){i.setStart=function(t,e){try{this.nativeRange.setStart(t,e)}catch(n){this.nativeRange.setEnd(t,e),this.nativeRange.setStart(t,e)}u(this)},i.setEnd=function(t,e){try{this.nativeRange.setEnd(t,e)}catch(n){this.nativeRange.setStart(t,e),this.nativeRange.setEnd(t,e)}u(this)},a=function(t,e){return function(n){try{this.nativeRange[t](n)}catch(i){this.nativeRange[e](n),this.nativeRange[t](n)}u(this)}}}i.setStartBefore=a("setStartBefore","setEndBefore"),i.setStartAfter=a("setStartAfter","setEndAfter"),i.setEndBefore=a("setEndBefore","setStartBefore"),i.setEndAfter=a("setEndAfter","setStartAfter"),i.selectNodeContents=function(t){this.setStartAndEnd(t,0,o.getNodeLength(t))},f.selectNodeContents(d),f.setEnd(d,3);var p=document.createRange();p.selectNodeContents(d),p.setEnd(d,4),p.setStart(d,2),-1==f.compareBoundaryPoints(f.START_TO_END,p)&&1==f.compareBoundaryPoints(f.END_TO_START,p)?i.compareBoundaryPoints=function(t,e){return e=e.nativeRange||e,t==e.START_TO_END?t=e.END_TO_START:t==e.END_TO_START&&(t=e.START_TO_END),this.nativeRange.compareBoundaryPoints(t,e)}:i.compareBoundaryPoints=function(t,e){return this.nativeRange.compareBoundaryPoints(t,e.nativeRange||e)};var g=document.createElement("div");g.innerHTML="123";var m=g.firstChild,v=l(document);v.appendChild(g),f.setStart(m,1),f.setEnd(m,2),f.deleteContents(),"13"==m.data&&(i.deleteContents=function(){this.nativeRange.deleteContents(),u(this)},i.extractContents=function(){var t=this.nativeRange.extractContents();return u(this),t}),v.removeChild(g),v=null,r.isHostMethod(f,"createContextualFragment")&&(i.createContextualFragment=function(t){return this.nativeRange.createContextualFragment(t)}),l(document).removeChild(d),i.getName=function(){return"WrappedRange"},t.WrappedRange=n,t.createNativeRange=function(t){return(t=h(t,e,"createNativeRange")).createRange()}}(),t.features.implementsTextRange){var u=function(t,e,n,i,r){var s=t.duplicate();s.collapse(n);var l=s.parentElement();if(o.isOrIsAncestorOf(e,l)||(l=e),!l.canHaveHTML){var h=new a(l.parentNode,o.getNodeIndex(l));return{boundaryPosition:h,nodeInfo:{nodeIndex:h.offset,containerElement:h.node}}}var u=o.getDocument(l).createElement("span");u.parentNode&&o.removeNode(u);for(var d,f,p,g,m,v=n?"StartToStart":"StartToEnd",y=r&&r.containerElement==l?r.nodeIndex:0,b=l.childNodes.length,E=b,w=E;w==b?l.appendChild(u):l.insertBefore(u,l.childNodes[w]),s.moveToElementText(u),0!=(d=s.compareEndPoints(v,t))&&y!=E;){if(-1==d){if(E==y+1)break;y=w}else E=E==y+1?y:w;w=Math.floor((y+E)/2),l.removeChild(u)}if(m=u.nextSibling,-1==d&&m&&c(m)){var C;if(s.setEndPoint(n?"EndToStart":"EndToEnd",t),/[\r\n]/.test(m.data)){var O=s.duplicate(),x=O.text.replace(/\r\n/g,"\r").length;for(C=O.moveStart("character",x);-1==(d=O.compareEndPoints("StartToEnd",O));)C++,O.moveStart("character",1)}else C=s.text.length;g=new a(m,C)}else f=(i||!n)&&u.previousSibling,p=(i||n)&&u.nextSibling,g=p&&c(p)?new a(p,0):f&&c(f)?new a(f,f.data.length):new a(l,o.getNodeIndex(u));return o.removeNode(u),{boundaryPosition:g,nodeInfo:{nodeIndex:w,containerElement:l}}},d=function(t,e){var n,i,r,a,s=t.offset,h=o.getDocument(t.node),u=l(h).createTextRange(),d=c(t.node);return d?(n=t.node,i=n.parentNode):(a=t.node.childNodes,n=s<a.length?a[s]:null,i=t.node),(r=h.createElement("span")).innerHTML="&#feff;",n?i.insertBefore(r,n):i.appendChild(r),u.moveToElementText(r),u.collapse(!e),i.removeChild(r),d&&u[e?"moveStart":"moveEnd"]("character",s),u};(i=function(t){this.textRange=t,this.refresh()}).prototype=new s(document),i.prototype.refresh=function(){var t,e,n,i,r=function(t){var e=t.parentElement(),n=t.duplicate();n.collapse(!0);var i=n.parentElement();(n=t.duplicate()).collapse(!1);var r=n.parentElement(),a=i==r?i:o.getCommonAncestor(i,r);return a==e?a:o.getCommonAncestor(e,a)}(this.textRange);0==(i=this.textRange).compareEndPoints("StartToEnd",i)?e=t=u(this.textRange,r,!0,!0).boundaryPosition:(n=u(this.textRange,r,!0,!1),t=n.boundaryPosition,e=u(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(t.node,t.offset),this.setEnd(e.node,e.offset)},i.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(i);var f=function(t){if(t.collapsed)return d(new a(t.startContainer,t.startOffset),!0);var e=d(new a(t.startContainer,t.startOffset),!0),n=d(new a(t.endContainer,t.endOffset),!1),i=l(s.getRangeDocument(t)).createTextRange();return i.setEndPoint("StartToStart",e),i.setEndPoint("EndToEnd",n),i};if(i.rangeToTextRange=f,i.prototype.toTextRange=function(){return f(this)},t.WrappedTextRange=i,!t.features.implementsDomRange||t.config.preferTextRange){var p=Function("return this;")();void 0===p.Range&&(p.Range=i),t.createNativeRange=function(t){return t=h(t,e,"createNativeRange"),l(t).createTextRange()},t.WrappedRange=i}}t.createRange=function(n){return n=h(n,e,"createRange"),new t.WrappedRange(t.createNativeRange(n))},t.createRangyRange=function(t){return t=h(t,e,"createRangyRange"),new s(t)},r.createAliasForDeprecatedMethod(t,"createIframeRange","createRange"),r.createAliasForDeprecatedMethod(t,"createIframeRangyRange","createRangyRange"),t.addShimListener(function(e){var n=e.document;void 0===n.createRange&&(n.createRange=function(){return t.createRange(n)}),n=e=null})}),w.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(t,e){t.config.checkSelectionRanges=!0;var n,i,o=t.dom,r=t.util,a=r.isHostMethod,s=t.DomRange,l=t.WrappedRange,h=t.DOMException,c=o.DomPosition,u=t.features,d=o.getDocument,f=o.getBody,p=s.rangesEqual;function g(t){return"string"==typeof t?/^backward(s)?$/i.test(t):!!t}function m(t,n){if(t){if(o.isWindow(t))return t;if(t instanceof z)return t.win;var i=o.getContentDocument(t,e,n);return o.getWindow(i)}return window}function v(t){return m(t,"getDocSelection").document.selection}function y(t){var e=!1;return t.anchorNode&&(e=1==o.comparePoints(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset)),e}var b=a(window,"getSelection"),E=r.isHostObject(document,"selection");u.implementsWinGetSelection=b,u.implementsDocSelection=E;var w=E&&(!b||t.config.preferTextRange);if(w)n=v,t.isSelectionValid=function(t){var e=m(t,"isSelectionValid").document,n=e.selection;return"None"!=n.type||d(n.createRange().parentElement())==e};else{if(!b)return e.fail("Neither document.selection or window.getSelection() detected."),!1;n=function(t){return m(t,"getWinSelection").getSelection()},t.isSelectionValid=function(){return!0}}t.getNativeSelection=n;var C=n();if(!C)return e.fail("Native selection was null (possibly issue 138?)"),!1;var O=t.createNativeRange(document),x=f(document),T=r.areHostProperties(C,["anchorNode","focusNode","anchorOffset","focusOffset"]);u.selectionHasAnchorAndFocus=T;var _=a(C,"extend");u.selectionHasExtend=_;var S="number"==typeof C.rangeCount;u.selectionHasRangeCount=S;var k=!1,A=!0,R=_?function(e,n){var i=s.getRangeDocument(n),o=t.createRange(i);o.collapseToPoint(n.endContainer,n.endOffset),e.addRange(B(o)),e.extend(n.startContainer,n.startOffset)}:null;r.areHostMethods(C,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof C.rangeCount&&u.implementsDomRange&&function(){var e=window.getSelection();if(e){for(var n=e.rangeCount,i=n>1,r=[],a=y(e),s=0;s<n;++s)r[s]=e.getRangeAt(s);var l=o.createTestElement(document,"",!1),h=l.appendChild(document.createTextNode("   ")),c=document.createRange();if(c.setStart(h,1),c.collapse(!0),e.removeAllRanges(),e.addRange(c),A=1==e.rangeCount,e.removeAllRanges(),!i){var u=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(u&&parseInt(u[1])>=36)k=!1;else{var d=c.cloneRange();c.setStart(h,0),d.setEnd(h,3),d.setStart(h,2),e.addRange(c),e.addRange(d),k=2==e.rangeCount}}for(o.removeNode(l),e.removeAllRanges(),s=0;s<n;++s)0==s&&a?R?R(e,r[s]):(t.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),e.addRange(r[s])):e.addRange(r[s])}}(),u.selectionSupportsMultipleRanges=k,u.collapsedNonEditableSelectionsSupported=A;var D,P,L=!1;function N(t,e,n){var i=n?"end":"start",o=n?"start":"end";t.anchorNode=e[i+"Container"],t.anchorOffset=e[i+"Offset"],t.focusNode=e[o+"Container"],t.focusOffset=e[o+"Offset"]}function M(t){t.anchorNode=t.focusNode=null,t.anchorOffset=t.focusOffset=0,t.rangeCount=0,t.isCollapsed=!0,t._ranges.length=0}function B(e){var n;return e instanceof s?((n=t.createNativeRange(e.getDocument())).setEnd(e.endContainer,e.endOffset),n.setStart(e.startContainer,e.startOffset)):e instanceof l?n=e.nativeRange:u.implementsDomRange&&e instanceof o.getWindow(e.startContainer).Range&&(n=e),n}function j(t){var n=t.getNodes();if(!function(t){if(!t.length||1!=t[0].nodeType)return!1;for(var e=1,n=t.length;e<n;++e)if(!o.isAncestorOf(t[0],t[e]))return!1;return!0}(n))throw e.createError("getSingleElementFromRange: range "+t.inspect()+" did not consist of a single element");return n[0]}function H(t){return!!t&&void 0!==t.text}function I(t,e){var n=new l(e);t._ranges=[n],N(t,n,!1),t.rangeCount=1,t.isCollapsed=n.collapsed}function F(e){if(e._ranges.length=0,"None"==e.docSelection.type)M(e);else{var n=e.docSelection.createRange();if(H(n))I(e,n);else{e.rangeCount=n.length;for(var i,o=d(n.item(0)),r=0;r<e.rangeCount;++r)(i=t.createRange(o)).selectNode(n.item(r)),e._ranges.push(i);e.isCollapsed=1==e.rangeCount&&e._ranges[0].collapsed,N(e,e._ranges[e.rangeCount-1],!1)}}}function q(t,n){for(var i=t.docSelection.createRange(),o=j(n),r=d(i.item(0)),a=f(r).createControlRange(),s=0,l=i.length;s<l;++s)a.add(i.item(s));try{a.add(o)}catch(t){throw e.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),F(t)}function z(t,e,n){this.nativeSelection=t,this.docSelection=e,this._ranges=[],this.win=n,this.refresh()}function Y(t){t.win=t.anchorNode=t.focusNode=t._ranges=null,t.rangeCount=t.anchorOffset=t.focusOffset=0,t.detached=!0}x&&a(x,"createControlRange")&&(D=x.createControlRange(),r.areHostProperties(D,["item","add"])&&(L=!0)),u.implementsControlRange=L,i=T?function(t){return t.anchorNode===t.focusNode&&t.anchorOffset===t.focusOffset}:function(t){return!!t.rangeCount&&t.getRangeAt(t.rangeCount-1).collapsed},a(C,"getRangeAt")?P=function(t,e){try{return t.getRangeAt(e)}catch(t){return null}}:T&&(P=function(e){var n=d(e.anchorNode),i=t.createRange(n);return i.setStartAndEnd(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset),i}),z.prototype=t.selectionPrototype;var X=[];function W(t,e){for(var n,i,o=X.length;o--;)if(n=X[o],i=n.selection,"deleteAll"==e)Y(i);else if(n.win==t)return"delete"==e?(X.splice(o,1),!0):i;return"deleteAll"==e&&(X.length=0),null}var U=function(t){if(t&&t instanceof z)return t.refresh(),t;var e=W(t=m(t,"getNativeSelection")),i=n(t),o=E?v(t):null;return e?(e.nativeSelection=i,e.docSelection=o,e.refresh()):(e=new z(i,o,t),X.push({win:t,selection:e})),e};t.getSelection=U,r.createAliasForDeprecatedMethod(t,"getIframeSelection","getSelection");var V,G=z.prototype;function J(t,n){for(var i,o=d(n[0].startContainer),r=f(o).createControlRange(),a=0,s=n.length;a<s;++a){i=j(n[a]);try{r.add(i)}catch(t){throw e.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}r.select(),F(t)}if(!w&&T&&r.areHostMethods(C,["removeAllRanges","addRange"])){G.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),M(this)};var $=function(t,e){R(t.nativeSelection,e),t.refresh()};G.addRange=S?function(e,n){if(L&&E&&"Control"==this.docSelection.type)q(this,e);else if(g(n)&&_)$(this,e);else{var o;k?o=this.rangeCount:(this.removeAllRanges(),o=0);var r=B(e).cloneRange();try{this.nativeSelection.addRange(r)}catch(t){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==o+1){if(t.config.checkSelectionRanges){var a=P(this.nativeSelection,this.rangeCount-1);a&&!p(a,e)&&(e=new l(a))}this._ranges[this.rangeCount-1]=e,N(this,e,Q(this.nativeSelection)),this.isCollapsed=i(this)}else this.refresh()}}:function(t,e){g(e)&&_?$(this,t):(this.nativeSelection.addRange(B(t)),this.refresh())},G.setRanges=function(t){if(L&&E&&t.length>1)J(this,t);else{this.removeAllRanges();for(var e=0,n=t.length;e<n;++e)this.addRange(t[e])}}}else{if(!(a(C,"empty")&&a(O,"select")&&L&&w))return e.fail("No means of selecting a Range or TextRange was found"),!1;G.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var t;if(this.anchorNode)t=d(this.anchorNode);else if("Control"==this.docSelection.type){var e=this.docSelection.createRange();e.length&&(t=d(e.item(0)))}if(t){var n=f(t).createTextRange();n.select(),this.docSelection.empty()}}}catch(t){}M(this)},G.addRange=function(e){"Control"==this.docSelection.type?q(this,e):(t.WrappedTextRange.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,N(this,e,!1))},G.setRanges=function(t){this.removeAllRanges();var e=t.length;e>1?J(this,t):e&&this.addRange(t[0])}}if(G.getRangeAt=function(t){if(t<0||t>=this.rangeCount)throw new h("INDEX_SIZE_ERR");return this._ranges[t].cloneRange()},w)V=function(e){var n;t.isSelectionValid(e.win)?n=e.docSelection.createRange():(n=f(e.win.document).createTextRange()).collapse(!0),"Control"==e.docSelection.type?F(e):H(n)?I(e,n):M(e)};else if(a(C,"getRangeAt")&&"number"==typeof C.rangeCount)V=function(e){if(L&&E&&"Control"==e.docSelection.type)F(e);else if(e._ranges.length=e.rangeCount=e.nativeSelection.rangeCount,e.rangeCount){for(var n=0,o=e.rangeCount;n<o;++n)e._ranges[n]=new t.WrappedRange(e.nativeSelection.getRangeAt(n));N(e,e._ranges[e.rangeCount-1],Q(e.nativeSelection)),e.isCollapsed=i(e)}else M(e)};else{if(!T||"boolean"!=typeof C.isCollapsed||"boolean"!=typeof O.collapsed||!u.implementsDomRange)return e.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;V=function(t){var e,n=t.nativeSelection;n.anchorNode?(e=P(n,0),t._ranges=[e],t.rangeCount=1,function(t){var e=t.nativeSelection;t.anchorNode=e.anchorNode,t.anchorOffset=e.anchorOffset,t.focusNode=e.focusNode,t.focusOffset=e.focusOffset}(t),t.isCollapsed=i(t)):M(t)}}G.refresh=function(t){var e=t?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(V(this),t){var o=e.length;if(o!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;o--;)if(!p(e[o],this._ranges[o]))return!0;return!1}};var Q,K=function(t,e){var n=t.getAllRanges();t.removeAllRanges();for(var i=0,o=n.length;i<o;++i)p(e,n[i])||t.addRange(n[i]);t.rangeCount||M(t)};function Z(t,e){if(t.win.document!=d(e))throw new h("WRONG_DOCUMENT_ERR")}function tt(e){return function(n,i){var o;this.rangeCount?(o=this.getRangeAt(0))["set"+(e?"Start":"End")](n,i):(o=t.createRange(this.win.document)).setStartAndEnd(n,i),this.setSingleRange(o,this.isBackward())}}function et(t){var e=[],n=new c(t.anchorNode,t.anchorOffset),i=new c(t.focusNode,t.focusOffset),o="function"==typeof t.getName?t.getName():"Selection";if(void 0!==t.rangeCount)for(var r=0,a=t.rangeCount;r<a;++r)e[r]=s.inspect(t.getRangeAt(r));return"["+o+"(Ranges: "+e.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}G.removeRange=L&&E?function(t){if("Control"==this.docSelection.type){for(var e=this.docSelection.createRange(),n=j(t),i=d(e.item(0)),o=f(i).createControlRange(),r=!1,a=0,s=e.length;a<s;++a)e.item(a)!==n||r?o.add(e.item(a)):r=!0;o.select(),F(this)}else K(this,t)}:function(t){K(this,t)},!w&&T&&u.implementsDomRange?(Q=y,G.isBackward=function(){return Q(this)}):Q=G.isBackward=function(){return!1},G.isBackwards=G.isBackward,G.toString=function(){for(var t=[],e=0,n=this.rangeCount;e<n;++e)t[e]=""+this._ranges[e];return t.join("")},G.collapse=function(e,n){Z(this,e);var i=t.createRange(e);i.collapseToPoint(e,n),this.setSingleRange(i),this.isCollapsed=!0},G.collapseToStart=function(){if(!this.rangeCount)throw new h("INVALID_STATE_ERR");var t=this._ranges[0];this.collapse(t.startContainer,t.startOffset)},G.collapseToEnd=function(){if(!this.rangeCount)throw new h("INVALID_STATE_ERR");var t=this._ranges[this.rangeCount-1];this.collapse(t.endContainer,t.endOffset)},G.selectAllChildren=function(e){Z(this,e);var n=t.createRange(e);n.selectNodeContents(e),this.setSingleRange(n)},G.deleteFromDocument=function(){if(L&&E&&"Control"==this.docSelection.type){for(var t,e=this.docSelection.createRange();e.length;)t=e.item(0),e.remove(t),o.removeNode(t);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;i<r;++i)n[i].deleteContents();this.addRange(n[r-1])}}},G.eachRange=function(t,e){for(var n=0,i=this._ranges.length;n<i;++n)if(t(this.getRangeAt(n)))return e},G.getAllRanges=function(){var t=[];return this.eachRange(function(e){t.push(e)}),t},G.setSingleRange=function(t,e){this.removeAllRanges(),this.addRange(t,e)},G.callMethodOnEachRange=function(t,e){var n=[];return this.eachRange(function(i){n.push(i[t].apply(i,e||[]))}),n},G.setStart=tt(!0),G.setEnd=tt(!1),t.rangePrototype.select=function(t){U(this.getDocument()).setSingleRange(this,t)},G.changeEachRange=function(t){var e=[],n=this.isBackward();this.eachRange(function(n){t(n),e.push(n)}),this.removeAllRanges(),n&&1==e.length?this.addRange(e[0],"backward"):this.setRanges(e)},G.containsNode=function(t,e){return this.eachRange(function(n){return n.containsNode(t,e)},!0)||!1},G.getBookmark=function(t){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[t])}},G.moveToBookmark=function(e){for(var n,i,o=[],r=0;n=e.rangeBookmarks[r++];)(i=t.createRange(this.win)).moveToBookmark(n),o.push(i);e.backward?this.setSingleRange(o[0],"backward"):this.setRanges(o)},G.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},G.restoreRanges=function(t){this.removeAllRanges();for(var e,n=0;e=t.ranges[n];++n)this.addRange(e,t.backward&&0==n)},G.toHtml=function(){var t=[];return this.eachRange(function(e){t.push(s.toHtml(e))}),t.join("")},u.implementsTextRange&&(G.getNativeTextRange=function(){var n;if(n=this.docSelection){var i=n.createRange();if(H(i))return i;throw e.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return t.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw e.createError("getNativeTextRange: selection contains no range")}),G.getName=function(){return"WrappedSelection"},G.inspect=function(){return et(this)},G.detach=function(){W(this.win,"delete"),Y(this)},z.detachAll=function(){W(null,"deleteAll")},z.inspect=et,z.isDirectionBackward=g,t.Selection=z,t.selectionPrototype=G,t.addShimListener(function(t){void 0===t.getSelection&&(t.getSelection=function(){return U(t)}),t=null})});var N=!1,M=function(t){N||(N=!0,!w.initialized&&w.config.autoInitialize&&S())};return b&&("complete"==document.readyState?M():(s(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",M,!1),v(window,"load",M))),w})?i.call(e,n,e,t):i)||(t.exports=o)},function(t,e,n){"use strict";var i=n(25),o=n.n(i),r=n(3),a=n.n(r),s=n(1),l=n(0),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),c=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};function u(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}var d=function(t){function e(){var t,n,i;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);for(var o=arguments.length,r=Array(o),a=0;a<o;a++)r[a]=arguments[a];return n=i=u(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r))),i.threads={},i.handlers=[],u(i,n)}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,a.a),h(e,[{key:"init",value:function(t){this.container=t.container,this.headerElement=t.headerElement,this.annotatedElement=t.annotatedElement,this.mode=t.mode,this.annotator=t.annotator,this.permissions=t.permissions||{},this.localized=t.localized||{},this.hasTouch=!!t.options&&t.options.hasTouch,this.isMobile=!!t.options&&t.options.isMobile,t.modeButton&&this.permissions.canAnnotate&&(this.modeButton=t.modeButton,this.showButton()),this.handleThreadEvents=this.handleThreadEvents.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this)}},{key:"destroy",value:function(){var t=this;Object.keys(this.threads).forEach(function(e){(t.threads[e].all()||[]).forEach(t.unregisterThread.bind(t))}),this.buttonEl&&this.buttonEl.removeEventListener("click",this.toggleMode),this.modeButton&&this.hideButton()}},{key:"getButton",value:function(t){return this.headerElement?this.headerElement.querySelector(t):null}},{key:"showButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&(this.buttonEl.title=this.modeButton.title,this.buttonEl.classList.remove(l.O),this.toggleMode=this.toggleMode.bind(this),this.buttonEl.addEventListener("click",this.toggleMode)))}},{key:"hideButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&this.buttonEl.classList.add(l.O))}},{key:"toggleMode",value:function(){this.destroyPendingThreads(),this.modeButton&&this.emit(l.fb.toggleMode)}},{key:"exit",value:function(){this.emit(l.fb.exit,{mode:this.mode}),Object(s.H)(this.headerElement,l.Xb),this.destroyPendingThreads(),this.annotatedElement.classList.remove(l.y),this.annotatedElement.classList.remove(l.h),this.buttonEl.classList.remove(l.c),this.unbindListeners(),this.emit(l.fb.bindDOMListeners),this.hadPendingThreads=!1}},{key:"enter",value:function(){this.annotatedElement.classList.add(l.y),this.annotatedElement.classList.add(l.h),this.buttonEl.classList.add(l.c),this.emit(l.fb.enter,{mode:this.mode}),this.emit(l.fb.unbindDOMListeners),this.bindListeners()}},{key:"isEnabled",value:function(){return!!this.buttonEl&&this.buttonEl.classList.contains(l.c)}},{key:"bindListeners",value:function(){var t=this,e=this.handlers.length;this.setupHandlers();for(var n=function(e){var n=t.handlers[e];(n.type instanceof Array?n.type:[n.type]).forEach(function(t){return n.eventObj.addEventListener(t,n.func,n.useCapture)})},i=e;i<this.handlers.length;i++)n(i)}},{key:"unbindListeners",value:function(){for(var t=this,e=function(){var e=t.handlers.pop();(e.type instanceof Array?e.type:[e.type]).forEach(function(t){e.eventObj.removeEventListener(t,e.func,e.useCapture)})};this.handlers.length>0;)e()}},{key:"registerThread",value:function(t){var e=this;if(t&&t.location&&Object(s.w)(t)){var n=t.location.page||1;n in this.threads||(this.threads[n]=new o.a),this.threads[n].insert(t),this.emit(l.fb.register,t),t.addListener("threadevent",function(n){return e.handleThreadEvents(t,n)})}}},{key:"unregisterThread",value:function(t){t&&t.location&&t.location.page&&this.threads[t.location.page]&&(this.threads[t.location.page].remove(t),this.emit(l.fb.unregister,t),t.removeListener("threadevent",this.handleThreadEvents))}},{key:"applyActionToPageThreads",value:function(t,e){this.threads[e]&&(this.threads[e].all()||[]).forEach(t)}},{key:"applyActionToThreads",value:function(t){var e=this;Object.keys(this.threads).forEach(function(n){return e.applyActionToPageThreads(t,n)})}},{key:"getThreadByID",value:function(t){var e=this,n=null;return t?(Object.keys(this.threads).some(function(i){var o=e.threads[i];return o?!!(n=o.all().filter(function(e){return e.threadID===t})[0]):!!n}),n):n}},{key:"removeSelection",value:function(){}},{key:"setupHandlers",value:function(){}},{key:"handleThreadEvents",value:function(t,e){var n=e.event,i=e.data;switch(n){case l.hc.save:case l.hc.cancel:this.hadPendingThreads=!1,this.emit(n,i);break;case l.hc.show:this.visibleThreadID=i.threadID;break;case l.hc.hide:this.visibleThreadID=null;break;case l.hc.threadCleanup:this.unregisterThread(t);break;case l.hc.threadDelete:this.unregisterThread(t),this.emit(n,i);break;case l.hc.deleteError:this.emit(l.a.error,this.localized.deleteError),this.emit(n,i);break;case l.hc.createError:this.emit(l.a.error,this.localized.createError),this.emit(n,i);break;default:this.emit(n,i)}}},{key:"pushElementHandler",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t&&this.handlers.push({eventObj:t,func:n,type:e,useCapture:i})}},{key:"setupHeader",value:function(t,e){var n=t.firstElementChild;Object(s.z)(t,e,n)}},{key:"render",value:function(){var t=this;this.threads&&Object.keys(this.threads).forEach(function(e){t.renderPage(e)})}},{key:"renderPage",value:function(t){var e=this;if(this.threads&&this.threads[t]){var n=this.threads[t].all()||[];n.forEach(function(t,i){if(Object(s.E)(t.state))return e.unregisterThread(t),void t.destroy();t.hideDialog(),t.annotatedElement||(n[i].annotatedElement=e.annotatedElement),t.show()})}}},{key:"destroyPendingThreads",value:function(){var t=this,e=!1;return Object.keys(this.threads).forEach(function(n){(t.threads[n].all()||[]).forEach(function(n){Object(s.E)(n.state)?(t.unregisterThread(n),e=!0,t.pendingThreadID=null,n.destroy()):n.isDialogVisible()&&n.hideDialog()})}),e}},{key:"getIntersectingThreads",value:function(t){if(!t||!this.threads||!this.annotator)return[];var e=this.annotator.getLocationFromEvent(t,l.ic.point);if(!e||0===Object.keys(this.threads).length||!this.threads[e.page])return[];var n={minX:+e.x-l.b,minY:+e.y-l.b,maxX:+e.x+l.b,maxY:+e.y+l.b};return this.threads[e.page].search(n)}},{key:"emit",value:function(t,n){c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,t,n),c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,"annotationcontrollerevent",{event:t,data:n,mode:this.mode})}}]),e}();e.a=d},function(t,e,n){"use strict";var i=n(3),o=n.n(i),r=n(6),a=n(1),s=(n(37),n(0)),l=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),h=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var c=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));n.options=t,n.locale=t.location.locale||"en-US",n.validationErrorEmitted=!1,n.isMobile=t.isMobile||!1,n.hasTouch=t.hasTouch||!1,n.localized=t.localizedStrings;var i=n.options,o=i.apiHost,a=i.file,s=i.token;n.fileVersionId=a.file_version.id,n.fileId=a.id,n.permissions=n.getAnnotationPermissions(n.options.file),n.annotationService=new r.a({apiHost:o,fileId:n.fileId,token:s,canAnnotate:n.permissions.canAnnotate,anonymousUserName:n.localized.anonymousUserName});var l=(n.options.annotator||{}).CONTROLLERS;return n.modeControllers=l||{},n.fetchPromise=n.fetchAnnotations(),n.createPointThread=n.createPointThread.bind(n),n.scaleAnnotations=n.scaleAnnotations.bind(n),n.handleControllerEvents=n.handleControllerEvents.bind(n),n.handleServicesErrors=n.handleServicesErrors.bind(n),n.hideAnnotations=n.hideAnnotations.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),l(e,[{key:"destroy",value:function(){var t=this;Object.keys(this.modeControllers).forEach(function(e){t.modeControllers[e].destroy()}),this.unbindDOMListeners(),this.unbindCustomListenersOnService(),this.removeListener(s.a.scale,this.scaleAnnotations)}},{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.container=this.options.container,"string"==typeof this.options.container&&(this.container=document.querySelector(this.container)),this.headerElement=this.options.headerElement,"string"==typeof this.headerElement&&(this.headerElement=document.querySelector(this.headerElement)),"none"===this.options.header||this.headerElement||(this.headerElement=this.container.querySelector(s.Yb)),this.annotatedElement=this.getAnnotatedEl(this.container),this.isMobile&&this.setupMobileDialog(),this.setScale(t),this.setupAnnotations(),this.loadAnnotations()}},{key:"isModeAnnotatable",value:function(t){if(!this.options.annotator)return!1;var e=this.options.annotator.TYPE;return!(t&&e&&!e.some(function(e){return t===e}))}},{key:"loadAnnotations",value:function(){var t=this;this.fetchPromise.then(function(){t.generateThreadMap(t.threadMap),t.render(),t.annotatedElement.classList.add(s.i)}).catch(function(e){t.emit(s.a.loadError,e)})}},{key:"setScale",value:function(t){this.annotatedElement.setAttribute("data-scale",t)}},{key:"getLocationFromEvent",value:function(t,e){}},{key:"createAnnotationThread",value:function(t,e,n){}},{key:"getAnnotatedEl",value:function(t){}},{key:"setupAnnotations",value:function(){this.bindDOMListeners(),this.bindCustomListenersOnService(this.annotationService),this.addListener(s.a.scale,this.scaleAnnotations),this.setupControllers()}},{key:"setupControllers",value:function(){var t=this;this.modeButtons=this.options.modeButtons||{};var e={header:this.options.header,isMobile:this.isMobile,hasTouch:this.hasTouch};Object.keys(this.modeControllers).forEach(function(n){var i=t.modeControllers[n];i.init({container:t.container,headerElement:t.headerElement,annotatedElement:t.annotatedElement,mode:n,modeButton:t.modeButtons[n],permissions:t.permissions,annotator:t,localized:t.localized,options:e}),i.addListener("annotationcontrollerevent",t.handleControllerEvents)});var n=this.modeControllers[s.ic.point];n&&this.isMobile&&n.setupSharedDialog(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,localized:this.localized})}},{key:"setupMobileDialog",value:function(){this.mobileDialogEl=a.n(),this.mobileDialogEl.setAttribute("data-type",s.ib),this.mobileDialogEl.classList.add(s.W),this.mobileDialogEl.classList.add(s.o),this.mobileDialogEl.classList.add(s.O),this.mobileDialogEl.id=s.zb,this.container.appendChild(this.mobileDialogEl)}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&!this.mobileDialogEl.classList.contains(s.O)&&(a.x(this.mobileDialogEl),a.M("."+s.Y),this.mobileDialogEl.removeChild(this.mobileDialogEl.lastChild))}},{key:"hideAnnotations",value:function(t){var e=this;t&&a.D(t)||Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].applyActionToThreads(function(t){a.E(t.state)||t.hideDialog()})})}},{key:"fetchAnnotations",value:function(){var t=this;return this.permissions.canViewAllAnnotations||this.permissions.canViewOwnAnnotations?this.annotationService.getThreadMap(this.fileVersionId).then(function(e){t.threadMap=e,t.emit(s.a.fetch)}).catch(function(e){t.emit(s.a.loadError,e)}):Promise.resolve({})}},{key:"generateThreadMap",value:function(t){var e=this;this.options.annotator&&Object.keys(t).forEach(function(n){var i=t[n],o=a.t(i);if(o&&e.isModeAnnotatable(o.type)){var r=a.r(i),s=e.createAnnotationThread(i,r.location,o.type),l=e.modeControllers[o.type];l&&l.registerThread(s)}})}},{key:"bindDOMListeners",value:function(){}},{key:"unbindDOMListeners",value:function(){}},{key:"bindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof r.a&&t.addListener(s.a.error,this.handleServicesErrors)}},{key:"unbindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof r.a&&t.removeListener(s.a.error,this.handleServicesErrors)}},{key:"getThreadParams",value:function(t,e,n){var i={annotatedElement:this.annotatedElement,annotations:t,annotationService:this.annotationService,container:this.container,fileVersionId:this.fileVersionId,isMobile:this.isMobile,hasTouch:this.hasTouch,locale:this.locale,location:e,type:n,permissions:this.permissions,localized:this.localized},o=a.r(t);return o&&(i.threadID=o.threadID,i.threadNumber=o.threadNumber),i}},{key:"getCurrentAnnotationMode",value:function(){var t=this;return Object.keys(this.modeControllers).filter(function(e){return t.modeControllers[e].isEnabled()})[0]||null}},{key:"createPointThread",value:function(t){var e=t.commentText,n=t.lastPointEvent,i=t.pendingThreadID;if(!n||!i||!e||""===e.trim())return null;if(!this.getLocationFromEvent(n,s.ic.point))return null;var o=this.modeControllers[s.ic.point],r=o.getThreadByID(i);return o&&r?(r.dialog.hasComments=!0,r.state=s.gc.hover,r.showDialog(),r.dialog.postAnnotation(e),this.emit(s.hc.threadSave,r.getThreadEventData()),r):null}},{key:"render",value:function(){var t=this;Object.keys(this.modeControllers).forEach(function(e){t.modeControllers[e].render()})}},{key:"renderPage",value:function(t){var e=this;Object.keys(this.modeControllers).forEach(function(n){return e.modeControllers[n].renderPage(t)})}},{key:"getAnnotationPermissions",value:function(t){var e=t.permissions||{};return{canAnnotate:e.can_annotate||!1,canViewAllAnnotations:e.can_view_annotations_all||!1,canViewOwnAnnotations:e.can_view_annotations_self||!1}}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.render()}},{key:"toggleAnnotationMode",value:function(t){this.hideAnnotations();var e=this.getCurrentAnnotationMode();e&&this.modeControllers[e].exit(),e!==t&&this.modeControllers[t].enter()}},{key:"scrollToAnnotation",value:function(t){var e=this;t&&Object.keys(this.modeControllers).forEach(function(n){var i=e.modeControllers[n].getThreadByID(t);i&&i.scrollIntoView()})}},{key:"handleValidationError",value:function(){this.validationErrorEmitted||(this.emit(s.a.error,this.localized.loadError),this.validationErrorEmitted=!0)}},{key:"handleServicesErrors",value:function(t){var e="";switch(t.reason){case"read":e=this.localized.loadError;break;case"create":e=this.localized.createError,this.loadAnnotations();break;case"delete":e=this.localized.deleteError,this.loadAnnotations();break;case"authorization":e=this.localized.authError}t.error,e&&this.emit(s.a.error,e)}},{key:"handleControllerEvents",value:function(t){switch(t.event){case s.fb.resetMobileDialog:this.removeThreadFromSharedDialog();break;case s.fb.toggleMode:this.toggleAnnotationMode(t.mode);break;case s.fb.enter:this.emit(t.event,{mode:t.mode}),this.unbindDOMListeners();break;case s.fb.exit:this.emit(t.event,{mode:t.mode}),this.bindDOMListeners();break;case s.fb.createThread:this.createPointThread(t.data);break;default:this.emit(t.event,t.data)}}},{key:"emit",value:function(t,n){var i=this.options.annotator;h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,t,n),h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).call(this,"annotatorevent",{event:t,data:n,annotatorName:i?i.NAME:"",fileVersionId:this.fileVersionId,fileId:this.fileId})}}]),e}();e.a=c},function(t,e,n){"use strict";e.a=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.annotationID=e.annotationID,this.fileVersionId=e.fileVersionId,this.threadID=e.threadID,this.threadNumber=e.threadNumber,this.type=e.type,this.text=e.text,this.location=e.location,this.user=e.user,this.permissions=e.permissions,this.created=e.created,this.modified=e.modified}},function(t,e,n){"use strict";var i=n(3),o=n.n(i),r=n(0),a=n(1),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var l=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.parentEl=t,i.hasTouch=n.hasTouch||!1,i.isMobile=n.isMobile||!1,i.localized=n.localized,i.cancelText=n.localized.cancelButton,i.postText=n.localized.postButton,i.placeholderText=n.localized.addCommentPlaceholder,i.containerEl=i.createCommentBox(),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),s(e,[{key:"focus",value:function(){this.textAreaEl&&(this.textAreaEl.focus(),this.textAreaEl.classList.remove(r.U))}},{key:"blur",value:function(){document.activeElement&&document.activeElement.blur()}},{key:"clear",value:function(){this.textAreaEl&&(this.textAreaEl.value="")}},{key:"hide",value:function(){this.containerEl&&Object(a.x)(this.containerEl)}},{key:"show",value:function(){this.containerEl||(this.containerEl=this.createCommentBox(),this.parentEl.appendChild(this.containerEl)),Object(a.M)(this.containerEl),Object(a.l)(this.textAreaEl)}},{key:"destroy",value:function(){this.containerEl&&(this.containerEl.removeEventListener("touchend",this.preventDefaultAndPropagation),this.containerEl.remove(),this.parentEl=null,this.containerEl=null,this.cancelEl&&(this.cancelEl.removeEventListener("click",this.onCancel),this.cancelEl.removeEventListener("touchend",this.onCancel)),this.postEl&&(this.postEl.removeEventListener("click",this.onPost),this.postEl.removeEventListener("touchend",this.onPost)),this.textAreaEl&&this.textAreaEl.removeEventListener("focus",this.focus))}},{key:"createHTML",value:function(){var t=document.createElement("section");return t.classList.add(r.J),t.innerHTML=('\n            <textarea class="'+r.cb+" "+r.C+" "+r.c+'"\n                placeholder="'+this.placeholderText+'"></textarea>\n            <div class="'+r.F+'">\n                <button class="'+r.E+" "+r.j+'">\n                    '+this.cancelText+'\n                </button>\n                <button class="'+r.E+" "+r.H+" "+r.k+'">\n                    '+this.postText+"\n                </button>\n            </div>").trim(),t}},{key:"preventDefaultAndPropagation",value:function(t){t.preventDefault(),t.stopPropagation()}},{key:"onCancel",value:function(t){this.preventDefaultAndPropagation(t),this.clear(),this.emit(e.CommentEvents.cancel)}},{key:"onPost",value:function(t){this.preventDefaultAndPropagation(t);var n=this.textAreaEl.value;""!==n.trim()?(this.emit(e.CommentEvents.post,n),this.clear()):this.textAreaEl.classList.add(r.U)}},{key:"createCommentBox",value:function(){var t=this.createHTML();return this.textAreaEl=t.querySelector(r.Wb),this.cancelEl=t.querySelector(r.Lb),this.postEl=t.querySelector(r.Rb),this.focus=this.focus.bind(this),this.onCancel=this.onCancel.bind(this),this.onPost=this.onPost.bind(this),this.hasTouch&&(t.addEventListener("touchend",this.preventDefaultAndPropagation.bind(this)),this.cancelEl.addEventListener("touchend",this.onCancel),this.postEl.addEventListener("touchend",this.onPost)),this.isMobile||(this.textAreaEl.addEventListener("focus",this.focus),this.cancelEl.addEventListener("click",this.onCancel),this.postEl.addEventListener("click",this.onPost)),t.addEventListener("click",this.preventDefaultAndPropagation.bind(this)),t}}]),e}();l.CommentEvents={cancel:"comment_cancel",post:"comment_post"};var h=l,c=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var u=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.position={x:0,y:0},i.parentEl=t,i.isMobile=!!n.isMobile||!1,i.hasTouch=!!n.hasTouch||!1,i.localized=n.localized,i.isVisible=!1,i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o.a),c(e,[{key:"setParentEl",value:function(t){this.parentEl=t}},{key:"setPosition",value:function(t,e){this.position.x=t,this.position.y=e,this.updatePosition()}},{key:"show",value:function(t){this.isVisible=!0,this.containerEl||this.createElement(),t&&this.setParentEl(t),this.setButtonVisibility(!0),Object(a.M)(this.containerEl),this.emit(r.gb.init)}},{key:"showCommentBox",value:function(){this.commentBox.show(),this.commentBox.focus()}},{key:"hide",value:function(){this.isVisible=!1,this.containerEl&&(Object(a.x)(this.containerEl),this.commentBox&&(this.commentBox.hide(),this.commentBox.clear()))}},{key:"destroy",value:function(){this.containerEl&&(this.hide(),this.isMobile||(this.containerEl.removeEventListener("click",this.stopPropagation),this.containerEl.removeEventListener("mouseup",this.stopPropagation),this.containerEl.removeEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.removeEventListener("touchend",this.stopPropagation),this.containerEl.remove(),this.containerEl=null,this.parentEl=null,this.commentBox&&(this.commentBox.removeListener(h.CommentEvents.post,this.onCommentPost),this.commentBox.removeListener(h.CommentEvents.cancel,this.onCommentCancel),this.commentBox.destroy(),this.commentBox=null))}},{key:"updatePosition",value:function(){this.isMobile||(this.containerEl.style.left=this.position.x-1-this.containerEl.clientWidth/2+"px",this.containerEl.style.top=this.position.y+5+"px")}},{key:"onCommentPost",value:function(t){this.emit(r.gb.post,t),t&&(this.commentBox.clear(),this.commentBox.blur())}},{key:"onCommentCancel",value:function(){this.emit(r.gb.cancel),this.commentBox.hide(),this.setButtonVisibility(!0),this.updatePosition()}},{key:"setButtonVisibility",value:function(t){t?Object(a.M)(this.buttonsEl):Object(a.x)(this.buttonsEl)}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"setupCommentBox",value:function(t){var e=new h(t,{hasTouch:this.hasTouch,isMobile:this.isMobile,localized:this.localized});return t.appendChild(e.containerEl),e.addListener(h.CommentEvents.post,this.onCommentPost.bind(this)),e.addListener(h.CommentEvents.cancel,this.onCommentCancel.bind(this)),e.hide(),e}},{key:"createElement",value:function(){this.containerEl=document.createElement("div"),this.containerEl.classList.add(r.X),this.containerEl.classList.add(r.o),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation),this.commentBox=this.setupCommentBox(this.containerEl),this.containerEl.appendChild(this.commentBox.containerEl)}}]),e}();e.a=u},function(t,e,n){"use strict";var i=n(8),o=n(1),r=n(0),a=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),s=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var l=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,i["a"]),a(e,[{key:"handleThreadEvents",value:function(t,n){var i=void 0;switch(n.event){case r.hc.save:(i=Object(o.r)(t.annotations))&&i.type===r.ic.highlight&&2===Object.keys(t.annotations).length&&this.renderPage(t.location.page);break;case r.hc.threadCleanup:this.emit(r.fb.renderPage,t.location.page)}s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"handleThreadEvents",this).call(this,t,n)}},{key:"exit",value:function(){this.destroyPendingThreads(),window.getSelection().removeAllRanges(),this.unbindListeners(),this.emit(r.fb.bindDOMListeners)}},{key:"enter",value:function(){this.emit(r.fb.unbindDOMListeners),this.bindListeners()}},{key:"render",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"render",this).call(this),this.destroyPendingThreads()}},{key:"renderPage",value:function(t){var n=this.annotatedElement.querySelector('[data-page-number="'+t+'"]'),i=this.mode===r.ic.highlight?r.w:r.x;Object(o.c)(n,i),this.threads&&s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"renderPage",this).call(this,t)}}]),e}();e.a=l},function(t,e){!function(t){"use strict";if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var n=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],i=function(t){return t&&DataView.prototype.isPrototypeOf(t)},o=ArrayBuffer.isView||function(t){return t&&n.indexOf(Object.prototype.toString.call(t))>-1};c.prototype.append=function(t,e){t=s(t),e=l(e);var n=this.map[t];this.map[t]=n?n+","+e:e},c.prototype.delete=function(t){delete this.map[s(t)]},c.prototype.get=function(t){return t=s(t),this.has(t)?this.map[t]:null},c.prototype.has=function(t){return this.map.hasOwnProperty(s(t))},c.prototype.set=function(t,e){this.map[s(t)]=l(e)},c.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},c.prototype.keys=function(){var t=[];return this.forEach(function(e,n){t.push(n)}),h(t)},c.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),h(t)},c.prototype.entries=function(){var t=[];return this.forEach(function(e,n){t.push([n,e])}),h(t)},e.iterable&&(c.prototype[Symbol.iterator]=c.prototype.entries);var r=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];m.prototype.clone=function(){return new m(this,{body:this._bodyInit})},g.call(m.prototype),g.call(y.prototype),y.prototype.clone=function(){return new y(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new c(this.headers),url:this.url})},y.error=function(){var t=new y(null,{status:0,statusText:""});return t.type="error",t};var a=[301,302,303,307,308];y.redirect=function(t,e){if(-1===a.indexOf(e))throw new RangeError("Invalid status code");return new y(null,{status:e,headers:{location:t}})},t.Headers=c,t.Request=m,t.Response=y,t.fetch=function(t,n){return new Promise(function(i,o){var r=new m(t,n),a=new XMLHttpRequest;a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new c,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var n=t.split(":"),i=n.shift().trim();if(i){var o=n.join(":").trim();e.append(i,o)}}),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL");var o="response"in a?a.response:a.responseText;i(new y(o,n))},a.onerror=function(){o(new TypeError("Network request failed"))},a.ontimeout=function(){o(new TypeError("Network request failed"))},a.open(r.method,r.url,!0),"include"===r.credentials?a.withCredentials=!0:"omit"===r.credentials&&(a.withCredentials=!1),"responseType"in a&&e.blob&&(a.responseType="blob"),r.headers.forEach(function(t,e){a.setRequestHeader(e,t)}),a.send(void 0===r._bodyInit?null:r._bodyInit)})},t.fetch.polyfill=!0}function s(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function l(t){return"string"!=typeof t&&(t=String(t)),t}function h(t){var n={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return e.iterable&&(n[Symbol.iterator]=function(){return n}),n}function c(t){this.map={},t instanceof c?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function u(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function d(t){return new Promise(function(e,n){t.onload=function(){e(t.result)},t.onerror=function(){n(t.error)}})}function f(t){var e=new FileReader,n=d(e);return e.readAsArrayBuffer(t),n}function p(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function g(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&i(t))this._bodyArrayBuffer=p(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!o(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=p(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},e.blob&&(this.blob=function(){var t=u(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?u(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(f)}),this.text=function(){var t,e,n,i=u(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,n=d(e),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),i=0;i<e.length;i++)n[i]=String.fromCharCode(e[i]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},e.formData&&(this.formData=function(){return this.text().then(v)}),this.json=function(){return this.text().then(JSON.parse)},this}function m(t,e){var n,i,o=(e=e||{}).body;if(t instanceof m){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new c(t.headers)),this.method=t.method,this.mode=t.mode,o||null==t._bodyInit||(o=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new c(e.headers)),this.method=(n=e.method||this.method||"GET",i=n.toUpperCase(),r.indexOf(i)>-1?i:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(o)}function v(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var n=t.split("="),i=n.shift().replace(/\+/g," "),o=n.join("=").replace(/\+/g," ");e.append(decodeURIComponent(i),decodeURIComponent(o))}}),e}function y(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new c(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:this)},function(t,e){t.exports='<svg width="22" height="21" viewBox="0 0 22 21" focusable="false">\n  <path d="M11 21l-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15l-4 4zm-7-9.5c0-.276.228-.5.51-.5h8.98c.282 0 .51.232.51.5 0 .276-.228.5-.51.5H4.51c-.282 0-.51-.232-.51-.5zm0-3c0-.276.23-.5.5-.5h11c.276 0 .5.232.5.5 0 .276-.23.5-.5.5h-11c-.276 0-.5-.232-.5-.5zm0-3c0-.276.22-.5.498-.5h13.004c.275 0 .498.232.498.5 0 .276-.22.5-.498.5H4.498C4.223 6 4 5.768 4 5.5z" fill="#0061d5" fill-rule="evenodd"/>\n</svg>\n'},function(t,e){t.exports='<svg width="20" height="20" viewBox="0 0 20 20" focusable="false">\n  <g fill="none" fill-rule="evenodd">\n    <path d="M-2-2h24v24H-2"/>\n    <path class="icon" d="M18 0H2C.9 0 .01.9.01 2L0 20l4-4h14c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2zM4 7h10v2H4V7zm8 5H4v-2h8v2zm4-6H4V4h12v2z" fill="#000"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="30" viewBox="0 0 24 30" focusable="false">\n  <g transform="translate(1 1)" fill="none" fill-rule="evenodd">\n    <path d="M15 17l-4 4-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15z" stroke="#FFF" fill="#0061d5"/>\n    <rect fill="#FFF" x="4" y="5" width="14" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="8" width="12" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="11" width="10" height="1" rx=".5"/>\n    <circle fill-opacity=".3" fill="#0061d5" cx="11" cy="26" r="3"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 10l5 5 5-5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 14l5-5 5 5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#000" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="24" viewBox="0 0 24 24" focusable="false">\n    <g fill-rule="evenodd">\n        <path d="M1 23h11.875v-3H1v3zm9.19-9.854l4.103 4.102.694.694.707-.68 7-6.742.306-.295V.07l-1.673 1.524L10.224 11.7l-.775.705.74.74z"/>\n        <path d="M11.023 12.17L6.33 16.58C5.28 17.62 5.9 19 7.32 19h3.95c.82 0 1.826-.413 2.406-.995l1.544-1.383.768-.69-.713-.745-2.844-2.976-.683-.717-.723.68v-.003zm-.038 1.42l2.844 2.977.053-1.435-1.584 1.42c-.244.243-.74.446-1.03.446l-2.454-.008 3.577-3.36-1.408-.04z"/>\n    </g>\n</svg>\n'},function(t,e){t.exports='<svg viewBox="-11 13 24 24" focusable="false">\n  <path class="icon" fill="#494949" d="M6 21l-1-1-4 4-4-4-1 1 4 4-4 4 1 1 4-4 4 4 1-1-4-4 4-4z"/>\n  <path fill="none" d="M-11 13h24v24h-24V13z"/>\n</svg>\n'},function(t,e){t.exports='<svg width="11" height="11" viewBox="0 0 24 18" focusable="false"><path d="M9 21.035l-9-8.638 2.791-2.87 6.156 5.874 12.21-12.436 2.843 2.817z"/></svg>'},function(t,e){t.exports='<svg width="11" height="9" viewBox="0 0 24 24" focusable="false"><path d="M23.954 21.03l-9.184-9.095 9.092-9.174-2.832-2.807-9.09 9.179-9.176-9.088-2.81 2.81 9.186 9.105-9.095 9.184 2.81 2.81 9.112-9.192 9.18 9.1z"/></svg>'},function(t,e,n){"use strict";var i=n(8),o=n(26),r=n.n(o),a=n(1),s=n(0),l=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),h=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var c=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,i["a"]),l(e,[{key:"init",value:function(t){h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this,t),("none"!==t.options.header||this.headerElement)&&this.setupHeader(this.headerElement,r.a),this.handleSelection=this.handleSelection.bind(this)}},{key:"setupHeader",value:function(t,n){h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setupHeader",this).call(this,t,n),this.cancelButtonEl=this.getButton(s.Mb),this.cancelButtonEl.textContent=this.localized.cancelButton,this.postButtonEl=this.getButton(s.Nb),this.postButtonEl.textContent=this.localized.doneButton||"Done",this.undoButtonEl=this.getButton(s.Pb),this.redoButtonEl=this.getButton(s.Ob)}},{key:"bindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.addEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.addEventListener("click",this.handleSelection)}},{key:"unbindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.removeEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.removeEventListener("click",this.handleSelection)}},{key:"bindListeners",value:function(){h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"bindListeners",this).call(this),this.unbindDOMListeners()}},{key:"unbindListeners",value:function(){h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"unbindListeners",this).call(this),this.bindDOMListeners(),Object(a.g)(this.undoButtonEl),Object(a.g)(this.redoButtonEl)}},{key:"stopPropagation",value:function(t){Object(a.k)(t.target,s.A)&&t.stopPropagation()}},{key:"cancelDrawing",value:function(){this.currentThread&&this.currentThread.cancelUnsavedAnnotation(),this.currentThread=void 0,this.toggleMode()}},{key:"postDrawing",value:function(){this.currentThread&&this.currentThread.state===s.gc.pending&&this.saveThread(this.currentThread),this.currentThread=void 0,this.toggleMode()}},{key:"undoDrawing",value:function(){this.currentThread&&this.currentThread.undo()}},{key:"redoDrawing",value:function(){this.currentThread&&this.currentThread.redo()}},{key:"setupHandlers",value:function(){var t=this;this.locationFunction=function(e){return t.annotator.getLocationFromEvent(e,s.ic.point)},this.stopPropagation=this.stopPropagation.bind(this),this.drawingStartHandler=this.drawingStartHandler.bind(this),this.cancelDrawing=this.cancelDrawing.bind(this),this.postDrawing=this.postDrawing.bind(this),this.undoDrawing=this.undoDrawing.bind(this),this.redoDrawing=this.redoDrawing.bind(this),this.pushElementHandler(this.annotatedElement,"click",this.stopPropagation,!0),this.pushElementHandler(this.cancelButtonEl,"click",this.cancelDrawing),this.pushElementHandler(this.postButtonEl,"click",this.postDrawing),this.pushElementHandler(this.undoButtonEl,"click",this.undoDrawing),this.pushElementHandler(this.redoButtonEl,"click",this.redoDrawing),this.pushElementHandler(this.annotatedElement,["mousedown","touchstart"],this.drawingStartHandler,!0)}},{key:"drawingStartHandler",value:function(t){var e=this;t.stopPropagation(),t.preventDefault();var n=this.annotator.getLocationFromEvent(t,s.ic.point);if(n)if(this.currentThread)this.currentThread.handleStart(n);else{n.minX=n.x,n.maxX=n.x,n.minY=n.y,n.maxY=n.y;var i=this.annotator.createAnnotationThread([],n,s.ic.draw);i&&(this.currentThread=i,this.emit(s.hc.pending,i.getThreadEventData()),i.bindDrawingListeners(this.locationFunction),i.addListener("threadevent",function(t){return e.handleThreadEvents(i,t)}),i.handleStart(n))}}},{key:"exit",value:function(){this.annotatedElement.classList.remove(s.s),h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"exit",this).call(this)}},{key:"enter",value:function(){h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"enter",this).call(this),Object(a.H)(this.headerElement,s.cc),this.annotatedElement.classList.add(s.s)}},{key:"handleThreadEvents",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=n.eventData;switch(n.event){case"softcommit":t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),this.currentThread=void 0,this.saveThread(t),this.unbindListeners(),this.bindListeners(),i&&i.location&&this.currentThread.handleStart(i.location);break;case"dialogdelete":if(!t||!t.dialog)return;if(this.currentThread=void 0,t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),t.state===s.gc.pending)t.destroy(),this.unbindListeners(),this.bindListeners();else{t.deleteThread(),this.unregisterThread(t);var o=t.location.page;this.threads[o].all().forEach(function(t){return t.show()})}break;case"availableactions":this.updateUndoRedoButtonEls(i.undo,i.redo)}h(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"handleThreadEvents",this).call(this,t,n)}},{key:"handleSelection",value:function(t){var e=this.currentThread&&this.currentThread.state===s.gc.pending;if(!(!t||t.target&&"BUTTON"===t.target.nodeName||e)){t.stopPropagation();var n=this.getIntersectingThreads(t);if(this.removeSelection(),0!==n.length){var i=n[Math.floor(Math.random()*n.length)];this.select(i)}else this.selectedThread=void 0}}},{key:"renderPage",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');(Object(a.c)(e,s.u),this.threads&&this.threads[t])&&(this.threads[t].all()||[]).forEach(function(t){return t.show()})}},{key:"removeSelection",value:function(){this.selectedThread&&(this.selectedThread.clearBoundary(),this.selectedThread=void 0)}},{key:"select",value:function(t){t.drawBoundary(),this.selectedThread=t}},{key:"updateUndoRedoButtonEls",value:function(t,e){this.undoButtonEl&&(1===t?Object(a.h)(this.undoButtonEl):0===t&&Object(a.g)(this.undoButtonEl)),this.redoButtonEl&&(1===e?Object(a.h)(this.redoButtonEl):0===e&&Object(a.g)(this.redoButtonEl))}},{key:"saveThread",value:function(t){t&&Object(a.w)(t)&&(t.saveAnnotation(s.ic.draw),this.registerThread(t))}}]),e}();e.a=c},function(t,e,n){"use strict";t.exports=o,t.exports.default=o;var i=n(39);function o(t,e){if(!(this instanceof o))return new o(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function r(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function a(t,e){s(t,0,t.children.length,e,t)}function s(t,e,n,i,o){o||(o=g(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,a=e;a<n;a++)r=t.children[a],l(o,t.leaf?i(r):r);return o}function l(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function h(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function u(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function d(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function p(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function g(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(t,e,n,o,r){for(var a,s=[e,n];s.length;)(n=s.pop())-(e=s.pop())<=o||(a=e+Math.ceil((n-e)/o/2)*o,i(t,a,e,n,r),s.push(e,a,a,n))}o.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],i=this.toBBox;if(!p(t,e))return n;for(var o,r,a,s,l=[];e;){for(o=0,r=e.children.length;o<r;o++)a=e.children[o],p(t,s=e.leaf?i(a):a)&&(e.leaf?n.push(a):f(t,s)?this._all(a,n):l.push(a));e=l.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!p(t,e))return!1;for(var i,o,r,a,s=[];e;){for(i=0,o=e.children.length;i<o;i++)if(r=e.children[i],p(t,a=e.leaf?n(r):r)){if(e.leaf||f(t,a))return!0;s.push(r)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var o=this.data;this.data=i,i=o}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=g([]),this},remove:function(t,e){if(!t)return this;for(var n,i,o,a,s=this.data,l=this.toBBox(t),h=[],c=[];s||h.length;){if(s||(s=h.pop(),i=h[h.length-1],n=c.pop(),a=!0),s.leaf&&-1!==(o=r(t,s.children,e)))return s.children.splice(o,1),h.push(s),this._condense(h),this;a||s.leaf||!f(s,l)?i?(n++,s=i.children[n],a=!1):s=null:(h.push(s),c.push(n),n=0,i=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:h,compareMinY:c,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,i){var o,r=n-e+1,s=this._maxEntries;if(r<=s)return a(o=g(t.slice(e,n+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),(o=g([])).leaf=!1,o.height=i;var l,h,c,u,d=Math.ceil(r/s),f=d*Math.ceil(Math.sqrt(s));for(m(t,e,n,f,this.compareMinX),l=e;l<=n;l+=f)for(m(t,l,c=Math.min(l+f-1,n),d,this.compareMinY),h=l;h<=c;h+=d)u=Math.min(h+d-1,c),o.children.push(this._build(t,h,u,i-1));return a(o,this.toBBox),o},_chooseSubtree:function(t,e,n,i){for(var o,r,a,s,l,h,c,d,f,p;i.push(e),!e.leaf&&i.length-1!==n;){for(c=d=1/0,o=0,r=e.children.length;o<r;o++)l=u(a=e.children[o]),f=t,p=a,(h=(Math.max(p.maxX,f.maxX)-Math.min(p.minX,f.minX))*(Math.max(p.maxY,f.maxY)-Math.min(p.minY,f.minY))-l)<d?(d=h,c=l<c?l:c,s=a):h===d&&l<c&&(c=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,n){var i=this.toBBox,o=n?t:i(t),r=[],a=this._chooseSubtree(o,this.data,e,r);for(a.children.push(t),l(a,o);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)},_split:function(t,e){var n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);var r=this._chooseSplitIndex(n,o,i),s=g(n.children.splice(r,n.children.length-r));s.height=n.height,s.leaf=n.leaf,a(n,this.toBBox),a(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)},_splitRoot:function(t,e){this.data=g([t,e]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var i,o,r,a,l,h,c,d,f,p,g,m,v,y;for(h=c=1/0,i=e;i<=n-e;i++)o=s(t,0,i,this.toBBox),r=s(t,i,n,this.toBBox),f=o,p=r,void 0,void 0,void 0,void 0,g=Math.max(f.minX,p.minX),m=Math.max(f.minY,p.minY),v=Math.min(f.maxX,p.maxX),y=Math.min(f.maxY,p.maxY),a=Math.max(0,v-g)*Math.max(0,y-m),l=u(o)+u(r),a<h?(h=a,d=i,c=l<c?l:c):a===h&&l<c&&(c=l,d=i);return d},_chooseSplitAxis:function(t,e,n){var i=t.leaf?this.compareMinX:h,o=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,o)&&t.children.sort(i)},_allDistMargin:function(t,e,n,i){t.children.sort(i);var o,r,a=this.toBBox,h=s(t,0,e,a),c=s(t,n-e,n,a),u=d(h)+d(c);for(o=e;o<n-e;o++)r=t.children[o],l(h,t.leaf?a(r):r),u+=d(h);for(o=n-e-1;o>=e;o--)r=t.children[o],l(c,t.leaf?a(r):r),u+=d(c);return u},_adjustParentBBoxes:function(t,e,n){for(var i=n;i>=0;i--)l(e[i],t)},_condense:function(t){for(var e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():a(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-draw-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-draw-undo-redo-container">\n        <button class="bp-btn-plain ba-btn-annotate-draw-undo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false" style="z-index: 1">\n                <path d="M2,10a6.22,6.22,0,0,0,6,6A6,6,0,0,0,8,4V6L3,3,8,0V2A8,8,0,0,1,8,18a8.16,8.16,0,0,1-5.49-2A7.83,7.83,0,0,1,0,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n        <button class="bp-btn-plain ba-btn-annotate-draw-redo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false">\n                <path d="M14,10a6.22,6.22,0,0,1-6,6A6,6,0,0,1,8,4V6l5-3L8,0V2A8,8,0,1,0,8,18a8.16,8.16,0,0,0,5.49-2A7.83,7.83,0,0,0,16,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n    </div>\n    <div class="ba-mode-header-btn-container ba-draw-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-draw-cancel"></button>\n        <button class="bp-btn ba-btn-annotate-draw-post"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";var i=n(8),o=n(28),r=n.n(o),a=n(0),s=n(11),l=n(1),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),c=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var u=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,i["a"]),h(e,[{key:"init",value:function(t){c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this,t),("none"!==t.options.header||this.headerElement)&&this.setupHeader(this.headerElement,r.a)}},{key:"setupHeader",value:function(t,n){c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setupHeader",this).call(this,t,n),this.exitButtonEl=this.getButton(a.Qb),this.exitButtonEl.textContent=this.localized.closeButton||"Close"}},{key:"setupSharedDialog",value:function(t,e){var n=this;this.createDialog=new s.a(t,{isMobile:e.isMobile,hasTouch:e.hasTouch,localized:e.localized}),this.createDialog.createElement(),this.onDialogCancel=this.onDialogCancel.bind(this),this.onDialogPost=this.onDialogPost.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this),this.createDialog.addListener(a.gb.init,function(){return n.emit(a.hc.pending,a.ic.point)}),this.createDialog.addListener(a.gb.cancel,this.onDialogCancel),this.createDialog.addListener(a.gb.post,this.onDialogPost)}},{key:"onDialogCancel",value:function(){var t=this.getThreadByID(this.pendingThreadID);this.unregisterThread(t),t.destroy(),this.hideSharedDialog()}},{key:"onDialogPost",value:function(t){this.emit(a.fb.createThread,{commentText:t,lastPointEvent:this.lastPointEvent,pendingThreadID:this.pendingThreadID}),this.hideSharedDialog()}},{key:"hideSharedDialog",value:function(){this.lastPointEvent=null,this.pendingThreadID=null,this.createDialog&&this.createDialog.isVisible&&this.createDialog.hide()}},{key:"setupHandlers",value:function(){this.pointClickHandler=this.pointClickHandler.bind(this),this.pushElementHandler(this.annotatedElement,["click","touchstart"],this.pointClickHandler,!0),this.pushElementHandler(this.exitButtonEl,"click",this.toggleMode)}},{key:"exit",value:function(){this.createDialog&&this.createDialog.hide(),this.buttonEl&&this.buttonEl.classList.remove(a.c),this.annotatedElement.classList.remove(a.B),c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"exit",this).call(this)}},{key:"enter",value:function(){c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"enter",this).call(this),Object(l.H)(this.headerElement,a.fc),this.annotatedElement.classList.add(a.B),this.buttonEl&&this.buttonEl.classList.add(a.c)}},{key:"pointClickHandler",value:function(t){if(Object(l.C)(t)||(t.stopPropagation(),t.preventDefault()),!Object(l.D)(t)){this.isMobile&&this.emit(a.fb.resetMobileDialog),this.hadPendingThreads=this.destroyPendingThreads();var e=this.annotator.getLocationFromEvent(t,a.ic.point);if(e){var n=this.annotator.createAnnotationThread([],e,a.ic.point);n?(this.isMobile&&(this.lastPointEvent=t,this.container.appendChild(this.createDialog.containerEl),this.createDialog.show(this.container),this.createDialog.showCommentBox()),this.pendingThreadID=n.threadID,n.show(),this.registerThread(n),this.emit(a.hc.pending,n.getThreadEventData())):this.hideSharedDialog()}else this.hideSharedDialog()}}}]),e}();e.a=u},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-point-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-point-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-point-exit"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";var i=n(7),o=n.n(i),r=(n(34),n(35),n(36),n(9)),a=n(4),s=n(5),l=n(1),h=n(0),c=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=30,d=4/3,f=.75;h.ib,h.jb,h.pb,h.hb,h.rb,h.kb,h.tb,h.mb,h.sb,h.ob,h.lb,h.nb;function p(t,e,n){for(var i=!1,o=-1,r=t.length,a=r-1;++o<r;a=o)(t[o][1]<=n&&n<t[a][1]||t[a][1]<=n&&n<t[o][1])&&e<(t[a][0]-t[o][0])*(n-t[o][1])/(t[a][1]-t[o][1])+t[o][0]&&(i=!i);return i}function g(){var t=window.getSelection();return!(!t||t.isCollapsed||t.rangeCount<1)}function m(t,e,n){var i=t.map(function(t){return t*d*n});if(2===i.length){var o=c(i,2);return[o[0],e-o[1]]}var r=c(i,8);return[r[0],e-r[1],r[2],e-r[3],r[4],e-r[5],r[6],e-r[7]]}function v(t,e,n){var i=[];if(2===t.length){var o=c(t,2);i=[o[0],e-o[1]]}else{var r=c(t,8);i=[r[0],e-r[1],r[2],e-r[3],r[4],e-r[5],r[6],e-r[7]]}return i.map(function(t){return(t*f/n).toFixed(4)})}function y(t,e){var n=(e.querySelector('[data-page-number="'+t.page+'"]')||e).getBoundingClientRect(),i=n.height-h.Bb-h.Ab,o=l.v(e),r=t.x,a=t.y,s=l.q(t.dimensions,n,o,u);return s&&(r*=s.x,a*=s.y),m([r,a],i,o)}function b(t){var e=c(t[t.length-1],8),n=e[0],i=e[1],o=e[2],r=e[3],a=e[4],s=e[5],l=e[6],h=e[7];return[Math.max(n,o,a,l),Math.min(i,r,s,h)]}function E(t){return!(t.rangeCount<=0||t.isCollapsed||""===t.toString())}function w(t,e){var n=t.getBoundingClientRect(),i=window.devicePixelRatio||1,o=n.width,r=n.height-h.Bb-h.Ab,a=e;(a.width=i*o,a.height=i*r,1!==i)&&(a.style.width=o+"px",a.style.height=r+"px",e.getContext("2d").scale(i,i));return a}function C(t,e){if(!t)return null;var n=t.querySelector("canvas."+e);if(n)return n.getContext("2d");(n=document.createElement("canvas")).classList.add(e),n=w(t,n);var i=t.querySelector(".textLayer"),o=t.querySelector(".canvasWrapper");return i?t.insertBefore(n,i):o&&o.appendChild(n),n.getContext("2d")}function O(t,e){return t.querySelector('[data-page-number="'+e+'"]')}var x=n(2),T=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),S=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var k=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.mousedownHandler=n.mousedownHandler.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,s["a"]),_(e,[{key:"addAnnotation",value:function(t){if(""===t.text&&"0"!==t.user.id){var n=this.highlightDialogEl.querySelector("."+h.R);n.textContent=l.I(this.localized.whoHighlighted,[t.user.name]),l.M(n),this.isMobile||this.position()}S(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"addAnnotation",this).call(this,t)}},{key:"removeAnnotation",value:function(t){var e=this.commentsDialogEl.querySelector('[data-annotation-id="'+t+'"]');e&&(e.parentNode.removeChild(e),this.deactivateReply())}},{key:"postAnnotation",value:function(t){var n=this.element.querySelector(h.Wb);""!==(t||n.value).trim()&&(this.element.querySelector(h.ec)&&(l.M(h.Y),this.element.classList.remove(h.z)),S(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"postAnnotation",this).call(this,t))}},{key:"hideCommentsDialog",value:function(){this.commentsDialogEl&&this.highlightDialogEl&&(this.commentsDialogEl.classList.contains(h.O)||(l.x(this.commentsDialogEl),this.element.classList.add(h.Q),l.M(this.highlightDialogEl),this.hasComments=!1))}},{key:"drawAnnotation",value:function(){this.emit("annotationdraw"),this.toggleHighlight()}},{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),e=t.getBoundingClientRect(),n=e.height-15-15,i=this.getScaledPDFCoordinates(e,n),o=T(i,2),r=o[0],a=o[1];t.appendChild(this.element);var s=l.p(this.element),h=r-s/2,c=this.hasComments?a-10:a;c-=10,this.hasComments&&(this.element.style.borderTopWidth="30px"),h=l.J(this.element,h,s,r,e.width),c<0?c=0:c+38>n&&(c=n-38),this.element.style.left=h+"px",this.element.style.top=c+15+"px",this.fitDialogHeightInPage(),l.M(this.element)}},{key:"toggleHighlightDialogs",value:function(){if(this.commentsDialogEl&&this.highlightDialogEl){if(this.commentsDialogEl.classList.contains(h.O))this.element.classList.remove(h.Q),l.x(this.highlightDialogEl),this.element.classList.add(h.o),l.M(this.commentsDialogEl),this.hasComments=!0,this.dialogEl.querySelector(h.Wb).classList.add(h.c);else this.element.classList.remove(h.o),l.x(this.commentsDialogEl),this.element.classList.add(h.Q),l.M(this.highlightDialogEl),this.hasComments=!1;this.isMobile||this.position()}}},{key:"toggleHighlightCommentsReply",value:function(t){var e=this.commentsDialogEl.querySelector(h.Gb),n=this.commentsDialogEl.querySelector(h.Hb);t?(l.x(e),l.M(n),this.deactivateReply()):(l.x(n),l.M(e),this.activateReply()),this.isMobile||this.position()}},{key:"setup",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.element||(this.element=document.createElement("div"));var n=l.r(t);n&&(this.hasComments=""!==n.text||Object.keys(t).length>1);var i=n?n.permissions.can_delete:this.canAnnotate;if(this.highlightDialogEl=this.generateHighlightDialogEl(i,e),this.highlightDialogEl.classList.add(h.t),this.commentsDialogEl=this.generateDialogEl(Object.keys(t).length),this.commentsDialogEl.classList.add(h.n),this.dialogEl=document.createElement("div"),this.dialogEl.appendChild(this.highlightDialogEl),this.dialogEl.appendChild(this.commentsDialogEl),this.hasComments?this.highlightDialogEl.classList.add(h.O):this.commentsDialogEl.classList.add(h.O),this.isMobile||(this.element.setAttribute("data-type",h.ib),this.element.classList.add(h.o),this.element.classList.add(h.O),this.element.innerHTML='<div class="'+h.l+'"></div>',this.element.appendChild(this.dialogEl),n&&(this.element.dataset.threadNumber=n.threadNumber)),n&&this.dialogEl.classList.add(h.db),l.F(t)&&n&&"0"!==n.user.id){var o=this.highlightDialogEl.querySelector("."+h.R);o.textContent=l.I(this.localized.whoHighlighted,[n.user.name]),l.M(o)}this.addSortedAnnotations(t),!this.isMobile&&this.canAnnotate&&this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("mousedown",this.mousedownHandler),this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("mouseup",this.stopPropagation),this.element.addEventListener("wheel",this.stopPropagation)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("mousedown",this.mousedownHandler),this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation)}},{key:"toggleHighlightIcon",value:function(t){var e=this.dialogEl.querySelector(h.Jb);e&&(t===h.yb.active?e.classList.add(h.c):e.classList.remove(h.c))}},{key:"keydownHandler",value:function(t){t.stopPropagation(),"Enter"===l.f(t)&&this.mousedownHandler(t),S(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"keydownHandler",this).call(this,t)}},{key:"mousedownHandler",value:function(t){switch(t.stopPropagation(),l.j(t.target)){case h.pb:this.drawAnnotation();break;case h.hb:this.emit("annotationdraw"),this.toggleHighlightCommentsReply(!1),this.toggleHighlightDialogs(),t.preventDefault(),this.focusAnnotationsTextArea();break;default:S(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"clickHandler",this).call(this,t)}}},{key:"toggleHighlight",value:function(){this.dialogEl.classList.contains(h.db)?(this.hasComments=!0,this.emit("annotationdelete")):(this.hasComments=!1,this.dialogEl.classList.add(h.db),this.emit("annotationcreate"))}},{key:"focusAnnotationsTextArea",value:function(){var t=this.dialogEl.querySelector(h.Wb);l.A(t)&&t.focus()}},{key:"getScaledPDFCoordinates",value:function(t,e){var n=l.v(this.annotatedElement),i=b(this.location.quadPoints),o=T(i,2),r=o[0],a=o[1],s=l.q(this.location.dimensions,t,n,30);return s&&(r*=s.x,a*=s.y),m([r,a],e,n)}},{key:"addAnnotationElement",value:function(t){""===t.text?this.highlightDialogEl.dataset.annotationId=t.annotationID:S(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"addAnnotationElement",this).call(this,t)}},{key:"generateHighlightDialogEl",value:function(t,e){var n=document.createElement("div"),i=document.createElement("span");if(i.classList.add(h.R),i.classList.add(h.O),n.appendChild(i),!this.canAnnotate)return n;var o=document.createElement("span");if(o.classList.add(h.P),n.appendChild(o),t){var r=l.m([h.G,h.e],this.localized.highlightToggle,x.e,h.pb);o.appendChild(r)}if(e){var a=l.m([h.G,h.f],this.localized.highlightComment,x.f,h.hb);o.appendChild(a)}return n}}]),e}(),A=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),R=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),D=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};function P(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var L=function(t){function e(t,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.showComment=n,i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,a["a"]),R(e,[{key:"cancelFirstComment",value:function(){l.F(this.annotations)&&(this.type=h.ic.highlight),this.reset(),this.isMobile?this.hideDialog():l.F(this.annotations)?this.dialog.toggleHighlightDialogs():this.destroy()}},{key:"destroy",value:function(){D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this.state===h.gc.pending&&window.getSelection().removeAllRanges(),this.emit(h.hc.threadCleanup)}},{key:"hide",value:function(){this.draw(h.yb.erase)}},{key:"reset",value:function(){this.state=h.gc.inactive,this.show()}},{key:"saveAnnotation",value:function(t,n){D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"saveAnnotation",this).call(this,t,n),window.getSelection().removeAllRanges()}},{key:"deleteAnnotation",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];D(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteAnnotation",this).call(this,t,n);var i=l.r(this.annotations);if(i&&((""!==i.text||Object.keys(this.annotations).length>1)&&i.permissions&&!i.permissions.can_delete)){var o=this.dialog.element.querySelector(h.Jb);l.x(o)}}},{key:"onMousedown",value:function(){this.state===h.gc.pending&&this.destroy()}},{key:"onClick",value:function(t,e){return!e&&this.isOnHighlight(t)?(this.state=h.gc.hover,this.show(),!0):(this.reset(),!1)}},{key:"isOnHighlight",value:function(t){return l.D(t)||this.isInHighlight(t)}},{key:"show",value:function(){switch(this.state){case h.gc.pending:this.showDialog();break;case h.gc.inactive:this.hideDialog(),this.draw(h.yb.normal);break;case h.gc.hover:case h.gc.pending_active:this.showDialog(),this.draw(h.yb.active)}}},{key:"showDialog",value:function(){this.dialog&&(this.dialog.element||this.dialog.setup(this.annotations,this.showComment),this.dialog.show())}},{key:"createDialog",value:function(){this.dialog=new k({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate});var t=l.r(this.annotations);t&&((""!==t.text||Object.keys(this.annotations).length>1)&&this.type===h.ic.highlight&&(this.type=h.ic.highlight_comment))}},{key:"setupElement",value:function(){}},{key:"handleDraw",value:function(){this.state=h.gc.pending_active,window.getSelection().removeAllRanges(),this.show()}},{key:"handleCommentPending",value:function(){this.state=h.gc.pending_active}},{key:"handleCreate",value:function(t){t?(this.type=h.ic.highlight_comment,this.dialog.toggleHighlightCommentsReply(Object.keys(this.annotations).length)):this.type=h.ic.highlight,this.saveAnnotation(this.type,t?t.text:"")}},{key:"handleDelete",value:function(t){if(t)this.deleteAnnotation(t.annotationID);else{var e=l.r(this.annotations);e&&this.deleteAnnotation(e.annotationID)}}},{key:"bindCustomListenersOnDialog",value:function(){this.handleDraw=this.handleDraw.bind(this),this.handleCommentPending=this.handleCommentPending.bind(this),this.handleCreate=this.handleCreate.bind(this),this.handleDelete=this.handleDelete.bind(this),this.cancelFirstComment=this.cancelFirstComment.bind(this),this.dialog.addListener("annotationdraw",this.handleDraw),this.dialog.addListener("annotationcommentpending",this.handleCommentPending),this.dialog.addListener("annotationcreate",this.handleCreate),this.dialog.addListener("annotationcancel",this.cancelFirstComment),this.dialog.addListener("annotationdelete",this.handleDelete)}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog.removeAllListeners("annotationdraw"),this.dialog.removeAllListeners("annotationcommentpending"),this.dialog.removeAllListeners("annotationcreate"),this.dialog.removeAllListeners("annotationcancel"),this.dialog.removeAllListeners("annotationdelete")}},{key:"scrollIntoView",value:function(){this.scrollToPage();var t=b(this.location.quadPoints),e=A(t,1)[0];this.adjustScroll(this.annotatedElement.scrollTop+e)}},{key:"draw",value:function(t){var e=this,n=this.getPageEl(),i=this.type===h.ic.highlight?C(n,h.w):C(n,h.x);if(i){var o=n.getBoundingClientRect(),r=o.height-h.Bb-h.Ab,a=l.v(this.annotatedElement),s=l.q(this.location.dimensions,o,a,h.Bb+h.Ab);this.location.quadPoints.forEach(function(n){var o=n;s&&(o=n.map(function(t,e){return e%2?t*s.y:t*s.x}));var l=m(o,r,a),c=A(l,8),u=c[0],d=c[1],f=c[2],p=c[3],g=c[4],v=c[5],y=c[6],b=c[7];i.fillStyle=t,i.beginPath(),i.moveTo(u,d),i.lineTo(f,p),i.lineTo(g,v),i.lineTo(y,b),i.closePath(),i.save(),i.globalCompositeOperation="destination-out",i.fillStyle=h.yb.erase,i.fill(),i.restore(),t!==h.yb.erase&&(i.fill(),e.dialog&&e.dialog.element&&e.dialog.toggleHighlightIcon(t))})}}},{key:"isInHighlight",value:function(t){for(var e=this.getPageEl().getBoundingClientRect(),n=e.height-h.Bb-h.Ab,i=e.top+h.Bb,o=l.v(this.annotatedElement),r=l.q(this.location.dimensions,e,o,h.Bb+h.Ab),a=function(t,e){return e%2?t*r.y:t*r.x},s=t.clientX-e.left,c=t.clientY-i,u=!1,d=this.location.quadPoints,f=d.length,g=0;g<f&&!u;){var v=d[g],y=[].concat(P(v));if(r)for(var b=v.length,E=0;E<b;E++)y[E]=a(v[E],E);var w=m(y,n,o),C=A(w,8);u=p([[C[0],C[1]],[C[2],C[3]],[C[4],C[5]],[C[6],C[7]]],s,c),g+=1}return u}},{key:"getPageEl",value:function(){return this.pageEl||(this.pageEl=O(this.annotatedElement,this.location.page)),this.pageEl}},{key:"regenerateBoundary",value:function(){var t=this;this.location&&this.location.quadPoints&&(this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0,this.location.quadPoints.forEach(function(e){var n=A(e,8),i=n[0],o=n[1],r=n[2],a=n[3],s=n[4],l=n[5],h=n[6],c=n[7];t.minX=Math.min(i,r,s,h,t.minX),t.maxX=Math.max(i,r,s,h,t.maxX),t.minY=Math.min(o,a,l,c,t.minY),t.maxY=Math.max(o,a,l,c,t.maxY)}))}}]),e}(),N=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var M=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,s["a"]),N(e,[{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement;t.appendChild(this.element),l.M(this.element);var e=this.element.getBoundingClientRect().width,n=t.getBoundingClientRect(),i=this.threadEl.offsetLeft+12,o=i-e/2,r=this.threadEl.offsetTop+31;o=l.J(this.element,o,e,i,n.width),this.element.style.left=o-1+"px";var a=n.height+15,s=this.flipDialog(r,a+31);this.element.style.top=s.top,this.element.style.bottom=s.bottom}}]),e}(),B=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),j=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var H=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,a["a"]),j(e,[{key:"showDialog",value:function(){this.permissions.canAnnotate&&g()||function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0}(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"showDialog",this).call(this)}},{key:"show",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement,e=y(this.location,this.annotatedElement),n=B(e,2),i=n[0],o=n[1];this.element.style.left=i-12+"px",this.element.style.top=o-31+4+15+"px",t.appendChild(this.element),l.M(this.element),this.state!==h.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new M({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),e}(),I=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var F=function(){function t(e){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.path=[],this.browserPath=[],this.maxX=-1/0,this.maxY=-1/0,this.minX=1/0,this.minY=1/0,e&&(this.path=e.path.map(function(t){var e=+t.x,i=+t.y;return n.minX=Math.min(n.minX,e),n.maxX=Math.max(n.maxX,e),n.minY=Math.min(n.minY,i),n.maxY=Math.max(n.maxY,i),Object(l.e)(e,i)}))}return I(t,[{key:"addCoordinate",value:function(t,e){if(t&&t.x&&t.y){var n=Object(l.L)(t.x,2),i=Object(l.L)(t.y,2);n<this.minX&&(this.minX=n),i<this.minY&&(this.minY=i),i>this.maxY&&(this.maxY=i),n>this.maxX&&(this.maxX=n),this.path.push(Object(l.e)(n,i)),e&&e.x&&e.y&&this.browserPath.push(e)}}},{key:"isEmpty",value:function(){return 0===this.path.length}},{key:"drawPath",value:function(t){var e=t;if(e&&this.browserPath)for(var n=this.browserPath.length,i=0;i<n;i++){var o=void 0,r=void 0;i>0?(o=this.browserPath[i-1].x,r=this.browserPath[i-1].y):(o=this.browserPath[i].x,r=this.browserPath[i].y,e.moveTo(o,r));var a=(this.browserPath[i].x+o)/2,s=(this.browserPath[i].y+r)/2;e.quadraticCurveTo(o,r,a,s)}}},{key:"generateBrowserPath",value:function(t){this.path&&(this.browserPath=this.path.map(t))}}],[{key:"extractDrawingInfo",value:function(t,e){var n=e.paths,i={path:t.path};return n?n.push(i):n=[i],{minX:e.minX?Math.min(e.minX,t.minX):t.minX,maxX:e.maxX?Math.max(e.maxX,t.maxX):t.maxX,minY:e.minY?Math.min(e.minY,t.minY):t.minY,maxY:e.maxY?Math.max(e.maxY,t.maxY):t.maxY,paths:n}}}]),t}(),q=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var z=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.undoStack=[],this.redoStack=[]}return q(t,[{key:"destroy",value:function(){this.undoStack=[],this.redoStack=[]}},{key:"insert",value:function(t){this.undoStack.push(t),this.redoStack=[]}},{key:"undo",value:function(){if(this.isEmpty())return!1;var t=this.undoStack.pop();return this.redoStack.push(t),!0}},{key:"redo",value:function(){if(0===this.redoStack.length)return!1;var t=this.redoStack.pop();return this.undoStack.push(t),!0}},{key:"isEmpty",value:function(){return 0===this.undoStack.length}},{key:"getNumberOfItems",value:function(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length}}},{key:"getItems",value:function(){return this.undoStack.slice()}},{key:"getAxisAlignedBoundingBox",value:function(){var t={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,paths:[]};return this.getItems().forEach(function(e){t.minX=Math.min(t.minX,e.minX),t.maxX=Math.max(t.maxX,e.maxX),t.minY=Math.min(t.minY,e.minY),t.maxY=Math.max(t.maxY,e.maxY),t.paths.push({path:e.path})}),t}},{key:"applyToItems",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.undoStack.forEach(t),e&&this.redoStack.forEach(t)}}]),t}(),Y=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),X=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),W=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var U=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.drawingFlag=h.xb.idle,n.pathContainer=new z,n.state=h.gc.inactive,n.render=n.render.bind(n),n.handleStart=n.handleStart.bind(n),n.handleMove=n.handleMove.bind(n),n.handleStop=n.handleStop.bind(n),n.undo=n.undo.bind(n),n.redo=n.redo.bind(n),n.location&&n.location.paths&&(n.regenerateBoundary(),n.dialog&&n.pathContainer.isEmpty()&&n.dialog.hide(),n.location.paths.forEach(function(t){var e=new F(t);n.pathContainer.insert(e)})),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,a["a"]),X(e,[{key:"destroy",value:function(){this.lastAnimationRequestId&&window.cancelAnimationFrame(this.lastAnimationRequestId),this.dialog&&(this.dialog.destroy(),this.dialog=null),W(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this.state!==h.gc.pending&&this.emit(h.hc.threadCleanup),this.reset()}},{key:"reset",value:function(){W(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"reset",this).call(this),this.clearBoundary()}},{key:"bindDrawingListeners",value:function(t){this.isMobile||(this.annotatedElement.addEventListener("mousemove",Object(l.i)(t,this.handleMove)),this.annotatedElement.addEventListener("mouseup",Object(l.i)(t,this.handleStop))),this.hasTouch&&(this.annotatedElement.addEventListener("touchmove",Object(l.i)(t,this.handleMove)),this.annotatedElement.addEventListener("touchcancel",Object(l.i)(t,this.handleStop)),this.annotatedElement.addEventListener("touchend",Object(l.i)(t,this.handleStop)))}},{key:"unbindDrawingListeners",value:function(){this.annotatedElement.removeEventListener("mousemove",l.i),this.annotatedElement.removeEventListener("mouseup",l.i),this.annotatedElement.removeEventListener("touchmove",l.i),this.annotatedElement.removeEventListener("touchcancel",l.i),this.annotatedElement.removeEventListener("touchend",l.i)}},{key:"handleMove",value:function(t){}},{key:"handleStart",value:function(t){}},{key:"handleStop",value:function(t){}},{key:"deleteThread",value:function(){var t=this;Object.keys(this.annotations).forEach(function(e){return t.deleteAnnotationWithID({annotationID:e})});var e=this.getBrowserRectangularBoundary(),n=Y(e,4),i=n[0],o=n[1],r=n[2],a=n[3];this.concreteContext&&this.concreteContext.clearRect(i-h.b,o+h.b,r+2*h.b,a-2*h.b),this.clearBoundary(),this.pathContainer.destroy(),this.pathContainer=null}},{key:"setContextStyles",value:function(t,e){if(this.drawingContext||e){var n=t.scale,i=t.color,o=e||this.drawingContext;o.lineCap="round",o.lineJoin="round",o.strokeStyle=i||"black",o.lineWidth=h.ub*(n||1)}}},{key:"undo",value:function(){this.pathContainer.undo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"redo",value:function(){this.pathContainer.redo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"setup",value:function(){Object(l.r)(this.annotations)?(this.state=h.gc.inactive,this.createDialog()):this.state=h.gc.pending}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t){if(e){var n=t.canvas;t.clearRect(0,0,n.width,n.height)}t.beginPath(),this.pathContainer.applyToItems(function(e){return e.drawPath(t)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.drawPath(t),t.stroke()}}},{key:"emitAvailableActions",value:function(){var t=this.pathContainer.getNumberOfItems();this.emit("availableactions",{undo:t.undoCount,redo:t.redoCount})}},{key:"drawBoundary",value:function(){if(this.location.page){var t=this.getBrowserRectangularBoundary(),e=Y(t,4),n=e[0],i=e[1],o=e[2],r=e[3];this.drawingContext.save(),this.drawingContext.beginPath(),this.drawingContext.lineWidth=this.drawingContext.lineWidth/2,this.drawingContext.setLineDash([h.vb,2*h.vb]),this.drawingContext.rect(n,i,o,r),this.drawingContext.stroke(),this.drawingContext.restore(),this.dialog&&(this.dialog.isVisible()||this.pathContainer.isEmpty()||this.showDialog(),this.dialog.position(n+o,i))}}},{key:"render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.performance.now(),e=!0;t-(this.lastRenderTimestamp||0)>=h.wb&&(this.draw(this.drawingContext,!0),this.drawBoundary(),this.lastRenderTimestamp=t,e=this.drawingFlag===h.xb.drawing),e&&(this.lastAnimationRequestId=window.requestAnimationFrame(this.render))}},{key:"updateBoundary",value:function(t){var e=t?F.extractDrawingInfo(t,this.location):this.pathContainer.getAxisAlignedBoundingBox();Object.assign(this.location,e)}},{key:"regenerateBoundary",value:function(){if(this.location&&!this.location.boundaryData){var t=this.location;this.minX=t.minX,this.maxX=t.maxX,this.minY=t.minY,this.maxY=t.maxY}}},{key:"getBrowserRectangularBoundary",value:function(){}},{key:"clearBoundary",value:function(){if(this.drawingContext){var t=this.drawingContext.canvas;this.drawingContext.clearRect(0,0,t.width,t.height)}this.dialog&&this.dialog.isVisible()&&this.dialog.hide()}}]),e}(),V=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var G=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.visible=!1,n.postDrawing=n.postDrawing.bind(n),n.deleteAnnotation=n.deleteAnnotation.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,s["a"]),V(e,[{key:"destroy",value:function(){this.unbindDOMListeners(),this.removeAllListeners(),this.element&&(this.element.removeEventListener("click",l.G),this.pageEl&&this.pageEl.contains(this.element)&&this.pageEl.removeChild(this.element),this.element=null)}},{key:"isVisible",value:function(){return this.visible}},{key:"addAnnotation",value:function(t){this.element||this.setup([t]),this.assignDrawingLabel(t)}},{key:"removeAnnotation",value:function(){}},{key:"bindDOMListeners",value:function(){this.commitButtonEl&&(this.isMobile||this.commitButtonEl.addEventListener("click",this.postDrawing),this.hasTouch&&this.commitButtonEl.addEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.isMobile||this.deleteButtonEl.addEventListener("click",this.deleteAnnotation),this.hasTouch&&this.deleteButtonEl.addEventListener("touchend",this.deleteAnnotation))}},{key:"unbindDOMListeners",value:function(){this.commitButtonEl&&(this.commitButtonEl.removeEventListener("click",this.postDrawing),this.commitButtonEl.removeEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.deleteButtonEl.removeEventListener("click",this.deleteAnnotation),this.deleteButtonEl.removeEventListener("touchend",this.deleteAnnotation))}},{key:"setup",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.element=document.createElement("div"),this.element.addEventListener("click",l.G),this.element.classList.add(h.o),this.drawingDialogEl=this.generateDialogEl(t),this.commitButtonEl=this.drawingDialogEl.querySelector(h.Ib),this.deleteButtonEl=this.drawingDialogEl.querySelector(h.bc),this.bindDOMListeners();var e=l.r(t);e&&this.addAnnotation(e),this.element.appendChild(this.drawingDialogEl)}},{key:"position",value:function(t,e){this.pageEl||(this.pageEl=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')),this.element||this.setup(),this.pageEl.contains(this.element)||this.pageEl.appendChild(this.element);var n=this.element.getBoundingClientRect();this.element.style.left=t-n.width+"px",this.element.style.top=e+"px"}},{key:"hide",value:function(){l.x(this.element),this.visible=!1}},{key:"show",value:function(){l.M(this.element),this.visible=!0}},{key:"generateDialogEl",value:function(t){var e=l.r(t),n=!e,i=n||e&&e.permissions&&e.permissions.can_delete,o=document.createElement("span");o.classList.add(h.p);var r=document.createElement("span");if(r.classList.add(h.r),r.classList.add(h.O),o.appendChild(r),n){var a=l.m([h.G,h.d],this.localized.drawSave,x.d+" "+this.localized.saveButton);o.appendChild(a)}if(i){var s=l.m([h.G,h.L],this.localized.drawDelete,x.c+" "+this.localized.deleteButton);o.appendChild(s)}var c=document.createElement("div");return c.classList.add(h.q),c.appendChild(o),c}},{key:"assignDrawingLabel",value:function(t){if(t&&this.drawingDialogEl&&"0"!==t.user.id){var e=this.drawingDialogEl.querySelector("."+h.r);e.textContent=l.I(this.localized.whoDrew,[t.user.name]),l.M(e)}}},{key:"postDrawing",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationcreate")}},{key:"deleteAnnotation",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationdelete")}}]),e}(),J=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),$=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var Q=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.onPageChange=n.onPageChange.bind(n),n.reconstructBrowserCoordFromLocation=n.reconstructBrowserCoordFromLocation.bind(n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,U),$(e,[{key:"handleMove",value:function(t){if(this.drawingFlag===h.xb.drawing&&t)if(this.hasPageChanged(t))this.onPageChange(t);else{var e=y(t,this.pageEl),n=J(e,2),i=n[0],o=n[1],r=Object(l.e)(i,o);this.pendingPath&&this.pendingPath.addCoordinate(t,r)}}},{key:"handleStart",value:function(t){t&&(this.hasPageChanged(t)?this.onPageChange(t):(this.location&&this.location.page||!t.page||(this.location={page:t.page,dimensions:t.dimensions}),this.checkAndHandleScaleUpdate(),this.drawingFlag=h.xb.drawing,this.pendingPath||(this.pendingPath=new F),this.dialog&&this.dialog.isVisible()&&this.dialog.hide(),this.lastAnimationRequestId=window.requestAnimationFrame(this.render),this.state=h.gc.pending))}},{key:"handleStop",value:function(){window.cancelAnimationFrame(this.lastAnimationRequestId),this.lastAnimationRequestId=0,this.drawingFlag=h.xb.idle,this.pendingPath&&!this.pendingPath.isEmpty()&&(this.dialog||this.createDialog(),this.pathContainer.insert(this.pendingPath),this.updateBoundary(this.pendingPath),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.render(),this.emitAvailableActions(),this.pendingPath=null)}},{key:"hasPageChanged",value:function(t){return!!(t&&this.location&&this.location.page&&this.location.page!==t.page)}},{key:"saveAnnotation",value:function(t,n){this.reset(),this.pathContainer.isEmpty()||(this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0}(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"saveAnnotation",this).call(this,t,n),this.createDialog(),this.show())}},{key:"show",value:function(){var t=this;if(this.annotatedElement&&this.location){var e=this.selectContext();this.dialog&&this.dialog.isVisible()&&(this.drawBoundary(),this.dialog.show()),this.pathContainer.applyToItems(function(e){return e.generateBrowserPath(t.reconstructBrowserCoordFromLocation)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.generateBrowserPath(this.reconstructBrowserCoordFromLocation),this.draw(e,!1)}}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.dialog.addListener("annotationcreate",function(){return t.emit("softcommit")}),this.dialog.addListener("annotationdelete",function(){return t.emit("dialogdelete")}))}},{key:"createDialog",value:function(){this.dialog&&this.dialog.destroy(),this.dialog=new G({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,canAnnotate:this.annotationService.canAnnotate,isMobile:this.isMobile,hasTouch:this.hasTouch}),this.dialog.localized=this.localized,this.bindCustomListenersOnDialog()}},{key:"checkAndHandleScaleUpdate",value:function(){var t=Object(l.v)(this.annotatedElement);if(this.lastScaleFactor!==t&&this.location&&this.location.page){this.lastScaleFactor=t,this.pageEl=O(this.annotatedElement,this.location.page),this.drawingContext=C(this.pageEl,h.v);var e={scale:t};this.setContextStyles(e)}}},{key:"onPageChange",value:function(t){this.handleStop(),this.emit("softcommit",{location:t})}},{key:"reconstructBrowserCoordFromLocation",value:function(t){var e=y(Object(l.e)(t.x,t.y,this.location.dimensions),this.pageEl),n=J(e,2),i=n[0],o=n[1];return Object(l.e)(i,o)}},{key:"selectContext",value:function(){if(this.checkAndHandleScaleUpdate(),this.state===h.gc.pending)return this.drawingContext;var t={scale:this.lastScaleFactor};return this.concreteContext=C(this.pageEl,h.u),this.setContextStyles(t,this.concreteContext),this.concreteContext}},{key:"getBrowserRectangularBoundary",value:function(){if(!this.location||!this.location.dimensions||!this.pageEl)return null;var t=Object(l.e)(this.minX,this.minY,this.location.dimensions),e=Object(l.e)(this.maxX,this.maxY,this.location.dimensions),n=y(t,this.pageEl),i=J(n,2),o=i[0],r=i[1],a=y(e,this.pageEl),s=J(a,2);return[o,r,s[0]-o,s[1]-r]}}]),e}(),K=n(11),Z=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),tt=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var et=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.position={x:0,y:0},i.allowHighlight=n.allowHighlight||!1,i.allowComment=n.allowComment||!1,i.allowHighlight&&(i.onHighlightClick=i.onHighlightClick.bind(i)),i.allowComment&&(i.onCommentClick=i.onCommentClick.bind(i),i.onCommentPost=i.onCommentPost.bind(i),i.onCommentCancel=i.onCommentCancel.bind(i)),i.createElement(),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,K["a"]),Z(e,[{key:"show",value:function(t,n){if(n){var i=Object(l.u)(n.anchorNode);if(i.pageEl){var o=this.isMobile?t:i.pageEl;tt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"show",this).call(this,o),this.parentEl.querySelector(".ba-create-annotation-dialog")||this.parentEl.appendChild(this.containerEl),this.isMobile||this.setPosition(n)}}}},{key:"setPosition",value:function(t){if(t&&t.rangeCount){var n=function(t){var e=t.endContainer,n=t.endOffset,i=document.createElement("span"),o=e.parentNode;if("#text"===e.nodeName){var r=e.splitText(n);o.insertBefore(i,r)}else{var a=e.firstChild,s=e.previousElementSibling;s?s.appendChild(i):a?e.insertBefore(i,a):e.appendChild(i)}var l=i.getBoundingClientRect(),h=l.right,c=l.bottom;return i.parentNode&&i.parentNode.removeChild(i),{x:h,y:c}}(t.getRangeAt(t.rangeCount-1)),i=Object(l.u)(t.anchorNode);if(i.pageEl){var o=i.pageEl.getBoundingClientRect(),r=o.left,a=o.top+h.Bb;tt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setPosition",this).call(this,n.x-r,n.y-a)}}}},{key:"destroy",value:function(){tt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this.highlightCreateEl&&(this.highlightCreateEl.removeEventListener("click",this.onHighlightClick),this.highlightCreateEl.removeEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.removeEventListener("touchend",this.onHighlightClick)),this.commentCreateEl&&(this.commentCreateEl.removeEventListener("click",this.onCommentClick),this.commentCreateEl.removeEventListener("touchstart",this.stopPropagation),this.commentCreateEl.removeEventListener("touchend",this.onCommentClick))}},{key:"updatePosition",value:function(){if(!this.isMobile){var t=Object(l.p)(this.containerEl),e=this.position.x-1-t/2,n=Object(l.J)(this.containerEl,e,78,this.position.x,this.parentEl.clientWidth);this.containerEl.style.left=n+"px",this.containerEl.style.top=this.position.y+5+"px",Object(l.M)(this.containerEl)}}},{key:"onHighlightClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(h.gb.plain)}},{key:"onCommentClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(h.gb.comment),this.commentBox.show(),this.commentBox.focus(),this.setButtonVisibility(!1),this.updatePosition()}},{key:"createElement",value:function(){if(this.containerEl=document.createElement("div"),this.containerEl.classList.add("ba-create-annotation-dialog"),!this.isMobile){var t=document.createElement("div");t.classList.add(h.l),t.left="50%",this.containerEl.appendChild(t)}var e=document.createElement("span");if(e.classList.add(h.P),this.allowHighlight){var n=Object(l.m)([h.G,h.e],this.localized.highlightToggle,x.e,"add-highlight-btn");e.appendChild(n)}var i=document.createElement("div");i.classList.add(h.t),i.appendChild(e),this.containerEl.appendChild(i),this.isMobile&&(this.containerEl.classList.add(h.W),this.containerEl.classList.add(h.o));var o=this.containerEl.querySelector(h.Ub);if(this.buttonsEl=o.querySelector(h.dc),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.allowHighlight&&(this.highlightCreateEl=o.querySelector(h.Jb),this.highlightCreateEl.addEventListener("click",this.onHighlightClick),this.hasTouch&&(this.highlightCreateEl.addEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.addEventListener("touchend",this.onHighlightClick))),this.allowComment){var r=Object(l.m)([h.G,h.f],this.localized.highlightComment,x.f,"add-highlight-comment-btn");e.appendChild(r),this.commentBox=this.setupCommentBox(o),this.commentCreateEl=o.querySelector(h.Kb),this.commentCreateEl.addEventListener("click",this.onCommentClick),this.hasTouch&&(this.commentCreateEl.addEventListener("touchstart",this.stopPropagation),this.commentCreateEl.addEventListener("touchend",this.onCommentClick))}this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation)}}]),e}(),nt=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),it=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),ot=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var rt=[h.w,h.x,h.u],at=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,r["a"]),it(e,[{key:"destroy",value:function(){ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this.createHighlightDialog&&(this.commentHighlightEnabled&&(this.createHighlightDialog.removeListener(h.gb.comment,this.highlightCurrentSelection),this.createHighlightDialog.removeListener(h.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&this.createHighlightDialog.removeListener(h.gb.plain,this.createPlainHighlight),this.createHighlightDialog.destroy(),this.createHighlightDialog=null)}},{key:"init",value:function(t){ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this,t),this.annotatedElement.id="ba-rangy-annotated-element"}},{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-doc")}},{key:"getLocationFromEvent",value:function(t,e){var n=null,i=l.v(this.annotatedElement);if(e===h.ic.point){var o=t;if(this.hasTouch&&t.targetTouches){if(t.targetTouches.length<=0)return n;o=t.targetTouches[0]}var r=o.target,a=l.u(r),s=a.pageEl?a.pageEl:this.annotatedElement.querySelector('[data-page-number="'+a.page+'"]');if(!s)return n;if(g())return n;var u=l.j(r);if(l.D(t)||u===h.jb)return n;var d=s.getBoundingClientRect(),f=d.width,p=d.height-h.Bb-h.Ab,m=[o.clientX-d.left,o.clientY-d.top-h.Bb];if(function(t,e,n){var i=c(t,2),o=i[0],r=i[1];return o<0||o>e||r<0||r>n}(m,f,p))return n;var y=m[0],b=m[1];if(Number.isNaN(y)||Number.isNaN(b))return this.emit(h.a.error,this.localized.createError),n;var E=v(m,p,i),w=nt(E,2);y=w[0],b=w[1];var C={x:f/i,y:p/i};n={x:y,y:b,page:a.page,dimensions:C}}else if(l.B(e)){if(!this.highlighter||!this.highlighter.highlights.length)return n;var O=l.u(window.getSelection().anchorNode),x=O.pageEl,T=O.page;if(!x){var _=l.u(this.annotatedElement.querySelector(".rangy-highlight"));x=_.pageEl,T=_.page}var S=function(t,e){return{highlight:t.highlights[0],highlightEls:[].slice.call(e.querySelectorAll(".rangy-highlight"),0).filter(function(t){return t.tagName&&"SPAN"===t.tagName&&""!==t.textContent.trim()})}}(this.highlighter,x).highlightEls;if(0===S.length)return n;var k=[];S.forEach(function(t){k.push(function(t,e,n){var i=document.createElement("div");i.classList.add(h.T),i.innerHTML=('\n        <div class="'+h.S+' corner1"></div>\n        <div class="'+h.S+' corner2"></div>\n        <div class="'+h.S+' corner3"></div>\n        <div class="'+h.S+' corner4"></div>').trim(),t.appendChild(i);var o=i.querySelector(".corner1"),r=i.querySelector(".corner2"),a=i.querySelector(".corner3"),s=i.querySelector(".corner4"),l=o.getBoundingClientRect(),c=r.getBoundingClientRect(),u=a.getBoundingClientRect(),d=s.getBoundingClientRect(),f=e.getBoundingClientRect(),p=f.height-h.Bb-h.Ab,g=f.left,m=f.top+h.Bb;return t.removeChild(i),v([l.left-g,l.top-m,c.left-g,c.top-m,u.left-g,u.top-m,d.left-g,d.top-m],p,n)}(t,x,i))});var A=x.getBoundingClientRect(),R=A.width,D=A.height-h.Bb-h.Ab;n={page:T,quadPoints:k,dimensions:{x:R/i,y:D/i}}}return n}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0,o=this.getThreadParams(t,e,n);return l.a(o)?(l.B(n)?i=new L(o,this.commentHighlightEnabled):n===h.ic.draw?i=new Q(o):n===h.ic.point&&(i=new H(o)),i||this.emit(h.a.error,this.localized.loadError),i):(this.handleValidationError(),i)}},{key:"renderPage",value:function(t){this.scaleAnnotationCanvases(t),ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"renderPage",this).call(this,t),this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide()}},{key:"scaleAnnotationCanvases",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');rt.forEach(function(t){var n=e.querySelector("canvas."+t);n&&w(e,n)})}},{key:"setupAnnotations",value:function(){var t=this;this.plainHighlightEnabled=!!this.modeControllers[h.ic.highlight],this.commentHighlightEnabled=!!this.modeControllers[h.ic.highlight_comment],this.drawEnabled=!!this.modeControllers[h.ic.draw],this.drawEnabled&&(this.drawingSelectionHandler=this.drawingSelectionHandler.bind(this)),this.plainHighlightEnabled||this.commentHighlightEnabled?(this.highlightCreateHandler=this.highlightCreateHandler.bind(this),this.highlightMouseupHandler=this.highlightMouseupHandler.bind(this),this.highlightMousedownHandler=this.highlightMousedownHandler.bind(this),this.hideCreateDialog=this.hideCreateDialog.bind(this),this.clickThread=this.clickThread.bind(this),(this.isMobile||this.hasTouch)&&(this.onSelectionChange=this.onSelectionChange.bind(this)),this.createHighlightDialog=new et(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,allowComment:this.commentHighlightEnabled,allowHighlight:this.plainHighlightEnabled,localized:this.localized}),this.createHighlightDialog.addListener(h.gb.init,function(){return t.emit(h.hc.pending,h.ic.highlight)}),this.commentHighlightEnabled&&(this.highlightCurrentSelection=this.highlightCurrentSelection.bind(this),this.createHighlightDialog.addListener(h.gb.comment,this.highlightCurrentSelection),this.createHighlightThread=this.createHighlightThread.bind(this),this.createHighlightDialog.addListener(h.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&(this.createPlainHighlight=this.createPlainHighlight.bind(this),this.createHighlightDialog.addListener(h.gb.plain,this.createPlainHighlight)),this.highlighter=o.a.createHighlighter(),this.highlighter.addClassApplier(o.a.createClassApplier("rangy-highlight",{ignoreWhiteSpace:!0,tagNames:["span","a"]})),ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setupAnnotations",this).call(this)):ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setupAnnotations",this).call(this)}},{key:"bindDOMListeners",value:function(){ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"bindDOMListeners",this).call(this),(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.annotatedElement.addEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.addEventListener("wheel",this.hideCreateDialog),this.hasTouch&&this.annotatedElement.addEventListener("touchend",this.hideCreateDialog)),this.hasTouch&&this.drawEnabled?this.annotatedElement.addEventListener("touchstart",this.drawingSelectionHandler):this.drawEnabled&&this.annotatedElement.addEventListener("click",this.drawingSelectionHandler),this.permissions.canAnnotate&&(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.hasTouch||this.isMobile?document.addEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.addEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.addEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.addEventListener("contextmenu",this.highlightMousedownHandler)))}},{key:"unbindDOMListeners",value:function(){var t=this;ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"unbindDOMListeners",this).call(this),this.annotatedElement.removeEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("wheel",this.hideCreateDialog),this.annotatedElement.removeEventListener("touchend",this.hideCreateDialog),this.highlightThrottleHandle&&(cancelAnimationFrame(this.highlightThrottleHandle),this.highlightThrottleHandle=null),Object.keys(this.modeControllers).forEach(function(e){t.modeControllers[e].removeSelection()}),this.hasTouch||this.isMobile?document.removeEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.removeEventListener("click",this.drawingSelectionHandler),this.annotatedElement.removeEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.removeEventListener("contextmenu",this.highlightMousedownHandler))}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&(this.mobileDialogEl.classList.remove(h.z),ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"removeThreadFromSharedDialog",this).call(this))}},{key:"hideCreateDialog",value:function(t){this.createHighlightDialog&&this.createHighlightDialog.isVisible&&t&&!l.D(t)&&this.createHighlightDialog.hide()}},{key:"resetHighlightSelection",value:function(t){this.isCreatingHighlight=!1,this.hideCreateDialog(t),document.getSelection().removeAllRanges()}},{key:"createPlainHighlight",value:function(){this.highlightCurrentSelection(),this.createHighlightThread()}},{key:"createHighlightThread",value:function(t){if(""===t||!this.lastHighlightEvent)return null;this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide(),this.isCreatingHighlight=!1;var e=t?h.ic.highlight_comment:h.ic.highlight,n=this.getLocationFromEvent(this.lastHighlightEvent,e);if(this.highlighter.removeAllHighlights(),!n)return null;var i=this.createAnnotationThread({},n,e);if(this.lastHighlightEvent=null,this.lastSelection=null,!i)return null;t?i.dialog.hasComments=!0:i.dialog.drawAnnotation(),i.state=h.gc.hover,i.show(),i.dialog.postAnnotation(t);var o=this.modeControllers[e];return o&&o.registerThread(i),this.emit(h.hc.threadSave,i.getThreadEventData()),i}},{key:"onSelectionChange",value:function(t){var e=this;t.preventDefault(),t.stopPropagation(),this.selectionEndTimeout&&(clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=null);var n=this.modeControllers[h.ic.point];if(!!(!n||!n.pendingThreadID)&&"textarea"!==document.activeElement.nodeName.toLowerCase()){var i=window.getSelection();if(this.lastSelection&&i&&function(t,e){if(!t||t.rangeCount<1||!e)return!1;var n=t.getRangeAt(t.rangeCount-1),i=e.getRangeAt(t.rangeCount-1);return n.compareBoundaryPoints(Range.START_TO_END,i)}(i,this.lastSelection)||this.highlighter.removeAllHighlights(),!E(i))return this.lastHighlightEvent=null,this.createHighlightDialog.hide(),void this.highlighter.removeAllHighlights();this.selectionEndTimeout=setTimeout(function(){e.createHighlightDialog&&e.createHighlightDialog.show(e.container,i)},500);var o=l.u(t.target).page;this.plainHighlightEnabled&&this.modeControllers[h.ic.highlight].applyActionToThreads(function(t){return t.reset()},o),this.commentHighlightEnabled&&this.modeControllers[h.ic.highlight_comment].applyActionToThreads(function(t){return t.reset()},o),this.lastSelection=i,this.lastHighlightEvent=t}}},{key:"highlightCurrentSelection",value:function(){this.highlighter&&this.highlighter.highlightSelection("rangy-highlight",{containerElementId:this.annotatedElement.id})}},{key:"highlightMousedownHandler",value:function(t){this.isCreatingHighlight=!0,this.mouseX=t.clientX,this.mouseY=t.clientY,this.plainHighlightEnabled&&this.modeControllers[h.ic.highlight].applyActionToThreads(function(t){return t.onMousedown()}),this.commentHighlightEnabled&&this.modeControllers[h.ic.highlight_comment].applyActionToThreads(function(t){return t.onMousedown()})}},{key:"drawingSelectionHandler",value:function(t){var e=this.modeControllers[h.ic.draw];!e||this.isCreatingAnnotation()||this.isCreatingHighlight||e.handleSelection(t)}},{key:"isCreatingAnnotation",value:function(){var t=this,e=!1;return Object.keys(this.modeControllers).some(function(n){return t.modeControllers[n].hadPendingThreads&&(e=!0),e}),e}},{key:"highlightMouseupHandler",value:function(t){this.highlighter&&this.highlighter.removeAllHighlights();var e=this.mouseX&&this.mouseX!==t.clientX||this.mouseY&&this.mouseY!==t.clientY;this.createHighlightDialog&&e||"dblclick"===t.type?this.highlightCreateHandler(t):this.highlightClickHandler(t)}},{key:"highlightCreateHandler",value:function(t){t.stopPropagation();var e=window.getSelection();if(E(e)){var n=l.u(e.anchorNode).pageEl;if(n){var i=this.isMobile?this.container:n;this.createHighlightDialog.show(i,e),this.isCreatingHighlight=!0,this.lastHighlightEvent=t}}}},{key:"highlightClickHandler",value:function(t){this.activeThread=null,this.mouseEvent=t,this.consumed=!1;var e=[],n=[];this.plainHighlightEnabled&&(e=this.modeControllers[h.ic.highlight].getIntersectingThreads(this.mouseEvent)),this.commentHighlightEnabled&&(n=this.modeControllers[h.ic.highlight_comment].getIntersectingThreads(this.mouseEvent)),this.hideAnnotations(t),[].concat(e,n).forEach(this.clickThread),this.activeThread?this.activeThread.show():this.isMobile?this.removeThreadFromSharedDialog():this.resetHighlightSelection(t)}},{key:"clickThread",value:function(t){if(l.E(t.state))t.type===h.ic.point?t.destroy():t.cancelFirstComment();else if(l.B(t.type)){var e=t.onClick(this.mouseEvent,this.consumed);e&&(this.activeThread=t),this.consumed=this.consumed||e}else t.hideDialog()}},{key:"useDefaultCursor",value:function(){this.annotatedElement.classList.add("bp-use-default-cursor")}},{key:"removeDefaultCursor",value:function(){this.annotatedElement.classList.remove("bp-use-default-cursor")}},{key:"removeRangyHighlight",value:function(t){var e=this.highlighter.highlights;if(Array.isArray(e)){var n=e.filter(function(e){return e.id===t.id});this.highlighter.removeHighlights(n)}}},{key:"handleControllerEvents",value:function(t){switch(t.event){case h.fb.toggleMode:this.resetHighlightSelection(t.event);break;case h.fb.bindDOMListeners:this.hideCreateDialog(t);break;case h.fb.renderPage:this.renderPage(t.data)}ot(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"handleControllerEvents",this).call(this,t)}},{key:"showFirstDialogFilter",value:function(t,e){0===e?t.show():t.hideDialog()}}]),e}();e.a=at},function(t,e,n){"use strict";var i=n(9),o=n(4),r=n(5),a=n(1),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var l=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,r["a"]),s(e,[{key:"position",value:function(){this.annotatedElement.appendChild(this.element),a.M(this.element);var t=this.element.getBoundingClientRect().width,e=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),n=this.threadEl.offsetLeft+12,i=n-t/2,o=this.threadEl.offsetTop+31,r=e.clientWidth>this.annotatedElement.clientWidth?e.clientWidth:this.annotatedElement.clientWidth;i=a.J(this.element,i,t,n,r),this.element.style.left=i+"px";var s=this.flipDialog(o,this.container.clientHeight);this.element.style.top=s.top,this.element.style.bottom=s.bottom}}]),e}(),h=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=15,u=-90,d=-180,f=-270;function p(t,e){var n=e.querySelector('[data-page-number="'+(t.page||1)+'"]')||e.querySelector("img"),i=e.getBoundingClientRect(),o=n.getBoundingClientRect(),r=a.v(e),s=o.top-i.top+e.scrollTop,l=o.left-i.left+e.scrollLeft,p=Number(n.getAttribute("data-rotation-angle")),g=function(t,e,n,i,o){var r=i.height,a=i.width/o,s=r/o;switch(n){case u:return[e,s-t];case d:return[a-t,s-e];case f:return[a-e,t]}return[t,e]}(t.x,t.y,p,o,r),m=h(g,2),v=m[0],y=m[1];return v*=r,y*=r,l>=0&&(v+=l),s>=0&&(y+=s),p===d&&(y-=c/2),[v,y]}var g=n(0),m=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),v=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var y=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,o["a"]),v(e,[{key:"show",value:function(){var t=p(this.location,this.annotatedElement),e=m(t,2),n=e[0],i=e[1];this.element.style.left=n-12+"px",this.element.style.top=i-31+8+"px",this.annotatedElement.appendChild(this.element),a.M(this.element),this.state!==g.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new l({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,location:this.location,locale:this.locale,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),e}(),b=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),w=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0};var C=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,i["a"]),E(e,[{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-image, .bp-images-wrapper")}},{key:"getLocationFromEvent",value:function(t){var e=null,n=t;if(this.hasTouch){if(!t.targetTouches||0===t.targetTouches.length)return e;n=t.targetTouches[0]}var i=n.target;if("img"!==i.nodeName.toLowerCase())return e;var o=a.u(i).page,r=i.getBoundingClientRect(),s=n.clientX-r.left,l=n.clientY-r.top;if(Number.isNaN(s)||Number.isNaN(l))return this.emit(g.a.error,this.localized.createError),e;var h=a.v(this.annotatedElement),c=function(t,e,n,i,o){var r=i.height,a=i.width;switch(n){case u:return[a/o-e,t];case d:return[a/o-t,r/o-e];case f:return[e,r/o-t]}return[t,e]}(s/h,l/h,Number(i.getAttribute("data-rotation-angle")),r,h),p=b(c,2);return e={x:s=p[0],y:l=p[1],imageEl:i,dimensions:{x:r.width/h,y:r.height/h},page:o}}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0,o=e;(!o.page||o.page<0)&&(o.page=1);var r=this.getThreadParams(t,e,n);return a.a(r)?(n===g.ic.point&&(i=new y(r)),i||this.emit(g.a.error,this.localized.loadError),i):(this.handleValidationError(),i)}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.rotateAnnotations(t.rotationAngle,t.pageNum)}},{key:"rotateAnnotations",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e?this.renderPage(e):this.render();var n=this.modeControllers[g.ic.point];if(this.permissions.canAnnotate&&n){var i=this.modeButtons[g.ic.point].selector,o=n.getButton(i);0!==t?a.x(o):a.M(o)}}},{key:"bindDOMListeners",value:function(){this.annotatedElement.addEventListener("mouseup",this.hideAnnotations),w(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"bindDOMListeners",this).call(this)}},{key:"unbindDOMListeners",value:function(){this.annotatedElement.removeEventListener("mouseup",this.hideAnnotations),w(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"bindDOMListeners",this).call(this)}}]),e}();e.a=C},function(t,e,n){t.exports=n(32)},function(t,e,n){"use strict";n.r(e),function(t){var i,o=n(29),r=n(30),a=n(24),s=n(27),l=n(12),h=n(0),c=n(1),u=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();function d(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function f(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var p=[{NAME:"Document",CONSTRUCTOR:o.a,VIEWER:["Document","Presentation"],TYPE:[h.ic.point,h.ic.highlight,h.ic.highlight_comment,h.ic.draw],DEFAULT_TYPES:[h.ic.point,h.ic.highlight,h.ic.highlight_comment,h.ic.draw]},{NAME:"Image",CONSTRUCTOR:r.a,VIEWER:["Image","MultiImage"],TYPE:[h.ic.point],DEFAULT_TYPES:[h.ic.point]}],g=(f(i={},h.ic.point,{CONSTRUCTOR:s.a}),f(i,h.ic.highlight,{CONSTRUCTOR:l.a}),f(i,h.ic.highlight_comment,{CONSTRUCTOR:l.a}),f(i,h.ic.draw,{CONSTRUCTOR:a.a}),i),m=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.annotators=p,this.viewerOptions=e}return u(t,[{key:"getAnnotators",value:function(){return Array.isArray(this.annotators)?this.annotators:[]}},{key:"getAnnotatorsForViewer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this.getAnnotators().find(function(n){return!e.includes(n.NAME)&&n.VIEWER.includes(t)});return this.instantiateControllers(n),n}},{key:"instantiateControllers",value:function(t){t&&t.TYPE&&!t.CONTROLLERS&&(t.CONTROLLERS={},this.getAnnotatorTypes(t).forEach(function(e){e in g&&(t.CONTROLLERS[e]=new g[e].CONSTRUCTOR)}))}},{key:"getAnnotatorTypes",value:function(t){if(this.viewerOptions&&this.viewerOptions[t.NAME]){var e=this.viewerOptions[t.NAME];if(e.enabledTypes)return e.enabledTypes.filter(function(e){return t.TYPE.some(function(t){return t===e})})}else if(!this.viewerConfig)return[].concat(d(t.DEFAULT_TYPES));var n=this.viewerConfig.enabledTypes||[].concat(d(t.DEFAULT_TYPES)),i=this.viewerConfig.disabledTypes||[];return n.filter(function(e){return!i.some(function(t){return t===e})&&t.TYPE.some(function(t){return t===e})})}},{key:"determineAnnotator",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=null;this.viewerConfig=e;var o=Object(c.b)(t.file.permissions),r=this.getAnnotatorsForViewer(t.viewer.NAME,n);return o&&r&&!1!==this.viewerConfig.enabled?((i=Object.assign({},r)).TYPE=this.getAnnotatorTypes(i),i):i}}]),t}();t.BoxAnnotations=m,e.default=m}.call(this,n(33))},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){var o,r,a;r=[n(7)],void 0===(a="function"==typeof(o=function(t){return t.createModule("ClassApplier",["WrappedSelection"],function(t,e){var n=t.dom,o=n.DomPosition,r=n.arrayContains,a=t.util,s=a.forEach,l=a.isHostMethod(document,"createElementNS");function h(t,e){for(var n in t)if(t.hasOwnProperty(n)&&!1===e(n,t[n]))return!1;return!0}function c(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function u(t,e){return!!t&&new RegExp("(?:^|\\s)"+e+"(?:\\s|$)").test(t)}function d(t,e){return"object"==typeof t.classList?t.classList.contains(e):u("string"==typeof t.className?t.className:t.getAttribute("class"),e)}function f(t,e){if("object"==typeof t.classList)t.classList.add(e);else{var n="string"==typeof t.className,i=n?t.className:t.getAttribute("class");i?u(i,e)||(i+=" "+e):i=e,n?t.className=i:t.setAttribute("class",i)}}var p=function(){function t(t,e,n){return e&&n?" ":""}return function(e,n){if("object"==typeof e.classList)e.classList.remove(n);else{var i="string"==typeof e.className,o=i?e.className:e.getAttribute("class");o=o.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),t),i?e.className=o:e.setAttribute("class",o)}}}();function g(t){return"string"==typeof t.className?t.className:t.getAttribute("class")}function m(t){return t&&t.split(/\s+/).sort().join(" ")}function v(t){return m(g(t))}function y(t,e){return v(t)==v(e)}function b(t,e){for(var n=e.split(/\s+/),i=0,o=n.length;i<o;++i)if(!d(t,c(n[i])))return!1;return!0}function E(t,e,i,o){-1==i&&(i=e.childNodes.length);var r=t.parentNode,a=n.getNodeIndex(t);s(o,function(t){!function(t,e,n,i,o){var r=t.node,a=t.offset,s=r,l=a;r==i&&a>o&&++l,r!=e||a!=n&&a!=n+1||(s=i,l+=o-n),r==e&&a>n+1&&--l,t.node=s,t.offset=l}(t,r,a,e,i)}),e.childNodes.length==i?e.appendChild(t):e.insertBefore(t,e.childNodes[i])}function w(t,e){var i=t.parentNode,o=n.getNodeIndex(t);s(e,function(t){!function(t,e,n){t.node==e&&t.offset>n&&--t.offset}(t,i,o)}),n.removeNode(t)}function C(t,e){return function(t,e,n,i,o){for(var r,a=[];r=t.firstChild;)E(r,e,n++,o),a.push(r);return i&&w(t,o),a}(t,t.parentNode,n.getNodeIndex(t),!0,e)}function O(t,e){var n=t.cloneRange();n.selectNodeContents(e);var i=n.intersection(t);return""!=(i?i.toString():"")}function x(t){for(var e,n=t.getNodes([3]),i=0;(e=n[i])&&!O(t,e);)++i;for(var o=n.length-1;(e=n[o])&&!O(t,e);)--o;return n.slice(i,o+1)}function T(t,e){if(t.attributes.length!=e.attributes.length)return!1;for(var n,i,o,r=0,a=t.attributes.length;r<a;++r)if("class"!=(o=(n=t.attributes[r]).name)){if(null===n!=(null===(i=e.attributes.getNamedItem(o))))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function _(t,e){for(var n,i=0,o=t.attributes.length;i<o;++i)if(n=t.attributes[i].name,(!e||!r(e,n))&&t.attributes[i].specified&&"class"!=n)return!0;return!1}var S=n.getComputedStyleProperty,k="boolean"==typeof document.createElement("div").isContentEditable?function(t){return t&&1==t.nodeType&&t.isContentEditable}:function(t){return!(!t||1!=t.nodeType||"false"==t.contentEditable)&&("true"==t.contentEditable||k(t.parentNode))};function A(t){var e;return t&&1==t.nodeType&&((e=t.parentNode)&&9==e.nodeType&&"on"==e.designMode||k(t)&&!k(t.parentNode))}function R(t){return(k(t)||1!=t.nodeType&&k(t.parentNode))&&!A(t)}var D=/^inline(-block|-table)?$/i;function P(t){return t&&1==t.nodeType&&!D.test(S(t,"display"))}var L=/[^\r\n\t\f \u200B]/;function N(t){var e,n,i=[];for(e=0;n=t[e++];)i.push(new o(n.startContainer,n.startOffset),new o(n.endContainer,n.endOffset));return i}function M(t,e){for(var n,i,o,r=0,a=t.length;r<a;++r)n=t[r],i=e[2*r],o=e[2*r+1],n.setStartAndEnd(i.node,i.offset,o.node,o.offset)}function B(t,i,o,r){var a,s,l=0==o;if(n.isAncestorOf(i,t))return t;if(n.isCharacterDataNode(i)){var h=n.getNodeIndex(i);if(0==o)o=h;else{if(o!=i.length)throw e.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+o+" in "+i.data);o=h+1}i=i.parentNode}if(function(t,e){return n.isCharacterDataNode(t)?0==e?!!t.previousSibling:e!=t.length||!!t.nextSibling:e>0&&e<t.childNodes.length}(i,o)){a=i.cloneNode(!1),s=i.parentNode,a.id&&a.removeAttribute("id");for(var c,u=0;c=i.childNodes[o];)E(c,a,u++,r);return E(a,s,n.getNodeIndex(i)+1,r),i==t?a:B(t,s,n.getNodeIndex(a),r)}if(t!=i){a=i.parentNode;var d=n.getNodeIndex(i);return l||d++,B(t,a,d,r)}return t}function j(t){var e=t?"nextSibling":"previousSibling";return function(n,i){var o,r,a=n.parentNode,s=n[e];if(s){if(s&&3==s.nodeType)return s}else if(i&&(s=a[e])&&1==s.nodeType&&(r=s,(o=a).namespaceURI==r.namespaceURI&&o.tagName.toLowerCase()==r.tagName.toLowerCase()&&y(o,r)&&T(o,r)&&"inline"==S(o,"display")&&"inline"==S(r,"display"))){var l=s[t?"firstChild":"lastChild"];if(l&&3==l.nodeType)return l}return null}}var H=j(!1),I=j(!0);function F(t){this.isElementMerge=1==t.nodeType,this.textNodes=[];var e=this.isElementMerge?t.lastChild:t;e&&(this.textNodes[0]=e)}F.prototype={doMerge:function(t){var e=this.textNodes,i=e[0];if(e.length>1){var o,r=n.getNodeIndex(i),a=[],l=0;s(e,function(e,h){o=e.parentNode,h>0&&(o.removeChild(e),o.hasChildNodes()||n.removeNode(o),t&&s(t,function(t){t.node==e&&(t.node=i,t.offset+=l),t.node==o&&t.offset>r&&(--t.offset,t.offset==r+1&&h<len-1&&(t.node=i,t.offset=l))})),a[h]=e.data,l+=e.data.length}),i.data=a.join("")}return i.data},getLength:function(){for(var t=this.textNodes.length,e=0;t--;)e+=this.textNodes[t].length;return e},toString:function(){var t=[];return s(this.textNodes,function(e,n){t[n]="'"+e.data+"'"}),"[Merge("+t.join(",")+")]"}};var q=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],z={};function Y(t,e,n){var i,o,r,a,s=this;s.cssClass=s.className=t;var l=null,u={};if("object"==typeof e&&null!==e){for(void 0!==e.elementTagName&&(e.elementTagName=e.elementTagName.toLowerCase()),n=e.tagNames,l=e.elementProperties,u=e.elementAttributes,o=0;a=q[o++];)e.hasOwnProperty(a)&&(s[a]=e[a]);i=e.normalize}else i=e;s.normalize=void 0===i||i,s.attrExceptions=[];var d=document.createElement(s.elementTagName);s.elementProperties=s.copyPropertiesToElement(l,d,!0),h(u,function(t,e){s.attrExceptions.push(t),u[t]=""+e}),s.elementAttributes=u,s.elementSortedClassName=s.elementProperties.hasOwnProperty("className")?m(s.elementProperties.className+" "+t):t,s.applyToAnyTagName=!1;var f=typeof n;if("string"==f)"*"==n?s.applyToAnyTagName=!0:s.tagNames=c(n.toLowerCase()).split(/\s*,\s*/);else if("object"==f&&"number"==typeof n.length)for(s.tagNames=[],o=0,r=n.length;o<r;++o)"*"==n[o]?s.applyToAnyTagName=!0:s.tagNames.push(n[o].toLowerCase());else s.tagNames=[s.elementTagName]}Y.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(t,e,n){var i,o,r,a,s,l,h={};for(var c in t)if(t.hasOwnProperty(c))if(a=t[c],s=e[c],"className"==c)f(e,a),f(e,this.className),e[c]=m(e[c]),n&&(h[c]=a);else if("style"==c){for(i in o=s,n&&(h[c]=r={}),t[c])t[c].hasOwnProperty(i)&&(o[i]=a[i],n&&(r[i]=o[i]));this.attrExceptions.push(c)}else e[c]=a,n&&(h[c]=e[c],l=z.hasOwnProperty(c)?z[c]:c,this.attrExceptions.push(l));return n?h:""},copyAttributesToElement:function(t,e){for(var n in t)t.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&e.setAttribute(n,t[n])},appliesToElement:function(t){return r(this.tagNames,t.tagName.toLowerCase())},getEmptyElements:function(t){var e=this;return t.getNodes([1],function(t){return e.appliesToElement(t)&&!t.hasChildNodes()})},hasClass:function(t){return 1==t.nodeType&&(this.applyToAnyTagName||this.appliesToElement(t))&&d(t,this.className)},getSelfOrAncestorWithClass:function(t){for(;t;){if(this.hasClass(t))return t;t=t.parentNode}return null},isModifiable:function(t){return!this.applyToEditableOnly||R(t)},isIgnorableWhiteSpaceNode:function(t){return this.ignoreWhiteSpace&&t&&3==t.nodeType&&function(t){if(0==t.data.length)return!0;if(L.test(t.data))return!1;switch(S(t.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(t.data))return!1}return P(t.previousSibling)||P(t.nextSibling)}(t)},postApply:function(t,e,n,o){var r,a,l=t[0],h=t[t.length-1],c=[],u=l,d=h,f=0,p=h.length;s(t,function(t){(a=H(t,!o))?(r||(r=new F(a),c.push(r)),r.textNodes.push(t),t===l&&(u=r.textNodes[0],f=u.length),t===h&&(d=r.textNodes[0],p=r.getLength())):r=null});var g=I(h,!o);if(g&&(r||(r=new F(h),c.push(r)),r.textNodes.push(g)),c.length){for(i=0,len=c.length;i<len;++i)c[i].doMerge(n);e.setStartAndEnd(u,f,d,p)}},createContainer:function(t){var e=n.getDocument(t),i=l&&!n.isHtmlNamespace(t)&&t.namespaceURI?e.createElementNS(t.namespaceURI,this.elementTagName):e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,i,!1),this.copyAttributesToElement(this.elementAttributes,i),f(i,this.className),this.onElementCreate&&this.onElementCreate(i,this),i},elementHasProperties:function(t,e){var n=this;return h(e,function(e,i){if("className"==e)return b(t,i);if("object"==typeof i){if(!n.elementHasProperties(t[e],i))return!1}else if(t[e]!==i)return!1})},elementHasAttributes:function(t,e){return h(e,function(e,n){if(t.getAttribute(e)!==n)return!1})},applyToTextNode:function(t,e){if(function(t){var e=t.parentNode;return e&&1==e.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(e.nodeName)}(t)){var n=t.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&this.appliesToElement(n)&&this.elementHasProperties(n,this.elementProperties)&&this.elementHasAttributes(n,this.elementAttributes))f(n,this.className);else{var i=t.parentNode,o=this.createContainer(i);i.insertBefore(o,t),o.appendChild(t)}}},isRemovable:function(t){return t.tagName.toLowerCase()==this.elementTagName&&v(t)==this.elementSortedClassName&&this.elementHasProperties(t,this.elementProperties)&&!_(t,this.attrExceptions)&&this.elementHasAttributes(t,this.elementAttributes)&&this.isModifiable(t)},isEmptyContainer:function(t){var e=t.childNodes.length;return 1==t.nodeType&&this.isRemovable(t)&&(0==e||1==e&&this.isEmptyContainer(t.firstChild))},removeEmptyContainers:function(t){var e=this,n=t.getNodes([1],function(t){return e.isEmptyContainer(t)}),i=[t],o=N(i);s(n,function(t){w(t,o)}),M(i,o)},undoToTextNode:function(t,e,n,i){if(!e.containsNode(n)){var o=e.cloneRange();o.selectNode(n),o.isPointInRange(e.endContainer,e.endOffset)&&(B(n,e.endContainer,e.endOffset,i),e.setEndAfter(n)),o.isPointInRange(e.startContainer,e.startOffset)&&(n=B(n,e.startContainer,e.startOffset,i))}this.isRemovable(n)?C(n,i):p(n,this.className)},splitAncestorWithClass:function(t,e,n){var i=this.getSelfOrAncestorWithClass(t);i&&B(i,t,e,n)},undoToAncestor:function(t,e){this.isRemovable(t)?C(t,e):p(t,this.className)},applyToRange:function(t,e){var n=this,i=N((e=e||[])||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t);var o=x(t);if(o.length){s(o,function(t){n.isIgnorableWhiteSpaceNode(t)||n.getSelfOrAncestorWithClass(t)||!n.isModifiable(t)||n.applyToTextNode(t,i)});var r=o[o.length-1];t.setStartAndEnd(o[0],0,r,r.length),n.normalize&&n.postApply(o,t,i,!1),M(e,i)}var a=n.getEmptyElements(t);s(a,function(t){f(t,n.className)})},applyToRanges:function(t){for(var e=t.length;e--;)this.applyToRange(t[e],t);return t},applyToSelection:function(e){var n=t.getSelection(e);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(t,e){var n=this,i=N(e=e||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t,i);var o,r,a=x(t),l=a[a.length-1];if(a.length){n.splitAncestorWithClass(t.endContainer,t.endOffset,i),n.splitAncestorWithClass(t.startContainer,t.startOffset,i);for(var h=0,c=a.length;h<c;++h)o=a[h],(r=n.getSelfOrAncestorWithClass(o))&&n.isModifiable(o)&&n.undoToAncestor(r,i);t.setStartAndEnd(a[0],0,l,l.length),n.normalize&&n.postApply(a,t,i,!0),M(e,i)}var u=n.getEmptyElements(t);s(u,function(t){p(t,n.className)})},undoToRanges:function(t){for(var e=t.length;e--;)this.undoToRange(t[e],t);return t},undoToSelection:function(e){var n=t.getSelection(e),i=t.getSelection(e).getAllRanges();this.undoToRanges(i),n.setRanges(i)},isAppliedToRange:function(t){if(t.collapsed||""==t.toString())return!!this.getSelfOrAncestorWithClass(t.commonAncestorContainer);var e=t.getNodes([3]);if(e.length)for(var n,i=0;n=e[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&O(t,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(t){var e=t.length;if(0==e)return!1;for(;e--;)if(!this.isAppliedToRange(t[e]))return!1;return!0},isAppliedToSelection:function(e){var n=t.getSelection(e);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(t){this.isAppliedToRange(t)?this.undoToRange(t):this.applyToRange(t)},toggleSelection:function(t){this.isAppliedToSelection(t)?this.undoToSelection(t):this.applyToSelection(t)},getElementsWithClassIntersectingRange:function(t){var e=[],n=this;return t.getNodes([3],function(t){var i=n.getSelfOrAncestorWithClass(t);i&&!r(e,i)&&e.push(i)}),e},detach:function(){}},Y.util={hasClass:d,addClass:f,removeClass:p,getClass:g,hasSameClasses:y,hasAllClasses:b,replaceWithOwnChildren:C,elementsHaveSameNonClassAttributes:T,elementHasNonClassAttributes:_,splitNodeAt:B,isEditableElement:k,isEditingHost:A,isEditable:R},t.CssClassApplier=t.ClassApplier=Y,t.createClassApplier=function(t,e,n){return new Y(t,e,n)},a.createAliasForDeprecatedMethod(t,"createCssClassApplier","createClassApplier",e)}),t})?o.apply(e,r):o)||(t.exports=a)},function(t,e,n){var i,o,r;o=[n(7)],void 0===(r="function"==typeof(i=function(t){return t.createModule("Highlighter",["ClassApplier"],function(t,e){var n=t.dom,i=n.arrayContains,o=n.getBody,r=t.util.createOptions,a=t.util.forEach,s=1;function l(t,e){return t.characterRange.start-e.characterRange.start}function h(t,e){return e?t.getElementById(e):o(t)}var c={};function u(t,e){this.type=t,this.converterCreator=e}function d(t,e){c[t]=new u(t,e)}function f(t){var e=c[t];if(e instanceof u)return e.create();throw new Error("Highlighter type '"+t+"' is not valid")}function p(t,e){this.start=t,this.end=e}u.prototype.create=function(){var t=this.converterCreator();return t.type=this.type,t},t.registerHighlighterType=d,p.prototype={intersects:function(t){return this.start<t.end&&this.end>t.start},isContiguousWith:function(t){return this.start==t.end||this.end==t.start},union:function(t){return new p(Math.min(this.start,t.start),Math.max(this.end,t.end))},intersection:function(t){return new p(Math.max(this.start,t.start),Math.min(this.end,t.end))},getComplements:function(t){var e=[];if(this.start>=t.start){if(this.end<=t.end)return[];e.push(new p(t.end,this.end))}else e.push(new p(this.start,Math.min(this.end,t.start))),this.end>t.end&&e.push(new p(t.end,this.end));return e},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},p.fromCharacterRange=function(t){return new p(t.start,t.end)};var g,m={rangeToCharacterRange:function(t,e){var n=t.getBookmark(e);return new p(n.start,n.end)},characterRangeToRange:function(e,n,i){var o=t.createRange(e);return o.moveToBookmark({start:n.start,end:n.end,containerNode:i}),o},serializeSelection:function(t,e){for(var n=t.getAllRanges(),i=[],o=1==n.length&&t.isBackward(),r=0,a=n.length;r<a;++r)i[r]={characterRange:this.rangeToCharacterRange(n[r],e),backward:o};return i},restoreSelection:function(t,e,n){t.removeAllRanges();for(var i,o,r=t.win.document,a=0,s=e.length;a<s;++a)(o=e[a]).characterRange,i=this.characterRangeToRange(r,o.characterRange,n),t.addRange(i,o.backward)}};function v(t,e,n,i,o,r){o?(this.id=o,s=Math.max(s,o+1)):this.id=s++,this.characterRange=e,this.doc=t,this.classApplier=n,this.converter=i,this.containerElementId=r||null,this.applied=!1}function y(t,e){e=e||"textContent",this.doc=t||document,this.classAppliers={},this.highlights=[],this.converter=f(e)}d("textContent",function(){return m}),d("TextRange",function(){if(!g){var e=t.modules.TextRange;if(!e)throw new Error("TextRange module is missing.");if(!e.supported)throw new Error("TextRange module is present but not supported.");g={rangeToCharacterRange:function(t,e){return p.fromCharacterRange(t.toCharacterRange(e))},characterRangeToRange:function(e,n,i){var o=t.createRange(e);return o.selectCharacters(i,n.start,n.end),o},serializeSelection:function(t,e){return t.saveCharacterRanges(e)},restoreSelection:function(t,e,n){t.restoreCharacterRanges(n,e)}}}return g}),v.prototype={getContainerElement:function(){return h(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(t){this.characterRange=this.converter.rangeToCharacterRange(t,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(t){return this.getRange().containsNodeContents(t.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},y.prototype={addClassApplier:function(t){this.classAppliers[t.className]=t},getHighlightForElement:function(t){for(var e=this.highlights,n=0,i=e.length;n<i;++n)if(e[n].containsElement(t))return e[n];return null},removeHighlights:function(t){for(var e,n=0,o=this.highlights.length;n<o;++n)e=this.highlights[n],i(t,e)&&(e.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(t){var e=[],n=this.highlights;return a(t,function(t){a(n,function(n){t.intersectsRange(n.getRange())&&!i(e,n)&&e.push(n)})}),e},highlightCharacterRanges:function(e,n,i){var o,s,l,h,c,u,d,f,g,m,y,b,E=this.highlights,w=this.converter,C=this.doc,O=[],x=e?this.classAppliers[e]:null,T=(i=r(i,{containerElementId:null,exclusive:!0})).containerElementId,_=i.exclusive;for(T&&(h=this.doc.getElementById(T))&&((c=t.createRange(this.doc)).selectNodeContents(h),u=new p(0,c.toString().length)),o=0,s=n.length;o<s;++o)if(d=n[o],y=[],u&&(d=d.intersection(u)),d.start!=d.end){for(l=0;l<E.length;++l)g=!1,T==E[l].containerElementId&&(f=E[l].characterRange,b=!(m=x==E[l].classApplier)&&_,(f.intersects(d)||f.isContiguousWith(d))&&(m||b)&&(b&&a(f.getComplements(d),function(t){y.push(new v(C,t,E[l].classApplier,w,null,T))}),g=!0,m&&(d=f.union(d)))),g?(O.push(E[l]),E[l]=new v(C,f.union(d),x,w,null,T)):y.push(E[l]);x&&y.push(new v(C,d,x,w,null,T)),this.highlights=E=y}a(O,function(t){t.unapply()});var S=[];return a(E,function(t){t.applied||(t.apply(),S.push(t))}),S},highlightRanges:function(e,n,i){var s,l=[],h=this.converter,c=(i=r(i,{containerElement:null,exclusive:!0})).containerElement,u=c?c.id:null;return c&&(s=t.createRange(c)).selectNodeContents(c),a(n,function(t){var e=c?s.intersection(t):t;l.push(h.rangeToCharacterRange(e,c||o(t.getDocument())))}),this.highlightCharacterRanges(e,l,{containerElementId:u,exclusive:i.exclusive})},highlightSelection:function(e,n){var i=this.converter,o=!!e&&this.classAppliers[e],s=(n=r(n,{containerElementId:null,selection:t.getSelection(this.doc),exclusive:!0})).containerElementId,l=n.exclusive,c=n.selection,u=h(c.win.document,s);if(!o&&!1!==e)throw new Error("No class applier found for class '"+e+"'");var d=i.serializeSelection(c,u),f=[];a(d,function(t){f.push(p.fromCharacterRange(t.characterRange))});var g=this.highlightCharacterRanges(e,f,{containerElementId:s,exclusive:l});return i.restoreSelection(c,d,u),g},unhighlightSelection:function(e){e=e||t.getSelection(this.doc);var n=this.getIntersectingHighlights(e.getAllRanges());return this.removeHighlights(n),e.removeAllRanges(),n},getHighlightsInSelection:function(e){return e=e||t.getSelection(this.doc),this.getIntersectingHighlights(e.getAllRanges())},selectionOverlapsHighlight:function(t){return this.getHighlightsInSelection(t).length>0},serialize:function(t){var e,n,i,o,s=this,h=s.highlights;return h.sort(l),e=(t=r(t,{serializeHighlightText:!1,type:s.converter.type})).type,(i=e!=s.converter.type)&&(o=f(e)),n=["type:"+e],a(h,function(e){var r,a=e.characterRange;i&&(r=e.getContainerElement(),a=o.rangeToCharacterRange(s.converter.characterRangeToRange(s.doc,a,r),r));var l=[a.start,a.end,e.id,e.classApplier.className,e.containerElementId];t.serializeHighlightText&&l.push(e.getText()),n.push(l.join("$"))}),n.join("|")},deserialize:function(t){var e,n,i,o,r,a,s,l,c=t.split("|"),u=[],d=c[0],g=!1;if(!d||!(e=/^type:(\w+)$/.exec(d)))throw new Error("Serialized highlights are invalid.");(n=e[1])!=this.converter.type&&(i=f(n),g=!0),c.shift();for(var m,y=c.length;y-- >0;){if(a=new p(+(m=c[y].split("$"))[0],+m[1]),s=m[4]||null,g&&(l=h(this.doc,s),a=this.converter.rangeToCharacterRange(i.characterRangeToRange(this.doc,a,l),l)),!(o=this.classAppliers[m[3]]))throw new Error("No class applier found for class '"+m[3]+"'");(r=new v(this.doc,a,o,this.converter,parseInt(m[2]),s)).apply(),u.push(r)}this.highlights=u}},t.Highlighter=y,t.createHighlighter=function(t,e){return new y(t,e)}}),t})?i.apply(e,o):i)||(t.exports=r)},function(t,e,n){var i,o,r;o=[n(7)],void 0===(r="function"==typeof(i=function(t){return t.createModule("SaveRestore",["WrappedRange"],function(t,e){var n=t.dom,i=n.removeNode,o=t.Selection.isDirectionBackward,r="\ufeff";function a(t,e){return(e||document).getElementById(t)}function s(t,e){var i,o="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),a=n.getDocument(t.startContainer),s=t.cloneRange();return s.collapse(e),(i=a.createElement("span")).id=o,i.style.lineHeight="0",i.style.display="none",i.className="rangySelectionBoundary",i.appendChild(a.createTextNode(r)),s.insertNode(i),i}function l(t,n,o,r){var s=a(o,t);s?(n[r?"setStartBefore":"setEndBefore"](s),i(s)):e.warn("Marker element has been removed. Cannot restore selection.")}function h(t,e){return e.compareBoundaryPoints(t.START_TO_START,t)}function c(e,n){var i,r=t.DomRange.getRangeDocument(e),a=e.toString(),l=o(n);return e.collapsed?{document:r,markerId:(i=s(e,!1)).id,collapsed:!0}:(i=s(e,!1),{document:r,startMarkerId:s(e,!0).id,endMarkerId:i.id,collapsed:!1,backward:l,toString:function(){return"original text: '"+a+"', new text: '"+e.toString()+"'"}})}function u(n,o){var r=n.document;void 0===o&&(o=!0);var s=t.createRange(r);if(n.collapsed){var h=a(n.markerId,r);if(h){h.style.display="inline";var c=h.previousSibling;c&&3==c.nodeType?(i(h),s.collapseToPoint(c,c.length)):(s.collapseBefore(h),i(h))}else e.warn("Marker element has been removed. Cannot restore selection.")}else l(r,s,n.startMarkerId,!0),l(r,s,n.endMarkerId,!1);return o&&s.normalizeBoundaries(),s}function d(e,n){var i,r,s=[],l=o(n);(e=e.slice(0)).sort(h);for(var u=0,d=e.length;u<d;++u)s[u]=c(e[u],l);for(u=d-1;u>=0;--u)i=e[u],r=t.DomRange.getRangeDocument(i),i.collapsed?i.collapseAfter(a(s[u].markerId,r)):(i.setEndBefore(a(s[u].endMarkerId,r)),i.setStartAfter(a(s[u].startMarkerId,r)));return s}function f(t){for(var e=[],n=t.length-1;n>=0;n--)e[n]=u(t[n],!0);return e}function p(t,e){var n=a(e,t);n&&i(n)}t.util.extend(t,{saveRange:c,restoreRange:u,saveRanges:d,restoreRanges:f,saveSelection:function(n){if(!t.isSelectionValid(n))return e.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var i=t.getSelection(n),o=i.getAllRanges(),r=1==o.length&&i.isBackward(),a=d(o,r);return r?i.setSingleRange(o[0],r):i.setRanges(o),{win:n,rangeInfos:a,restored:!1}},restoreSelection:function(e,n){if(!e.restored){var i=e.rangeInfos,o=t.getSelection(e.win),r=f(i);1==i.length&&n&&t.features.selectionHasExtend&&i[0].backward?(o.removeAllRanges(),o.addRange(r[0],!0)):o.setRanges(r),e.restored=!0}},removeMarkerElement:p,removeMarkers:function(t){for(var e,n=t.rangeInfos,i=0,o=n.length;i<o;++i)(e=n[i]).collapsed?p(t.doc,e.markerId):(p(t.doc,e.startMarkerId),p(t.doc,e.endMarkerId))}})}),t})?i.apply(e,o):i)||(t.exports=r)},function(t,e,n){},,function(t,e,n){"use strict";function i(t,e,n,i,a){!function t(e,n,i,r,a){for(;r>i;){if(r-i>600){var s=r-i+1,l=n-i+1,h=Math.log(s),c=.5*Math.exp(2*h/3),u=.5*Math.sqrt(h*c*(s-c)/s)*(l-s/2<0?-1:1),d=Math.max(i,Math.floor(n-l*c/s+u)),f=Math.min(r,Math.floor(n+(s-l)*c/s+u));t(e,n,d,f,a)}var p=e[n],g=i,m=r;for(o(e,i,n),a(e[r],p)>0&&o(e,i,r);g<m;){for(o(e,g,m),g++,m--;a(e[g],p)<0;)g++;for(;a(e[m],p)>0;)m--}0===a(e[i],p)?o(e,i,m):o(e,++m,r),m<=n&&(i=m+1),n<=m&&(r=m-1)}}(t,e,n||0,i||t.length-1,a||r)}function o(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function r(t,e){return t<e?-1:t>e?1:0}t.exports=i,t.exports.default=i}]);