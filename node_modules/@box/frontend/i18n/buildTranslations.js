const fs = require('fs');
const path = require('path');
const propsParser = require('properties-parser');
const isEqual = require('lodash/isEqual');

const EXPORT_PREFIX = 'export default ';

/**
 * Function to recursively extract messages from JSON files created by react-intl
 * and also complain about potential duplicates.
 *
 * @param {string} dir - path for the directory to process
 * @param {Object} json - flattened json array for all messages
 * @return {Object} flattened json array for all messages
 */
const extractMessages = (dir, json) => {
    if (!fs.existsSync(dir)) {
        return json;
    }
    fs.readdirSync(dir).forEach(file => {
        const fqp = path.join(dir, file);
        const isDir = fs.statSync(fqp).isDirectory();
        if (isDir) {
            json = extractMessages(fqp, json);
        } else if (file.endsWith('.json')) {
            const arr = JSON.parse(fs.readFileSync(fqp, 'utf8'));
            arr.forEach(message => {
                const existingMessage = json[message.id];
                if (existingMessage && !isEqual(message, existingMessage)) {
                    const diff = JSON.stringify({ existingMessage, message }, null, 2);
                    throw new Error(`buildTranslations Error: Duplicate ID ${message.id} detected at ${fqp}.\n${diff}`);
                }
                json[message.id] = message;
            });
        }
    });
    return json;
};

/**
 * Function to build translations
 * @return {void}
 */
const buildTranslations = () => {
    const projectRootDir = process.cwd();
    const i18nDir = path.join(projectRootDir, 'i18n');
    const jsonDir = path.join(i18nDir, 'json');

    if (!fs.existsSync(i18nDir)) {
        throw new Error(`buildTranslations Error: The "${i18nDir}" directory does not exist.`);
    }

    const simpleJsonMessages = {}; // Collects sanitized messages as simple key: value pairs
    let str = '';
    let messages = extractMessages(jsonDir, {});

    // Iterating over the json messages and writing to en-US.properties
    const messageKeys = Object.keys(messages);

    messageKeys.sort().forEach(key => {
        const message = messages[key];
        const cleanedMessage = message.defaultMessage.replace(/\s+/g, ' ');
        if (!message.description) throw new Error(`Missing description for ${message.id}`);
        const cleanedDescription = message.description.trim().replace(/\s+/g, ' ');
        str = `${str}# ${cleanedDescription}\n${message.id} = ${cleanedMessage}\n`;
        simpleJsonMessages[message.id] = cleanedMessage;
    });

    // If the react-intl json files aren't ready yet, don't overwrite our primary translation file
    if (messageKeys.length) {
        fs.writeFileSync(`${i18nDir}/en-US.properties`, str);
    }

    // Iterating over all .properties files and generating corresponding ES6 .js files.
    // Also merges in any additional new messages from en-US.properties that may have been added
    // but not translated yet when build non en-US .js files.

    fs.readdirSync(i18nDir).forEach(file => {
        const fqp = path.join(i18nDir, file);
        const isDir = fs.statSync(fqp).isDirectory();
        if (!isDir && file.endsWith('.properties')) {
            const target = path.join(i18nDir, file.replace('.properties', '.js'));

            // prettier-ignore
            messages = { ...simpleJsonMessages, ...propsParser.read(fqp) };

            // Don't write new JS files if nothing has changed from the last write
            // This helps break potential loops when webpack is watching the js files
            try {
                // prettier-ignore
                const existing = JSON.parse(fs.readFileSync(target, 'utf8').replace(EXPORT_PREFIX, ''));
                if (isEqual(existing, messages)) {
                    return;
                }
            } catch (e) {
                // ignore
            }

            // prettier-ignore
            const jsonString = `${EXPORT_PREFIX}${JSON.stringify(messages, null, 2)}`;
            fs.writeFileSync(target, jsonString);
        }
    });
};

module.exports = buildTranslations;
