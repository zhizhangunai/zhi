/*!
 * Box Content Preview
 * 
 * Copyright 2019 Box, Inc. All rights reserved.
 * 
 * This product includes software developed by Box, Inc. ("Box")
 * (http://www.box.com)
 * 
 * ALL BOX SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL BOX BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 * See the Box license for the specific language governing permissions
 * and limitations under the license.
 */!function(n){var i={};function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}o.m=n,o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=284)}({284:function(t,e,n){t.exports=n(285)},285:function(t,e,n){"use strict";n.r(e);n(286),n(287);e.default=BoxAnnotations},286:function(t,e,n){},287:function(I,J,K){function N(t){if(M[t])return M[t].exports;var e=M[t]={i:t,l:!1,exports:{}};return L[t].call(e.exports,e,e.exports,N),e.l=!0,e.exports}var L,M;M={},N.m=L=[function(t,e,n){"use strict";n.d(e,"c",function(){return i}),n.d(e,"O",function(){return o}),n.d(e,"V",function(){return r}),n.d(e,"N",function(){return a}),n.d(e,"E",function(){return s}),n.d(e,"G",function(){return l}),n.d(e,"H",function(){return h}),n.d(e,"D",function(){return c}),n.d(e,"Xb",function(){return u}),n.d(e,"Yb",function(){return d}),n.d(e,"Z",function(){return f}),n.d(e,"i",function(){return p}),n.d(e,"A",function(){return g}),n.d(e,"o",function(){return m}),n.d(e,"l",function(){return v}),n.d(e,"Sb",function(){return y}),n.d(e,"cb",function(){return b}),n.d(e,"C",function(){return E}),n.d(e,"Wb",function(){return w}),n.d(e,"U",function(){return C}),n.d(e,"F",function(){return O}),n.d(e,"Zb",function(){return x}),n.d(e,"j",function(){return T}),n.d(e,"Lb",function(){return _}),n.d(e,"k",function(){return S}),n.d(e,"Rb",function(){return k}),n.d(e,"ac",function(){return A}),n.d(e,"K",function(){return R}),n.d(e,"n",function(){return D}),n.d(e,"Tb",function(){return P}),n.d(e,"m",function(){return N}),n.d(e,"ab",function(){return L}),n.d(e,"bb",function(){return M}),n.d(e,"eb",function(){return B}),n.d(e,"I",function(){return j}),n.d(e,"J",function(){return H}),n.d(e,"t",function(){return I}),n.d(e,"Ub",function(){return F}),n.d(e,"z",function(){return q}),n.d(e,"Q",function(){return z}),n.d(e,"db",function(){return Y}),n.d(e,"R",function(){return X}),n.d(e,"P",function(){return W}),n.d(e,"dc",function(){return U}),n.d(e,"e",function(){return V}),n.d(e,"Jb",function(){return G}),n.d(e,"f",function(){return J}),n.d(e,"Kb",function(){return $}),n.d(e,"T",function(){return Q}),n.d(e,"S",function(){return K}),n.d(e,"r",function(){return Z}),n.d(e,"q",function(){return tt}),n.d(e,"p",function(){return et}),n.d(e,"d",function(){return nt}),n.d(e,"Ib",function(){return it}),n.d(e,"L",function(){return ot}),n.d(e,"bc",function(){return rt}),n.d(e,"g",function(){return at}),n.d(e,"W",function(){return st}),n.d(e,"X",function(){return lt}),n.d(e,"Y",function(){return ht}),n.d(e,"ec",function(){return ct}),n.d(e,"M",function(){return ut}),n.d(e,"y",function(){return dt}),n.d(e,"Vb",function(){return ft}),n.d(e,"B",function(){return pt}),n.d(e,"s",function(){return gt}),n.d(e,"h",function(){return mt}),n.d(e,"Qb",function(){return vt}),n.d(e,"fc",function(){return yt}),n.d(e,"cc",function(){return bt}),n.d(e,"w",function(){return Et}),n.d(e,"x",function(){return wt}),n.d(e,"u",function(){return Ct}),n.d(e,"v",function(){return Ot}),n.d(e,"Pb",function(){return xt}),n.d(e,"Ob",function(){return Tt}),n.d(e,"Nb",function(){return _t}),n.d(e,"Mb",function(){return St}),n.d(e,"ib",function(){return kt}),n.d(e,"jb",function(){return At}),n.d(e,"pb",function(){return Rt}),n.d(e,"hb",function(){return Dt}),n.d(e,"rb",function(){return Pt}),n.d(e,"kb",function(){return Nt}),n.d(e,"tb",function(){return Lt}),n.d(e,"mb",function(){return Mt}),n.d(e,"sb",function(){return Bt}),n.d(e,"ob",function(){return jt}),n.d(e,"lb",function(){return Ht}),n.d(e,"nb",function(){return It}),n.d(e,"qb",function(){return Ft}),n.d(e,"Gb",function(){return qt}),n.d(e,"Hb",function(){return zt}),n.d(e,"Db",function(){return Yt}),n.d(e,"Eb",function(){return Xt}),n.d(e,"Fb",function(){return Wt}),n.d(e,"xb",function(){return Ut}),n.d(e,"gc",function(){return Vt}),n.d(e,"Cb",function(){return Gt}),n.d(e,"ic",function(){return Jt}),n.d(e,"yb",function(){return $t}),n.d(e,"a",function(){return Qt}),n.d(e,"hc",function(){return Kt}),n.d(e,"fb",function(){return Zt}),n.d(e,"gb",function(){return te}),n.d(e,"Bb",function(){return ee}),n.d(e,"Ab",function(){return ne}),n.d(e,"zb",function(){return ie}),n.d(e,"wb",function(){return oe}),n.d(e,"ub",function(){return re}),n.d(e,"b",function(){return ae}),n.d(e,"vb",function(){return se});var i="bp-is-active",o="bp-is-hidden",r="bp-is-invisible",a="is-disabled",s="bp-btn",l="bp-btn-plain",h="bp-btn-primary",c="bp-header",u=".bp-base-header",d=".bp-header-container",f="bp-doc-presentation",p="ba-annotations-loaded",g="ba-point-annotation-marker",m="ba-annotation-dialog",v="ba-annotation-caret",y="."+v,b="ba-textarea",E="annotation-textarea",w="."+E,C="ba-invalid-input",O="button-container",x="."+O,T="cancel-annotation-btn",_="."+T,S="post-annotation-btn",k="."+S,A=".delete-comment-btn",R="delete-confirmation-message",D="annotation-container",P="."+D,N="ba-annotation-comment-text",L="profile-container",M="profile-image-container",B="user-name",j="comment-date",H="ba-create-comment",I="ba-annotation-highlight-dialog",F="."+I,q="ba-plain-highlight",z="ba-highlight-dialog",Y="ba-is-text-highlighted",X="ba-annotation-highlight-label",W="ba-annotation-highlight-btns",U="."+W,V="ba-add-highlight-btn",G="."+V,J="ba-highlight-comment-btn",$="."+J,Q="ba-quad-corner-container",K="ba-quad-corner",Z="ba-annotation-drawing-label",tt="ba-annotation-drawing-dialog",et="ba-annotation-drawing-btns",nt="ba-btn-annotate-draw-add",it="."+nt,ot="ba-btn-annotate-draw-delete",rt="."+ot,at="ba-animate-show-dialog",st="ba-mobile-annotation-dialog",lt="ba-mobile-create-annotation-dialog",ht="ba-annotation-mobile-header",ct="."+ht,ut="ba-annotation-dialog-close",dt="ba-annotation-mode",ft="."+dt,pt="ba-point-mode",gt="ba-draw-mode",mt="ba-annotate-mode-background",vt=".ba-btn-annotate-point-exit",yt=".ba-point-mode-header",bt=".ba-draw-mode-header",Et="ba-annotation-layer-highlight",wt="ba-annotation-layer-highlight-comment",Ct="ba-annotation-layer-draw",Ot="ba-annotation-layer-draw-in-progress",xt=".ba-btn-annotate-draw-undo",Tt=".ba-btn-annotate-draw-redo",_t=".ba-btn-annotate-draw-post",St=".ba-btn-annotate-draw-cancel",kt="annotation-dialog",At="annotation-indicator",Rt="highlight-btn",Dt="add-highlight-comment-btn",Pt="post-annotation-btn",Nt="cancel-annotation-btn",Lt="reply-textarea",Mt="cancel-reply-btn",Bt="post-reply-btn",jt="delete-btn",Ht="cancel-delete-btn",It="confirm-delete-btn",Ft="mobile-dialog-close-btn",qt='[data-section="create"]',zt='[data-section="show"]',Yt="can_annotate",Xt="can_view_annotations_all",Wt="can_view_annotations_self",Ut={idle:"idle",drawing:"drawing",erasing:"erasing"},Vt={hover:"hover",inactive:"inactive",pending:"pending",pending_active:"pending-active"},Gt=[Vt.pending,Vt.pending_active],Jt={point:"point",highlight:"highlight",draw:"draw",highlight_comment:"highlight-comment"},$t={normal:"rgba(254, 217, 78, 0.5)",active:"rgba(255, 201, 0, 0.5)",erase:"rgba(255, 245, 132, 1)"},Qt={fetch:"annotationsfetched",error:"annotationerror",scale:"scaleannotations"},Kt={pending:"annotationpending",threadSave:"annotationthreadsaved",threadDelete:"annotationthreaddeleted",threadCleanup:"annotationthreadcleanup",save:"annotationsaved",delete:"annotationdeleted",deleteError:"annotationdeleteerror",cancel:"annotationcanceled",createError:"annotationcreateerror",show:"annotationshow",hide:"annotationhide"},Zt={toggleMode:"togglemode",enter:"annotationmodeenter",exit:"annotationmodeexit",createThread:"createannotationthread",register:"registerthread",unregister:"unregisterthread",bindDOMListeners:"binddomlisteners",unbindDOMListeners:"unbinddomlisteners",renderPage:"annotationsrenderpage",resetMobileDialog:"annotationsmobiledialogreset"},te={init:"init",post:"post_comment",cancel:"cancel",plain:"plain_highlight_create",comment:"comment_highlight_edit"},ee=15,ne=15,ie="mobile-annotation-dialog",oe=16.67,re=3,ae=5,se=5},function(t,e,n){"use strict";n(13);var c=n(0),i=n(2);n.d(e,"H",function(){return d}),n.d(e,"k",function(){return f}),n.d(e,"u",function(){return p}),n.d(e,"j",function(){return g}),n.d(e,"M",function(){return m}),n.d(e,"x",function(){return v}),n.d(e,"g",function(){return y}),n.d(e,"h",function(){return b}),n.d(e,"K",function(){return E}),n.d(e,"D",function(){return w}),n.d(e,"C",function(){return C}),n.d(e,"z",function(){return O}),n.d(e,"m",function(){return x}),n.d(e,"A",function(){return T}),n.d(e,"o",function(){return _}),n.d(e,"v",function(){return S}),n.d(e,"r",function(){return k}),n.d(e,"t",function(){return A}),n.d(e,"F",function(){return R}),n.d(e,"B",function(){return D}),n.d(e,"q",function(){return P}),n.d(e,"y",function(){return N}),n.d(e,"J",function(){return L}),n.d(e,"E",function(){return M}),n.d(e,"w",function(){return B}),n.d(e,"a",function(){return j}),n.d(e,"i",function(){return H}),n.d(e,"G",function(){return I}),n.d(e,"e",function(){return F}),n.d(e,"f",function(){return q}),n.d(e,"s",function(){return z}),n.d(e,"L",function(){return Y}),n.d(e,"I",function(){return X}),n.d(e,"b",function(){return W}),n.d(e,"d",function(){return U}),n.d(e,"c",function(){return V}),n.d(e,"l",function(){return G}),n.d(e,"n",function(){return J}),n.d(e,"p",function(){return $});var o="X-Box-Client-Name",r="X-Box-Client-Version",a="box-annotations",s="2.3.0",l=9,h=["annotations","annotationService","fileVersionId","locale","location","type"],u=/\r\n|\n\r|\n|\r/g;function d(t,e){var n=t.querySelector(e);if(n){var i=t.querySelectorAll("."+c.D);[].forEach.call(i,function(t){t.classList.add(c.O)}),n.classList.remove(c.O)}}function f(t,e){for(var n=t;n&&n!==document;n=n.parentNode)if(n.classList&&n.classList.contains(e))return n;return null}function p(t){var e=f(t,"page")||null,n=1;return e&&(n=parseInt(e.getAttribute("data-page-number"),10)),{pageEl:e,page:n}}function g(t,e){for(var n=e||"data-type",i=t;i&&i!==document;i=i.parentNode)if(i&&i.getAttribute(n))return i.getAttribute(n);return""}function m(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.remove(c.O)}function v(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.add(c.O)}function y(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.add(c.N)}function b(t){var e=t;("string"==typeof t||t instanceof String)&&(e=document.querySelector(t)),e&&e.classList.remove(c.N)}function E(t,e){var n=t;n.style.width="",n.style.height="",n.classList.remove(c.c),n.classList.remove(c.U),e&&(n.value="")}function w(t,e){return!!f(e||t.target,c.o)}function C(t){var e=t.target;return!(!f(e,c.o)&&!f(e,c.A))}function O(t,e){var n,i,o,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;t.insertBefore((n=t,i=e,(o=document.createRange()).selectNode(n),o.createContextualFragment(i.replace(/>\s*</g,"><"))),r)}function x(t,e,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"",o=document.createElement("button");return t.forEach(function(t){return o.classList.add(t)}),o.title=e,o.innerHTML=n,o.setAttribute("data-type",i),o}function T(t){var e=t.getBoundingClientRect();return 0<=e.top&&0<=e.left&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function _(t,e,n,i){if(""!==t)return('<img src="'+t+'" alt="'+i+'">').trim();var o="";return"0"!==e&&(o=n.replace(/\W*(\w)\w*/g,"$1").toUpperCase().substring(0,3)),('<div class="ba-annotation-profile avatar-color-'+(parseInt(e,10)||0)%l+'">'+o+"</div>").trim()}function S(t){return parseFloat(t.getAttribute("data-scale"))||1}function k(t){return t[Object.keys(t)[0]]}function A(t){var e=Object.keys(t).length;return t[Object.keys(t)[e-1]]}function R(t){var e=k(t);return 1===Object.keys(t).length&&""===e.text}function D(t){return t===c.ic.highlight||t===c.ic.highlight_comment}function P(t,e,n,i){var o=null;if(t&&void 0!==t.x&&void 0!==t.y){var r=e.width/n,a=(e.height-i)/n;(1<Math.abs(r-t.x)||1<Math.abs(a!==t.y))&&(o={x:r/t.x,y:a/t.y})}return o}function N(t){return(""+t).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/`/g,"&#96;")}function L(t,e,n,i,o){var r=e<0,a=o<e+n,s=t.querySelector(c.Sb);if(r&&!a){var l=Math.max(10,i);return s.style.left=l+"px",0}if(!a||r)return s.style.left="50%",e;var h=Math.max(10,o-i);return s.style.left=n-h+"px",o-n}function M(t){return-1<c.Cb.indexOf(t)}function B(t){return!!(D(t.type)||t.minX&&t.minY&&t.maxX&&t.maxY)}function j(e){return!!e&&!(!(e.type!==c.ic.point||(i=e.location)&&i.x&&i.y)||D(e.type)&&(!(n=e.location)||!n.quadPoints)||e.type===c.ic.draw&&!((t=e.location)&&t.minX&&t.minY&&t.maxX&&t.maxY))&&h.every(function(t){return void 0!==e[t]});var t,n,i}function H(i,o){return function(t){var e=t||window.event;if(e&&(!e.target||"BUTTON"!==e.target.nodeName)){e.preventDefault(),e.stopPropagation();var n=i(e);o(n)}}}function I(t){t&&(t.preventDefault(),t.stopPropagation())}function F(t,e,n){var i={x:t,y:e};return n&&(i.dimensions=n),i}function q(t){return n="",i=(e=t).keyIdentifier,o=e.key||i||"",e.ctrlKey?n="Control":e.shiftKey?n="Shift":e.metaKey&&(n="Meta"),o===n&&(o=""),0===o.indexOf("U+")&&(o="U+001B"===o?"Escape":String.fromCharCode(Number(o.replace("U+","0x")))),o?(" "===o&&(o="Space"),"Esc"===o&&(o="Escape"),"Right"!==o&&"Left"!==o&&"Down"!==o&&"Up"!==o||(o="Arrow"+o),n&&(n+="+"),n+o):"";var e,n,i,o}function z(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"";return e&&(t.Authorization="Bearer "+e),n&&(t.BoxApi="shared_link="+n,i&&(t.BoxApi=t.BoxApi+"&shared_link_password="+i)),a&&(t[o]=a),s&&(t[r]=s),t}function Y(t,e){var n=(t+"e").split("e");return+((n=(Math.round(n[0]+"e"+(+n[1]+e))+"e").split("e"))[0]+"e"+(+n[1]-e))}function X(t,n){return t&&t.length?t.replace(/\{\d+\}/g,function(t){var e=parseInt(t.replace(/^\D+/g,""),10)-1;return n[e]?n[e]:t}):t}function W(t){if(!t)return!1;var e=t[c.Db],n=t[c.Eb],i=t[c.Fb];return!!e||!!n||!!i}function U(t){var e=t.replace(u,"\n").split("\n"),n=document.createElement("p");return n.classList.add(c.m),1<e.length?e.forEach(function(t){if(""===t)n.appendChild(document.createElement("br"));else{var e=document.createElement("p");e.textContent=t,n.appendChild(e)}}):n.textContent=t,n}function V(t,e){var n=t.querySelector("canvas."+e);if(n){var i=n.getContext("2d");i&&i.clearRect(0,0,n.width,n.height)}}function G(t){var e=t;return e&&(e.classList.add(c.c),e.selectionStart&&(e.selectionEnd=e.value.length,e.selectionStart=e.selectionEnd),T(e)&&e.focus()),e}function J(){var t=document.createElement("div"),e=document.createElement("div");e.classList.add(c.Y),t.appendChild(e);var n=x([c.M],c.qb,i.a,c.qb);return e.appendChild(n),t}function $(t){var e,n,i=t;("string"==typeof(n=e=i)||e instanceof String)&&(n=document.querySelector(e)),n&&n.classList.add(c.V),m(i),i.style.left=0;var o,r,a=i.getBoundingClientRect().width;return v(i),("string"==typeof(r=o=i)||o instanceof String)&&(r=document.querySelector(o)),r&&r.classList.remove(c.V),a}},function(t,e,n){"use strict";n.d(e,"f",function(){return O}),n.d(e,"g",function(){return x}),n.d(e,"b",function(){return T}),n.d(e,"e",function(){return _}),n.d(e,"a",function(){return S}),n.d(e,"d",function(){return k}),n.d(e,"c",function(){return A});var i=n(14),o=n.n(i),r=n(15),a=n.n(r),s=n(16),l=n.n(s),h=n(17),c=n.n(h),u=n(18),d=n.n(u),f=n(19),p=n.n(f),g=n(20),m=n.n(g),v=n(21),y=n.n(v),b=n(22),E=n.n(b),w=n(23),C=n.n(w),O=(o.a,a.a),x=l.a,T=(c.a,d.a,p.a),_=m.a,S=y.a,k=E.a,A=C.a},function(t,e){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function l(t){return"function"==typeof t}function h(t){return"object"==typeof t&&null!==t}function c(t){return void 0===t}((t.exports=i).EventEmitter=i).prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,n,i,o,r,a;if(this._events||(this._events={}),"error"===t&&(!this._events.error||h(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var s=new Error('Uncaught, unspecified "error" event. ('+e+")");throw s.context=e,s}if(c(n=this._events[t]))return!1;if(l(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(h(n))for(o=Array.prototype.slice.call(arguments,1),i=(a=n.slice()).length,r=0;r<i;r++)a[r].apply(this,o);return!0},i.prototype.on=i.prototype.addListener=function(t,e){var n;if(!l(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,l(e.listener)?e.listener:e),this._events[t]?h(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,h(this._events[t])&&!this._events[t].warned&&(n=c(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&0<n&&this._events[t].length>n&&(this._events[t].warned=!0,console.trace),this},i.prototype.once=function(t,e){if(!l(e))throw TypeError("listener must be a function");var n=!1;function i(){this.removeListener(t,i),n||(n=!0,e.apply(this,arguments))}return i.listener=e,this.on(t,i),this},i.prototype.removeListener=function(t,e){var n,i,o,r;if(!l(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(o=(n=this._events[t]).length,i=-1,n===e||l(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(h(n)){for(r=o;0<r--;)if(n[r]===e||n[r].listener&&n[r].listener===e){i=r;break}if(i<0)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(l(n=this._events[t]))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){return this._events&&this._events[t]?l(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(l(e))return 1;if(e)return e.length}return 0},i.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(3),o=n.n(i),s=n(10),l=n(6),h=n(1),r=n(2),c=n(0),u=function(t,e,n){return e&&d(t.prototype,e),n&&d(t,n),t};function d(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var f=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(p,o.a),u(p,[{key:"destroy",value:function(){this.dialog&&!this.isMobile&&(this.unbindCustomListenersOnDialog(),this.dialog.destroy(),this.dialog=null),this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null),this.state!==c.gc.pending&&this.emit(c.hc.threadDelete)}},{key:"hide",value:function(){h.x(this.element)}},{key:"reset",value:function(){this.state=c.gc.inactive}},{key:"isDialogVisible",value:function(){return!(!this.dialog||!this.dialog.element||this.dialog.element.classList.contains(c.O))}},{key:"showDialog",value:function(){this.dialog.element||this.dialog.setup(this.annotations,this.element),this.dialog.show()}},{key:"hideDialog",value:function(){this.dialog&&(this.state=c.gc.inactive,this.dialog.hide())}},{key:"saveAnnotation",value:function(t,e){var n=this,i=this.createAnnotationData(t,e),o=l.a.generateID(),r=i;r.annotationID=o,r.permissions={can_edit:!0,can_delete:!0},r.created=(new Date).getTime(),r.modified=r.created;var a=new s.a(r);return this.saveAnnotationToThread(a),this.state=c.gc.inactive,this.dialog&&this.dialog.disable(a.annotationID),this.annotationService.create(i).then(function(t){return n.updateTemporaryAnnotation(a,t)}).catch(function(t){return n.handleThreadSaveError(t,o)})}},{key:"deleteAnnotation",value:function(t){var e=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],i=this.annotations[t];if(!i)return this.emit(c.hc.deleteError),Promise.reject();if(i.permissions&&!i.permissions.can_delete)return this.emit(c.hc.deleteError),Promise.reject();delete this.annotations[t];var o=h.r(this.annotations),r=o&&o.permissions&&o.permissions.can_delete;return h.F(this.annotations)&&!r?this.cancelFirstComment():!o||h.F(this.annotations)?(this.isMobile&&this.dialog&&(this.dialog.hideMobileDialog(),this.dialog.removeAnnotation(t)),this.destroy()):this.dialog&&(this.dialog.removeAnnotation(t),this.showDialog(),this.dialog.activateReply()),n?this.annotationService.delete(t).then(function(){o=h.r(e.annotations),r=o&&o.permissions&&o.permissions.can_delete,h.F(e.annotations)&&r&&e.annotationService.delete(o.annotationID),(o=h.r(e.annotations))||e.emit(c.hc.threadCleanup),e.emit(c.hc.delete)}).catch(function(t){e.emit(c.hc.deleteError)}):Promise.resolve()}},{key:"cancelFirstComment",value:function(){}},{key:"show",value:function(){}},{key:"createDialog",value:function(){}},{key:"setup",value:function(){var t=h.r(this.annotations);this.state=t?c.gc.inactive:c.gc.pending,this.createDialog(),this.bindCustomListenersOnDialog(),this.dialog&&(this.dialog.isMobile=this.isMobile,this.dialog.localized=this.localized),this.setupElement()}},{key:"setupElement",value:function(){this.element=this.createElement(),this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element&&this.element.addEventListener("click",this.showDialog)}},{key:"unbindDOMListeners",value:function(){this.element&&this.element.removeEventListener("click",this.showDialog)}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.createAnnotation=this.createAnnotation.bind(this),this.cancelUnsavedAnnotation=this.cancelUnsavedAnnotation.bind(this),this.deleteAnnotationWithID=this.deleteAnnotationWithID.bind(this),this.dialog.addListener("annotationcreate",this.createAnnotation),this.dialog.addListener("annotationcancel",this.cancelUnsavedAnnotation),this.dialog.addListener("annotationdelete",this.deleteAnnotationWithID),this.dialog.addListener("annotationshow",function(){return t.emit(c.hc.show)}),this.dialog.addListener("annotationhide",function(){return t.emit(c.hc.hide)}))}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog&&this.dialog.removeAllListeners(["annotationcreate","annotationcancel","annotationdelete","annotationshow","annotationhide"])}},{key:"cancelUnsavedAnnotation",value:function(){h.E(this.state)?(this.emit(c.hc.cancel),this.destroy()):this.hideDialog()}},{key:"scrollIntoView",value:function(){var t=parseInt(this.location.y,10);this.scrollToPage(),this.centerAnnotation(this.annotatedElement.scrollTop+t)}},{key:"scrollToPage",value:function(){this.location&&this.location.page&&this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]').scrollIntoView()}},{key:"centerAnnotation",value:function(t){t<this.annotatedElement.scrollHeight?this.annotatedElement.scrollTop=t:this.annotatedElement.scrollTop=this.annotatedElement.scrollBottom}},{key:"updateTemporaryAnnotation",value:function(t,e){t.annotationID in this.annotations?(delete this.annotations[t.annotationID],this.annotations[e.annotationID]=e):this.saveAnnotationToThread(e),!this.threadNumber&&e&&e.threadNumber&&(this.threadNumber=e.threadNumber),this.dialog&&(this.dialog.element&&this.dialog.element.dataset&&(this.dialog.element.dataset.threadNumber=this.threadNumber),this.dialog.addAnnotation(e),this.dialog.removeAnnotation(t.annotationID),this.dialog.enable(e.annotationID),this.dialog.scrollToLastComment()),this.isMobile&&(this.state=c.gc.hover,this.showDialog()),this.emit(c.hc.save)}},{key:"createElement",value:function(){var t=document.createElement("button");return t.classList.add(c.A),t.setAttribute("data-type",c.jb),t.innerHTML=r.g,t}},{key:"saveAnnotationToThread",value:function(t){this.annotations[t.annotationID]=t,this.dialog&&(this.dialog.addAnnotation(t),this.dialog.activateReply())}},{key:"createAnnotationData",value:function(t,e){return{fileVersionId:this.fileVersionId,type:t,text:e,location:this.location,user:this.annotationService.user,threadID:this.threadID,threadNumber:this.threadNumber}}},{key:"createAnnotation",value:function(t){this.saveAnnotation(c.ic.point,t.text)}},{key:"deleteAnnotationWithID",value:function(t){this.deleteAnnotation(t.annotationID)}},{key:"regenerateBoundary",value:function(){this.location&&this.location.x&&this.location.y&&(this.minX=this.location.x,this.maxX=this.location.x,this.minY=this.location.y,this.maxY=this.location.y)}},{key:"handleThreadSaveError",value:function(t,e){this.deleteAnnotation(e,!1),this.emit(c.hc.createError)}},{key:"getThreadEventData",value:function(){var t={type:this.type,threadID:this.threadID};return 0<this.annotationService.user.id&&(t.userId=this.annotationService.user.id),this.threadNumber&&(t.threadNumber=this.threadNumber),t}},{key:"emit",value:function(t,e){var n=this.getThreadEventData();a(p.prototype.__proto__||Object.getPrototypeOf(p.prototype),"emit",this).call(this,t,{data:n,eventData:e}),a(p.prototype.__proto__||Object.getPrototypeOf(p.prototype),"emit",this).call(this,"threadevent",{event:t,data:n,eventData:e})}}]),p);function p(t){!function(t){if(!(t instanceof p))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(p.__proto__||Object.getPrototypeOf(p)).call(this));return e.annotatedElement=t.annotatedElement,e.annotations=t.annotations||{},e.annotationService=t.annotationService,e.container=t.container,e.fileVersionId=t.fileVersionId,e.location=t.location,e.threadID=t.threadID||l.a.generateID(),e.threadNumber=t.threadNumber||"",e.type=t.type,e.locale=t.locale,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.permissions=t.permissions,e.localized=t.localized,e.state=c.gc.inactive,e.regenerateBoundary(),e.showDialog=e.showDialog.bind(e),e.setup(),e}e.a=f},function(t,e,n){"use strict";var i=n(3),o=n.n(i),b=n(1),E=n(0),w=n(2),r=function(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t};function a(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var s="ba-annotation-dialog-flipped",l=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(h,o.a),r(h,[{key:"destroy",value:function(){this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null)}},{key:"show",value:function(){if(this.isMobile)this.showMobileDialog();else if(this.element&&!this.element.classList.contains(E.O))return;var t=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(E.Wb);if(this.canAnnotate&&t.classList.contains(E.c)&&this.element.parentNode)return b.M(this.element),void this.scrollToLastComment();this.isMobile||this.position(),this.scrollToLastComment(),this.emit("annotationshow")}},{key:"scrollToLastComment",value:function(){if(this.element){this.hasAnnotations&&this.activateReply();var t=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(E.Wb);b.l(t);var e=this.element.querySelector(E.Tb);if(e){var n=this.dialogEl.classList.contains(s)?0:e.clientHeight;e.scrollTop=e.scrollHeight-n}}}},{key:"showMobileDialog",value:function(){if(this.element=this.container.querySelector("."+E.W),this.element.classList.contains(E.O)){b.M(this.element),this.element.appendChild(this.dialogEl);var t=this.element.querySelectorAll(".annotation-comment");this.highlightDialogEl&&!t.length&&(this.element.classList.add(E.z),this.element.querySelector(E.ec).classList.add(E.O)),this.element.classList.add(E.g),this.bindDOMListeners()}}},{key:"hideMobileDialog",value:function(){this.element&&(this.dialogEl&&this.dialogEl.parentNode&&this.dialogEl.parentNode.removeChild(this.dialogEl),b.x(this.element),this.unbindDOMListeners(),this.element=b.n())}},{key:"hide",value:function(){this.element&&this.element.classList.contains(E.O)||(this.isMobile&&this.hideMobileDialog(),b.x(this.element),this.deactivateReply(),this.emit("annotationhide"),this.toggleFlippedThreadEl())}},{key:"addAnnotation",value:function(t){if(!this.hasAnnotations){var e=this.element.querySelector(E.Gb),n=this.element.querySelector(E.Hb);b.x(e),b.M(n),this.hasAnnotations=!0}this.addAnnotationElement(t)}},{key:"removeAnnotation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');e&&e.parentNode.removeChild(e);var n=this.element.querySelector(".reply-textarea");n&&n.focus()}},{key:"postAnnotation",value:function(t){var e=this.element.querySelector(E.Wb),n=t||e.value;""!==n.trim()?(this.emit("annotationcreate",{text:n}),e.value=""):e.classList.add(E.U)}},{key:"position",value:function(){}},{key:"setup",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0;if(this.threadEl=e,this.dialogEl=this.generateDialogEl(Object.keys(t).length),this.dialogEl.classList.add(E.n),!this.isMobile){this.element=document.createElement("div"),this.element.setAttribute("data-type",E.ib),this.element.classList.add(E.o),this.element.classList.add(E.O),this.element.innerHTML='<div class="'+E.l+'"></div>',this.element.appendChild(this.dialogEl);var n=b.r(t);n&&(this.element.dataset.threadNumber=n.threadNumber),this.bindDOMListeners()}this.addSortedAnnotations(t)}},{key:"addSortedAnnotations",value:function(e){var n=this,t=Object.keys(e).map(function(t){return e[t]});t.sort(function(t,e){return new Date(t.created)-new Date(e.created)}),t.forEach(function(t){n.addAnnotationElement(t)})}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("wheel",this.stopPropagation),this.element.addEventListener("mouseup",this.stopPropagation),this.hasTouch&&(this.element.addEventListener("touchstart",this.clickHandler),this.element.addEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.addEventListener("focus",this.validateTextArea);var e=this.element.querySelector(E.Wb);e&&e.addEventListener("focus",this.validateTextArea),this.isMobile||this.element.addEventListener("click",this.clickHandler)}},{key:"validateTextArea",value:function(t){var e=t.target;"textarea"===e.type&&""!==e.value.trim()&&e.classList.remove(E.U)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation),this.hasTouch&&(this.element.removeEventListener("touchstart",this.clickHandler),this.element.removeEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.removeEventListener("focus",this.validateTextArea);var e=this.element.querySelector(E.Wb);e&&e.removeEventListener("focus",this.validateTextArea),this.isMobile||(this.element.removeEventListener("click",this.clickHandler),this.element.removeEventListener("click",this.stopPropagation))}},{key:"enable",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');if(e){var n=e.querySelectorAll("button");Array.prototype.forEach.call(n,function(t){t.classList.remove(E.N)})}}},{key:"disable",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]');if(e){var n=e.querySelectorAll("button");Array.prototype.forEach.call(n,function(t){t.classList.add(E.N)})}}},{key:"keydownHandler",value:function(t){t.stopPropagation(),"Escape"===b.f(t)?this.hasAnnotations?this.hide():this.cancelAnnotation():"reply-textarea"===b.j(t.target)&&this.scrollToLastComment()}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"clickHandler",value:function(t){t.stopPropagation(),this.isMobile&&t.target&&"BUTTON"===t.target.nodeName&&t.preventDefault();var e=t.target,n=b.j(e),i=b.j(e,"data-annotation-id");switch(n){case E.rb:this.postAnnotation();break;case E.kb:case E.qb:this.hide(),this.isMobile||this.cancelAnnotation();break;case E.tb:this.activateReply();break;case E.mb:this.deactivateReply(!0);break;case E.sb:this.postReply();break;case E.ob:this.showDeleteConfirmation(i);break;case E.lb:this.hideDeleteConfirmation(i);break;case E.nb:this.deleteAnnotation(i)}}},{key:"addAnnotationElement",value:function(t){var e,n=b.y(t.user.id||"0");e="0"===n?this.localized.posting:b.y(t.user.name)||this.localized.anonymousUserName;var i=b.y(t.user.avatarUrl||""),o=b.o(i,n,e,this.localized.profileAlt),r=new Date(t.created).toLocaleString(this.locale,{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),a=b.d(t.text),s=document.createElement("div");s.classList.add("annotation-comment"),s.setAttribute("data-annotation-id",t.annotationID),this.dialogEl.querySelector(".annotation-comments").appendChild(s);var l=document.createElement("div");l.classList.add(E.bb),l.innerHTML=o,s.appendChild(l);var h=document.createElement("div");h.classList.add(E.ab),s.appendChild(h);var c=document.createElement("div");c.classList.add(E.eb),c.textContent=e,h.appendChild(c);var u=document.createElement("div");u.classList.add(E.I),u.textContent=r,h.appendChild(u);var d=document.createElement("div");if(d.appendChild(a),s.appendChild(d),t.permissions.can_delete){var f=b.m([E.G,"delete-comment-btn"],this.localized.deleteButton,w.b,E.ob);s.appendChild(f);var p=document.createElement("div");p.classList.add("delete-confirmation"),p.classList.add(E.O),s.appendChild(p);var g=document.createElement("div");g.classList.add(E.K),g.textContent=this.localized.deleteConfirmation,p.appendChild(g);var m=document.createElement("div");m.classList.add(E.F),p.appendChild(m);var v=b.m([E.E,"cancel-delete-btn"],this.localized.cancelButton,this.localized.cancelButton,E.lb);m.appendChild(v);var y=b.m([E.E,"confirm-delete-btn",E.H],this.localized.deleteButton,this.localized.deleteButton,E.nb);m.appendChild(y)}}},{key:"cancelAnnotation",value:function(){this.emit("annotationcancel")}},{key:"activateReply",value:function(){if(this.dialogEl){var t=this.dialogEl.querySelector(".reply-textarea");if(t){var e=t.classList.contains(E.c);if(t.classList.remove(E.U),!e){var n=t.parentNode.querySelector(E.Zb);t.classList.add(E.c),b.M(n)}}}}},{key:"deactivateReply",value:function(t){if(this.dialogEl){var e=this.dialogEl.querySelector(".reply-container");if(e){var n=e.querySelector(".reply-textarea"),i=e.querySelector(E.Zb);b.K(n,t),b.x(i)}}}},{key:"postReply",value:function(){var t=this.element.querySelector(".reply-textarea"),e=t.value;""!==e.trim()?(this.emit("annotationcreate",{text:e}),t.value="",t.focus()):t.classList.add(E.U)}},{key:"showDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),n=e.querySelector(".delete-confirmation"),i=e.querySelector(".cancel-delete-btn"),o=e.querySelector(E.ac);b.x(o),b.M(n),i.focus()}},{key:"hideDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),n=e.querySelector(".delete-confirmation"),i=e.querySelector(E.ac);b.M(i),b.x(n),i.focus()}},{key:"deleteAnnotation",value:function(t){this.emit("annotationdelete",{annotationID:t})}},{key:"generateDialogEl",value:function(t){var e=document.createElement("div");if(this.canAnnotate){var n=document.createElement("section");n.setAttribute("data-section","create"),t&&n.classList.add(E.O),e.appendChild(n);var i=document.createElement("textarea");i.classList.add(E.cb),i.classList.add(E.C),i.placeholder=this.localized.addCommentPlaceholder,n.appendChild(i);var o=document.createElement("div");o.classList.add(E.F),n.appendChild(o);var r=b.m([E.E,E.j],this.localized.cancelButton,this.localized.cancelButton,E.kb);o.appendChild(r);var a=b.m([E.E,E.H,E.k],this.localized.postButton,this.localized.postButton,E.rb);o.appendChild(a)}var s=document.createElement("section");s.setAttribute("data-section","show"),t||s.classList.add(E.O),e.appendChild(s);var l=document.createElement("div");if(l.classList.add("annotation-comments"),s.appendChild(l),this.canAnnotate){var h=document.createElement("div");h.classList.add("reply-container"),s.appendChild(h);var c=document.createElement("textarea");c.classList.add(E.cb),c.classList.add(E.C),c.classList.add("reply-textarea"),c.placeholder=this.localized.replyPlaceholder,c.setAttribute("data-type",E.tb),h.appendChild(c);var u=document.createElement("div");u.classList.add(E.F),u.classList.add(E.O),h.appendChild(u);var d=b.m([E.E,E.j],this.localized.cancelButton,this.localized.cancelButton,E.mb);u.appendChild(d);var f=b.m([E.E,E.H,E.k],this.localized.postButton,this.localized.postButton,E.sb);u.appendChild(f)}return e}},{key:"flipDialog",value:function(t,e){var n="",i="",o=this.element.querySelector(E.Sb);return t<=e/2?(n=t-8+"px",i="",this.element.classList.remove(s),o.style.bottom=""):(n="",i=e-t-27+"px",this.element.classList.add(s),o.style.top="",o.style.bottom="0px"),this.fitDialogHeightInPage(),this.toggleFlippedThreadEl(),{top:n,bottom:i}}},{key:"toggleFlippedThreadEl",value:function(){this.element&&this.threadEl&&this.element.classList.contains(s)&&(this.element.classList.contains(E.O)?this.threadEl.classList.remove(s):this.threadEl.classList.add(s))}},{key:"fitDialogHeightInPage",value:function(){var t=this.container.clientHeight/2-E.Bb-E.Ab;this.dialogEl.style.maxHeight=t+"px";var e=this.dialogEl.querySelector("."+E.n);e&&(e.style.maxHeight=t+"px")}}]),h);function h(t){!function(t){if(!(t instanceof h))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));return e.annotatedElement=t.annotatedElement,e.container=t.container,e.location=t.location,e.hasAnnotations=0<Object.keys(t.annotations).length,e.canAnnotate=t.canAnnotate,e.locale=t.locale,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.keydownHandler=e.keydownHandler.bind(e),e.clickHandler=e.clickHandler.bind(e),e.stopPropagation=e.stopPropagation.bind(e),e.validateTextArea=e.validateTextArea.bind(e),e}e.a=l},function(t,e,n){"use strict";n(13);var i=n(3),o=n.n(i),r=n(10),a=n(1),s=function(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t};function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,o.a),s(c,null,[{key:"generateID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}}]),s(c,[{key:"create",value:function(t){var a=this;return new Promise(function(o,r){fetch(a.api+"/2.0/annotations",{method:"POST",headers:a.headers,body:JSON.stringify({item:{type:"file_version",id:t.fileVersionId},details:{type:t.type,drawingPaths:t.drawingPaths,location:t.location,threadID:t.threadID},message:t.text,thread:t.threadNumber})}).then(function(t){return t.json()}).then(function(t){if("error"!==t.type&&t.id){var e=t;e.permissions={can_edit:!0,can_delete:!0};var n=a.createAnnotation(e);"0"===a.user.id&&(a.user=n.user),o(n)}else{var i=new Error("Could not create annotation");r(i),a.emit("annotationerror",{reason:"create",error:i.toString()})}}).catch(function(t){r(new Error("Could not create annotation due to invalid or expired token")),a.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"read",value:function(t){this.annotations={};var n=void 0,i=void 0,e=new Promise(function(t,e){n=t,i=e});return this.readFromMarker(n,i,t),e}},{key:"delete",value:function(o){var r=this;return new Promise(function(n,i){fetch(r.api+"/2.0/annotations/"+o,{method:"DELETE",headers:r.headers}).then(function(t){if(204===t.status)n();else{var e=new Error("Could not delete annotation with ID "+o);i(e),r.emit("annotationerror",{reason:"delete",error:e.toString()})}}).catch(function(t){i(new Error("Could not delete annotation due to invalid or expired token")),r.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"getThreadMap",value:function(t){return this.read(t).then(this.createThreadMap)}},{key:"createThreadMap",value:function(o){var r={};return this.annotations=o,Object.keys(o).forEach(function(t){var e=o[t],n=e.threadID,i=r[n]||[];(r[n]=i)[e.annotationID]=e}),r}},{key:"createAnnotation",value:function(t){return new r.a({annotationID:t.id,fileVersionId:t.item.id,threadID:t.details.threadID,type:t.details.type,threadNumber:t.thread,text:t.message,location:t.details.location,user:{id:t.created_by.id,name:t.created_by.name,avatarUrl:t.created_by.profile_image},permissions:t.permissions,created:t.created_at,modified:t.modified_at})}},{key:"getReadUrl",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=this.api+"/2.0/files/"+this.fileId+"/annotations?version="+t+"&fields=item,thread,details,message,created_by,created_at,modified_at,permissions";return e&&(i+="&marker="+e),n&&(i+="&limit="+n),i}},{key:"readFromMarker",value:function(n,i,o){var r=this,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;fetch(this.getReadUrl(o,t,a),{headers:this.headers}).then(function(t){return t.json()}).then(function(t){if("error"!==t.type&&Array.isArray(t.entries))t.entries.forEach(function(t){var e=r.createAnnotation(t);r.annotations[e.annotationID]=e}),t.next_marker?r.readFromMarker(n,i,o,t.next_marker,a):n(r.annotations);else{var e=new Error("Could not read annotations from file version with ID "+o);i(e),r.emit("annotationerror",{reason:"read",error:e.toString()})}}).catch(function(t){i(new Error("Could not read annotations from file due to invalid or expired token")),r.emit("annotationerror",{reason:"authorization",error:t.toString()})})}}]),c);function c(t){!function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return e.api=t.apiHost,e.fileId=t.fileId,e.headers=Object(a.s)({},t.token),e.canAnnotate=t.canAnnotate,e.user={id:"0",name:e.anonymousUserName},e.createThreadMap=e.createThreadMap.bind(e),e}e.a=h},function(t,e,n){var i,o;void 0===(o="function"==typeof(i=function(){var i="object",o="function",n="undefined",l=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],h=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],e=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],r=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function c(t,e){var n=typeof t[e];return n==o||!(n!=i||!t[e])||"unknown"==n}function a(t,e){return!(typeof t[e]!=i||!t[e])}function t(t,e){return typeof t[e]!=n}function s(i){return function(t,e){for(var n=e.length;n--;)if(!i(t,e[n]))return!1;return!0}}var u=s(c),d=s(a),f=s(t);function p(t){return t&&u(t,r)&&f(t,e)}function g(t){return a(t,"body")?t.body:t.getElementsByTagName("body")[0]}var m,v,y={},b=typeof window!=n&&typeof document!=n,E={isHostMethod:c,isHostObject:a,isHostProperty:t,areHostMethods:u,areHostObjects:d,areHostProperties:f,isTextRange:p,getBody:g,forEach:[].forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=0,i=t.length;n<i;++n)e(t[n],n)}},w={version:"1.3.0",initialized:!1,isBrowser:b,supported:!0,util:E,features:{},modules:y,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==n||rangyAutoInitialize}};function C(){typeof console!=n&&c(console,"log")}function O(t,e){b&&e?alert(t):C()}function x(t){w.initialized=!0,w.supported=!1,O("Rangy is not supported in this environment. Reason: "+t,w.config.alertOnFail)}w.fail=x,w.warn=function(t){O("Rangy warning: "+t,w.config.alertOnWarn)},{}.hasOwnProperty?(E.extend=m=function(t,e,n){var i,o;for(var r in e)e.hasOwnProperty(r)&&(i=t[r],o=e[r],n&&null!==i&&"object"==typeof i&&null!==o&&"object"==typeof o&&m(i,o,!0),t[r]=o);return e.hasOwnProperty("toString")&&(t.toString=e.toString),t},E.createOptions=function(t,e){var n={};return m(n,e),t&&m(n,t),n}):x("hasOwnProperty not supported"),b||x("Rangy can only run in a browser"),function(){var t;if(b){var e=document.createElement("div");e.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(t){return n.call(t,0)})}catch(t){}}t=t||function(t){for(var e=[],n=0,i=t.length;n<i;++n)e[n]=t[n];return e},E.toArray=t}(),b&&(c(document,"addEventListener")?v=function(t,e,n){t.addEventListener(e,n,!1)}:c(document,"attachEvent")?v=function(t,e,n){t.attachEvent("on"+e,n)}:x("Document does not have required addEventListener or attachEvent method"),E.addListener=v);var T=[];function _(t){return t.message||t.description||String(t)}function S(){if(b&&!w.initialized){var t,e=!1,n=!1;c(document,"createRange")&&(t=document.createRange(),u(t,h)&&f(t,l)&&(e=!0));var i=g(document);if(i&&"body"==i.nodeName.toLowerCase())if(i&&c(i,"createTextRange")&&p(t=i.createTextRange())&&(n=!0),e||n){var o;for(var r in w.initialized=!0,w.features={implementsDomRange:e,implementsTextRange:n},y)(o=y[r])instanceof D&&o.init(o,w);for(var a=0,s=T.length;a<s;++a)try{T[a](w)}catch(t){C(_(t))}}else x("Neither Range nor TextRange are available");else x("No body element found")}}function k(t,e,n){n&&(t+=" in module "+n.name),w.warn("DEPRECATED: "+t+" is deprecated. Please use "+e+" instead.")}function A(t,e,n,i){t[e]=function(){return k(e,n,i),t[n].apply(t,E.toArray(arguments))}}E.deprecationNotice=k,E.createAliasForDeprecatedMethod=A,w.init=S,w.addInitListener=function(t){w.initialized?t(w):T.push(t)};var R=[];function D(t,e,n){this.name=t,this.dependencies=e,this.initialized=!1,this.supported=!1,this.initializer=n}function P(t,e,n){var i=new D(t,e,function(t){if(!t.initialized){t.initialized=!0;try{n(w,t),t.supported=!0}catch(t){_(t),C(),t.stack&&C(t.stack)}}});return y[t]=i}function N(){}w.addShimListener=function(t){R.push(t)},b&&(w.shim=w.createMissingNativeApi=function(t){t=t||window,S();for(var e=0,n=R.length;e<n;++e)R[e](t)},A(w,"createMissingNativeApi","shim")),D.prototype={init:function(){for(var t,e,n=this.dependencies||[],i=0,o=n.length;i<o;++i){if(e=n[i],!((t=y[e])&&t instanceof D))throw new Error("required module '"+e+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+e+"' not supported")}this.initializer(this)},fail:function(t){throw this.initialized=!0,this.supported=!1,new Error(t)},warn:function(t){w.warn("Module "+this.name+": "+t)},deprecationNotice:function(t,e){w.warn("DEPRECATED: "+t+" in module "+this.name+" is deprecated. Please use "+e+" instead")},createError:function(t){return new Error("Error in Rangy "+this.name+" module: "+t)}},w.createModule=function(t){var e,n=P(t,2==arguments.length?(e=arguments[1],[]):(e=arguments[2],arguments[1]),e);w.initialized&&w.supported&&n.init()},w.createCoreModule=function(t,e,n){P(t,e,n)},w.RangePrototype=N,w.rangePrototype=new N,w.selectionPrototype=new function(){},w.createCoreModule("DomUtil",[],function(n,h){var i="undefined",o=n.util,a=o.getBody;o.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||h.fail("document missing a Node creation method"),o.isHostMethod(document,"getElementsByTagName")||h.fail("document missing getElementsByTagName method");var t=document.createElement("div");o.areHostMethods(t,["insertBefore","appendChild","cloneNode"])||h.fail("Incomplete Element implementation"),o.isHostProperty(t,"innerHTML")||h.fail("Element is missing innerHTML property");var e=document.createTextNode("test");o.areHostMethods(e,["splitText","deleteData","insertData","appendData","cloneNode"])||h.fail("Incomplete Text Node implementation");function r(t,e){for(var n=t.length;n--;)if(t[n]===e)return!0;return!1}function c(t){for(var e=0;t=t.previousSibling;)++e;return e}function u(t,e){var n,i=[];for(n=t;n;n=n.parentNode)i.push(n);for(n=e;n;n=n.parentNode)if(r(i,n))return n;return null}function s(t,e,n){for(var i=n?e:e.parentNode;i;){if(i===t)return!0;i=i.parentNode}return!1}function d(t,e,n){for(var i,o=n?t:t.parentNode;o;){if((i=o.parentNode)===e)return o;o=i}return null}function l(t){var e=t.nodeType;return 3==e||4==e||8==e}function f(t,e){var n=e.nextSibling,i=e.parentNode;return n?i.insertBefore(t,n):i.appendChild(t),t}function p(t){if(9==t.nodeType)return t;if(typeof t.ownerDocument!=i)return t.ownerDocument;if(typeof t.document!=i)return t.document;if(t.parentNode)return p(t.parentNode);throw h.createError("getDocument: no document found for node")}function g(t){var e=p(t);if(typeof e.defaultView!=i)return e.defaultView;if(typeof e.parentWindow!=i)return e.parentWindow;throw h.createError("Cannot get a window object for node")}function m(t){if(typeof t.contentDocument!=i)return t.contentDocument;if(typeof t.contentWindow!=i)return t.contentWindow.document;throw h.createError("getIframeDocument: No Document object found for iframe element")}function v(t){return t&&o.isHostMethod(t,"setTimeout")&&o.isHostObject(t,"document")}var y,b=!1;function E(t){try{return t.parentNode,!1}catch(t){return!0}}function w(t){if(!t)return"[No node]";if(b&&E(t))return"[Broken node]";if(l(t))return'"'+t.data+'"';if(1!=t.nodeType)return t.nodeName;var e=t.id?' id="'+t.id+'"':"";return"<"+t.nodeName+e+">[index:"+c(t)+",length:"+t.childNodes.length+"]["+(t.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}function C(t){this.root=t,this._next=t}function O(t,e){this.node=t,this.offset=e}function x(t){this.code=this[t],this.codeName=t,this.message="DOMException: "+this.codeName}!function(){var t=document.createElement("b");t.innerHTML="1";var e=t.firstChild;t.innerHTML="<br />",b=E(e),n.features.crashyTextNodes=b}(),typeof window.getComputedStyle!=i?y=function(t,e){return g(t).getComputedStyle(t,null)[e]}:typeof document.documentElement.currentStyle!=i?y=function(t,e){return t.currentStyle?t.currentStyle[e]:""}:h.fail("No means of obtaining computed style properties found"),C.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var t,e,n=this._current=this._next;if(this._current)if(t=n.firstChild)this._next=t;else{for(e=null;n!==this.root&&!(e=n.nextSibling);)n=n.parentNode;this._next=e}return this._current},detach:function(){this._current=this._next=this.root=null}},O.prototype={equals:function(t){return!!t&&this.node===t.node&&this.offset==t.offset},inspect:function(){return"[DomPosition("+w(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},(x.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24}).toString=function(){return this.message},n.dom={arrayContains:r,isHtmlNamespace:function(t){var e;return typeof t.namespaceURI==i||null===(e=t.namespaceURI)||"http://www.w3.org/1999/xhtml"==e},parentElement:function(t){var e=t.parentNode;return 1==e.nodeType?e:null},getNodeIndex:c,getNodeLength:function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},getCommonAncestor:u,isAncestorOf:s,isOrIsAncestorOf:function(t,e){return s(t,e,!0)},getClosestAncestorIn:d,isCharacterDataNode:l,isTextOrCommentNode:function(t){if(!t)return!1;var e=t.nodeType;return 3==e||8==e},insertAfter:f,splitDataNode:function(t,e,n){var i=t.cloneNode(!1);if(i.deleteData(0,e),t.deleteData(e,t.length-e),f(i,t),n)for(var o,r=0;o=n[r++];)o.node==t&&o.offset>e?(o.node=i,o.offset-=e):o.node==t.parentNode&&o.offset>c(t)&&++o.offset;return i},getDocument:p,getWindow:g,getIframeWindow:function(t){if(typeof t.contentWindow!=i)return t.contentWindow;if(typeof t.contentDocument!=i)return t.contentDocument.defaultView;throw h.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:m,getBody:a,isWindow:v,getContentDocument:function(t,e,n){var i;if(t?o.isHostProperty(t,"nodeType")?i=1==t.nodeType&&"iframe"==t.tagName.toLowerCase()?m(t):p(t):v(t)&&(i=t.document):i=document,!i)throw e.createError(n+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(t){for(var e;e=t.parentNode;)t=e;return t},comparePoints:function(t,e,n,i){var o,r,a,s,l;if(t==n)return e===i?0:e<i?-1:1;if(o=d(n,t,!0))return e<=c(o)?-1:1;if(o=d(t,n,!0))return c(o)<i?-1:1;if(!(r=u(t,n)))throw new Error("comparePoints error: nodes have no common ancestor");if((a=t===r?r:d(t,r,!0))===(s=n===r?r:d(n,r,!0)))throw h.createError("comparePoints got to case 4 and childA and childB are the same!");for(l=r.firstChild;l;){if(l===a)return-1;if(l===s)return 1;l=l.nextSibling}},isBrokenNode:E,inspectNode:w,getComputedStyleProperty:y,createTestElement:function(t,e,n){var i=a(t),o=t.createElement("div");o.contentEditable=""+!!n,e&&(o.innerHTML=e);var r=i.firstChild;return r?i.insertBefore(o,r):i.appendChild(o),o},removeNode:function(t){return t.parentNode.removeChild(t)},fragmentFromNodeChildren:function(t){for(var e,n=p(t).createDocumentFragment();e=t.firstChild;)n.appendChild(e);return n},createIterator:function(t){return new C(t)},DomPosition:O},n.DOMException=x}),w.createCoreModule("DomRange",["DomUtil"],function(a,t){var s=a.dom,i=a.util,e=s.DomPosition,l=a.DOMException,u=s.isCharacterDataNode,d=s.getNodeIndex,h=s.isOrIsAncestorOf,o=s.getDocument,f=s.comparePoints,c=s.splitDataNode,p=s.getClosestAncestorIn,g=s.getNodeLength,r=s.arrayContains,m=s.getRootContainer,n=a.features.crashyTextNodes,v=s.removeNode;function y(t,e){return 3!=t.nodeType&&(h(t,e.startContainer)||h(t,e.endContainer))}function b(t){return t.document||o(t.startContainer)}function E(t){return new e(t.parentNode,d(t))}function w(t){return new e(t.parentNode,d(t)+1)}function C(t,e,n){var i=11==t.nodeType?t.firstChild:t;return u(e)?n==e.length?s.insertAfter(t,e):e.parentNode.insertBefore(t,0==n?e:c(e,n)):n>=e.childNodes.length?e.appendChild(t):e.insertBefore(t,e.childNodes[n]),i}function O(t,e,n){if(W(t),W(e),b(e)!=b(t))throw new l("WRONG_DOCUMENT_ERR");var i=f(t.startContainer,t.startOffset,e.endContainer,e.endOffset),o=f(t.endContainer,t.endOffset,e.startContainer,e.startOffset);return n?i<=0&&0<=o:i<0&&0<o}function x(t,e,n){var i,o,r,a;for(n=n||{stop:!1};r=t.next();)if(t.isPartiallySelectedSubtree()){if(!1===e(r))return void(n.stop=!0);if(x(a=t.getSubtreeIterator(),e,n),a.detach(),n.stop)return}else for(i=s.createIterator(r);o=i.next();)if(!1===e(o))return void(n.stop=!0)}function T(t){for(var e;t.next();)t.isPartiallySelectedSubtree()?(T(e=t.getSubtreeIterator()),e.detach()):t.remove()}function _(t){for(var e,n,i=b(t.range).createDocumentFragment();e=t.next();){if(t.isPartiallySelectedSubtree()?(e=e.cloneNode(!1),n=t.getSubtreeIterator(),e.appendChild(_(n)),n.detach()):t.remove(),10==e.nodeType)throw new l("HIERARCHY_REQUEST_ERR");i.appendChild(e)}return i}function S(t){return"["+(void 0===t.getName?"Range":t.getName())+"("+s.inspectNode(t.startContainer)+":"+t.startOffset+", "+s.inspectNode(t.endContainer)+":"+t.endOffset+")]"}function k(t,e){if(this.range=t,this.clonePartiallySelectedTextNodes=e,!t.collapsed){this.sc=t.startContainer,this.so=t.startOffset,this.ec=t.endContainer,this.eo=t.endOffset;var n=t.commonAncestorContainer;this.sc===this.ec&&u(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||u(this.sc)?p(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||u(this.ec)?p(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}k.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var t=this._current=this._next;return t&&(this._next=t!==this._last?t.nextSibling:null,u(t)&&this.clonePartiallySelectedTextNodes&&(t===this.ec&&(t=t.cloneNode(!0)).deleteData(this.eo,t.length-this.eo),this._current===this.sc&&(t=t.cloneNode(!0)).deleteData(0,this.so))),t},remove:function(){var t,e,n=this._current;!u(n)||n!==this.sc&&n!==this.ec?n.parentNode&&v(n):(t=n===this.sc?this.so:0)!=(e=n===this.ec?this.eo:n.length)&&n.deleteData(t,e-t)},isPartiallySelectedSubtree:function(){return y(this._current,this.range)},getSubtreeIterator:function(){var t;if(this.isSingleCharacterDataNode)(t=this.range.cloneRange()).collapse(!1);else{t=new dt(b(this.range));var e=this._current,n=e,i=0,o=e,r=g(e);h(e,this.sc)&&(n=this.sc,i=this.so),h(e,this.ec)&&(o=this.ec,r=this.eo),ut(t,n,i,o,r)}return new k(t,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var A=[1,3,4,5,7,8,10],R=[2,9,11],D=[1,3,4,5,7,8,10,11],P=[1,3,4,5,7,8];function N(o){return function(t,e){for(var n,i=e?t:t.parentNode;i;){if(n=i.nodeType,r(o,n))return i;i=i.parentNode}return null}}var L=N([9,11]),M=N([5,6,10,12]),B=N([6,10,12]);function j(t,e){if(B(t,e))throw new l("INVALID_NODE_TYPE_ERR")}function H(t,e){if(!r(e,t.nodeType))throw new l("INVALID_NODE_TYPE_ERR")}function I(t,e){if(e<0||e>(u(t)?t.length:t.childNodes.length))throw new l("INDEX_SIZE_ERR")}function F(t,e){if(L(t,!0)!==L(e,!0))throw new l("WRONG_DOCUMENT_ERR")}function q(t){if(M(t,!0))throw new l("NO_MODIFICATION_ALLOWED_ERR")}function z(t,e){if(!t)throw new l(e)}function Y(t,e){return e<=(u(t)?t.length:t.childNodes.length)}function X(t){return!!t.startContainer&&!!t.endContainer&&!(n&&(s.isBrokenNode(t.startContainer)||s.isBrokenNode(t.endContainer)))&&m(t.startContainer)==m(t.endContainer)&&Y(t.startContainer,t.startOffset)&&Y(t.endContainer,t.endOffset)}function W(t){if(!X(t))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+t.inspect()+")")}var U=document.createElement("style"),V=!1;try{U.innerHTML="<b>x</b>",V=3==U.firstChild.nodeType}catch(a){}var G=(a.features.htmlParsingConforms=V)?function(t){var e=this.startContainer,n=o(e);if(!e)throw new l("INVALID_STATE_ERR");var i=null;return 1==e.nodeType?i=e:u(e)&&(i=s.parentElement(e)),(i=null===i||"HTML"==i.nodeName&&s.isHtmlNamespace(o(i).documentElement)&&s.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1)).innerHTML=t,s.fragmentFromNodeChildren(i)}:function(t){var e=b(this).createElement("body");return e.innerHTML=t,s.fragmentFromNodeChildren(e)};function J(t,e){W(t);var n=t.startContainer,i=t.startOffset,o=t.endContainer,r=t.endOffset,a=n===o;u(o)&&0<r&&r<o.length&&c(o,r,e),u(n)&&0<i&&i<n.length&&(n=c(n,i,e),a?(r-=i,o=n):o==n.parentNode&&r>=d(n)&&r++,i=0),t.setStartAndEnd(n,i,o,r)}function $(t){W(t);var e=t.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(t.cloneContents()),e.innerHTML}var Q=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],K=0,Z=1,tt=2,et=3,nt=0,it=1,ot=2,rt=3;function at(t){t.START_TO_START=K,t.START_TO_END=Z,t.END_TO_END=tt,t.END_TO_START=et,t.NODE_BEFORE=nt,t.NODE_AFTER=it,t.NODE_BEFORE_AND_AFTER=ot,t.NODE_INSIDE=rt}function st(t){at(t),at(t.prototype)}function lt(a,s){return function(){W(this);var t,e=this.startContainer,n=this.startOffset,i=this.commonAncestorContainer,o=new k(this,!0);e!==i&&(e=(t=w(p(e,i,!0))).node,n=t.offset),x(o,q),o.reset();var r=a(o);return o.detach(),s(this,e,n,e,n),r}}function ht(t,c){function e(n,i){return function(t){H(t,A),H(m(t),R);var e=(n?E:w)(t);(i?o:r)(this,e.node,e.offset)}}function o(t,e,n){var i=t.endContainer,o=t.endOffset;e===t.startContainer&&n===t.startOffset||(m(e)==m(i)&&1!=f(e,n,i,o)||(i=e,o=n),c(t,e,n,i,o))}function r(t,e,n){var i=t.startContainer,o=t.startOffset;e===t.endContainer&&n===t.endOffset||(m(e)==m(i)&&-1!=f(e,n,i,o)||(i=e,o=n),c(t,i,o,e,n))}function n(){}n.prototype=a.rangePrototype,t.prototype=new n,i.extend(t.prototype,{setStart:function(t,e){j(t,!0),I(t,e),o(this,t,e)},setEnd:function(t,e){j(t,!0),I(t,e),r(this,t,e)},setStartAndEnd:function(){var t=arguments,e=t[0],n=t[1],i=e,o=n;switch(t.length){case 3:o=t[2];break;case 4:i=t[2],o=t[3]}c(this,e,n,i,o)},setBoundary:function(t,e,n){this["set"+(n?"Start":"End")](t,e)},setStartBefore:e(!0,!0),setStartAfter:e(!1,!0),setEndBefore:e(!0,!1),setEndAfter:e(!1,!1),collapse:function(t){W(this),t?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(t){j(t,!0),c(this,t,0,t,g(t))},selectNode:function(t){j(t,!1),H(t,A);var e=E(t),n=w(t);c(this,e.node,e.offset,n.node,n.offset)},extractContents:lt(_,c),deleteContents:lt(T,c),canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&y(t._first,this)||t._last&&y(t._last,this);return t.detach(),!e},splitBoundaries:function(){J(this)},splitBoundariesPreservingPositions:function(t){J(this,t)},normalizeBoundaries:function(){W(this);function t(t){var e=t.nextSibling;e&&e.nodeType==t.nodeType&&(s=(a=t).length,t.appendData(e.data),v(e))}function e(t){var e=t.previousSibling;if(e&&e.nodeType==t.nodeType){var n=(o=t).length;if(r=e.length,t.insertData(0,e.data),v(e),o==a)s+=r,a=o;else if(a==t.parentNode){var i=d(t);s==i?(a=t,s=n):i<s&&s--}}}var n,o=this.startContainer,r=this.startOffset,a=this.endContainer,s=this.endOffset,i=!0;if(u(a))s==a.length?t(a):0==s&&(n=a.previousSibling)&&n.nodeType==a.nodeType&&(s=n.length,o==a&&(i=!1),n.appendData(a.data),v(a),a=n);else{if(0<s){var l=a.childNodes[s-1];l&&u(l)&&t(l)}i=!this.collapsed}if(i){if(u(o))0==r?e(o):r==o.length&&(n=o.nextSibling)&&n.nodeType==o.nodeType&&(a==n&&(s+=(a=o).length),o.appendData(n.data),v(n));else if(r<o.childNodes.length){var h=o.childNodes[r];h&&u(h)&&e(h)}}else o=a,r=s;c(this,o,r,a,s)},collapseToPoint:function(t,e){j(t,!0),I(t,e),this.setStartAndEnd(t,e)}}),st(t)}function ct(t){t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset,t.commonAncestorContainer=t.collapsed?t.startContainer:s.getCommonAncestor(t.startContainer,t.endContainer)}function ut(t,e,n,i,o){t.startContainer=e,t.startOffset=n,t.endContainer=i,t.endOffset=o,t.document=s.getDocument(e),ct(t)}function dt(t){this.startContainer=t,this.startOffset=0,this.endContainer=t,this.endOffset=0,this.document=t,ct(this)}i.extend(a.rangePrototype,{compareBoundaryPoints:function(t,e){var n,i,o,r;W(this),F(this.startContainer,e.startContainer);var a=t==et||t==K?"start":"end",s=t==Z||t==K?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],o=e[s+"Container"],r=e[s+"Offset"],f(n,i,o,r)},insertNode:function(t){if(W(this),H(t,D),q(this.startContainer),h(t,this.startContainer))throw new l("HIERARCHY_REQUEST_ERR");var e=C(t,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){var t,e;if(W(this),this.collapsed)return b(this).createDocumentFragment();if(this.startContainer===this.endContainer&&u(this.startContainer))return(t=this.startContainer.cloneNode(!0)).data=t.data.slice(this.startOffset,this.endOffset),(e=b(this).createDocumentFragment()).appendChild(t),e;var n=new k(this,!0);return t=function t(e){for(var n,i,o,r=b(e.range).createDocumentFragment();i=e.next();){if(n=e.isPartiallySelectedSubtree(),i=i.cloneNode(!n),n&&(o=e.getSubtreeIterator(),i.appendChild(t(o)),o.detach()),10==i.nodeType)throw new l("HIERARCHY_REQUEST_ERR");r.appendChild(i)}return r}(n),n.detach(),t},canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&y(t._first,this)||t._last&&y(t._last,this);return t.detach(),!e},surroundContents:function(t){if(H(t,P),!this.canSurroundContents())throw new l("INVALID_STATE_ERR");var e=this.extractContents();if(t.hasChildNodes())for(;t.lastChild;)t.removeChild(t.lastChild);C(t,this.startContainer,this.startOffset),t.appendChild(e),this.selectNode(t)},cloneRange:function(){W(this);for(var t,e=new dt(b(this)),n=Q.length;n--;)e[t=Q[n]]=this[t];return e},toString:function(){W(this);var t=this.startContainer;if(t===this.endContainer&&u(t))return 3==t.nodeType||4==t.nodeType?t.data.slice(this.startOffset,this.endOffset):"";var e=[],n=new k(this,!0);return x(n,function(t){3!=t.nodeType&&4!=t.nodeType||e.push(t.data)}),n.detach(),e.join("")},compareNode:function(t){W(this);var e=t.parentNode,n=d(t);if(!e)throw new l("NOT_FOUND_ERR");var i=this.comparePoint(e,n),o=this.comparePoint(e,n+1);return i<0?0<o?ot:nt:0<o?it:rt},comparePoint:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),f(t,e,this.startContainer,this.startOffset)<0?-1:0<f(t,e,this.endContainer,this.endOffset)?1:0},createContextualFragment:G,toHtml:function(){return $(this)},intersectsNode:function(t,e){if(W(this),m(t)!=m(this.startContainer))return!1;var n=t.parentNode,i=d(t);if(!n)return!0;var o=f(n,i,this.endContainer,this.endOffset),r=f(n,i+1,this.startContainer,this.startOffset);return e?o<=0&&0<=r:o<0&&0<r},isPointInRange:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),0<=f(t,e,this.startContainer,this.startOffset)&&f(t,e,this.endContainer,this.endOffset)<=0},intersectsRange:function(t){return O(this,t,!1)},intersectsOrTouchesRange:function(t){return O(this,t,!0)},intersection:function(t){if(this.intersectsRange(t)){var e=f(this.startContainer,this.startOffset,t.startContainer,t.startOffset),n=f(this.endContainer,this.endOffset,t.endContainer,t.endOffset),i=this.cloneRange();return-1==e&&i.setStart(t.startContainer,t.startOffset),1==n&&i.setEnd(t.endContainer,t.endOffset),i}return null},union:function(t){if(this.intersectsOrTouchesRange(t)){var e=this.cloneRange();return-1==f(t.startContainer,t.startOffset,this.startContainer,this.startOffset)&&e.setStart(t.startContainer,t.startOffset),1==f(t.endContainer,t.endOffset,this.endContainer,this.endOffset)&&e.setEnd(t.endContainer,t.endOffset),e}throw new l("Ranges do not intersect")},containsNode:function(t,e){return e?this.intersectsNode(t,!1):this.compareNode(t)==rt},containsNodeContents:function(t){return 0<=this.comparePoint(t,0)&&this.comparePoint(t,g(t))<=0},containsRange:function(t){var e=this.intersection(t);return null!==e&&t.equals(e)},containsNodeText:function(t){var e=this.cloneRange();e.selectNode(t);var n=e.getNodes([3]);if(0<n.length){e.setStart(n[0],0);var i=n.pop();return e.setEnd(i,i.length),this.containsRange(e)}return this.containsNodeContents(t)},getNodes:function(t,e){return W(this),function(i,t,o){var r,a=!(!t||!t.length),s=!!o;a&&(r=new RegExp("^("+t.join("|")+")$"));var l=[];return x(new k(i,!1),function(t){if((!a||r.test(t.nodeType))&&(!s||o(t))){var e=i.startContainer;if(t!=e||!u(e)||i.startOffset!=e.length){var n=i.endContainer;t==n&&u(n)&&0==i.endOffset||l.push(t)}}}),l}(this,t,e)},getDocument:function(){return b(this)},collapseBefore:function(t){this.setEndBefore(t),this.collapse(!1)},collapseAfter:function(t){this.setStartAfter(t),this.collapse(!0)},getBookmark:function(t){var e=b(this),n=a.createRange(e);t=t||s.getBody(e),n.selectNodeContents(t);var i=this.intersection(n),o=0,r=0;return i&&(n.setEnd(i.startContainer,i.startOffset),r=(o=n.toString().length)+i.toString().length),{start:o,end:r,containerNode:t}},moveToBookmark:function(t){var e=t.containerNode,n=0;this.setStart(e,0),this.collapse(!0);for(var i,o,r,a,s=[e],l=!1,h=!1;!h&&(i=s.pop());)if(3==i.nodeType)o=n+i.length,!l&&t.start>=n&&t.start<=o&&(this.setStart(i,t.start-n),l=!0),l&&t.end>=n&&t.end<=o&&(this.setEnd(i,t.end-n),h=!0),n=o;else for(r=(a=i.childNodes).length;r--;)s.push(a[r])},getName:function(){return"DomRange"},equals:function(t){return dt.rangesEqual(this,t)},isValid:function(){return X(this)},inspect:function(){return S(this)},detach:function(){}}),ht(dt,ut),i.extend(dt,{rangeProperties:Q,RangeIterator:k,copyComparisonConstants:st,createPrototypeRange:ht,inspect:S,toHtml:$,getRangeDocument:b,rangesEqual:function(t,e){return t.startContainer===e.startContainer&&t.startOffset===e.startOffset&&t.endContainer===e.endContainer&&t.endOffset===e.endOffset}}),a.DomRange=dt}),w.createCoreModule("WrappedRange",["DomRange"],function(c,u){var d,t,C=c.dom,f=c.util,O=C.DomPosition,p=c.DomRange,g=C.getBody,m=C.getContentDocument,x=C.isCharacterDataNode;if(c.features.implementsDomRange&&function(){var e,n,i=p.rangeProperties;function o(t){for(var e,n=i.length;n--;)t[e=i[n]]=t.nativeRange[e];t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset}d=function(t){if(!t)throw u.createError("WrappedRange: Range must be specified");this.nativeRange=t,o(this)},p.createPrototypeRange(d,function(t,e,n,i,o){var r=t.startContainer!==e||t.startOffset!=n,a=t.endContainer!==i||t.endOffset!=o,s=!t.equals(t.nativeRange);(r||a||s)&&(t.setEnd(i,o),t.setStart(e,n))}),(e=d.prototype).selectNode=function(t){this.nativeRange.selectNode(t),o(this)},e.cloneContents=function(){return this.nativeRange.cloneContents()},e.surroundContents=function(t){this.nativeRange.surroundContents(t),o(this)},e.collapse=function(t){this.nativeRange.collapse(t),o(this)},e.cloneRange=function(){return new d(this.nativeRange.cloneRange())},e.refresh=function(){o(this)},e.toString=function(){return this.nativeRange.toString()};var t=document.createTextNode("test");g(document).appendChild(t);var r=document.createRange();r.setStart(t,0),r.setEnd(t,0);try{r.setStart(t,1),e.setStart=function(t,e){this.nativeRange.setStart(t,e),o(this)},e.setEnd=function(t,e){this.nativeRange.setEnd(t,e),o(this)},n=function(e){return function(t){this.nativeRange[e](t),o(this)}}}catch(t){e.setStart=function(e,n){try{this.nativeRange.setStart(e,n)}catch(t){this.nativeRange.setEnd(e,n),this.nativeRange.setStart(e,n)}o(this)},e.setEnd=function(e,n){try{this.nativeRange.setEnd(e,n)}catch(t){this.nativeRange.setStart(e,n),this.nativeRange.setEnd(e,n)}o(this)},n=function(n,i){return function(e){try{this.nativeRange[n](e)}catch(t){this.nativeRange[i](e),this.nativeRange[n](e)}o(this)}}}e.setStartBefore=n("setStartBefore","setEndBefore"),e.setStartAfter=n("setStartAfter","setEndAfter"),e.setEndBefore=n("setEndBefore","setStartBefore"),e.setEndAfter=n("setEndAfter","setStartAfter"),e.selectNodeContents=function(t){this.setStartAndEnd(t,0,C.getNodeLength(t))},r.selectNodeContents(t),r.setEnd(t,3);var a=document.createRange();a.selectNodeContents(t),a.setEnd(t,4),a.setStart(t,2),-1==r.compareBoundaryPoints(r.START_TO_END,a)&&1==r.compareBoundaryPoints(r.END_TO_START,a)?e.compareBoundaryPoints=function(t,e){return t==(e=e.nativeRange||e).START_TO_END?t=e.END_TO_START:t==e.END_TO_START&&(t=e.START_TO_END),this.nativeRange.compareBoundaryPoints(t,e)}:e.compareBoundaryPoints=function(t,e){return this.nativeRange.compareBoundaryPoints(t,e.nativeRange||e)};var s=document.createElement("div");s.innerHTML="123";var l=s.firstChild,h=g(document);h.appendChild(s),r.setStart(l,1),r.setEnd(l,2),r.deleteContents(),"13"==l.data&&(e.deleteContents=function(){this.nativeRange.deleteContents(),o(this)},e.extractContents=function(){var t=this.nativeRange.extractContents();return o(this),t}),h.removeChild(s),h=null,f.isHostMethod(r,"createContextualFragment")&&(e.createContextualFragment=function(t){return this.nativeRange.createContextualFragment(t)}),g(document).removeChild(t),e.getName=function(){return"WrappedRange"},c.WrappedRange=d,c.createNativeRange=function(t){return(t=m(t,u,"createNativeRange")).createRange()}}(),c.features.implementsTextRange){function r(t,e,n,i,o){var r=t.duplicate();r.collapse(n);var a=r.parentElement();if(C.isOrIsAncestorOf(e,a)||(a=e),!a.canHaveHTML){var s=new O(a.parentNode,C.getNodeIndex(a));return{boundaryPosition:s,nodeInfo:{nodeIndex:s.offset,containerElement:s.node}}}var l=C.getDocument(a).createElement("span");l.parentNode&&C.removeNode(l);for(var h,c,u,d,f,p=n?"StartToStart":"StartToEnd",g=o&&o.containerElement==a?o.nodeIndex:0,m=a.childNodes.length,v=m,y=v;y==m?a.appendChild(l):a.insertBefore(l,a.childNodes[y]),r.moveToElementText(l),0!=(h=r.compareEndPoints(p,t))&&g!=v;){if(-1==h){if(v==g+1)break;g=y}else v=v==g+1?g:y;y=Math.floor((g+v)/2),a.removeChild(l)}if(f=l.nextSibling,-1==h&&f&&x(f)){var b;if(r.setEndPoint(n?"EndToStart":"EndToEnd",t),/[\r\n]/.test(f.data)){var E=r.duplicate(),w=E.text.replace(/\r\n/g,"\r").length;for(b=E.moveStart("character",w);-1==(h=E.compareEndPoints("StartToEnd",E));)b++,E.moveStart("character",1)}else b=r.text.length;d=new O(f,b)}else c=(i||!n)&&l.previousSibling,d=(u=(i||n)&&l.nextSibling)&&x(u)?new O(u,0):c&&x(c)?new O(c,c.data.length):new O(a,C.getNodeIndex(l));return C.removeNode(l),{boundaryPosition:d,nodeInfo:{nodeIndex:y,containerElement:a}}}function o(t,e){var n,i,o,r,a=t.offset,s=C.getDocument(t.node),l=g(s).createTextRange(),h=x(t.node);return i=h?(n=t.node).parentNode:(n=a<(r=t.node.childNodes).length?r[a]:null,t.node),(o=s.createElement("span")).innerHTML="&#feff;",n?i.insertBefore(o,n):i.appendChild(o),l.moveToElementText(o),l.collapse(!e),i.removeChild(o),h&&l[e?"moveStart":"moveEnd"]("character",a),l}(t=function(t){this.textRange=t,this.refresh()}).prototype=new p(document),t.prototype.refresh=function(){var t,e,n,i,o=function(t){var e=t.parentElement(),n=t.duplicate();n.collapse(!0);var i=n.parentElement();(n=t.duplicate()).collapse(!1);var o=n.parentElement(),r=i==o?i:C.getCommonAncestor(i,o);return r==e?r:C.getCommonAncestor(e,r)}(this.textRange);e=0==(i=this.textRange).compareEndPoints("StartToEnd",i)?t=r(this.textRange,o,!0,!0).boundaryPosition:(t=(n=r(this.textRange,o,!0,!1)).boundaryPosition,r(this.textRange,o,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(t.node,t.offset),this.setEnd(e.node,e.offset)},t.prototype.getName=function(){return"WrappedTextRange"},p.copyComparisonConstants(t);function e(t){if(t.collapsed)return o(new O(t.startContainer,t.startOffset),!0);var e=o(new O(t.startContainer,t.startOffset),!0),n=o(new O(t.endContainer,t.endOffset),!1),i=g(p.getRangeDocument(t)).createTextRange();return i.setEndPoint("StartToStart",e),i.setEndPoint("EndToEnd",n),i}if(t.rangeToTextRange=e,t.prototype.toTextRange=function(){return e(this)},c.WrappedTextRange=t,!c.features.implementsDomRange||c.config.preferTextRange){var n=Function("return this;")();void 0===n.Range&&(n.Range=t),c.createNativeRange=function(t){return t=m(t,u,"createNativeRange"),g(t).createTextRange()},c.WrappedRange=t}}c.createRange=function(t){return t=m(t,u,"createRange"),new c.WrappedRange(c.createNativeRange(t))},c.createRangyRange=function(t){return t=m(t,u,"createRangyRange"),new p(t)},f.createAliasForDeprecatedMethod(c,"createIframeRange","createRange"),f.createAliasForDeprecatedMethod(c,"createIframeRangyRange","createRangyRange"),c.addShimListener(function(t){var e=t.document;void 0===e.createRange&&(e.createRange=function(){return c.createRange(e)}),e=t=null})}),w.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(u,l){u.config.checkSelectionRanges=!0;var o,r,d=u.dom,t=u.util,e=t.isHostMethod,s=u.DomRange,a=u.WrappedRange,n=u.DOMException,h=d.DomPosition,i=u.features,c=d.getDocument,f=d.getBody,p=s.rangesEqual;function g(t){return"string"==typeof t?/^backward(s)?$/i.test(t):!!t}function m(t,e){if(t){if(d.isWindow(t))return t;if(t instanceof z)return t.win;var n=d.getContentDocument(t,l,e);return d.getWindow(n)}return window}function v(t){return m(t,"getDocSelection").document.selection}function y(t){var e=!1;return t.anchorNode&&(e=1==d.comparePoints(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset)),e}var b=e(window,"getSelection"),E=t.isHostObject(document,"selection");i.implementsWinGetSelection=b;var w=(i.implementsDocSelection=E)&&(!b||u.config.preferTextRange);if(w)o=v,u.isSelectionValid=function(t){var e=m(t,"isSelectionValid").document,n=e.selection;return"None"!=n.type||c(n.createRange().parentElement())==e};else{if(!b)return l.fail("Neither document.selection or window.getSelection() detected."),!1;o=function(t){return m(t,"getWinSelection").getSelection()},u.isSelectionValid=function(){return!0}}var C=(u.getNativeSelection=o)();if(!C)return l.fail("Native selection was null (possibly issue 138?)"),!1;var O=u.createNativeRange(document),x=f(document),T=t.areHostProperties(C,["anchorNode","focusNode","anchorOffset","focusOffset"]);i.selectionHasAnchorAndFocus=T;var _=e(C,"extend");i.selectionHasExtend=_;var S="number"==typeof C.rangeCount;i.selectionHasRangeCount=S;var k=!1,A=!0,R=_?function(t,e){var n=s.getRangeDocument(e),i=u.createRange(n);i.collapseToPoint(e.endContainer,e.endOffset),t.addRange(B(i)),t.extend(e.startContainer,e.startOffset)}:null;t.areHostMethods(C,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof C.rangeCount&&i.implementsDomRange&&function(){var t=window.getSelection();if(t){for(var e=t.rangeCount,n=1<e,i=[],o=y(t),r=0;r<e;++r)i[r]=t.getRangeAt(r);var a=d.createTestElement(document,"",!1),s=a.appendChild(document.createTextNode("   ")),l=document.createRange();if(l.setStart(s,1),l.collapse(!0),t.removeAllRanges(),t.addRange(l),A=1==t.rangeCount,t.removeAllRanges(),!n){var h=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(h&&36<=parseInt(h[1]))k=!1;else{var c=l.cloneRange();l.setStart(s,0),c.setEnd(s,3),c.setStart(s,2),t.addRange(l),t.addRange(c),k=2==t.rangeCount}}for(d.removeNode(a),t.removeAllRanges(),r=0;r<e;++r)0==r&&o?R?R(t,i[r]):(u.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(i[r])):t.addRange(i[r])}}(),i.selectionSupportsMultipleRanges=k,i.collapsedNonEditableSelectionsSupported=A;var D,P,N=!1;function L(t,e,n){var i=n?"end":"start",o=n?"start":"end";t.anchorNode=e[i+"Container"],t.anchorOffset=e[i+"Offset"],t.focusNode=e[o+"Container"],t.focusOffset=e[o+"Offset"]}function M(t){t.anchorNode=t.focusNode=null,t.anchorOffset=t.focusOffset=0,t.rangeCount=0,t.isCollapsed=!0,t._ranges.length=0}function B(t){var e;return t instanceof s?((e=u.createNativeRange(t.getDocument())).setEnd(t.endContainer,t.endOffset),e.setStart(t.startContainer,t.startOffset)):t instanceof a?e=t.nativeRange:i.implementsDomRange&&t instanceof d.getWindow(t.startContainer).Range&&(e=t),e}function j(t){var e=t.getNodes();if(!function(t){if(!t.length||1!=t[0].nodeType)return!1;for(var e=1,n=t.length;e<n;++e)if(!d.isAncestorOf(t[0],t[e]))return!1;return!0}(e))throw l.createError("getSingleElementFromRange: range "+t.inspect()+" did not consist of a single element");return e[0]}function H(t){return!!t&&void 0!==t.text}function I(t,e){var n=new a(e);t._ranges=[n],L(t,n,!1),t.rangeCount=1,t.isCollapsed=n.collapsed}function F(t){if(t._ranges.length=0,"None"==t.docSelection.type)M(t);else{var e=t.docSelection.createRange();if(H(e))I(t,e);else{t.rangeCount=e.length;for(var n,i=c(e.item(0)),o=0;o<t.rangeCount;++o)(n=u.createRange(i)).selectNode(e.item(o)),t._ranges.push(n);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,L(t,t._ranges[t.rangeCount-1],!1)}}}function q(t,e){for(var n=t.docSelection.createRange(),i=j(e),o=c(n.item(0)),r=f(o).createControlRange(),a=0,s=n.length;a<s;++a)r.add(n.item(a));try{r.add(i)}catch(t){throw l.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}r.select(),F(t)}function z(t,e,n){this.nativeSelection=t,this.docSelection=e,this._ranges=[],this.win=n,this.refresh()}function Y(t){t.win=t.anchorNode=t.focusNode=t._ranges=null,t.rangeCount=t.anchorOffset=t.focusOffset=0,t.detached=!0}x&&e(x,"createControlRange")&&(D=x.createControlRange(),t.areHostProperties(D,["item","add"])&&(N=!0)),i.implementsControlRange=N,r=T?function(t){return t.anchorNode===t.focusNode&&t.anchorOffset===t.focusOffset}:function(t){return!!t.rangeCount&&t.getRangeAt(t.rangeCount-1).collapsed},e(C,"getRangeAt")?P=function(t,e){try{return t.getRangeAt(e)}catch(t){return null}}:T&&(P=function(t){var e=c(t.anchorNode),n=u.createRange(e);return n.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),n.collapsed!==this.isCollapsed&&n.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),n}),z.prototype=u.selectionPrototype;var X=[];function W(t,e){for(var n,i,o=X.length;o--;)if(i=(n=X[o]).selection,"deleteAll"==e)Y(i);else if(n.win==t)return"delete"==e?(X.splice(o,1),!0):i;return"deleteAll"==e&&(X.length=0),null}function U(t){if(t&&t instanceof z)return t.refresh(),t;var e=W(t=m(t,"getNativeSelection")),n=o(t),i=E?v(t):null;return e?(e.nativeSelection=n,e.docSelection=i,e.refresh()):(e=new z(n,i,t),X.push({win:t,selection:e})),e}u.getSelection=U,t.createAliasForDeprecatedMethod(u,"getIframeSelection","getSelection");var V,G=z.prototype;function J(t,e){for(var n,i=c(e[0].startContainer),o=f(i).createControlRange(),r=0,a=e.length;r<a;++r){n=j(e[r]);try{o.add(n)}catch(t){throw l.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),F(t)}if(!w&&T&&t.areHostMethods(C,["removeAllRanges","addRange"])){G.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),M(this)};function $(t,e){R(t.nativeSelection,e),t.refresh()}G.addRange=S?function(t,e){if(N&&E&&"Control"==this.docSelection.type)q(this,t);else if(g(e)&&_)$(this,t);else{var n;n=k?this.rangeCount:(this.removeAllRanges(),0);var i=B(t).cloneRange();try{this.nativeSelection.addRange(i)}catch(t){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==n+1){if(u.config.checkSelectionRanges){var o=P(this.nativeSelection,this.rangeCount-1);o&&!p(o,t)&&(t=new a(o))}this._ranges[this.rangeCount-1]=t,L(this,t,K(this.nativeSelection)),this.isCollapsed=r(this)}else this.refresh()}}:function(t,e){g(e)&&_?$(this,t):(this.nativeSelection.addRange(B(t)),this.refresh())},G.setRanges=function(t){if(N&&E&&1<t.length)J(this,t);else{this.removeAllRanges();for(var e=0,n=t.length;e<n;++e)this.addRange(t[e])}}}else{if(!(e(C,"empty")&&e(O,"select")&&N&&w))return l.fail("No means of selecting a Range or TextRange was found"),!1;G.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var t;if(this.anchorNode)t=c(this.anchorNode);else if("Control"==this.docSelection.type){var e=this.docSelection.createRange();e.length&&(t=c(e.item(0)))}if(t)f(t).createTextRange().select(),this.docSelection.empty()}}catch(t){}M(this)},G.addRange=function(t){"Control"==this.docSelection.type?q(this,t):(u.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,L(this,t,!1))},G.setRanges=function(t){this.removeAllRanges();var e=t.length;1<e?J(this,t):e&&this.addRange(t[0])}}if(G.getRangeAt=function(t){if(t<0||t>=this.rangeCount)throw new n("INDEX_SIZE_ERR");return this._ranges[t].cloneRange()},w)V=function(t){var e;u.isSelectionValid(t.win)?e=t.docSelection.createRange():(e=f(t.win.document).createTextRange()).collapse(!0),"Control"==t.docSelection.type?F(t):H(e)?I(t,e):M(t)};else if(e(C,"getRangeAt")&&"number"==typeof C.rangeCount)V=function(t){if(N&&E&&"Control"==t.docSelection.type)F(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var e=0,n=t.rangeCount;e<n;++e)t._ranges[e]=new u.WrappedRange(t.nativeSelection.getRangeAt(e));L(t,t._ranges[t.rangeCount-1],K(t.nativeSelection)),t.isCollapsed=r(t)}else M(t)};else{if(!T||"boolean"!=typeof C.isCollapsed||"boolean"!=typeof O.collapsed||!i.implementsDomRange)return l.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;V=function(t){var e,n,i,o=t.nativeSelection;o.anchorNode?(e=P(o,0),t._ranges=[e],t.rangeCount=1,i=(n=t).nativeSelection,n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset,t.isCollapsed=r(t)):M(t)}}G.refresh=function(t){var e=t?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(V(this),t){var o=e.length;if(o!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;o--;)if(!p(e[o],this._ranges[o]))return!0;return!1}};function Q(t,e){var n=t.getAllRanges();t.removeAllRanges();for(var i=0,o=n.length;i<o;++i)p(e,n[i])||t.addRange(n[i]);t.rangeCount||M(t)}var K;function Z(t,e){if(t.win.document!=c(e))throw new n("WRONG_DOCUMENT_ERR")}function tt(i){return function(t,e){var n;this.rangeCount?(n=this.getRangeAt(0))["set"+(i?"Start":"End")](t,e):(n=u.createRange(this.win.document)).setStartAndEnd(t,e),this.setSingleRange(n,this.isBackward())}}function et(t){var e=[],n=new h(t.anchorNode,t.anchorOffset),i=new h(t.focusNode,t.focusOffset),o="function"==typeof t.getName?t.getName():"Selection";if(void 0!==t.rangeCount)for(var r=0,a=t.rangeCount;r<a;++r)e[r]=s.inspect(t.getRangeAt(r));return"["+o+"(Ranges: "+e.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}G.removeRange=N&&E?function(t){if("Control"==this.docSelection.type){for(var e=this.docSelection.createRange(),n=j(t),i=c(e.item(0)),o=f(i).createControlRange(),r=!1,a=0,s=e.length;a<s;++a)e.item(a)!==n||r?o.add(e.item(a)):r=!0;o.select(),F(this)}else Q(this,t)}:function(t){Q(this,t)},!w&&T&&i.implementsDomRange?(K=y,G.isBackward=function(){return K(this)}):K=G.isBackward=function(){return!1},G.isBackwards=G.isBackward,G.toString=function(){for(var t=[],e=0,n=this.rangeCount;e<n;++e)t[e]=""+this._ranges[e];return t.join("")},G.collapse=function(t,e){Z(this,t);var n=u.createRange(t);n.collapseToPoint(t,e),this.setSingleRange(n),this.isCollapsed=!0},G.collapseToStart=function(){if(!this.rangeCount)throw new n("INVALID_STATE_ERR");var t=this._ranges[0];this.collapse(t.startContainer,t.startOffset)},G.collapseToEnd=function(){if(!this.rangeCount)throw new n("INVALID_STATE_ERR");var t=this._ranges[this.rangeCount-1];this.collapse(t.endContainer,t.endOffset)},G.selectAllChildren=function(t){Z(this,t);var e=u.createRange(t);e.selectNodeContents(t),this.setSingleRange(e)},G.deleteFromDocument=function(){if(N&&E&&"Control"==this.docSelection.type){for(var t,e=this.docSelection.createRange();e.length;)t=e.item(0),e.remove(t),d.removeNode(t);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,o=n.length;i<o;++i)n[i].deleteContents();this.addRange(n[o-1])}}},G.eachRange=function(t,e){for(var n=0,i=this._ranges.length;n<i;++n)if(t(this.getRangeAt(n)))return e},G.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},G.setSingleRange=function(t,e){this.removeAllRanges(),this.addRange(t,e)},G.callMethodOnEachRange=function(e,n){var i=[];return this.eachRange(function(t){i.push(t[e].apply(t,n||[]))}),i},G.setStart=tt(!0),G.setEnd=tt(!1),u.rangePrototype.select=function(t){U(this.getDocument()).setSingleRange(this,t)},G.changeEachRange=function(e){var n=[],t=this.isBackward();this.eachRange(function(t){e(t),n.push(t)}),this.removeAllRanges(),t&&1==n.length?this.addRange(n[0],"backward"):this.setRanges(n)},G.containsNode=function(e,n){return this.eachRange(function(t){return t.containsNode(e,n)},!0)||!1},G.getBookmark=function(t){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[t])}},G.moveToBookmark=function(t){for(var e,n,i=[],o=0;e=t.rangeBookmarks[o++];)(n=u.createRange(this.win)).moveToBookmark(e),i.push(n);t.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)},G.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},G.restoreRanges=function(t){this.removeAllRanges();for(var e,n=0;e=t.ranges[n];++n)this.addRange(e,t.backward&&0==n)},G.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(s.toHtml(t))}),e.join("")},i.implementsTextRange&&(G.getNativeTextRange=function(){var t;if(t=this.docSelection){var e=t.createRange();if(H(e))return e;throw l.createError("getNativeTextRange: selection is a control selection")}if(0<this.rangeCount)return u.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw l.createError("getNativeTextRange: selection contains no range")}),G.getName=function(){return"WrappedSelection"},G.inspect=function(){return et(this)},G.detach=function(){W(this.win,"delete"),Y(this)},z.detachAll=function(){W(null,"deleteAll")},z.inspect=et,z.isDirectionBackward=g,u.Selection=z,u.selectionPrototype=G,u.addShimListener(function(t){void 0===t.getSelection&&(t.getSelection=function(){return U(t)}),t=null})});function L(t){M||(M=!0,!w.initialized&&w.config.autoInitialize&&S())}var M=!1;return b&&("complete"==document.readyState?L():(c(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",L,!1),v(window,"load",L))),w})?i.call(e,n,e,t):i)||(t.exports=o)},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(25),o=n.n(i),r=n(3),s=n.n(r),l=n(1),h=n(0),c=function(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),t};function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function d(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}var f=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(p,s.a),c(p,[{key:"init",value:function(t){this.container=t.container,this.headerElement=t.headerElement,this.annotatedElement=t.annotatedElement,this.mode=t.mode,this.annotator=t.annotator,this.permissions=t.permissions||{},this.localized=t.localized||{},this.hasTouch=!!t.options&&t.options.hasTouch,this.isMobile=!!t.options&&t.options.isMobile,t.modeButton&&this.permissions.canAnnotate&&(this.modeButton=t.modeButton,this.showButton()),this.handleThreadEvents=this.handleThreadEvents.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this)}},{key:"destroy",value:function(){var e=this;Object.keys(this.threads).forEach(function(t){(e.threads[t].all()||[]).forEach(e.unregisterThread.bind(e))}),this.buttonEl&&this.buttonEl.removeEventListener("click",this.toggleMode),this.modeButton&&this.hideButton()}},{key:"getButton",value:function(t){return this.headerElement?this.headerElement.querySelector(t):null}},{key:"showButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&(this.buttonEl.title=this.modeButton.title,this.buttonEl.classList.remove(h.O),this.toggleMode=this.toggleMode.bind(this),this.buttonEl.addEventListener("click",this.toggleMode)))}},{key:"hideButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&this.buttonEl.classList.add(h.O))}},{key:"toggleMode",value:function(){this.destroyPendingThreads(),this.modeButton&&this.emit(h.fb.toggleMode)}},{key:"exit",value:function(){this.emit(h.fb.exit,{mode:this.mode}),Object(l.H)(this.headerElement,h.Xb),this.destroyPendingThreads(),this.annotatedElement.classList.remove(h.y),this.annotatedElement.classList.remove(h.h),this.buttonEl.classList.remove(h.c),this.unbindListeners(),this.emit(h.fb.bindDOMListeners),this.hadPendingThreads=!1}},{key:"enter",value:function(){this.annotatedElement.classList.add(h.y),this.annotatedElement.classList.add(h.h),this.buttonEl.classList.add(h.c),this.emit(h.fb.enter,{mode:this.mode}),this.emit(h.fb.unbindDOMListeners),this.bindListeners()}},{key:"isEnabled",value:function(){return!!this.buttonEl&&this.buttonEl.classList.contains(h.c)}},{key:"bindListeners",value:function(){var n=this,t=this.handlers.length;this.setupHandlers();for(var e=function(t){var e=n.handlers[t];(e.type instanceof Array?e.type:[e.type]).forEach(function(t){return e.eventObj.addEventListener(t,e.func,e.useCapture)})},i=t;i<this.handlers.length;i++)e(i)}},{key:"unbindListeners",value:function(){for(var t=this,e=function(){var e=t.handlers.pop();(e.type instanceof Array?e.type:[e.type]).forEach(function(t){e.eventObj.removeEventListener(t,e.func,e.useCapture)})};0<this.handlers.length;)e()}},{key:"registerThread",value:function(e){var n=this;if(e&&e.location&&Object(l.w)(e)){var t=e.location.page||1;t in this.threads||(this.threads[t]=new o.a),this.threads[t].insert(e),this.emit(h.fb.register,e),e.addListener("threadevent",function(t){return n.handleThreadEvents(e,t)})}}},{key:"unregisterThread",value:function(t){t&&t.location&&t.location.page&&this.threads[t.location.page]&&(this.threads[t.location.page].remove(t),this.emit(h.fb.unregister,t),t.removeListener("threadevent",this.handleThreadEvents))}},{key:"applyActionToPageThreads",value:function(t,e){this.threads[e]&&(this.threads[e].all()||[]).forEach(t)}},{key:"applyActionToThreads",value:function(e){var n=this;Object.keys(this.threads).forEach(function(t){return n.applyActionToPageThreads(e,t)})}},{key:"getThreadByID",value:function(n){var i=this,o=null;return n&&Object.keys(this.threads).some(function(t){var e=i.threads[t];return e?!!(o=e.all().filter(function(t){return t.threadID===n})[0]):!!o}),o}},{key:"removeSelection",value:function(){}},{key:"setupHandlers",value:function(){}},{key:"handleThreadEvents",value:function(t,e){var n=e.event,i=e.data;switch(n){case h.hc.save:case h.hc.cancel:this.hadPendingThreads=!1,this.emit(n,i);break;case h.hc.show:this.visibleThreadID=i.threadID;break;case h.hc.hide:this.visibleThreadID=null;break;case h.hc.threadCleanup:this.unregisterThread(t);break;case h.hc.threadDelete:this.unregisterThread(t),this.emit(n,i);break;case h.hc.deleteError:this.emit(h.a.error,this.localized.deleteError),this.emit(n,i);break;case h.hc.createError:this.emit(h.a.error,this.localized.createError),this.emit(n,i);break;default:this.emit(n,i)}}},{key:"pushElementHandler",value:function(t,e,n){var i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];t&&this.handlers.push({eventObj:t,func:n,type:e,useCapture:i})}},{key:"setupHeader",value:function(t,e){var n=t.firstElementChild;Object(l.z)(t,e,n)}},{key:"render",value:function(){var e=this;this.threads&&Object.keys(this.threads).forEach(function(t){e.renderPage(t)})}},{key:"renderPage",value:function(t){var n=this;if(this.threads&&this.threads[t]){var i=this.threads[t].all()||[];i.forEach(function(t,e){if(Object(l.E)(t.state))return n.unregisterThread(t),void t.destroy();t.hideDialog(),t.annotatedElement||(i[e].annotatedElement=n.annotatedElement),t.show()})}}},{key:"destroyPendingThreads",value:function(){var e=this,n=!1;return Object.keys(this.threads).forEach(function(t){(e.threads[t].all()||[]).forEach(function(t){Object(l.E)(t.state)?(e.unregisterThread(t),n=!0,e.pendingThreadID=null,t.destroy()):t.isDialogVisible()&&t.hideDialog()})}),n}},{key:"getIntersectingThreads",value:function(t){if(!t||!this.threads||!this.annotator)return[];var e=this.annotator.getLocationFromEvent(t,h.ic.point);if(!e||0===Object.keys(this.threads).length||!this.threads[e.page])return[];var n={minX:+e.x-h.b,minY:+e.y-h.b,maxX:+e.x+h.b,maxY:+e.y+h.b};return this.threads[e.page].search(n)}},{key:"emit",value:function(t,e){a(p.prototype.__proto__||Object.getPrototypeOf(p.prototype),"emit",this).call(this,t,e),a(p.prototype.__proto__||Object.getPrototypeOf(p.prototype),"emit",this).call(this,"annotationcontrollerevent",{event:t,data:e,mode:this.mode})}}]),p);function p(){var t,e,n;!function(t){if(!(t instanceof p))throw new TypeError("Cannot call a class as a function")}(this);for(var i=arguments.length,o=Array(i),r=0;r<i;r++)o[r]=arguments[r];return e=n=d(this,(t=p.__proto__||Object.getPrototypeOf(p)).call.apply(t,[this].concat(o))),n.threads={},n.handlers=[],d(n,e)}e.a=f},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(3),o=n.n(i),s=n(6),l=n(1),h=(n(37),n(0)),r=function(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t};function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var u=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(d,o.a),r(d,[{key:"destroy",value:function(){var e=this;Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].destroy()}),this.unbindDOMListeners(),this.unbindCustomListenersOnService(),this.removeListener(h.a.scale,this.scaleAnnotations)}},{key:"init",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;this.container=this.options.container,"string"==typeof this.options.container&&(this.container=document.querySelector(this.container)),this.headerElement=this.options.headerElement,"string"==typeof this.headerElement&&(this.headerElement=document.querySelector(this.headerElement)),"none"===this.options.header||this.headerElement||(this.headerElement=this.container.querySelector(h.Yb)),this.annotatedElement=this.getAnnotatedEl(this.container),this.isMobile&&this.setupMobileDialog(),this.setScale(t),this.setupAnnotations(),this.loadAnnotations()}},{key:"isModeAnnotatable",value:function(e){if(!this.options.annotator)return!1;var t=this.options.annotator.TYPE;return!(e&&t&&!t.some(function(t){return e===t}))}},{key:"loadAnnotations",value:function(){var e=this;this.fetchPromise.then(function(){e.generateThreadMap(e.threadMap),e.render(),e.annotatedElement.classList.add(h.i)}).catch(function(t){e.emit(h.a.loadError,t)})}},{key:"setScale",value:function(t){this.annotatedElement.setAttribute("data-scale",t)}},{key:"getLocationFromEvent",value:function(t,e){}},{key:"createAnnotationThread",value:function(t,e,n){}},{key:"getAnnotatedEl",value:function(t){}},{key:"setupAnnotations",value:function(){this.bindDOMListeners(),this.bindCustomListenersOnService(this.annotationService),this.addListener(h.a.scale,this.scaleAnnotations),this.setupControllers()}},{key:"setupControllers",value:function(){var n=this;this.modeButtons=this.options.modeButtons||{};var i={header:this.options.header,isMobile:this.isMobile,hasTouch:this.hasTouch};Object.keys(this.modeControllers).forEach(function(t){var e=n.modeControllers[t];e.init({container:n.container,headerElement:n.headerElement,annotatedElement:n.annotatedElement,mode:t,modeButton:n.modeButtons[t],permissions:n.permissions,annotator:n,localized:n.localized,options:i}),e.addListener("annotationcontrollerevent",n.handleControllerEvents)});var t=this.modeControllers[h.ic.point];t&&this.isMobile&&t.setupSharedDialog(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,localized:this.localized})}},{key:"setupMobileDialog",value:function(){this.mobileDialogEl=l.n(),this.mobileDialogEl.setAttribute("data-type",h.ib),this.mobileDialogEl.classList.add(h.W),this.mobileDialogEl.classList.add(h.o),this.mobileDialogEl.classList.add(h.O),this.mobileDialogEl.id=h.zb,this.container.appendChild(this.mobileDialogEl)}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&!this.mobileDialogEl.classList.contains(h.O)&&(l.x(this.mobileDialogEl),l.M("."+h.Y),this.mobileDialogEl.removeChild(this.mobileDialogEl.lastChild))}},{key:"hideAnnotations",value:function(t){var e=this;t&&l.D(t)||Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].applyActionToThreads(function(t){l.E(t.state)||t.hideDialog()})})}},{key:"fetchAnnotations",value:function(){var e=this;return this.permissions.canViewAllAnnotations||this.permissions.canViewOwnAnnotations?this.annotationService.getThreadMap(this.fileVersionId).then(function(t){e.threadMap=t,e.emit(h.a.fetch)}).catch(function(t){e.emit(h.a.loadError,t)}):Promise.resolve({})}},{key:"generateThreadMap",value:function(a){var s=this;this.options.annotator&&Object.keys(a).forEach(function(t){var e=a[t],n=l.t(e);if(n&&s.isModeAnnotatable(n.type)){var i=l.r(e),o=s.createAnnotationThread(e,i.location,n.type),r=s.modeControllers[n.type];r&&r.registerThread(o)}})}},{key:"bindDOMListeners",value:function(){}},{key:"unbindDOMListeners",value:function(){}},{key:"bindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof s.a&&t.addListener(h.a.error,this.handleServicesErrors)}},{key:"unbindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof s.a&&t.removeListener(h.a.error,this.handleServicesErrors)}},{key:"getThreadParams",value:function(t,e,n){var i={annotatedElement:this.annotatedElement,annotations:t,annotationService:this.annotationService,container:this.container,fileVersionId:this.fileVersionId,isMobile:this.isMobile,hasTouch:this.hasTouch,locale:this.locale,location:e,type:n,permissions:this.permissions,localized:this.localized},o=l.r(t);return o&&(i.threadID=o.threadID,i.threadNumber=o.threadNumber),i}},{key:"getCurrentAnnotationMode",value:function(){var e=this;return Object.keys(this.modeControllers).filter(function(t){return e.modeControllers[t].isEnabled()})[0]||null}},{key:"createPointThread",value:function(t){var e=t.commentText,n=t.lastPointEvent,i=t.pendingThreadID;if(!n||!i||!e||""===e.trim())return null;if(!this.getLocationFromEvent(n,h.ic.point))return null;var o=this.modeControllers[h.ic.point],r=o.getThreadByID(i);return o&&r?(r.dialog.hasComments=!0,r.state=h.gc.hover,r.showDialog(),r.dialog.postAnnotation(e),this.emit(h.hc.threadSave,r.getThreadEventData()),r):null}},{key:"render",value:function(){var e=this;Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].render()})}},{key:"renderPage",value:function(e){var n=this;Object.keys(this.modeControllers).forEach(function(t){return n.modeControllers[t].renderPage(e)})}},{key:"getAnnotationPermissions",value:function(t){var e=t.permissions||{};return{canAnnotate:e.can_annotate||!1,canViewAllAnnotations:e.can_view_annotations_all||!1,canViewOwnAnnotations:e.can_view_annotations_self||!1}}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.render()}},{key:"toggleAnnotationMode",value:function(t){this.hideAnnotations();var e=this.getCurrentAnnotationMode();e&&this.modeControllers[e].exit(),e!==t&&this.modeControllers[t].enter()}},{key:"scrollToAnnotation",value:function(n){var i=this;n&&Object.keys(this.modeControllers).forEach(function(t){var e=i.modeControllers[t].getThreadByID(n);e&&e.scrollIntoView()})}},{key:"handleValidationError",value:function(){this.validationErrorEmitted||(this.emit(h.a.error,this.localized.loadError),this.validationErrorEmitted=!0)}},{key:"handleServicesErrors",value:function(t){var e="";switch(t.reason){case"read":e=this.localized.loadError;break;case"create":e=this.localized.createError,this.loadAnnotations();break;case"delete":e=this.localized.deleteError,this.loadAnnotations();break;case"authorization":e=this.localized.authError}t.error,e&&this.emit(h.a.error,e)}},{key:"handleControllerEvents",value:function(t){switch(t.event){case h.fb.resetMobileDialog:this.removeThreadFromSharedDialog();break;case h.fb.toggleMode:this.toggleAnnotationMode(t.mode);break;case h.fb.enter:this.emit(t.event,{mode:t.mode}),this.unbindDOMListeners();break;case h.fb.exit:this.emit(t.event,{mode:t.mode}),this.bindDOMListeners();break;case h.fb.createThread:this.createPointThread(t.data);break;default:this.emit(t.event,t.data)}}},{key:"emit",value:function(t,e){var n=this.options.annotator;a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"emit",this).call(this,t,e),a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"emit",this).call(this,"annotatorevent",{event:t,data:e,annotatorName:n?n.NAME:"",fileVersionId:this.fileVersionId,fileId:this.fileId})}}]),d);function d(t){!function(t){if(!(t instanceof d))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(d.__proto__||Object.getPrototypeOf(d)).call(this));e.options=t,e.locale=t.location.locale||"en-US",e.validationErrorEmitted=!1,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.localized=t.localizedStrings;var n=e.options,i=n.apiHost,o=n.file,r=n.token;e.fileVersionId=o.file_version.id,e.fileId=o.id,e.permissions=e.getAnnotationPermissions(e.options.file),e.annotationService=new s.a({apiHost:i,fileId:e.fileId,token:r,canAnnotate:e.permissions.canAnnotate,anonymousUserName:e.localized.anonymousUserName});var a=(e.options.annotator||{}).CONTROLLERS;return e.modeControllers=a||{},e.fetchPromise=e.fetchAnnotations(),e.createPointThread=e.createPointThread.bind(e),e.scaleAnnotations=e.scaleAnnotations.bind(e),e.handleControllerEvents=e.handleControllerEvents.bind(e),e.handleServicesErrors=e.handleServicesErrors.bind(e),e.hideAnnotations=e.hideAnnotations.bind(e),e}e.a=u},function(t,e,n){"use strict";e.a=function e(t){!function(t){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.annotationID=t.annotationID,this.fileVersionId=t.fileVersionId,this.threadID=t.threadID,this.threadNumber=t.threadNumber,this.type=t.type,this.text=t.text,this.location=t.location,this.user=t.user,this.permissions=t.permissions,this.created=t.created,this.modified=t.modified}},function(t,e,n){"use strict";var i=n(3),o=n.n(i),r=n(0),a=n(1),s=function(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t};function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,o.a),s(c,[{key:"focus",value:function(){this.textAreaEl&&(this.textAreaEl.focus(),this.textAreaEl.classList.remove(r.U))}},{key:"blur",value:function(){document.activeElement&&document.activeElement.blur()}},{key:"clear",value:function(){this.textAreaEl&&(this.textAreaEl.value="")}},{key:"hide",value:function(){this.containerEl&&Object(a.x)(this.containerEl)}},{key:"show",value:function(){this.containerEl||(this.containerEl=this.createCommentBox(),this.parentEl.appendChild(this.containerEl)),Object(a.M)(this.containerEl),Object(a.l)(this.textAreaEl)}},{key:"destroy",value:function(){this.containerEl&&(this.containerEl.removeEventListener("touchend",this.preventDefaultAndPropagation),this.containerEl.remove(),this.parentEl=null,this.containerEl=null,this.cancelEl&&(this.cancelEl.removeEventListener("click",this.onCancel),this.cancelEl.removeEventListener("touchend",this.onCancel)),this.postEl&&(this.postEl.removeEventListener("click",this.onPost),this.postEl.removeEventListener("touchend",this.onPost)),this.textAreaEl&&this.textAreaEl.removeEventListener("focus",this.focus))}},{key:"createHTML",value:function(){var t=document.createElement("section");return t.classList.add(r.J),t.innerHTML=('\n            <textarea class="'+r.cb+" "+r.C+" "+r.c+'"\n                placeholder="'+this.placeholderText+'"></textarea>\n            <div class="'+r.F+'">\n                <button class="'+r.E+" "+r.j+'">\n                    '+this.cancelText+'\n                </button>\n                <button class="'+r.E+" "+r.H+" "+r.k+'">\n                    '+this.postText+"\n                </button>\n            </div>").trim(),t}},{key:"preventDefaultAndPropagation",value:function(t){t.preventDefault(),t.stopPropagation()}},{key:"onCancel",value:function(t){this.preventDefaultAndPropagation(t),this.clear(),this.emit(c.CommentEvents.cancel)}},{key:"onPost",value:function(t){this.preventDefaultAndPropagation(t);var e=this.textAreaEl.value;""!==e.trim()?(this.emit(c.CommentEvents.post,e),this.clear()):this.textAreaEl.classList.add(r.U)}},{key:"createCommentBox",value:function(){var t=this.createHTML();return this.textAreaEl=t.querySelector(r.Wb),this.cancelEl=t.querySelector(r.Lb),this.postEl=t.querySelector(r.Rb),this.focus=this.focus.bind(this),this.onCancel=this.onCancel.bind(this),this.onPost=this.onPost.bind(this),this.hasTouch&&(t.addEventListener("touchend",this.preventDefaultAndPropagation.bind(this)),this.cancelEl.addEventListener("touchend",this.onCancel),this.postEl.addEventListener("touchend",this.onPost)),this.isMobile||(this.textAreaEl.addEventListener("focus",this.focus),this.cancelEl.addEventListener("click",this.onCancel),this.postEl.addEventListener("click",this.onPost)),t.addEventListener("click",this.preventDefaultAndPropagation.bind(this)),t}}]),c);function c(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return n.parentEl=t,n.hasTouch=e.hasTouch||!1,n.isMobile=e.isMobile||!1,n.localized=e.localized,n.cancelText=e.localized.cancelButton,n.postText=e.localized.postButton,n.placeholderText=e.localized.addCommentPlaceholder,n.containerEl=n.createCommentBox(),n}h.CommentEvents={cancel:"comment_cancel",post:"comment_post"};var u=h,d=function(t,e,n){return e&&f(t.prototype,e),n&&f(t,n),t};function f(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var p=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(g,o.a),d(g,[{key:"setParentEl",value:function(t){this.parentEl=t}},{key:"setPosition",value:function(t,e){this.position.x=t,this.position.y=e,this.updatePosition()}},{key:"show",value:function(t){this.isVisible=!0,this.containerEl||this.createElement(),t&&this.setParentEl(t),this.setButtonVisibility(!0),Object(a.M)(this.containerEl),this.emit(r.gb.init)}},{key:"showCommentBox",value:function(){this.commentBox.show(),this.commentBox.focus()}},{key:"hide",value:function(){this.isVisible=!1,this.containerEl&&(Object(a.x)(this.containerEl),this.commentBox&&(this.commentBox.hide(),this.commentBox.clear()))}},{key:"destroy",value:function(){this.containerEl&&(this.hide(),this.isMobile||(this.containerEl.removeEventListener("click",this.stopPropagation),this.containerEl.removeEventListener("mouseup",this.stopPropagation),this.containerEl.removeEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.removeEventListener("touchend",this.stopPropagation),this.containerEl.remove(),this.containerEl=null,this.parentEl=null,this.commentBox&&(this.commentBox.removeListener(u.CommentEvents.post,this.onCommentPost),this.commentBox.removeListener(u.CommentEvents.cancel,this.onCommentCancel),this.commentBox.destroy(),this.commentBox=null))}},{key:"updatePosition",value:function(){this.isMobile||(this.containerEl.style.left=this.position.x-1-this.containerEl.clientWidth/2+"px",this.containerEl.style.top=this.position.y+5+"px")}},{key:"onCommentPost",value:function(t){this.emit(r.gb.post,t),t&&(this.commentBox.clear(),this.commentBox.blur())}},{key:"onCommentCancel",value:function(){this.emit(r.gb.cancel),this.commentBox.hide(),this.setButtonVisibility(!0),this.updatePosition()}},{key:"setButtonVisibility",value:function(t){t?Object(a.M)(this.buttonsEl):Object(a.x)(this.buttonsEl)}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"setupCommentBox",value:function(t){var e=new u(t,{hasTouch:this.hasTouch,isMobile:this.isMobile,localized:this.localized});return t.appendChild(e.containerEl),e.addListener(u.CommentEvents.post,this.onCommentPost.bind(this)),e.addListener(u.CommentEvents.cancel,this.onCommentCancel.bind(this)),e.hide(),e}},{key:"createElement",value:function(){this.containerEl=document.createElement("div"),this.containerEl.classList.add(r.X),this.containerEl.classList.add(r.o),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation),this.commentBox=this.setupCommentBox(this.containerEl),this.containerEl.appendChild(this.commentBox.containerEl)}}]),g);function g(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof g))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(g.__proto__||Object.getPrototypeOf(g)).call(this));return n.position={x:0,y:0},n.parentEl=t,n.isMobile=!!e.isMobile||!1,n.hasTouch=!!e.hasTouch||!1,n.localized=e.localized,n.isVisible=!1,n}e.a=p},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(8),o=n(1),r=n(0),s=function(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t};function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,i.a),s(c,[{key:"handleThreadEvents",value:function(t,e){var n=void 0;switch(e.event){case r.hc.save:(n=Object(o.r)(t.annotations))&&n.type===r.ic.highlight&&2===Object.keys(t.annotations).length&&this.renderPage(t.location.page);break;case r.hc.threadCleanup:this.emit(r.fb.renderPage,t.location.page)}a(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"handleThreadEvents",this).call(this,t,e)}},{key:"exit",value:function(){this.destroyPendingThreads(),window.getSelection().removeAllRanges(),this.unbindListeners(),this.emit(r.fb.bindDOMListeners)}},{key:"enter",value:function(){this.emit(r.fb.unbindDOMListeners),this.bindListeners()}},{key:"render",value:function(){a(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"render",this).call(this),this.destroyPendingThreads()}},{key:"renderPage",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]'),n=this.mode===r.ic.highlight?r.w:r.x;Object(o.c)(e,n),this.threads&&a(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"renderPage",this).call(this,t)}}]),c);function c(){return function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).apply(this,arguments))}e.a=h},function(t,e){!function(t){"use strict";if(!t.fetch){var e="URLSearchParams"in t,n="Symbol"in t&&"iterator"in Symbol,a="FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),i="FormData"in t,o="ArrayBuffer"in t;if(o)var r=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],s=function(t){return t&&DataView.prototype.isPrototypeOf(t)},l=ArrayBuffer.isView||function(t){return t&&-1<r.indexOf(Object.prototype.toString.call(t))};p.prototype.append=function(t,e){t=u(t),e=d(e);var n=this.map[t];this.map[t]=n?n+","+e:e},p.prototype.delete=function(t){delete this.map[u(t)]},p.prototype.get=function(t){return t=u(t),this.has(t)?this.map[t]:null},p.prototype.has=function(t){return this.map.hasOwnProperty(u(t))},p.prototype.set=function(t,e){this.map[u(t)]=d(e)},p.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},p.prototype.keys=function(){var n=[];return this.forEach(function(t,e){n.push(e)}),f(n)},p.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),f(e)},p.prototype.entries=function(){var n=[];return this.forEach(function(t,e){n.push([e,t])}),f(n)},n&&(p.prototype[Symbol.iterator]=p.prototype.entries);var h=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];E.prototype.clone=function(){return new E(this,{body:this._bodyInit})},b.call(E.prototype),b.call(C.prototype),C.prototype.clone=function(){return new C(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new p(this.headers),url:this.url})},C.error=function(){var t=new C(null,{status:0,statusText:""});return t.type="error",t};var c=[301,302,303,307,308];C.redirect=function(t,e){if(-1===c.indexOf(e))throw new RangeError("Invalid status code");return new C(null,{status:e,headers:{location:t}})},t.Headers=p,t.Request=E,t.Response=C,t.fetch=function(n,o){return new Promise(function(i,t){var e=new E(n,o),r=new XMLHttpRequest;r.onload=function(){var t,o,e={status:r.status,statusText:r.statusText,headers:(t=r.getAllResponseHeaders()||"",o=new p,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var e=t.split(":"),n=e.shift().trim();if(n){var i=e.join(":").trim();o.append(n,i)}}),o)};e.url="responseURL"in r?r.responseURL:e.headers.get("X-Request-URL");var n="response"in r?r.response:r.responseText;i(new C(n,e))},r.onerror=function(){t(new TypeError("Network request failed"))},r.ontimeout=function(){t(new TypeError("Network request failed"))},r.open(e.method,e.url,!0),"include"===e.credentials?r.withCredentials=!0:"omit"===e.credentials&&(r.withCredentials=!1),"responseType"in r&&a&&(r.responseType="blob"),e.headers.forEach(function(t,e){r.setRequestHeader(e,t)}),r.send(void 0===e._bodyInit?null:e._bodyInit)})},t.fetch.polyfill=!0}function u(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function d(t){return"string"!=typeof t&&(t=String(t)),t}function f(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return n&&(t[Symbol.iterator]=function(){return t}),t}function p(e){this.map={},e instanceof p?e.forEach(function(t,e){this.append(e,t)},this):Array.isArray(e)?e.forEach(function(t){this.append(t[0],t[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function g(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function m(n){return new Promise(function(t,e){n.onload=function(){t(n.result)},n.onerror=function(){e(n.error)}})}function v(t){var e=new FileReader,n=m(e);return e.readAsArrayBuffer(t),n}function y(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function b(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t)if("string"==typeof t)this._bodyText=t;else if(a&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(i&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(o&&a&&s(t))this._bodyArrayBuffer=y(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!o||!ArrayBuffer.prototype.isPrototypeOf(t)&&!l(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=y(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},a&&(this.blob=function(){var t=g(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?g(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(v)}),this.text=function(){var t,e,n,i=g(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,n=m(e=new FileReader),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),i=0;i<e.length;i++)n[i]=String.fromCharCode(e[i]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},i&&(this.formData=function(){return this.text().then(w)}),this.json=function(){return this.text().then(JSON.parse)},this}function E(t,e){var n,i,o=(e=e||{}).body;if(t instanceof E){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new p(t.headers)),this.method=t.method,this.mode=t.mode,o||null==t._bodyInit||(o=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new p(e.headers)),this.method=(i=(n=e.method||this.method||"GET").toUpperCase(),-1<h.indexOf(i)?i:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(o)}function w(t){var o=new FormData;return t.trim().split("&").forEach(function(t){if(t){var e=t.split("="),n=e.shift().replace(/\+/g," "),i=e.join("=").replace(/\+/g," ");o.append(decodeURIComponent(n),decodeURIComponent(i))}}),o}function C(t,e){e=e||{},this.type="default",this.status=void 0===e.status?200:e.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new p(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:this)},function(t,e){t.exports='<svg width="22" height="21" viewBox="0 0 22 21" focusable="false">\n  <path d="M11 21l-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15l-4 4zm-7-9.5c0-.276.228-.5.51-.5h8.98c.282 0 .51.232.51.5 0 .276-.228.5-.51.5H4.51c-.282 0-.51-.232-.51-.5zm0-3c0-.276.23-.5.5-.5h11c.276 0 .5.232.5.5 0 .276-.23.5-.5.5h-11c-.276 0-.5-.232-.5-.5zm0-3c0-.276.22-.5.498-.5h13.004c.275 0 .498.232.498.5 0 .276-.22.5-.498.5H4.498C4.223 6 4 5.768 4 5.5z" fill="#0061d5" fill-rule="evenodd"/>\n</svg>\n'},function(t,e){t.exports='<svg width="20" height="20" viewBox="0 0 20 20" focusable="false">\n  <g fill="none" fill-rule="evenodd">\n    <path d="M-2-2h24v24H-2"/>\n    <path class="icon" d="M18 0H2C.9 0 .01.9.01 2L0 20l4-4h14c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2zM4 7h10v2H4V7zm8 5H4v-2h8v2zm4-6H4V4h12v2z" fill="#000"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="30" viewBox="0 0 24 30" focusable="false">\n  <g transform="translate(1 1)" fill="none" fill-rule="evenodd">\n    <path d="M15 17l-4 4-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15z" stroke="#FFF" fill="#0061d5"/>\n    <rect fill="#FFF" x="4" y="5" width="14" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="8" width="12" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="11" width="10" height="1" rx=".5"/>\n    <circle fill-opacity=".3" fill="#0061d5" cx="11" cy="26" r="3"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 10l5 5 5-5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 14l5-5 5 5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#000" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="24" viewBox="0 0 24 24" focusable="false">\n    <g fill-rule="evenodd">\n        <path d="M1 23h11.875v-3H1v3zm9.19-9.854l4.103 4.102.694.694.707-.68 7-6.742.306-.295V.07l-1.673 1.524L10.224 11.7l-.775.705.74.74z"/>\n        <path d="M11.023 12.17L6.33 16.58C5.28 17.62 5.9 19 7.32 19h3.95c.82 0 1.826-.413 2.406-.995l1.544-1.383.768-.69-.713-.745-2.844-2.976-.683-.717-.723.68v-.003zm-.038 1.42l2.844 2.977.053-1.435-1.584 1.42c-.244.243-.74.446-1.03.446l-2.454-.008 3.577-3.36-1.408-.04z"/>\n    </g>\n</svg>\n'},function(t,e){t.exports='<svg viewBox="-11 13 24 24" focusable="false">\n  <path class="icon" fill="#494949" d="M6 21l-1-1-4 4-4-4-1 1 4 4-4 4 1 1 4-4 4 4 1-1-4-4 4-4z"/>\n  <path fill="none" d="M-11 13h24v24h-24V13z"/>\n</svg>\n'},function(t,e){t.exports='<svg width="11" height="11" viewBox="0 0 24 18" focusable="false"><path d="M9 21.035l-9-8.638 2.791-2.87 6.156 5.874 12.21-12.436 2.843 2.817z"/></svg>'},function(t,e){t.exports='<svg width="11" height="9" viewBox="0 0 24 24" focusable="false"><path d="M23.954 21.03l-9.184-9.095 9.092-9.174-2.832-2.807-9.09 9.179-9.176-9.088-2.81 2.81 9.186 9.105-9.095 9.184 2.81 2.81 9.112-9.192 9.18 9.1z"/></svg>'},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(8),o=n(26),r=n.n(o),s=n(1),l=n(0),h=function(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t};function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var u=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(d,i.a),h(d,[{key:"init",value:function(t){a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"init",this).call(this,t),"none"===t.options.header&&!this.headerElement||this.setupHeader(this.headerElement,r.a),this.handleSelection=this.handleSelection.bind(this)}},{key:"setupHeader",value:function(t,e){a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"setupHeader",this).call(this,t,e),this.cancelButtonEl=this.getButton(l.Mb),this.cancelButtonEl.textContent=this.localized.cancelButton,this.postButtonEl=this.getButton(l.Nb),this.postButtonEl.textContent=this.localized.doneButton||"Done",this.undoButtonEl=this.getButton(l.Pb),this.redoButtonEl=this.getButton(l.Ob)}},{key:"bindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.addEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.addEventListener("click",this.handleSelection)}},{key:"unbindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.removeEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.removeEventListener("click",this.handleSelection)}},{key:"bindListeners",value:function(){a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"bindListeners",this).call(this),this.unbindDOMListeners()}},{key:"unbindListeners",value:function(){a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"unbindListeners",this).call(this),this.bindDOMListeners(),Object(s.g)(this.undoButtonEl),Object(s.g)(this.redoButtonEl)}},{key:"stopPropagation",value:function(t){Object(s.k)(t.target,l.A)&&t.stopPropagation()}},{key:"cancelDrawing",value:function(){this.currentThread&&this.currentThread.cancelUnsavedAnnotation(),this.currentThread=void 0,this.toggleMode()}},{key:"postDrawing",value:function(){this.currentThread&&this.currentThread.state===l.gc.pending&&this.saveThread(this.currentThread),this.currentThread=void 0,this.toggleMode()}},{key:"undoDrawing",value:function(){this.currentThread&&this.currentThread.undo()}},{key:"redoDrawing",value:function(){this.currentThread&&this.currentThread.redo()}},{key:"setupHandlers",value:function(){var e=this;this.locationFunction=function(t){return e.annotator.getLocationFromEvent(t,l.ic.point)},this.stopPropagation=this.stopPropagation.bind(this),this.drawingStartHandler=this.drawingStartHandler.bind(this),this.cancelDrawing=this.cancelDrawing.bind(this),this.postDrawing=this.postDrawing.bind(this),this.undoDrawing=this.undoDrawing.bind(this),this.redoDrawing=this.redoDrawing.bind(this),this.pushElementHandler(this.annotatedElement,"click",this.stopPropagation,!0),this.pushElementHandler(this.cancelButtonEl,"click",this.cancelDrawing),this.pushElementHandler(this.postButtonEl,"click",this.postDrawing),this.pushElementHandler(this.undoButtonEl,"click",this.undoDrawing),this.pushElementHandler(this.redoButtonEl,"click",this.redoDrawing),this.pushElementHandler(this.annotatedElement,["mousedown","touchstart"],this.drawingStartHandler,!0)}},{key:"drawingStartHandler",value:function(t){var e=this;t.stopPropagation(),t.preventDefault();var n=this.annotator.getLocationFromEvent(t,l.ic.point);if(n)if(this.currentThread)this.currentThread.handleStart(n);else{n.minX=n.x,n.maxX=n.x,n.minY=n.y,n.maxY=n.y;var i=this.annotator.createAnnotationThread([],n,l.ic.draw);i&&(this.currentThread=i,this.emit(l.hc.pending,i.getThreadEventData()),i.bindDrawingListeners(this.locationFunction),i.addListener("threadevent",function(t){return e.handleThreadEvents(i,t)}),i.handleStart(n))}}},{key:"exit",value:function(){this.annotatedElement.classList.remove(l.s),a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"exit",this).call(this)}},{key:"enter",value:function(){a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"enter",this).call(this),Object(s.H)(this.headerElement,l.cc),this.annotatedElement.classList.add(l.s)}},{key:"handleThreadEvents",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=e.eventData;switch(e.event){case"softcommit":t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),this.currentThread=void 0,this.saveThread(t),this.unbindListeners(),this.bindListeners(),n&&n.location&&this.currentThread.handleStart(n.location);break;case"dialogdelete":if(!t||!t.dialog)return;if(this.currentThread=void 0,t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),t.state===l.gc.pending)t.destroy(),this.unbindListeners(),this.bindListeners();else{t.deleteThread(),this.unregisterThread(t);var i=t.location.page;this.threads[i].all().forEach(function(t){return t.show()})}break;case"availableactions":this.updateUndoRedoButtonEls(n.undo,n.redo)}a(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"handleThreadEvents",this).call(this,t,e)}},{key:"handleSelection",value:function(t){var e=this.currentThread&&this.currentThread.state===l.gc.pending;if(!(!t||t.target&&"BUTTON"===t.target.nodeName||e)){t.stopPropagation();var n=this.getIntersectingThreads(t);if(this.removeSelection(),0!==n.length){var i=n[Math.floor(Math.random()*n.length)];this.select(i)}else this.selectedThread=void 0}}},{key:"renderPage",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');Object(s.c)(e,l.u),this.threads&&this.threads[t]&&(this.threads[t].all()||[]).forEach(function(t){return t.show()})}},{key:"removeSelection",value:function(){this.selectedThread&&(this.selectedThread.clearBoundary(),this.selectedThread=void 0)}},{key:"select",value:function(t){t.drawBoundary(),this.selectedThread=t}},{key:"updateUndoRedoButtonEls",value:function(t,e){this.undoButtonEl&&(1===t?Object(s.h)(this.undoButtonEl):0===t&&Object(s.g)(this.undoButtonEl)),this.redoButtonEl&&(1===e?Object(s.h)(this.redoButtonEl):0===e&&Object(s.g)(this.redoButtonEl))}},{key:"saveThread",value:function(t){t&&Object(s.w)(t)&&(t.saveAnnotation(l.ic.draw),this.registerThread(t))}}]),d);function d(){return function(t){if(!(t instanceof d))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(d.__proto__||Object.getPrototypeOf(d)).apply(this,arguments))}e.a=u},function(t,e,n){"use strict";t.exports=i,t.exports.default=i;var s=n(39);function i(t,e){if(!(this instanceof i))return new i(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function c(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function f(t,e){v(t,0,t.children.length,e,t)}function v(t,e,n,i,o){(o=o||g(null)).minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,a=e;a<n;a++)r=t.children[a],u(o,t.leaf?i(r):r);return o}function u(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function r(t,e){return t.minX-e.minX}function a(t,e){return t.minY-e.minY}function y(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function d(t){return t.maxX-t.minX+(t.maxY-t.minY)}function p(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function h(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function g(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(t,e,n,i,o){for(var r,a=[e,n];a.length;)(n=a.pop())-(e=a.pop())<=i||(r=e+Math.ceil((n-e)/i/2)*i,s(t,r,e,n,o),a.push(e,r,r,n))}i.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],i=this.toBBox;if(!h(t,e))return n;for(var o,r,a,s,l=[];e;){for(o=0,r=e.children.length;o<r;o++)a=e.children[o],h(t,s=e.leaf?i(a):a)&&(e.leaf?n.push(a):p(t,s)?this._all(a,n):l.push(a));e=l.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!h(t,e))return!1;for(var i,o,r,a,s=[];e;){for(i=0,o=e.children.length;i<o;i++)if(r=e.children[i],h(t,a=e.leaf?n(r):r)){if(e.leaf||p(t,a))return!0;s.push(r)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var o=this.data;this.data=i,i=o}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=g([]),this},remove:function(t,e){if(!t)return this;for(var n,i,o,r,a=this.data,s=this.toBBox(t),l=[],h=[];a||l.length;){if(a||(a=l.pop(),i=l[l.length-1],n=h.pop(),r=!0),a.leaf&&-1!==(o=c(t,a.children,e)))return a.children.splice(o,1),l.push(a),this._condense(l),this;r||a.leaf||!p(a,s)?i?(n++,a=i.children[n],r=!1):a=null:(l.push(a),h.push(n),n=0,a=(i=a).children[0])}return this},toBBox:function(t){return t},compareMinX:r,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,i){var o,r=n-e+1,a=this._maxEntries;if(r<=a)return f(o=g(t.slice(e,n+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(a)),a=Math.ceil(r/Math.pow(a,i-1))),(o=g([])).leaf=!1,o.height=i;var s,l,h,c,u=Math.ceil(r/a),d=u*Math.ceil(Math.sqrt(a));for(m(t,e,n,d,this.compareMinX),s=e;s<=n;s+=d)for(m(t,s,h=Math.min(s+d-1,n),u,this.compareMinY),l=s;l<=h;l+=u)c=Math.min(l+u-1,h),o.children.push(this._build(t,l,c,i-1));return f(o,this.toBBox),o},_chooseSubtree:function(t,e,n,i){for(var o,r,a,s,l,h,c,u,d,f;i.push(e),!e.leaf&&i.length-1!==n;){for(c=u=1/0,o=0,r=e.children.length;o<r;o++)l=y(a=e.children[o]),d=t,f=a,(h=(Math.max(f.maxX,d.maxX)-Math.min(f.minX,d.minX))*(Math.max(f.maxY,d.maxY)-Math.min(f.minY,d.minY))-l)<u?(u=h,c=l<c?l:c,s=a):h===u&&l<c&&(c=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,n){var i=this.toBBox,o=n?t:i(t),r=[],a=this._chooseSubtree(o,this.data,e,r);for(a.children.push(t),u(a,o);0<=e&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)},_split:function(t,e){var n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);var r=this._chooseSplitIndex(n,o,i),a=g(n.children.splice(r,n.children.length-r));a.height=n.height,a.leaf=n.leaf,f(n,this.toBBox),f(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)},_splitRoot:function(t,e){this.data=g([t,e]),this.data.height=t.height+1,this.data.leaf=!1,f(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var i,o,r,a,s,l,h,c,u,d,f,p,g,m;for(l=h=1/0,i=e;i<=n-e;i++)u=o=v(t,0,i,this.toBBox),d=r=v(t,i,n,this.toBBox),f=Math.max(u.minX,d.minX),p=Math.max(u.minY,d.minY),g=Math.min(u.maxX,d.maxX),m=Math.min(u.maxY,d.maxY),a=Math.max(0,g-f)*Math.max(0,m-p),s=y(o)+y(r),a<l?(l=a,c=i,h=s<h?s:h):a===l&&s<h&&(h=s,c=i);return c},_chooseSplitAxis:function(t,e,n){var i=t.leaf?this.compareMinX:r,o=t.leaf?this.compareMinY:a;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,o)&&t.children.sort(i)},_allDistMargin:function(t,e,n,i){t.children.sort(i);var o,r,a=this.toBBox,s=v(t,0,e,a),l=v(t,n-e,n,a),h=d(s)+d(l);for(o=e;o<n-e;o++)r=t.children[o],u(s,t.leaf?a(r):r),h+=d(s);for(o=n-e-1;e<=o;o--)r=t.children[o],u(l,t.leaf?a(r):r),h+=d(l);return h},_adjustParentBBoxes:function(t,e,n){for(var i=n;0<=i;i--)u(e[i],t)},_condense:function(t){for(var e,n=t.length-1;0<=n;n--)0===t[n].children.length?0<n?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():f(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-draw-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-draw-undo-redo-container">\n        <button class="bp-btn-plain ba-btn-annotate-draw-undo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false" style="z-index: 1">\n                <path d="M2,10a6.22,6.22,0,0,0,6,6A6,6,0,0,0,8,4V6L3,3,8,0V2A8,8,0,0,1,8,18a8.16,8.16,0,0,1-5.49-2A7.83,7.83,0,0,1,0,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n        <button class="bp-btn-plain ba-btn-annotate-draw-redo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false">\n                <path d="M14,10a6.22,6.22,0,0,1-6,6A6,6,0,0,1,8,4V6l5-3L8,0V2A8,8,0,1,0,8,18a8.16,8.16,0,0,0,5.49-2A7.83,7.83,0,0,0,16,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n    </div>\n    <div class="ba-mode-header-btn-container ba-draw-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-draw-cancel"></button>\n        <button class="bp-btn ba-btn-annotate-draw-post"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";function a(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:a(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var i=n(8),o=n(28),r=n.n(o),s=n(0),l=n(11),h=n(1),c=function(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),t};function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var d=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(f,i.a),c(f,[{key:"init",value:function(t){a(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"init",this).call(this,t),"none"===t.options.header&&!this.headerElement||this.setupHeader(this.headerElement,r.a)}},{key:"setupHeader",value:function(t,e){a(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"setupHeader",this).call(this,t,e),this.exitButtonEl=this.getButton(s.Qb),this.exitButtonEl.textContent=this.localized.closeButton||"Close"}},{key:"setupSharedDialog",value:function(t,e){var n=this;this.createDialog=new l.a(t,{isMobile:e.isMobile,hasTouch:e.hasTouch,localized:e.localized}),this.createDialog.createElement(),this.onDialogCancel=this.onDialogCancel.bind(this),this.onDialogPost=this.onDialogPost.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this),this.createDialog.addListener(s.gb.init,function(){return n.emit(s.hc.pending,s.ic.point)}),this.createDialog.addListener(s.gb.cancel,this.onDialogCancel),this.createDialog.addListener(s.gb.post,this.onDialogPost)}},{key:"onDialogCancel",value:function(){var t=this.getThreadByID(this.pendingThreadID);this.unregisterThread(t),t.destroy(),this.hideSharedDialog()}},{key:"onDialogPost",value:function(t){this.emit(s.fb.createThread,{commentText:t,lastPointEvent:this.lastPointEvent,pendingThreadID:this.pendingThreadID}),this.hideSharedDialog()}},{key:"hideSharedDialog",value:function(){this.lastPointEvent=null,this.pendingThreadID=null,this.createDialog&&this.createDialog.isVisible&&this.createDialog.hide()}},{key:"setupHandlers",value:function(){this.pointClickHandler=this.pointClickHandler.bind(this),this.pushElementHandler(this.annotatedElement,["click","touchstart"],this.pointClickHandler,!0),this.pushElementHandler(this.exitButtonEl,"click",this.toggleMode)}},{key:"exit",value:function(){this.createDialog&&this.createDialog.hide(),this.buttonEl&&this.buttonEl.classList.remove(s.c),this.annotatedElement.classList.remove(s.B),a(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"exit",this).call(this)}},{key:"enter",value:function(){a(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"enter",this).call(this),Object(h.H)(this.headerElement,s.fc),this.annotatedElement.classList.add(s.B),this.buttonEl&&this.buttonEl.classList.add(s.c)}},{key:"pointClickHandler",value:function(t){if(Object(h.C)(t)||(t.stopPropagation(),t.preventDefault()),!Object(h.D)(t)){this.isMobile&&this.emit(s.fb.resetMobileDialog),this.hadPendingThreads=this.destroyPendingThreads();var e=this.annotator.getLocationFromEvent(t,s.ic.point);if(e){var n=this.annotator.createAnnotationThread([],e,s.ic.point);n?(this.isMobile&&(this.lastPointEvent=t,this.container.appendChild(this.createDialog.containerEl),this.createDialog.show(this.container),this.createDialog.showCommentBox()),this.pendingThreadID=n.threadID,n.show(),this.registerThread(n),this.emit(s.hc.pending,n.getThreadEventData())):this.hideSharedDialog()}else this.hideSharedDialog()}}}]),f);function f(){return function(t){if(!(t instanceof f))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(f.__proto__||Object.getPrototypeOf(f)).apply(this,arguments))}e.a=d},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-point-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-point-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-point-exit"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";var i=n(7),o=n.n(i),r=(n(34),n(35),n(36),n(9)),a=n(4),s=n(5),L=n(1),M=n(0),B=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},l=4/3;function b(t,e,n){for(var i=!1,o=-1,r=t.length,a=r-1;++o<r;a=o)(t[o][1]<=n&&n<t[a][1]||t[a][1]<=n&&n<t[o][1])&&e<(t[a][0]-t[o][0])*(n-t[o][1])/(t[a][1]-t[o][1])+t[o][0]&&(i=!i);return i}function j(){var t=window.getSelection();return!(!t||t.isCollapsed||t.rangeCount<1)}function E(t,e,n){var i=t.map(function(t){return t*l*n});if(2===i.length){var o=B(i,2);return[o[0],e-o[1]]}var r=B(i,8);return[r[0],e-r[1],r[2],e-r[3],r[4],e-r[5],r[6],e-r[7]]}function H(t,e,n){var i=[];if(2===t.length){var o=B(t,2);i=[o[0],e-o[1]]}else{var r=B(t,8);i=[r[0],e-r[1],r[2],e-r[3],r[4],e-r[5],r[6],e-r[7]]}return i.map(function(t){return(.75*t/n).toFixed(4)})}function h(t,e){var n=(e.querySelector('[data-page-number="'+t.page+'"]')||e).getBoundingClientRect(),i=n.height-M.Bb-M.Ab,o=L.v(e),r=t.x,a=t.y,s=L.q(t.dimensions,n,o,30);return s&&(r*=s.x,a*=s.y),E([r,a],i,o)}function c(t){var e=B(t[t.length-1],8),n=e[0],i=e[1],o=e[2],r=e[3],a=e[4],s=e[5],l=e[6],h=e[7];return[Math.max(n,o,a,l),Math.min(i,r,s,h)]}function u(t){return!(t.rangeCount<=0||t.isCollapsed||""===t.toString())}function d(t,e){var n=t.getBoundingClientRect(),i=window.devicePixelRatio||1,o=n.width,r=n.height-M.Bb-M.Ab,a=e;return a.width=i*o,a.height=i*r,1!==i&&(a.style.width=o+"px",a.style.height=r+"px",e.getContext("2d").scale(i,i)),a}function y(t,e){if(!t)return null;var n=t.querySelector("canvas."+e);if(n)return n.getContext("2d");(n=document.createElement("canvas")).classList.add(e),n=d(t,n);var i=t.querySelector(".textLayer"),o=t.querySelector(".canvasWrapper");return i?t.insertBefore(n,i):o&&o.appendChild(n),n.getContext("2d")}function f(t,e){return t.querySelector('[data-page-number="'+e+'"]')}M.ib,M.jb,M.pb,M.hb,M.rb,M.kb,M.tb,M.mb,M.sb,M.ob,M.lb,M.nb;function p(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:p(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var g=n(2),m=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},v=function(t,e,n){return e&&w(t.prototype,e),n&&w(t,n),t};function w(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function C(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:C(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var O=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(S,s.a),v(S,[{key:"addAnnotation",value:function(t){if(""===t.text&&"0"!==t.user.id){var e=this.highlightDialogEl.querySelector("."+M.R);e.textContent=L.I(this.localized.whoHighlighted,[t.user.name]),L.M(e),this.isMobile||this.position()}p(S.prototype.__proto__||Object.getPrototypeOf(S.prototype),"addAnnotation",this).call(this,t)}},{key:"removeAnnotation",value:function(t){var e=this.commentsDialogEl.querySelector('[data-annotation-id="'+t+'"]');e&&(e.parentNode.removeChild(e),this.deactivateReply())}},{key:"postAnnotation",value:function(t){var e=this.element.querySelector(M.Wb);""!==(t||e.value).trim()&&(this.element.querySelector(M.ec)&&(L.M(M.Y),this.element.classList.remove(M.z)),p(S.prototype.__proto__||Object.getPrototypeOf(S.prototype),"postAnnotation",this).call(this,t))}},{key:"hideCommentsDialog",value:function(){this.commentsDialogEl&&this.highlightDialogEl&&(this.commentsDialogEl.classList.contains(M.O)||(L.x(this.commentsDialogEl),this.element.classList.add(M.Q),L.M(this.highlightDialogEl),this.hasComments=!1))}},{key:"drawAnnotation",value:function(){this.emit("annotationdraw"),this.toggleHighlight()}},{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),e=t.getBoundingClientRect(),n=e.height-15-15,i=this.getScaledPDFCoordinates(e,n),o=m(i,2),r=o[0],a=o[1];t.appendChild(this.element);var s=L.p(this.element),l=r-s/2,h=this.hasComments?a-10:a;h-=10,this.hasComments&&(this.element.style.borderTopWidth="30px"),l=L.J(this.element,l,s,r,e.width),h<0?h=0:n<h+38&&(h=n-38),this.element.style.left=l+"px",this.element.style.top=h+15+"px",this.fitDialogHeightInPage(),L.M(this.element)}},{key:"toggleHighlightDialogs",value:function(){this.commentsDialogEl&&this.highlightDialogEl&&(this.commentsDialogEl.classList.contains(M.O)?(this.element.classList.remove(M.Q),L.x(this.highlightDialogEl),this.element.classList.add(M.o),L.M(this.commentsDialogEl),this.hasComments=!0,this.dialogEl.querySelector(M.Wb).classList.add(M.c)):(this.element.classList.remove(M.o),L.x(this.commentsDialogEl),this.element.classList.add(M.Q),L.M(this.highlightDialogEl),this.hasComments=!1),this.isMobile||this.position())}},{key:"toggleHighlightCommentsReply",value:function(t){var e=this.commentsDialogEl.querySelector(M.Gb),n=this.commentsDialogEl.querySelector(M.Hb);t?(L.x(e),L.M(n),this.deactivateReply()):(L.x(n),L.M(e),this.activateReply()),this.isMobile||this.position()}},{key:"setup",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.element||(this.element=document.createElement("div"));var n=L.r(t);n&&(this.hasComments=""!==n.text||1<Object.keys(t).length);var i=n?n.permissions.can_delete:this.canAnnotate;if(this.highlightDialogEl=this.generateHighlightDialogEl(i,e),this.highlightDialogEl.classList.add(M.t),this.commentsDialogEl=this.generateDialogEl(Object.keys(t).length),this.commentsDialogEl.classList.add(M.n),this.dialogEl=document.createElement("div"),this.dialogEl.appendChild(this.highlightDialogEl),this.dialogEl.appendChild(this.commentsDialogEl),this.hasComments?this.highlightDialogEl.classList.add(M.O):this.commentsDialogEl.classList.add(M.O),this.isMobile||(this.element.setAttribute("data-type",M.ib),this.element.classList.add(M.o),this.element.classList.add(M.O),this.element.innerHTML='<div class="'+M.l+'"></div>',this.element.appendChild(this.dialogEl),n&&(this.element.dataset.threadNumber=n.threadNumber)),n&&this.dialogEl.classList.add(M.db),L.F(t)&&n&&"0"!==n.user.id){var o=this.highlightDialogEl.querySelector("."+M.R);o.textContent=L.I(this.localized.whoHighlighted,[n.user.name]),L.M(o)}this.addSortedAnnotations(t),!this.isMobile&&this.canAnnotate&&this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("mousedown",this.mousedownHandler),this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("mouseup",this.stopPropagation),this.element.addEventListener("wheel",this.stopPropagation)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("mousedown",this.mousedownHandler),this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation)}},{key:"toggleHighlightIcon",value:function(t){var e=this.dialogEl.querySelector(M.Jb);e&&(t===M.yb.active?e.classList.add(M.c):e.classList.remove(M.c))}},{key:"keydownHandler",value:function(t){t.stopPropagation(),"Enter"===L.f(t)&&this.mousedownHandler(t),p(S.prototype.__proto__||Object.getPrototypeOf(S.prototype),"keydownHandler",this).call(this,t)}},{key:"mousedownHandler",value:function(t){switch(t.stopPropagation(),L.j(t.target)){case M.pb:this.drawAnnotation();break;case M.hb:this.emit("annotationdraw"),this.toggleHighlightCommentsReply(!1),this.toggleHighlightDialogs(),t.preventDefault(),this.focusAnnotationsTextArea();break;default:p(S.prototype.__proto__||Object.getPrototypeOf(S.prototype),"clickHandler",this).call(this,t)}}},{key:"toggleHighlight",value:function(){this.dialogEl.classList.contains(M.db)?(this.hasComments=!0,this.emit("annotationdelete")):(this.hasComments=!1,this.dialogEl.classList.add(M.db),this.emit("annotationcreate"))}},{key:"focusAnnotationsTextArea",value:function(){var t=this.dialogEl.querySelector(M.Wb);L.A(t)&&t.focus()}},{key:"getScaledPDFCoordinates",value:function(t,e){var n=L.v(this.annotatedElement),i=c(this.location.quadPoints),o=m(i,2),r=o[0],a=o[1],s=L.q(this.location.dimensions,t,n,30);return s&&(r*=s.x,a*=s.y),E([r,a],e,n)}},{key:"addAnnotationElement",value:function(t){""===t.text?this.highlightDialogEl.dataset.annotationId=t.annotationID:p(S.prototype.__proto__||Object.getPrototypeOf(S.prototype),"addAnnotationElement",this).call(this,t)}},{key:"generateHighlightDialogEl",value:function(t,e){var n=document.createElement("div"),i=document.createElement("span");if(i.classList.add(M.R),i.classList.add(M.O),n.appendChild(i),!this.canAnnotate)return n;var o=document.createElement("span");if(o.classList.add(M.P),n.appendChild(o),t){var r=L.m([M.G,M.e],this.localized.highlightToggle,g.e,M.pb);o.appendChild(r)}if(e){var a=L.m([M.G,M.f],this.localized.highlightComment,g.f,M.hb);o.appendChild(a)}return n}}]),S),x=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},T=function(t,e,n){return e&&_(t.prototype,e),n&&_(t,n),t};function _(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function S(t){!function(t){if(!(t instanceof S))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(S.__proto__||Object.getPrototypeOf(S)).call(this,t));return e.mousedownHandler=e.mousedownHandler.bind(e),e}function k(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}var A=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(P,a.a),T(P,[{key:"cancelFirstComment",value:function(){L.F(this.annotations)&&(this.type=M.ic.highlight),this.reset(),this.isMobile?this.hideDialog():L.F(this.annotations)?this.dialog.toggleHighlightDialogs():this.destroy()}},{key:"destroy",value:function(){C(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"destroy",this).call(this),this.state===M.gc.pending&&window.getSelection().removeAllRanges(),this.emit(M.hc.threadCleanup)}},{key:"hide",value:function(){this.draw(M.yb.erase)}},{key:"reset",value:function(){this.state=M.gc.inactive,this.show()}},{key:"saveAnnotation",value:function(t,e){C(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"saveAnnotation",this).call(this,t,e),window.getSelection().removeAllRanges()}},{key:"deleteAnnotation",value:function(t){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];C(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"deleteAnnotation",this).call(this,t,e);var n=L.r(this.annotations);if(n&&(""!==n.text||1<Object.keys(this.annotations).length)&&n.permissions&&!n.permissions.can_delete){var i=this.dialog.element.querySelector(M.Jb);L.x(i)}}},{key:"onMousedown",value:function(){this.state===M.gc.pending&&this.destroy()}},{key:"onClick",value:function(t,e){return!e&&this.isOnHighlight(t)?(this.state=M.gc.hover,this.show(),!0):(this.reset(),!1)}},{key:"isOnHighlight",value:function(t){return L.D(t)||this.isInHighlight(t)}},{key:"show",value:function(){switch(this.state){case M.gc.pending:this.showDialog();break;case M.gc.inactive:this.hideDialog(),this.draw(M.yb.normal);break;case M.gc.hover:case M.gc.pending_active:this.showDialog(),this.draw(M.yb.active)}}},{key:"showDialog",value:function(){this.dialog&&(this.dialog.element||this.dialog.setup(this.annotations,this.showComment),this.dialog.show())}},{key:"createDialog",value:function(){this.dialog=new O({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate});var t=L.r(this.annotations);t&&(""!==t.text||1<Object.keys(this.annotations).length)&&this.type===M.ic.highlight&&(this.type=M.ic.highlight_comment)}},{key:"setupElement",value:function(){}},{key:"handleDraw",value:function(){this.state=M.gc.pending_active,window.getSelection().removeAllRanges(),this.show()}},{key:"handleCommentPending",value:function(){this.state=M.gc.pending_active}},{key:"handleCreate",value:function(t){t?(this.type=M.ic.highlight_comment,this.dialog.toggleHighlightCommentsReply(Object.keys(this.annotations).length)):this.type=M.ic.highlight,this.saveAnnotation(this.type,t?t.text:"")}},{key:"handleDelete",value:function(t){if(t)this.deleteAnnotation(t.annotationID);else{var e=L.r(this.annotations);e&&this.deleteAnnotation(e.annotationID)}}},{key:"bindCustomListenersOnDialog",value:function(){this.handleDraw=this.handleDraw.bind(this),this.handleCommentPending=this.handleCommentPending.bind(this),this.handleCreate=this.handleCreate.bind(this),this.handleDelete=this.handleDelete.bind(this),this.cancelFirstComment=this.cancelFirstComment.bind(this),this.dialog.addListener("annotationdraw",this.handleDraw),this.dialog.addListener("annotationcommentpending",this.handleCommentPending),this.dialog.addListener("annotationcreate",this.handleCreate),this.dialog.addListener("annotationcancel",this.cancelFirstComment),this.dialog.addListener("annotationdelete",this.handleDelete)}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog.removeAllListeners("annotationdraw"),this.dialog.removeAllListeners("annotationcommentpending"),this.dialog.removeAllListeners("annotationcreate"),this.dialog.removeAllListeners("annotationcancel"),this.dialog.removeAllListeners("annotationdelete")}},{key:"scrollIntoView",value:function(){this.scrollToPage();var t=c(this.location.quadPoints),e=x(t,1)[0];this.adjustScroll(this.annotatedElement.scrollTop+e)}},{key:"draw",value:function(d){var f=this,t=this.getPageEl(),p=this.type===M.ic.highlight?y(t,M.w):y(t,M.x);if(p){var e=t.getBoundingClientRect(),g=e.height-M.Bb-M.Ab,m=L.v(this.annotatedElement),v=L.q(this.location.dimensions,e,m,M.Bb+M.Ab);this.location.quadPoints.forEach(function(t){var e=t;v&&(e=t.map(function(t,e){return e%2?t*v.y:t*v.x}));var n=E(e,g,m),i=x(n,8),o=i[0],r=i[1],a=i[2],s=i[3],l=i[4],h=i[5],c=i[6],u=i[7];p.fillStyle=d,p.beginPath(),p.moveTo(o,r),p.lineTo(a,s),p.lineTo(l,h),p.lineTo(c,u),p.closePath(),p.save(),p.globalCompositeOperation="destination-out",p.fillStyle=M.yb.erase,p.fill(),p.restore(),d!==M.yb.erase&&(p.fill(),f.dialog&&f.dialog.element&&f.dialog.toggleHighlightIcon(d))})}}},{key:"isInHighlight",value:function(t){for(var e=this.getPageEl().getBoundingClientRect(),n=e.height-M.Bb-M.Ab,i=e.top+M.Bb,o=L.v(this.annotatedElement),r=L.q(this.location.dimensions,e,o,M.Bb+M.Ab),a=t.clientX-e.left,s=t.clientY-i,l=!1,h=this.location.quadPoints,c=h.length,u=0;u<c&&!l;){var d=h[u],f=[].concat(k(d));if(r)for(var p=d.length,g=0;g<p;g++)f[g]=(y=d[g],g%2?y*r.y:y*r.x);var m=E(f,n,o),v=x(m,8);l=b([[v[0],v[1]],[v[2],v[3]],[v[4],v[5]],[v[6],v[7]]],a,s),u+=1}var y;return l}},{key:"getPageEl",value:function(){return this.pageEl||(this.pageEl=f(this.annotatedElement,this.location.page)),this.pageEl}},{key:"regenerateBoundary",value:function(){var c=this;this.location&&this.location.quadPoints&&(this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0,this.location.quadPoints.forEach(function(t){var e=x(t,8),n=e[0],i=e[1],o=e[2],r=e[3],a=e[4],s=e[5],l=e[6],h=e[7];c.minX=Math.min(n,o,a,l,c.minX),c.maxX=Math.max(n,o,a,l,c.maxX),c.minY=Math.min(i,r,s,h,c.minY),c.maxY=Math.max(i,r,s,h,c.maxY)}))}}]),P),R=function(t,e,n){return e&&D(t.prototype,e),n&&D(t,n),t};function D(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function P(t,e){!function(t){if(!(t instanceof P))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(P.__proto__||Object.getPrototypeOf(P)).call(this,t));return n.showComment=e,n}var N=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(z,s.a),R(z,[{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement;t.appendChild(this.element),L.M(this.element);var e=this.element.getBoundingClientRect().width,n=t.getBoundingClientRect(),i=this.threadEl.offsetLeft+12,o=i-e/2,r=this.threadEl.offsetTop+31;o=L.J(this.element,o,e,i,n.width),this.element.style.left=o-1+"px";var a=n.height+15,s=this.flipDialog(r,a+31);this.element.style.top=s.top,this.element.style.bottom=s.bottom}}]),z),I=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},F=function(t,e,n){return e&&q(t.prototype,e),n&&q(t,n),t};function q(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function z(){return function(t){if(!(t instanceof z))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(z.__proto__||Object.getPrototypeOf(z)).apply(this,arguments))}var Y=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(W,a.a),F(W,[{key:"showDialog",value:function(){this.permissions.canAnnotate&&j()||function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0}(W.prototype.__proto__||Object.getPrototypeOf(W.prototype),"showDialog",this).call(this)}},{key:"show",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement,e=h(this.location,this.annotatedElement),n=I(e,2),i=n[0],o=n[1];this.element.style.left=i-12+"px",this.element.style.top=o-31+4+15+"px",t.appendChild(this.element),L.M(this.element),this.state!==M.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new N({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),W);function X(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function W(){return function(t){if(!(t instanceof W))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(W.__proto__||Object.getPrototypeOf(W)).apply(this,arguments))}var U=(function(t,e,n){return e&&X(t.prototype,e),n&&X(t,n),t}(G,[{key:"addCoordinate",value:function(t,e){if(t&&t.x&&t.y){var n=Object(L.L)(t.x,2),i=Object(L.L)(t.y,2);n<this.minX&&(this.minX=n),i<this.minY&&(this.minY=i),i>this.maxY&&(this.maxY=i),n>this.maxX&&(this.maxX=n),this.path.push(Object(L.e)(n,i)),e&&e.x&&e.y&&this.browserPath.push(e)}}},{key:"isEmpty",value:function(){return 0===this.path.length}},{key:"drawPath",value:function(t){var e=t;if(e&&this.browserPath)for(var n=this.browserPath.length,i=0;i<n;i++){var o=void 0,r=void 0;0<i?(o=this.browserPath[i-1].x,r=this.browserPath[i-1].y):(o=this.browserPath[i].x,r=this.browserPath[i].y,e.moveTo(o,r));var a=(this.browserPath[i].x+o)/2,s=(this.browserPath[i].y+r)/2;e.quadraticCurveTo(o,r,a,s)}}},{key:"generateBrowserPath",value:function(t){this.path&&(this.browserPath=this.path.map(t))}}],[{key:"extractDrawingInfo",value:function(t,e){var n=e.paths,i={path:t.path};return n?n.push(i):n=[i],{minX:e.minX?Math.min(e.minX,t.minX):t.minX,maxX:e.maxX?Math.max(e.maxX,t.maxX):t.maxX,minY:e.minY?Math.min(e.minY,t.minY):t.minY,maxY:e.maxY?Math.max(e.maxY,t.maxY):t.maxY,paths:n}}}]),G);function V(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function G(t){var i=this;!function(t){if(!(t instanceof G))throw new TypeError("Cannot call a class as a function")}(this),this.path=[],this.browserPath=[],this.maxX=-1/0,this.maxY=-1/0,this.minX=1/0,this.minY=1/0,t&&(this.path=t.path.map(function(t){var e=+t.x,n=+t.y;return i.minX=Math.min(i.minX,e),i.maxX=Math.max(i.maxX,e),i.minY=Math.min(i.minY,n),i.maxY=Math.max(i.maxY,n),Object(L.e)(e,n)}))}function J(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:J(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var $=(function(t,e,n){return e&&V(t.prototype,e),n&&V(t,n),t}(tt,[{key:"destroy",value:function(){this.undoStack=[],this.redoStack=[]}},{key:"insert",value:function(t){this.undoStack.push(t),this.redoStack=[]}},{key:"undo",value:function(){if(this.isEmpty())return!1;var t=this.undoStack.pop();return this.redoStack.push(t),!0}},{key:"redo",value:function(){if(0===this.redoStack.length)return!1;var t=this.redoStack.pop();return this.undoStack.push(t),!0}},{key:"isEmpty",value:function(){return 0===this.undoStack.length}},{key:"getNumberOfItems",value:function(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length}}},{key:"getItems",value:function(){return this.undoStack.slice()}},{key:"getAxisAlignedBoundingBox",value:function(){var e={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,paths:[]};return this.getItems().forEach(function(t){e.minX=Math.min(e.minX,t.minX),e.maxX=Math.max(e.maxX,t.maxX),e.minY=Math.min(e.minY,t.minY),e.maxY=Math.max(e.maxY,t.maxY),e.paths.push({path:t.path})}),e}},{key:"applyToItems",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.undoStack.forEach(t),e&&this.redoStack.forEach(t)}}]),tt),Q=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},K=function(t,e,n){return e&&Z(t.prototype,e),n&&Z(t,n),t};function Z(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function tt(){!function(t){if(!(t instanceof tt))throw new TypeError("Cannot call a class as a function")}(this),this.undoStack=[],this.redoStack=[]}var et=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(ot,a.a),K(ot,[{key:"destroy",value:function(){this.lastAnimationRequestId&&window.cancelAnimationFrame(this.lastAnimationRequestId),this.dialog&&(this.dialog.destroy(),this.dialog=null),J(ot.prototype.__proto__||Object.getPrototypeOf(ot.prototype),"destroy",this).call(this),this.state!==M.gc.pending&&this.emit(M.hc.threadCleanup),this.reset()}},{key:"reset",value:function(){J(ot.prototype.__proto__||Object.getPrototypeOf(ot.prototype),"reset",this).call(this),this.clearBoundary()}},{key:"bindDrawingListeners",value:function(t){this.isMobile||(this.annotatedElement.addEventListener("mousemove",Object(L.i)(t,this.handleMove)),this.annotatedElement.addEventListener("mouseup",Object(L.i)(t,this.handleStop))),this.hasTouch&&(this.annotatedElement.addEventListener("touchmove",Object(L.i)(t,this.handleMove)),this.annotatedElement.addEventListener("touchcancel",Object(L.i)(t,this.handleStop)),this.annotatedElement.addEventListener("touchend",Object(L.i)(t,this.handleStop)))}},{key:"unbindDrawingListeners",value:function(){this.annotatedElement.removeEventListener("mousemove",L.i),this.annotatedElement.removeEventListener("mouseup",L.i),this.annotatedElement.removeEventListener("touchmove",L.i),this.annotatedElement.removeEventListener("touchcancel",L.i),this.annotatedElement.removeEventListener("touchend",L.i)}},{key:"handleMove",value:function(t){}},{key:"handleStart",value:function(t){}},{key:"handleStop",value:function(t){}},{key:"deleteThread",value:function(){var e=this;Object.keys(this.annotations).forEach(function(t){return e.deleteAnnotationWithID({annotationID:t})});var t=this.getBrowserRectangularBoundary(),n=Q(t,4),i=n[0],o=n[1],r=n[2],a=n[3];this.concreteContext&&this.concreteContext.clearRect(i-M.b,o+M.b,r+2*M.b,a-2*M.b),this.clearBoundary(),this.pathContainer.destroy(),this.pathContainer=null}},{key:"setContextStyles",value:function(t,e){if(this.drawingContext||e){var n=t.scale,i=t.color,o=e||this.drawingContext;o.lineCap="round",o.lineJoin="round",o.strokeStyle=i||"black",o.lineWidth=M.ub*(n||1)}}},{key:"undo",value:function(){this.pathContainer.undo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"redo",value:function(){this.pathContainer.redo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"setup",value:function(){Object(L.r)(this.annotations)?(this.state=M.gc.inactive,this.createDialog()):this.state=M.gc.pending}},{key:"draw",value:function(e){if(e){if(1<arguments.length&&void 0!==arguments[1]&&arguments[1]){var t=e.canvas;e.clearRect(0,0,t.width,t.height)}e.beginPath(),this.pathContainer.applyToItems(function(t){return t.drawPath(e)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.drawPath(e),e.stroke()}}},{key:"emitAvailableActions",value:function(){var t=this.pathContainer.getNumberOfItems();this.emit("availableactions",{undo:t.undoCount,redo:t.redoCount})}},{key:"drawBoundary",value:function(){if(this.location.page){var t=this.getBrowserRectangularBoundary(),e=Q(t,4),n=e[0],i=e[1],o=e[2],r=e[3];this.drawingContext.save(),this.drawingContext.beginPath(),this.drawingContext.lineWidth=this.drawingContext.lineWidth/2,this.drawingContext.setLineDash([M.vb,2*M.vb]),this.drawingContext.rect(n,i,o,r),this.drawingContext.stroke(),this.drawingContext.restore(),this.dialog&&(this.dialog.isVisible()||this.pathContainer.isEmpty()||this.showDialog(),this.dialog.position(n+o,i))}}},{key:"render",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:window.performance.now(),e=!0;t-(this.lastRenderTimestamp||0)>=M.wb&&(this.draw(this.drawingContext,!0),this.drawBoundary(),this.lastRenderTimestamp=t,e=this.drawingFlag===M.xb.drawing),e&&(this.lastAnimationRequestId=window.requestAnimationFrame(this.render))}},{key:"updateBoundary",value:function(t){var e=t?U.extractDrawingInfo(t,this.location):this.pathContainer.getAxisAlignedBoundingBox();Object.assign(this.location,e)}},{key:"regenerateBoundary",value:function(){if(this.location&&!this.location.boundaryData){var t=this.location;this.minX=t.minX,this.maxX=t.maxX,this.minY=t.minY,this.maxY=t.maxY}}},{key:"getBrowserRectangularBoundary",value:function(){}},{key:"clearBoundary",value:function(){if(this.drawingContext){var t=this.drawingContext.canvas;this.drawingContext.clearRect(0,0,t.width,t.height)}this.dialog&&this.dialog.isVisible()&&this.dialog.hide()}}]),ot),nt=function(t,e,n){return e&&it(t.prototype,e),n&&it(t,n),t};function it(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function ot(t){!function(t){if(!(t instanceof ot))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(ot.__proto__||Object.getPrototypeOf(ot)).call(this,t));return n.drawingFlag=M.xb.idle,n.pathContainer=new $,n.state=M.gc.inactive,n.render=n.render.bind(n),n.handleStart=n.handleStart.bind(n),n.handleMove=n.handleMove.bind(n),n.handleStop=n.handleStop.bind(n),n.undo=n.undo.bind(n),n.redo=n.redo.bind(n),n.location&&n.location.paths&&(n.regenerateBoundary(),n.dialog&&n.pathContainer.isEmpty()&&n.dialog.hide(),n.location.paths.forEach(function(t){var e=new U(t);n.pathContainer.insert(e)})),n}var rt=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(ht,s.a),nt(ht,[{key:"destroy",value:function(){this.unbindDOMListeners(),this.removeAllListeners(),this.element&&(this.element.removeEventListener("click",L.G),this.pageEl&&this.pageEl.contains(this.element)&&this.pageEl.removeChild(this.element),this.element=null)}},{key:"isVisible",value:function(){return this.visible}},{key:"addAnnotation",value:function(t){this.element||this.setup([t]),this.assignDrawingLabel(t)}},{key:"removeAnnotation",value:function(){}},{key:"bindDOMListeners",value:function(){this.commitButtonEl&&(this.isMobile||this.commitButtonEl.addEventListener("click",this.postDrawing),this.hasTouch&&this.commitButtonEl.addEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.isMobile||this.deleteButtonEl.addEventListener("click",this.deleteAnnotation),this.hasTouch&&this.deleteButtonEl.addEventListener("touchend",this.deleteAnnotation))}},{key:"unbindDOMListeners",value:function(){this.commitButtonEl&&(this.commitButtonEl.removeEventListener("click",this.postDrawing),this.commitButtonEl.removeEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.deleteButtonEl.removeEventListener("click",this.deleteAnnotation),this.deleteButtonEl.removeEventListener("touchend",this.deleteAnnotation))}},{key:"setup",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this.element=document.createElement("div"),this.element.addEventListener("click",L.G),this.element.classList.add(M.o),this.drawingDialogEl=this.generateDialogEl(t),this.commitButtonEl=this.drawingDialogEl.querySelector(M.Ib),this.deleteButtonEl=this.drawingDialogEl.querySelector(M.bc),this.bindDOMListeners();var e=L.r(t);e&&this.addAnnotation(e),this.element.appendChild(this.drawingDialogEl)}},{key:"position",value:function(t,e){this.pageEl||(this.pageEl=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')),this.element||this.setup(),this.pageEl.contains(this.element)||this.pageEl.appendChild(this.element);var n=this.element.getBoundingClientRect();this.element.style.left=t-n.width+"px",this.element.style.top=e+"px"}},{key:"hide",value:function(){L.x(this.element),this.visible=!1}},{key:"show",value:function(){L.M(this.element),this.visible=!0}},{key:"generateDialogEl",value:function(t){var e=L.r(t),n=!e,i=n||e&&e.permissions&&e.permissions.can_delete,o=document.createElement("span");o.classList.add(M.p);var r=document.createElement("span");if(r.classList.add(M.r),r.classList.add(M.O),o.appendChild(r),n){var a=L.m([M.G,M.d],this.localized.drawSave,g.d+" "+this.localized.saveButton);o.appendChild(a)}if(i){var s=L.m([M.G,M.L],this.localized.drawDelete,g.c+" "+this.localized.deleteButton);o.appendChild(s)}var l=document.createElement("div");return l.classList.add(M.q),l.appendChild(o),l}},{key:"assignDrawingLabel",value:function(t){if(t&&this.drawingDialogEl&&"0"!==t.user.id){var e=this.drawingDialogEl.querySelector("."+M.r);e.textContent=L.I(this.localized.whoDrew,[t.user.name]),L.M(e)}}},{key:"postDrawing",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationcreate")}},{key:"deleteAnnotation",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationdelete")}}]),ht),at=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},st=function(t,e,n){return e&&lt(t.prototype,e),n&&lt(t,n),t};function lt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function ht(t){!function(t){if(!(t instanceof ht))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(ht.__proto__||Object.getPrototypeOf(ht)).call(this,t));return e.visible=!1,e.postDrawing=e.postDrawing.bind(e),e.deleteAnnotation=e.deleteAnnotation.bind(e),e}function ct(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:ct(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var ut=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e}(gt,et),st(gt,[{key:"handleMove",value:function(t){if(this.drawingFlag===M.xb.drawing&&t)if(this.hasPageChanged(t))this.onPageChange(t);else{var e=h(t,this.pageEl),n=at(e,2),i=n[0],o=n[1],r=Object(L.e)(i,o);this.pendingPath&&this.pendingPath.addCoordinate(t,r)}}},{key:"handleStart",value:function(t){t&&(this.hasPageChanged(t)?this.onPageChange(t):(this.location&&this.location.page||!t.page||(this.location={page:t.page,dimensions:t.dimensions}),this.checkAndHandleScaleUpdate(),this.drawingFlag=M.xb.drawing,this.pendingPath||(this.pendingPath=new U),this.dialog&&this.dialog.isVisible()&&this.dialog.hide(),this.lastAnimationRequestId=window.requestAnimationFrame(this.render),this.state=M.gc.pending))}},{key:"handleStop",value:function(){window.cancelAnimationFrame(this.lastAnimationRequestId),this.lastAnimationRequestId=0,this.drawingFlag=M.xb.idle,this.pendingPath&&!this.pendingPath.isEmpty()&&(this.dialog||this.createDialog(),this.pathContainer.insert(this.pendingPath),this.updateBoundary(this.pendingPath),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.render(),this.emitAvailableActions(),this.pendingPath=null)}},{key:"hasPageChanged",value:function(t){return!!(t&&this.location&&this.location.page&&this.location.page!==t.page)}},{key:"saveAnnotation",value:function(t,e){this.reset(),this.pathContainer.isEmpty()||(this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(i):void 0}(gt.prototype.__proto__||Object.getPrototypeOf(gt.prototype),"saveAnnotation",this).call(this,t,e),this.createDialog(),this.show())}},{key:"show",value:function(){var e=this;if(this.annotatedElement&&this.location){var t=this.selectContext();this.dialog&&this.dialog.isVisible()&&(this.drawBoundary(),this.dialog.show()),this.pathContainer.applyToItems(function(t){return t.generateBrowserPath(e.reconstructBrowserCoordFromLocation)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.generateBrowserPath(this.reconstructBrowserCoordFromLocation),this.draw(t,!1)}}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.dialog.addListener("annotationcreate",function(){return t.emit("softcommit")}),this.dialog.addListener("annotationdelete",function(){return t.emit("dialogdelete")}))}},{key:"createDialog",value:function(){this.dialog&&this.dialog.destroy(),this.dialog=new rt({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,canAnnotate:this.annotationService.canAnnotate,isMobile:this.isMobile,hasTouch:this.hasTouch}),this.dialog.localized=this.localized,this.bindCustomListenersOnDialog()}},{key:"checkAndHandleScaleUpdate",value:function(){var t=Object(L.v)(this.annotatedElement);if(this.lastScaleFactor!==t&&this.location&&this.location.page){this.lastScaleFactor=t,this.pageEl=f(this.annotatedElement,this.location.page),this.drawingContext=y(this.pageEl,M.v);var e={scale:t};this.setContextStyles(e)}}},{key:"onPageChange",value:function(t){this.handleStop(),this.emit("softcommit",{location:t})}},{key:"reconstructBrowserCoordFromLocation",value:function(t){var e=h(Object(L.e)(t.x,t.y,this.location.dimensions),this.pageEl),n=at(e,2),i=n[0],o=n[1];return Object(L.e)(i,o)}},{key:"selectContext",value:function(){if(this.checkAndHandleScaleUpdate(),this.state===M.gc.pending)return this.drawingContext;var t={scale:this.lastScaleFactor};return this.concreteContext=y(this.pageEl,M.u),this.setContextStyles(t,this.concreteContext),this.concreteContext}},{key:"getBrowserRectangularBoundary",value:function(){if(!this.location||!this.location.dimensions||!this.pageEl)return null;var t=Object(L.e)(this.minX,this.minY,this.location.dimensions),e=Object(L.e)(this.maxX,this.maxY,this.location.dimensions),n=h(t,this.pageEl),i=at(n,2),o=i[0],r=i[1],a=h(e,this.pageEl),s=at(a,2);return[o,r,s[0]-o,s[1]-r]}}]),gt),dt=n(11),ft=function(t,e,n){return e&&pt(t.prototype,e),n&&pt(t,n),t};function pt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function gt(t){!function(t){if(!(t instanceof gt))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(gt.__proto__||Object.getPrototypeOf(gt)).call(this,t));return e.onPageChange=e.onPageChange.bind(e),e.reconstructBrowserCoordFromLocation=e.reconstructBrowserCoordFromLocation.bind(e),e}function mt(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:mt(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var vt=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(wt,dt.a),ft(wt,[{key:"show",value:function(t,e){if(e){var n=Object(L.u)(e.anchorNode);if(n.pageEl){var i=this.isMobile?t:n.pageEl;ct(wt.prototype.__proto__||Object.getPrototypeOf(wt.prototype),"show",this).call(this,i),this.parentEl.querySelector(".ba-create-annotation-dialog")||this.parentEl.appendChild(this.containerEl),this.isMobile||this.setPosition(e)}}}},{key:"setPosition",value:function(t){if(t&&t.rangeCount){var e=function(t){var e=t.endContainer,n=t.endOffset,i=document.createElement("span"),o=e.parentNode;if("#text"===e.nodeName){var r=e.splitText(n);o.insertBefore(i,r)}else{var a=e.firstChild,s=e.previousElementSibling;s?s.appendChild(i):a?e.insertBefore(i,a):e.appendChild(i)}var l=i.getBoundingClientRect(),h=l.right,c=l.bottom;return i.parentNode&&i.parentNode.removeChild(i),{x:h,y:c}}(t.getRangeAt(t.rangeCount-1)),n=Object(L.u)(t.anchorNode);if(n.pageEl){var i=n.pageEl.getBoundingClientRect(),o=i.left,r=i.top+M.Bb;ct(wt.prototype.__proto__||Object.getPrototypeOf(wt.prototype),"setPosition",this).call(this,e.x-o,e.y-r)}}}},{key:"destroy",value:function(){ct(wt.prototype.__proto__||Object.getPrototypeOf(wt.prototype),"destroy",this).call(this),this.highlightCreateEl&&(this.highlightCreateEl.removeEventListener("click",this.onHighlightClick),this.highlightCreateEl.removeEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.removeEventListener("touchend",this.onHighlightClick)),this.commentCreateEl&&(this.commentCreateEl.removeEventListener("click",this.onCommentClick),this.commentCreateEl.removeEventListener("touchstart",this.stopPropagation),this.commentCreateEl.removeEventListener("touchend",this.onCommentClick))}},{key:"updatePosition",value:function(){if(!this.isMobile){var t=Object(L.p)(this.containerEl),e=this.position.x-1-t/2,n=Object(L.J)(this.containerEl,e,78,this.position.x,this.parentEl.clientWidth);this.containerEl.style.left=n+"px",this.containerEl.style.top=this.position.y+5+"px",Object(L.M)(this.containerEl)}}},{key:"onHighlightClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(M.gb.plain)}},{key:"onCommentClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(M.gb.comment),this.commentBox.show(),this.commentBox.focus(),this.setButtonVisibility(!1),this.updatePosition()}},{key:"createElement",value:function(){if(this.containerEl=document.createElement("div"),this.containerEl.classList.add("ba-create-annotation-dialog"),!this.isMobile){var t=document.createElement("div");t.classList.add(M.l),t.left="50%",this.containerEl.appendChild(t)}var e=document.createElement("span");if(e.classList.add(M.P),this.allowHighlight){var n=Object(L.m)([M.G,M.e],this.localized.highlightToggle,g.e,"add-highlight-btn");e.appendChild(n)}var i=document.createElement("div");i.classList.add(M.t),i.appendChild(e),this.containerEl.appendChild(i),this.isMobile&&(this.containerEl.classList.add(M.W),this.containerEl.classList.add(M.o));var o=this.containerEl.querySelector(M.Ub);if(this.buttonsEl=o.querySelector(M.dc),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.allowHighlight&&(this.highlightCreateEl=o.querySelector(M.Jb),this.highlightCreateEl.addEventListener("click",this.onHighlightClick),this.hasTouch&&(this.highlightCreateEl.addEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.addEventListener("touchend",this.onHighlightClick))),this.allowComment){var r=Object(L.m)([M.G,M.f],this.localized.highlightComment,g.f,"add-highlight-comment-btn");e.appendChild(r),this.commentBox=this.setupCommentBox(o),this.commentCreateEl=o.querySelector(M.Kb),this.commentCreateEl.addEventListener("click",this.onCommentClick),this.hasTouch&&(this.commentCreateEl.addEventListener("touchstart",this.stopPropagation),this.commentCreateEl.addEventListener("touchend",this.onCommentClick))}this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation)}}]),wt),yt=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},bt=function(t,e,n){return e&&Et(t.prototype,e),n&&Et(t,n),t};function Et(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function wt(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof wt))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(wt.__proto__||Object.getPrototypeOf(wt)).call(this,t,e));return n.position={x:0,y:0},n.allowHighlight=e.allowHighlight||!1,n.allowComment=e.allowComment||!1,n.allowHighlight&&(n.onHighlightClick=n.onHighlightClick.bind(n)),n.allowComment&&(n.onCommentClick=n.onCommentClick.bind(n),n.onCommentPost=n.onCommentPost.bind(n),n.onCommentCancel=n.onCommentCancel.bind(n)),n.createElement(),n}var Ct=[M.w,M.x,M.u],Ot=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(xt,r.a),bt(xt,[{key:"destroy",value:function(){mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"destroy",this).call(this),this.createHighlightDialog&&(this.commentHighlightEnabled&&(this.createHighlightDialog.removeListener(M.gb.comment,this.highlightCurrentSelection),this.createHighlightDialog.removeListener(M.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&this.createHighlightDialog.removeListener(M.gb.plain,this.createPlainHighlight),this.createHighlightDialog.destroy(),this.createHighlightDialog=null)}},{key:"init",value:function(t){mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"init",this).call(this,t),this.annotatedElement.id="ba-rangy-annotated-element"}},{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-doc")}},{key:"getLocationFromEvent",value:function(t,e){var n,i,o,r,a,s,l,h=null,c=L.v(this.annotatedElement);if(e===M.ic.point){var u=t;if(this.hasTouch&&t.targetTouches){if(t.targetTouches.length<=0)return h;u=t.targetTouches[0]}var d=u.target,f=L.u(d),p=f.pageEl?f.pageEl:this.annotatedElement.querySelector('[data-page-number="'+f.page+'"]');if(!p)return h;if(j())return h;var g=L.j(d);if(L.D(t)||g===M.jb)return h;var m=p.getBoundingClientRect(),v=m.width,y=m.height-M.Bb-M.Ab,b=[u.clientX-m.left,u.clientY-m.top-M.Bb];if(o=v,r=y,a=B(b,2),s=a[0],l=a[1],s<0||o<s||l<0||r<l)return h;var E=b[0],w=b[1];if(Number.isNaN(E)||Number.isNaN(w))return this.emit(M.a.error,this.localized.createError),h;var C=H(b,y,c),O=yt(C,2);E=O[0],w=O[1];var x={x:v/c,y:y/c};h={x:E,y:w,page:f.page,dimensions:x}}else if(L.B(e)){if(!this.highlighter||!this.highlighter.highlights.length)return h;var T=L.u(window.getSelection().anchorNode),_=T.pageEl,S=T.page;if(!_){var k=L.u(this.annotatedElement.querySelector(".rangy-highlight"));_=k.pageEl,S=k.page}var A=(n=this.highlighter,i=_,{highlight:n.highlights[0],highlightEls:[].slice.call(i.querySelectorAll(".rangy-highlight"),0).filter(function(t){return t.tagName&&"SPAN"===t.tagName&&""!==t.textContent.trim()})}).highlightEls;if(0===A.length)return h;var R=[];A.forEach(function(t){R.push(function(t,e,n){var i=document.createElement("div");i.classList.add(M.T),i.innerHTML=('\n        <div class="'+M.S+' corner1"></div>\n        <div class="'+M.S+' corner2"></div>\n        <div class="'+M.S+' corner3"></div>\n        <div class="'+M.S+' corner4"></div>').trim(),t.appendChild(i);var o=i.querySelector(".corner1"),r=i.querySelector(".corner2"),a=i.querySelector(".corner3"),s=i.querySelector(".corner4"),l=o.getBoundingClientRect(),h=r.getBoundingClientRect(),c=a.getBoundingClientRect(),u=s.getBoundingClientRect(),d=e.getBoundingClientRect(),f=d.height-M.Bb-M.Ab,p=d.left,g=d.top+M.Bb;return t.removeChild(i),H([l.left-p,l.top-g,h.left-p,h.top-g,c.left-p,c.top-g,u.left-p,u.top-g],f,n)}(t,_,c))});var D=_.getBoundingClientRect(),P=D.width,N=D.height-M.Bb-M.Ab;h={page:S,quadPoints:R,dimensions:{x:P/c,y:N/c}}}return h}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0,o=this.getThreadParams(t,e,n);return L.a(o)?(L.B(n)?i=new A(o,this.commentHighlightEnabled):n===M.ic.draw?i=new ut(o):n===M.ic.point&&(i=new Y(o)),i||this.emit(M.a.error,this.localized.loadError)):this.handleValidationError(),i}},{key:"renderPage",value:function(t){this.scaleAnnotationCanvases(t),mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"renderPage",this).call(this,t),this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide()}},{key:"scaleAnnotationCanvases",value:function(t){var n=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');Ct.forEach(function(t){var e=n.querySelector("canvas."+t);e&&d(n,e)})}},{key:"setupAnnotations",value:function(){var t=this;this.plainHighlightEnabled=!!this.modeControllers[M.ic.highlight],this.commentHighlightEnabled=!!this.modeControllers[M.ic.highlight_comment],this.drawEnabled=!!this.modeControllers[M.ic.draw],this.drawEnabled&&(this.drawingSelectionHandler=this.drawingSelectionHandler.bind(this)),(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.highlightCreateHandler=this.highlightCreateHandler.bind(this),this.highlightMouseupHandler=this.highlightMouseupHandler.bind(this),this.highlightMousedownHandler=this.highlightMousedownHandler.bind(this),this.hideCreateDialog=this.hideCreateDialog.bind(this),this.clickThread=this.clickThread.bind(this),(this.isMobile||this.hasTouch)&&(this.onSelectionChange=this.onSelectionChange.bind(this)),this.createHighlightDialog=new vt(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,allowComment:this.commentHighlightEnabled,allowHighlight:this.plainHighlightEnabled,localized:this.localized}),this.createHighlightDialog.addListener(M.gb.init,function(){return t.emit(M.hc.pending,M.ic.highlight)}),this.commentHighlightEnabled&&(this.highlightCurrentSelection=this.highlightCurrentSelection.bind(this),this.createHighlightDialog.addListener(M.gb.comment,this.highlightCurrentSelection),this.createHighlightThread=this.createHighlightThread.bind(this),this.createHighlightDialog.addListener(M.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&(this.createPlainHighlight=this.createPlainHighlight.bind(this),this.createHighlightDialog.addListener(M.gb.plain,this.createPlainHighlight)),this.highlighter=o.a.createHighlighter(),this.highlighter.addClassApplier(o.a.createClassApplier("rangy-highlight",{ignoreWhiteSpace:!0,tagNames:["span","a"]}))),mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"setupAnnotations",this).call(this)}},{key:"bindDOMListeners",value:function(){mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"bindDOMListeners",this).call(this),(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.annotatedElement.addEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.addEventListener("wheel",this.hideCreateDialog),this.hasTouch&&this.annotatedElement.addEventListener("touchend",this.hideCreateDialog)),this.hasTouch&&this.drawEnabled?this.annotatedElement.addEventListener("touchstart",this.drawingSelectionHandler):this.drawEnabled&&this.annotatedElement.addEventListener("click",this.drawingSelectionHandler),this.permissions.canAnnotate&&(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.hasTouch||this.isMobile?document.addEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.addEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.addEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.addEventListener("contextmenu",this.highlightMousedownHandler)))}},{key:"unbindDOMListeners",value:function(){var e=this;mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"unbindDOMListeners",this).call(this),this.annotatedElement.removeEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("wheel",this.hideCreateDialog),this.annotatedElement.removeEventListener("touchend",this.hideCreateDialog),this.highlightThrottleHandle&&(cancelAnimationFrame(this.highlightThrottleHandle),this.highlightThrottleHandle=null),Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].removeSelection()}),this.hasTouch||this.isMobile?document.removeEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.removeEventListener("click",this.drawingSelectionHandler),this.annotatedElement.removeEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.removeEventListener("contextmenu",this.highlightMousedownHandler))}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&(this.mobileDialogEl.classList.remove(M.z),mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"removeThreadFromSharedDialog",this).call(this))}},{key:"hideCreateDialog",value:function(t){this.createHighlightDialog&&this.createHighlightDialog.isVisible&&t&&!L.D(t)&&this.createHighlightDialog.hide()}},{key:"resetHighlightSelection",value:function(t){this.isCreatingHighlight=!1,this.hideCreateDialog(t),document.getSelection().removeAllRanges()}},{key:"createPlainHighlight",value:function(){this.highlightCurrentSelection(),this.createHighlightThread()}},{key:"createHighlightThread",value:function(t){if(""===t||!this.lastHighlightEvent)return null;this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide(),this.isCreatingHighlight=!1;var e=t?M.ic.highlight_comment:M.ic.highlight,n=this.getLocationFromEvent(this.lastHighlightEvent,e);if(this.highlighter.removeAllHighlights(),!n)return null;var i=this.createAnnotationThread({},n,e);if(this.lastHighlightEvent=null,this.lastSelection=null,!i)return null;t?i.dialog.hasComments=!0:i.dialog.drawAnnotation(),i.state=M.gc.hover,i.show(),i.dialog.postAnnotation(t);var o=this.modeControllers[e];return o&&o.registerThread(i),this.emit(M.hc.threadSave,i.getThreadEventData()),i}},{key:"onSelectionChange",value:function(t){var e=this;t.preventDefault(),t.stopPropagation(),this.selectionEndTimeout&&(clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=null);var n=this.modeControllers[M.ic.point];if(!(n&&n.pendingThreadID||"textarea"===document.activeElement.nodeName.toLowerCase())){var i=window.getSelection();if(this.lastSelection&&i&&function(t,e){if(!t||t.rangeCount<1||!e)return!1;var n=t.getRangeAt(t.rangeCount-1),i=e.getRangeAt(t.rangeCount-1);return n.compareBoundaryPoints(Range.START_TO_END,i)}(i,this.lastSelection)||this.highlighter.removeAllHighlights(),!u(i))return this.lastHighlightEvent=null,this.createHighlightDialog.hide(),void this.highlighter.removeAllHighlights();this.selectionEndTimeout=setTimeout(function(){e.createHighlightDialog&&e.createHighlightDialog.show(e.container,i)},500);var o=L.u(t.target).page;this.plainHighlightEnabled&&this.modeControllers[M.ic.highlight].applyActionToThreads(function(t){return t.reset()},o),this.commentHighlightEnabled&&this.modeControllers[M.ic.highlight_comment].applyActionToThreads(function(t){return t.reset()},o),this.lastSelection=i,this.lastHighlightEvent=t}}},{key:"highlightCurrentSelection",value:function(){this.highlighter&&this.highlighter.highlightSelection("rangy-highlight",{containerElementId:this.annotatedElement.id})}},{key:"highlightMousedownHandler",value:function(t){this.isCreatingHighlight=!0,this.mouseX=t.clientX,this.mouseY=t.clientY,this.plainHighlightEnabled&&this.modeControllers[M.ic.highlight].applyActionToThreads(function(t){return t.onMousedown()}),this.commentHighlightEnabled&&this.modeControllers[M.ic.highlight_comment].applyActionToThreads(function(t){return t.onMousedown()})}},{key:"drawingSelectionHandler",value:function(t){var e=this.modeControllers[M.ic.draw];!e||this.isCreatingAnnotation()||this.isCreatingHighlight||e.handleSelection(t)}},{key:"isCreatingAnnotation",value:function(){var e=this,n=!1;return Object.keys(this.modeControllers).some(function(t){return e.modeControllers[t].hadPendingThreads&&(n=!0),n}),n}},{key:"highlightMouseupHandler",value:function(t){this.highlighter&&this.highlighter.removeAllHighlights();var e=this.mouseX&&this.mouseX!==t.clientX||this.mouseY&&this.mouseY!==t.clientY;this.createHighlightDialog&&e||"dblclick"===t.type?this.highlightCreateHandler(t):this.highlightClickHandler(t)}},{key:"highlightCreateHandler",value:function(t){t.stopPropagation();var e=window.getSelection();if(u(e)){var n=L.u(e.anchorNode).pageEl;if(n){var i=this.isMobile?this.container:n;this.createHighlightDialog.show(i,e),this.isCreatingHighlight=!0,this.lastHighlightEvent=t}}}},{key:"highlightClickHandler",value:function(t){this.activeThread=null,this.mouseEvent=t,this.consumed=!1;var e=[],n=[];this.plainHighlightEnabled&&(e=this.modeControllers[M.ic.highlight].getIntersectingThreads(this.mouseEvent)),this.commentHighlightEnabled&&(n=this.modeControllers[M.ic.highlight_comment].getIntersectingThreads(this.mouseEvent)),this.hideAnnotations(t),[].concat(e,n).forEach(this.clickThread),this.activeThread?this.activeThread.show():this.isMobile?this.removeThreadFromSharedDialog():this.resetHighlightSelection(t)}},{key:"clickThread",value:function(t){if(L.E(t.state))t.type===M.ic.point?t.destroy():t.cancelFirstComment();else if(L.B(t.type)){var e=t.onClick(this.mouseEvent,this.consumed);e&&(this.activeThread=t),this.consumed=this.consumed||e}else t.hideDialog()}},{key:"useDefaultCursor",value:function(){this.annotatedElement.classList.add("bp-use-default-cursor")}},{key:"removeDefaultCursor",value:function(){this.annotatedElement.classList.remove("bp-use-default-cursor")}},{key:"removeRangyHighlight",value:function(e){var t=this.highlighter.highlights;if(Array.isArray(t)){var n=t.filter(function(t){return t.id===e.id});this.highlighter.removeHighlights(n)}}},{key:"handleControllerEvents",value:function(t){switch(t.event){case M.fb.toggleMode:this.resetHighlightSelection(t.event);break;case M.fb.bindDOMListeners:this.hideCreateDialog(t);break;case M.fb.renderPage:this.renderPage(t.data)}mt(xt.prototype.__proto__||Object.getPrototypeOf(xt.prototype),"handleControllerEvents",this).call(this,t)}},{key:"showFirstDialogFilter",value:function(t,e){0===e?t.show():t.hideDialog()}}]),xt);function xt(){return function(t){if(!(t instanceof xt))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(xt.__proto__||Object.getPrototypeOf(xt)).apply(this,arguments))}e.a=Ot},function(t,e,n){"use strict";var i=n(9),o=n(4),r=n(5),f=n(1),a=function(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t};function s(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var l=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(h,r.a),a(h,[{key:"position",value:function(){this.annotatedElement.appendChild(this.element),f.M(this.element);var t=this.element.getBoundingClientRect().width,e=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),n=this.threadEl.offsetLeft+12,i=n-t/2,o=this.threadEl.offsetTop+31,r=e.clientWidth>this.annotatedElement.clientWidth?e.clientWidth:this.annotatedElement.clientWidth;i=f.J(this.element,i,t,n,r),this.element.style.left=i+"px";var a=this.flipDialog(o,this.container.clientHeight);this.element.style.top=a.top,this.element.style.bottom=a.bottom}}]),h),p=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function h(){return function(t){if(!(t instanceof h))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(h.__proto__||Object.getPrototypeOf(h)).apply(this,arguments))}var u=n(0),c=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},d=function(t,e,n){return e&&g(t.prototype,e),n&&g(t,n),t};function g(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function m(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:m(o,e,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0}var v=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(w,o.a),d(w,[{key:"show",value:function(){var t=function(t,e){var n=e.querySelector('[data-page-number="'+(t.page||1)+'"]')||e.querySelector("img"),i=e.getBoundingClientRect(),o=n.getBoundingClientRect(),r=f.v(e),a=o.top-i.top+e.scrollTop,s=o.left-i.left+e.scrollLeft,l=Number(n.getAttribute("data-rotation-angle")),h=function(t,e,n,i,o){var r=i.height,a=i.width/o,s=r/o;switch(n){case-90:return[e,s-t];case-180:return[a-t,s-e];case-270:return[a-e,t]}return[t,e]}(t.x,t.y,l,o,r),c=p(h,2),u=c[0],d=c[1];return u*=r,d*=r,0<=s&&(u+=s),0<=a&&(d+=a),-180===l&&(d-=7.5),[u,d]}(this.location,this.annotatedElement),e=c(t,2),n=e[0],i=e[1];this.element.style.left=n-12+"px",this.element.style.top=i-31+8+"px",this.annotatedElement.appendChild(this.element),f.M(this.element),this.state!==u.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new l({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,location:this.location,locale:this.locale,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),w),y=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},b=function(t,e,n){return e&&E(t.prototype,e),n&&E(t,n),t};function E(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function w(){return function(t){if(!(t instanceof w))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(w.__proto__||Object.getPrototypeOf(w)).apply(this,arguments))}var C=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(O,i.a),b(O,[{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-image, .bp-images-wrapper")}},{key:"getLocationFromEvent",value:function(t){var e=null,n=t;if(this.hasTouch){if(!t.targetTouches||0===t.targetTouches.length)return e;n=t.targetTouches[0]}var i=n.target;if("img"!==i.nodeName.toLowerCase())return e;var o=f.u(i).page,r=i.getBoundingClientRect(),a=n.clientX-r.left,s=n.clientY-r.top;if(Number.isNaN(a)||Number.isNaN(s))return this.emit(u.a.error,this.localized.createError),e;var l=f.v(this.annotatedElement),h=function(t,e,n,i,o){var r=i.height,a=i.width;switch(n){case-90:return[a/o-e,t];case-180:return[a/o-t,r/o-e];case-270:return[e,r/o-t]}return[t,e]}(a/l,s/l,Number(i.getAttribute("data-rotation-angle")),r,l),c=y(h,2);return{x:a=c[0],y:s=c[1],imageEl:i,dimensions:{x:r.width/l,y:r.height/l},page:o}}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0,o=e;(!o.page||o.page<0)&&(o.page=1);var r=this.getThreadParams(t,e,n);return f.a(r)?(n===u.ic.point&&(i=new v(r)),i||this.emit(u.a.error,this.localized.loadError)):this.handleValidationError(),i}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.rotateAnnotations(t.rotationAngle,t.pageNum)}},{key:"rotateAnnotations",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;e?this.renderPage(e):this.render();var n=this.modeControllers[u.ic.point];if(this.permissions.canAnnotate&&n){var i=this.modeButtons[u.ic.point].selector,o=n.getButton(i);0!==t?f.x(o):f.M(o)}}},{key:"bindDOMListeners",value:function(){this.annotatedElement.addEventListener("mouseup",this.hideAnnotations),m(O.prototype.__proto__||Object.getPrototypeOf(O.prototype),"bindDOMListeners",this).call(this)}},{key:"unbindDOMListeners",value:function(){this.annotatedElement.removeEventListener("mouseup",this.hideAnnotations),m(O.prototype.__proto__||Object.getPrototypeOf(O.prototype),"bindDOMListeners",this).call(this)}}]),O);function O(){return function(t){if(!(t instanceof O))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(O.__proto__||Object.getPrototypeOf(O)).apply(this,arguments))}e.a=C},function(t,e,n){t.exports=n(32)},function(t,v,y){"use strict";y.r(v),function(t){var e,n=y(29),i=y(30),o=y(24),r=y(27),a=y(12),s=y(0),l=y(1),h=function(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t};function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function u(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function d(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var f=[{NAME:"Document",CONSTRUCTOR:n.a,VIEWER:["Document","Presentation"],TYPE:[s.ic.point,s.ic.highlight,s.ic.highlight_comment,s.ic.draw],DEFAULT_TYPES:[s.ic.point,s.ic.highlight,s.ic.highlight_comment,s.ic.draw]},{NAME:"Image",CONSTRUCTOR:i.a,VIEWER:["Image","MultiImage"],TYPE:[s.ic.point],DEFAULT_TYPES:[s.ic.point]}],p=(d(e={},s.ic.point,{CONSTRUCTOR:r.a}),d(e,s.ic.highlight,{CONSTRUCTOR:a.a}),d(e,s.ic.highlight_comment,{CONSTRUCTOR:a.a}),d(e,s.ic.draw,{CONSTRUCTOR:o.a}),e),g=(h(m,[{key:"getAnnotators",value:function(){return Array.isArray(this.annotators)?this.annotators:[]}},{key:"getAnnotatorsForViewer",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],t=this.getAnnotators().find(function(t){return!n.includes(t.NAME)&&t.VIEWER.includes(e)});return this.instantiateControllers(t),t}},{key:"instantiateControllers",value:function(e){e&&e.TYPE&&!e.CONTROLLERS&&(e.CONTROLLERS={},this.getAnnotatorTypes(e).forEach(function(t){t in p&&(e.CONTROLLERS[t]=new p[t].CONSTRUCTOR)}))}},{key:"getAnnotatorTypes",value:function(t){if(this.viewerOptions&&this.viewerOptions[t.NAME]){var e=this.viewerOptions[t.NAME];if(e.enabledTypes)return e.enabledTypes.filter(function(e){return t.TYPE.some(function(t){return t===e})})}else if(!this.viewerConfig)return[].concat(u(t.DEFAULT_TYPES));var n=this.viewerConfig.enabledTypes||[].concat(u(t.DEFAULT_TYPES)),i=this.viewerConfig.disabledTypes||[];return n.filter(function(e){return!i.some(function(t){return t===e})&&t.TYPE.some(function(t){return t===e})})}},{key:"determineAnnotator",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],i=null;this.viewerConfig=e;var o=Object(l.b)(t.file.permissions),r=this.getAnnotatorsForViewer(t.viewer.NAME,n);return o&&r&&!1!==this.viewerConfig.enabled&&((i=Object.assign({},r)).TYPE=this.getAnnotatorTypes(i)),i}}]),m);function m(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t){if(!(t instanceof m))throw new TypeError("Cannot call a class as a function")}(this),this.annotators=f,this.viewerOptions=t}t.BoxAnnotations=g,v.default=g}.call(this,y(33))},function(c8,d8){var e8;e8=function(){return this}();try{e8=e8||Function("return this")()||eval("this")}catch(c8){"object"==typeof window&&(e8=window)}c8.exports=e8},function(t,e,n){var o,r,a;r=[n(7)],void 0===(a="function"==typeof(o=function(t){return t.createModule("ClassApplier",["WrappedSelection"],function(o,f){var p=o.dom,r=p.DomPosition,a=p.arrayContains,t=o.util,g=t.forEach,s=t.isHostMethod(document,"createElementNS");function d(t,e){for(var n in t)if(t.hasOwnProperty(n)&&!1===e(n,t[n]))return!1;return!0}function m(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function l(t,e){return!!t&&new RegExp("(?:^|\\s)"+e+"(?:\\s|$)").test(t)}function h(t,e){return"object"==typeof t.classList?t.classList.contains(e):l("string"==typeof t.className?t.className:t.getAttribute("class"),e)}function u(t,e){if("object"==typeof t.classList)t.classList.add(e);else{var n="string"==typeof t.className,i=n?t.className:t.getAttribute("class");i?l(i,e)||(i+=" "+e):i=e,n?t.className=i:t.setAttribute("class",i)}}var v=function(t,e){if("object"==typeof t.classList)t.classList.remove(e);else{var n="string"==typeof t.className,i=n?t.className:t.getAttribute("class");i=i.replace(new RegExp("(^|\\s)"+e+"(\\s|$)"),c),n?t.className=i:t.setAttribute("class",i)}};function c(t,e,n){return e&&n?" ":""}function e(t){return"string"==typeof t.className?t.className:t.getAttribute("class")}function y(t){return t&&t.split(/\s+/).sort().join(" ")}function n(t){return y(e(t))}function b(t,e){return n(t)==n(e)}function E(t,e){for(var n=e.split(/\s+/),i=0,o=n.length;i<o;++i)if(!h(t,m(n[i])))return!1;return!0}function w(t,c,u,e){-1==u&&(u=c.childNodes.length);var d=t.parentNode,f=p.getNodeIndex(t);g(e,function(t){var e,n,i,o,r,a,s,l,h;n=d,i=f,o=c,r=u,a=(e=t).node,s=e.offset,h=s,(l=a)==o&&r<s&&++h,a!=n||s!=i&&s!=i+1||(l=o,h+=r-i),a==n&&i+1<s&&--h,e.node=l,e.offset=h}),c.childNodes.length==u?c.appendChild(t):c.insertBefore(t,c.childNodes[u])}function C(t,e){var o=t.parentNode,r=p.getNodeIndex(t);g(e,function(t){var e,n,i;n=o,i=r,(e=t).node==n&&e.offset>i&&--e.offset}),p.removeNode(t)}function O(t,e){return function(t,e,n,i,o){for(var r,a=[];r=t.firstChild;)w(r,e,n++,o),a.push(r);return C(t,o),a}(t,t.parentNode,p.getNodeIndex(t),0,e)}function x(t,e){var n=t.cloneRange();n.selectNodeContents(e);var i=n.intersection(t);return""!=(i?i.toString():"")}function T(t){for(var e,n=t.getNodes([3]),i=0;(e=n[i])&&!x(t,e);)++i;for(var o=n.length-1;(e=n[o])&&!x(t,e);)--o;return n.slice(i,o+1)}function _(t,e){if(t.attributes.length!=e.attributes.length)return!1;for(var n,i,o,r=0,a=t.attributes.length;r<a;++r)if("class"!=(o=(n=t.attributes[r]).name)){if(null===n!=(null===(i=e.attributes.getNamedItem(o))))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function S(t,e){for(var n,i=0,o=t.attributes.length;i<o;++i)if(n=t.attributes[i].name,(!e||!a(e,n))&&t.attributes[i].specified&&"class"!=n)return!0;return!1}var k=p.getComputedStyleProperty,A="boolean"==typeof document.createElement("div").isContentEditable?function(t){return t&&1==t.nodeType&&t.isContentEditable}:function(t){return!(!t||1!=t.nodeType||"false"==t.contentEditable)&&("true"==t.contentEditable||A(t.parentNode))};function R(t){var e;return t&&1==t.nodeType&&((e=t.parentNode)&&9==e.nodeType&&"on"==e.designMode||A(t)&&!A(t.parentNode))}function D(t){return(A(t)||1!=t.nodeType&&A(t.parentNode))&&!R(t)}var P=/^inline(-block|-table)?$/i;function N(t){return t&&1==t.nodeType&&!P.test(k(t,"display"))}var L=/[^\r\n\t\f \u200B]/;function M(t){var e,n,i=[];for(e=0;n=t[e++];)i.push(new r(n.startContainer,n.startOffset),new r(n.endContainer,n.endOffset));return i}function B(t,e){for(var n,i,o,r=0,a=t.length;r<a;++r)n=t[r],i=e[2*r],o=e[2*r+1],n.setStartAndEnd(i.node,i.offset,o.node,o.offset)}function j(t,e,n,i){var o,r,a,s,l=0==n;if(p.isAncestorOf(e,t))return t;if(p.isCharacterDataNode(e)){var h=p.getNodeIndex(e);if(0==n)n=h;else{if(n!=e.length)throw f.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+n+" in "+e.data);n=h+1}e=e.parentNode}if(a=e,s=n,p.isCharacterDataNode(a)?0==s?a.previousSibling:s!=a.length||a.nextSibling:0<s&&s<a.childNodes.length){o=e.cloneNode(!1),r=e.parentNode,o.id&&o.removeAttribute("id");for(var c,u=0;c=e.childNodes[n];)w(c,o,u++,i);return w(o,r,p.getNodeIndex(e)+1,i),e==t?o:j(t,r,p.getNodeIndex(o),i)}if(t==e)return t;o=e.parentNode;var d=p.getNodeIndex(e);return l||d++,j(t,o,d,i)}function H(s){var l=s?"nextSibling":"previousSibling";return function(t,e){var n,i,o=t.parentNode,r=t[l];if(r){if(r&&3==r.nodeType)return r}else if(e&&(r=o[l])&&1==r.nodeType&&(i=r,(n=o).namespaceURI==i.namespaceURI&&n.tagName.toLowerCase()==i.tagName.toLowerCase()&&b(n,i)&&_(n,i)&&"inline"==k(n,"display")&&"inline"==k(i,"display"))){var a=r[s?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}var I=H(!1),F=H(!0);function q(t){this.isElementMerge=1==t.nodeType,this.textNodes=[];var e=this.isElementMerge?t.lastChild:t;e&&(this.textNodes[0]=e)}var z=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],Y={};function X(t,e,n){var i,o,r,a,s=this;s.cssClass=s.className=t;var l=null,h={};if("object"==typeof e&&null!==e){for(void 0!==e.elementTagName&&(e.elementTagName=e.elementTagName.toLowerCase()),n=e.tagNames,l=e.elementProperties,h=e.elementAttributes,o=0;a=z[o++];)e.hasOwnProperty(a)&&(s[a]=e[a]);i=e.normalize}else i=e;s.normalize=void 0===i||i,s.attrExceptions=[];var c=document.createElement(s.elementTagName);s.elementProperties=s.copyPropertiesToElement(l,c,!0),d(h,function(t,e){s.attrExceptions.push(t),h[t]=""+e}),s.elementAttributes=h,s.elementSortedClassName=s.elementProperties.hasOwnProperty("className")?y(s.elementProperties.className+" "+t):t,s.applyToAnyTagName=!1;var u=typeof n;if("string"==u)"*"==n?s.applyToAnyTagName=!0:s.tagNames=m(n.toLowerCase()).split(/\s*,\s*/);else if("object"==u&&"number"==typeof n.length)for(s.tagNames=[],o=0,r=n.length;o<r;++o)"*"==n[o]?s.applyToAnyTagName=!0:s.tagNames.push(n[o].toLowerCase());else s.tagNames=[s.elementTagName]}X.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!(q.prototype={doMerge:function(t){var e=this.textNodes,i=e[0];if(1<e.length){var o,r=p.getNodeIndex(i),a=[],s=0;g(e,function(e,n){o=e.parentNode,0<n&&(o.removeChild(e),o.hasChildNodes()||p.removeNode(o),t&&g(t,function(t){t.node==e&&(t.node=i,t.offset+=s),t.node==o&&t.offset>r&&(--t.offset,t.offset==r+1&&n<len-1&&(t.node=i,t.offset=s))})),a[n]=e.data,s+=e.data.length}),i.data=a.join("")}return i.data},getLength:function(){for(var t=this.textNodes.length,e=0;t--;)e+=this.textNodes[t].length;return e},toString:function(){var n=[];return g(this.textNodes,function(t,e){n[e]="'"+t.data+"'"}),"[Merge("+n.join(",")+")]"}}),useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(t,e,n){var i,o,r,a,s,l,h={};for(var c in t)if(t.hasOwnProperty(c))if(a=t[c],s=e[c],"className"==c)u(e,a),u(e,this.className),e[c]=y(e[c]),n&&(h[c]=a);else if("style"==c){for(i in o=s,n&&(h[c]=r={}),t[c])t[c].hasOwnProperty(i)&&(o[i]=a[i],n&&(r[i]=o[i]));this.attrExceptions.push(c)}else e[c]=a,n&&(h[c]=e[c],l=Y.hasOwnProperty(c)?Y[c]:c,this.attrExceptions.push(l));return n?h:""},copyAttributesToElement:function(t,e){for(var n in t)t.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&e.setAttribute(n,t[n])},appliesToElement:function(t){return a(this.tagNames,t.tagName.toLowerCase())},getEmptyElements:function(t){var e=this;return t.getNodes([1],function(t){return e.appliesToElement(t)&&!t.hasChildNodes()})},hasClass:function(t){return 1==t.nodeType&&(this.applyToAnyTagName||this.appliesToElement(t))&&h(t,this.className)},getSelfOrAncestorWithClass:function(t){for(;t;){if(this.hasClass(t))return t;t=t.parentNode}return null},isModifiable:function(t){return!this.applyToEditableOnly||D(t)},isIgnorableWhiteSpaceNode:function(t){return this.ignoreWhiteSpace&&t&&3==t.nodeType&&function(t){if(0==t.data.length)return!0;if(L.test(t.data))return!1;switch(k(t.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(t.data))return!1}return N(t.previousSibling)||N(t.nextSibling)}(t)},postApply:function(t,e,n,o){var r,a,s=t[0],l=t[t.length-1],h=[],c=s,u=l,d=0,f=l.length;g(t,function(t){(a=I(t,!o))?(r||(r=new q(a),h.push(r)),r.textNodes.push(t),t===s&&(c=r.textNodes[0],d=c.length),t===l&&(u=r.textNodes[0],f=r.getLength())):r=null});var p=F(l,!o);if(p&&(r||(r=new q(l),h.push(r)),r.textNodes.push(p)),h.length){for(i=0,len=h.length;i<len;++i)h[i].doMerge(n);e.setStartAndEnd(c,d,u,f)}},createContainer:function(t){var e=p.getDocument(t),n=s&&!p.isHtmlNamespace(t)&&t.namespaceURI?e.createElementNS(t.namespaceURI,this.elementTagName):e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,n,!1),this.copyAttributesToElement(this.elementAttributes,n),u(n,this.className),this.onElementCreate&&this.onElementCreate(n,this),n},elementHasProperties:function(n,t){var i=this;return d(t,function(t,e){if("className"==t)return E(n,e);if("object"==typeof e){if(!i.elementHasProperties(n[t],e))return!1}else if(n[t]!==e)return!1})},elementHasAttributes:function(n,t){return d(t,function(t,e){if(n.getAttribute(t)!==e)return!1})},applyToTextNode:function(t,e){if((r=t.parentNode)&&1==r.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(r.nodeName)){var n=t.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&this.appliesToElement(n)&&this.elementHasProperties(n,this.elementProperties)&&this.elementHasAttributes(n,this.elementAttributes))u(n,this.className);else{var i=t.parentNode,o=this.createContainer(i);i.insertBefore(o,t),o.appendChild(t)}}var r},isRemovable:function(t){return t.tagName.toLowerCase()==this.elementTagName&&n(t)==this.elementSortedClassName&&this.elementHasProperties(t,this.elementProperties)&&!S(t,this.attrExceptions)&&this.elementHasAttributes(t,this.elementAttributes)&&this.isModifiable(t)},isEmptyContainer:function(t){var e=t.childNodes.length;return 1==t.nodeType&&this.isRemovable(t)&&(0==e||1==e&&this.isEmptyContainer(t.firstChild))},removeEmptyContainers:function(t){var e=this,n=t.getNodes([1],function(t){return e.isEmptyContainer(t)}),i=[t],o=M(i);g(n,function(t){C(t,o)}),B(i,o)},undoToTextNode:function(t,e,n,i){if(!e.containsNode(n)){var o=e.cloneRange();o.selectNode(n),o.isPointInRange(e.endContainer,e.endOffset)&&(j(n,e.endContainer,e.endOffset,i),e.setEndAfter(n)),o.isPointInRange(e.startContainer,e.startOffset)&&(n=j(n,e.startContainer,e.startOffset,i))}this.isRemovable(n)?O(n,i):v(n,this.className)},splitAncestorWithClass:function(t,e,n){var i=this.getSelfOrAncestorWithClass(t);i&&j(i,t,e,n)},undoToAncestor:function(t,e){this.isRemovable(t)?O(t,e):v(t,this.className)},applyToRange:function(t,e){var n=this,i=M((e=e||[])||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t);var o=T(t);if(o.length){g(o,function(t){n.isIgnorableWhiteSpaceNode(t)||n.getSelfOrAncestorWithClass(t)||!n.isModifiable(t)||n.applyToTextNode(t,i)});var r=o[o.length-1];t.setStartAndEnd(o[0],0,r,r.length),n.normalize&&n.postApply(o,t,i,!1),B(e,i)}var a=n.getEmptyElements(t);g(a,function(t){u(t,n.className)})},applyToRanges:function(t){for(var e=t.length;e--;)this.applyToRange(t[e],t);return t},applyToSelection:function(t){var e=o.getSelection(t);e.setRanges(this.applyToRanges(e.getAllRanges()))},undoToRange:function(t,e){var n=this,i=M(e=e||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t,i);var o,r,a=T(t),s=a[a.length-1];if(a.length){n.splitAncestorWithClass(t.endContainer,t.endOffset,i),n.splitAncestorWithClass(t.startContainer,t.startOffset,i);for(var l=0,h=a.length;l<h;++l)o=a[l],(r=n.getSelfOrAncestorWithClass(o))&&n.isModifiable(o)&&n.undoToAncestor(r,i);t.setStartAndEnd(a[0],0,s,s.length),n.normalize&&n.postApply(a,t,i,!0),B(e,i)}var c=n.getEmptyElements(t);g(c,function(t){v(t,n.className)})},undoToRanges:function(t){for(var e=t.length;e--;)this.undoToRange(t[e],t);return t},undoToSelection:function(t){var e=o.getSelection(t),n=o.getSelection(t).getAllRanges();this.undoToRanges(n),e.setRanges(n)},isAppliedToRange:function(t){if(t.collapsed||""==t.toString())return!!this.getSelfOrAncestorWithClass(t.commonAncestorContainer);var e=t.getNodes([3]);if(e.length)for(var n,i=0;n=e[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&x(t,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(t){var e=t.length;if(0==e)return!1;for(;e--;)if(!this.isAppliedToRange(t[e]))return!1;return!0},isAppliedToSelection:function(t){var e=o.getSelection(t);return this.isAppliedToRanges(e.getAllRanges())},toggleRange:function(t){this.isAppliedToRange(t)?this.undoToRange(t):this.applyToRange(t)},toggleSelection:function(t){this.isAppliedToSelection(t)?this.undoToSelection(t):this.applyToSelection(t)},getElementsWithClassIntersectingRange:function(t){var n=[],i=this;return t.getNodes([3],function(t){var e=i.getSelfOrAncestorWithClass(t);e&&!a(n,e)&&n.push(e)}),n},detach:function(){}},X.util={hasClass:h,addClass:u,removeClass:v,getClass:e,hasSameClasses:b,hasAllClasses:E,replaceWithOwnChildren:O,elementsHaveSameNonClassAttributes:_,elementHasNonClassAttributes:S,splitNodeAt:j,isEditableElement:A,isEditingHost:R,isEditable:D},o.CssClassApplier=o.ClassApplier=X,o.createClassApplier=function(t,e,n){return new X(t,e,n)},t.createAliasForDeprecatedMethod(o,"createCssClassApplier","createClassApplier",f)}),t})?o.apply(e,r):o)||(t.exports=a)},function(t,e,n){var i,o,r;o=[n(7)],void 0===(r="function"==typeof(i=function(t){return t.createModule("Highlighter",["ClassApplier"],function(O,t){var e=O.dom,o=e.arrayContains,l=e.getBody,x=O.util.createOptions,T=O.util.forEach,a=1;function n(t,e){return t.characterRange.start-e.characterRange.start}function g(t,e){return e?t.getElementById(e):l(t)}var i={};function r(t,e){this.type=t,this.converterCreator=e}function s(t,e){i[t]=new r(t,e)}function m(t){var e=i[t];if(e instanceof r)return e.create();throw new Error("Highlighter type '"+t+"' is not valid")}function _(t,e){this.start=t,this.end=e}r.prototype.create=function(){var t=this.converterCreator();return t.type=this.type,t},O.registerHighlighterType=s,_.prototype={intersects:function(t){return this.start<t.end&&this.end>t.start},isContiguousWith:function(t){return this.start==t.end||this.end==t.start},union:function(t){return new _(Math.min(this.start,t.start),Math.max(this.end,t.end))},intersection:function(t){return new _(Math.max(this.start,t.start),Math.min(this.end,t.end))},getComplements:function(t){var e=[];if(this.start>=t.start){if(this.end<=t.end)return[];e.push(new _(t.end,this.end))}else e.push(new _(this.start,Math.min(this.end,t.start))),this.end>t.end&&e.push(new _(t.end,this.end));return e},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},_.fromCharacterRange=function(t){return new _(t.start,t.end)};var h,c={rangeToCharacterRange:function(t,e){var n=t.getBookmark(e);return new _(n.start,n.end)},characterRangeToRange:function(t,e,n){var i=O.createRange(t);return i.moveToBookmark({start:e.start,end:e.end,containerNode:n}),i},serializeSelection:function(t,e){for(var n=t.getAllRanges(),i=[],o=1==n.length&&t.isBackward(),r=0,a=n.length;r<a;++r)i[r]={characterRange:this.rangeToCharacterRange(n[r],e),backward:o};return i},restoreSelection:function(t,e,n){t.removeAllRanges();for(var i,o,r=t.win.document,a=0,s=e.length;a<s;++a)(o=e[a]).characterRange,i=this.characterRangeToRange(r,o.characterRange,n),t.addRange(i,o.backward)}};function S(t,e,n,i,o,r){o?(this.id=o,a=Math.max(a,o+1)):this.id=a++,this.characterRange=e,this.doc=t,this.classApplier=n,this.converter=i,this.containerElementId=r||null,this.applied=!1}function u(t,e){e=e||"textContent",this.doc=t||document,this.classAppliers={},this.highlights=[],this.converter=m(e)}s("textContent",function(){return c}),s("TextRange",function(){if(!h){var t=O.modules.TextRange;if(!t)throw new Error("TextRange module is missing.");if(!t.supported)throw new Error("TextRange module is present but not supported.");h={rangeToCharacterRange:function(t,e){return _.fromCharacterRange(t.toCharacterRange(e))},characterRangeToRange:function(t,e,n){var i=O.createRange(t);return i.selectCharacters(n,e.start,e.end),i},serializeSelection:function(t,e){return t.saveCharacterRanges(e)},restoreSelection:function(t,e,n){t.restoreCharacterRanges(n,e)}}}return h}),S.prototype={getContainerElement:function(){return g(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(t){this.characterRange=this.converter.rangeToCharacterRange(t,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(t){return this.getRange().containsNodeContents(t.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},u.prototype={addClassApplier:function(t){this.classAppliers[t.className]=t},getHighlightForElement:function(t){for(var e=this.highlights,n=0,i=e.length;n<i;++n)if(e[n].containsElement(t))return e[n];return null},removeHighlights:function(t){for(var e,n=0,i=this.highlights.length;n<i;++n)e=this.highlights[n],o(t,e)&&(e.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(t){var n=[],i=this.highlights;return T(t,function(e){T(i,function(t){e.intersectsRange(t.getRange())&&!o(n,t)&&n.push(t)})}),n},highlightCharacterRanges:function(t,e,n){var i,o,r,a,s,l,h,c,u,d,f,p,g=this.highlights,m=this.converter,v=this.doc,y=[],b=t?this.classAppliers[t]:null,E=(n=x(n,{containerElementId:null,exclusive:!0})).containerElementId,w=n.exclusive;for(E&&(a=this.doc.getElementById(E))&&((s=O.createRange(this.doc)).selectNodeContents(a),l=new _(0,s.toString().length)),i=0,o=e.length;i<o;++i)if(h=e[i],f=[],l&&(h=h.intersection(l)),h.start!=h.end){for(r=0;r<g.length;++r)u=!1,E==g[r].containerElementId&&(c=g[r].characterRange,p=!(d=b==g[r].classApplier)&&w,(c.intersects(h)||c.isContiguousWith(h))&&(d||p)&&(p&&T(c.getComplements(h),function(t){f.push(new S(v,t,g[r].classApplier,m,null,E))}),u=!0,d&&(h=c.union(h)))),u?(y.push(g[r]),g[r]=new S(v,c.union(h),b,m,null,E)):f.push(g[r]);b&&f.push(new S(v,h,b,m,null,E)),this.highlights=g=f}T(y,function(t){t.unapply()});var C=[];return T(g,function(t){t.applied||(t.apply(),C.push(t))}),C},highlightRanges:function(t,e,n){var i,o=[],r=this.converter,a=(n=x(n,{containerElement:null,exclusive:!0})).containerElement,s=a?a.id:null;return a&&(i=O.createRange(a)).selectNodeContents(a),T(e,function(t){var e=a?i.intersection(t):t;o.push(r.rangeToCharacterRange(e,a||l(t.getDocument())))}),this.highlightCharacterRanges(t,o,{containerElementId:s,exclusive:n.exclusive})},highlightSelection:function(t,e){var n=this.converter,i=!!t&&this.classAppliers[t],o=(e=x(e,{containerElementId:null,selection:O.getSelection(this.doc),exclusive:!0})).containerElementId,r=e.exclusive,a=e.selection,s=g(a.win.document,o);if(!i&&!1!==t)throw new Error("No class applier found for class '"+t+"'");var l=n.serializeSelection(a,s),h=[];T(l,function(t){h.push(_.fromCharacterRange(t.characterRange))});var c=this.highlightCharacterRanges(t,h,{containerElementId:o,exclusive:r});return n.restoreSelection(a,l,s),c},unhighlightSelection:function(t){t=t||O.getSelection(this.doc);var e=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(e),t.removeAllRanges(),e},getHighlightsInSelection:function(t){return t=t||O.getSelection(this.doc),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(t){return 0<this.getHighlightsInSelection(t).length},serialize:function(o){var t,r,a,s,l=this,e=l.highlights;return e.sort(n),t=(o=x(o,{serializeHighlightText:!1,type:l.converter.type})).type,(a=t!=l.converter.type)&&(s=m(t)),r=["type:"+t],T(e,function(t){var e,n=t.characterRange;a&&(e=t.getContainerElement(),n=s.rangeToCharacterRange(l.converter.characterRangeToRange(l.doc,n,e),e));var i=[n.start,n.end,t.id,t.classApplier.className,t.containerElementId];o.serializeHighlightText&&i.push(t.getText()),r.push(i.join("$"))}),r.join("|")},deserialize:function(t){var e,n,i,o,r,a,s,l,h=t.split("|"),c=[],u=h[0],d=!1;if(!u||!(e=/^type:(\w+)$/.exec(u)))throw new Error("Serialized highlights are invalid.");(n=e[1])!=this.converter.type&&(i=m(n),d=!0),h.shift();for(var f,p=h.length;0<p--;){if(a=new _(+(f=h[p].split("$"))[0],+f[1]),s=f[4]||null,d&&(l=g(this.doc,s),a=this.converter.rangeToCharacterRange(i.characterRangeToRange(this.doc,a,l),l)),!(o=this.classAppliers[f[3]]))throw new Error("No class applier found for class '"+f[3]+"'");(r=new S(this.doc,a,o,this.converter,parseInt(f[2]),s)).apply(),c.push(r)}this.highlights=c}},O.Highlighter=u,O.createHighlighter=function(t,e){return new u(t,e)}}),t})?i.apply(e,o):i)||(t.exports=r)},function(t,e,n){var i,o,r;o=[n(7)],void 0===(r="function"==typeof(i=function(t){return t.createModule("SaveRestore",["WrappedRange"],function(l,a){var s=l.dom,h=s.removeNode,c=l.Selection.isDirectionBackward,u="\ufeff";function d(t,e){return(e||document).getElementById(t)}function f(t,e){var n,i="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),o=s.getDocument(t.startContainer),r=t.cloneRange();return r.collapse(e),(n=o.createElement("span")).id=i,n.style.lineHeight="0",n.style.display="none",n.className="rangySelectionBoundary",n.appendChild(o.createTextNode(u)),r.insertNode(n),n}function p(t,e,n,i){var o=d(n,t);o?(e[i?"setStartBefore":"setEndBefore"](o),h(o)):a.warn("Marker element has been removed. Cannot restore selection.")}function g(t,e){return e.compareBoundaryPoints(t.START_TO_START,t)}function m(t,e){var n,i=l.DomRange.getRangeDocument(t),o=t.toString(),r=c(e);return t.collapsed?{document:i,markerId:(n=f(t,!1)).id,collapsed:!0}:(n=f(t,!1),{document:i,startMarkerId:f(t,!0).id,endMarkerId:n.id,collapsed:!1,backward:r,toString:function(){return"original text: '"+o+"', new text: '"+t.toString()+"'"}})}function i(t,e){var n=t.document;void 0===e&&(e=!0);var i=l.createRange(n);if(t.collapsed){var o=d(t.markerId,n);if(o){o.style.display="inline";var r=o.previousSibling;r&&3==r.nodeType?(h(o),i.collapseToPoint(r,r.length)):(i.collapseBefore(o),h(o))}else a.warn("Marker element has been removed. Cannot restore selection.")}else p(n,i,t.startMarkerId,!0),p(n,i,t.endMarkerId,!1);return e&&i.normalizeBoundaries(),i}function r(t,e){var n,i,o=[],r=c(e);(t=t.slice(0)).sort(g);for(var a=0,s=t.length;a<s;++a)o[a]=m(t[a],r);for(a=s-1;0<=a;--a)n=t[a],i=l.DomRange.getRangeDocument(n),n.collapsed?n.collapseAfter(d(o[a].markerId,i)):(n.setEndBefore(d(o[a].endMarkerId,i)),n.setStartAfter(d(o[a].startMarkerId,i)));return o}function v(t){for(var e=[],n=t.length-1;0<=n;n--)e[n]=i(t[n],!0);return e}function y(t,e){var n=d(e,t);n&&h(n)}l.util.extend(l,{saveRange:m,restoreRange:i,saveRanges:r,restoreRanges:v,saveSelection:function(t){if(!l.isSelectionValid(t))return a.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var e=l.getSelection(t),n=e.getAllRanges(),i=1==n.length&&e.isBackward(),o=r(n,i);return i?e.setSingleRange(n[0],i):e.setRanges(n),{win:t,rangeInfos:o,restored:!1}},restoreSelection:function(t,e){if(!t.restored){var n=t.rangeInfos,i=l.getSelection(t.win),o=v(n);1==n.length&&e&&l.features.selectionHasExtend&&n[0].backward?(i.removeAllRanges(),i.addRange(o[0],!0)):i.setRanges(o),t.restored=!0}},removeMarkerElement:y,removeMarkers:function(t){for(var e,n=t.rangeInfos,i=0,o=n.length;i<o;++i)(e=n[i]).collapsed?y(t.doc,e.markerId):(y(t.doc,e.startMarkerId),y(t.doc,e.endMarkerId))}})}),t})?i.apply(e,o):i)||(t.exports=r)},function(t,e,n){},,function(t,e,n){"use strict";function i(t,e,n,i,o){!function t(e,n,i,o,r){for(;i<o;){if(600<o-i){var a=o-i+1,s=n-i+1,l=Math.log(a),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(a-h)/a)*(s-a/2<0?-1:1);t(e,n,Math.max(i,Math.floor(n-s*h/a+c)),Math.min(o,Math.floor(n+(a-s)*h/a+c)),r)}var u=e[n],d=i,f=o;for(p(e,i,n),0<r(e[o],u)&&p(e,i,o);d<f;){for(p(e,d,f),d++,f--;r(e[d],u)<0;)d++;for(;0<r(e[f],u);)f--}0===r(e[i],u)?p(e,i,f):p(e,++f,o),f<=n&&(i=f+1),n<=f&&(o=f-1)}}(t,e,n||0,i||t.length-1,o||r)}function p(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function r(t,e){return t<e?-1:e<t?1:0}t.exports=i,t.exports.default=i}],N.c=M,N.d=function(t,e,n){N.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},N.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},N.t=function(e,t){if(1&t&&(e=N(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(N.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)N.d(n,i,function(t){return e[t]}.bind(null,i));return n},N.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return N.d(e,"a",e),e},N.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},N.p="",N(N.s=31)}});